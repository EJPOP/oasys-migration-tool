WITH BASE AS ( SELECT CASE WHEN trim(A.ENFC_ATRZ_YMD) IS NOT NULL THEN '8' WHEN trim(A.LDRV_MBCMT_ATRZ_YMD) IS NOT NULL THEN '7' WHEN trim(A.OW_DHD_ATRZ_YMD) IS NOT NULL THEN '6' WHEN trim(A.JDAF_SRNG_OFER_ATRZ_YMD) IS NOT NULL THEN '5' WHEN trim(A.AJMT_DDG_ATRZ_YMD) IS NOT NULL THEN '4' WHEN trim(A.AJMT_OFER_ATRZ_YMD) IS NOT NULL THEN '3' WHEN trim(A.AB_ATRZ_YMD) IS NOT NULL THEN '2' WHEN trim(A.DAG_RPT_YMD) IS NOT NULL THEN '1' ELSE '0' END AS TRIM,
    A.ACADT_PRCS_STTS_SECD /* 실지감사처리상태구분코드 */,
    A.DAG_RPT_YMD /* 귀청보고일자 */,
    A.AB_ATRZ_YMD /* 감사국결재일자 */,
    A.AJMT_OFER_ATRZ_YMD /* 조정담당관결재일자 */,
    A.AJMT_DDG_ATRZ_YMD /* 조정심의관결재일자 */,
    A.JDAF_SRNG_OFER_ATRZ_YMD /* 법무심사담당관결재일자 */,
    A.OW_DHD_ATRZ_YMD /* 사무차장결재일자 */,
    A.LDRV_MBCMT_ATRZ_YMD /* 주심위원위원결재일자 */,
    B.SPRVSN_DEPT_CD /* 주관부서코드 */,
    B.ADT_KDCD /* 감사종류코드 */,
    A.PRCS_TERM_YMD /* 처리기한일자 */,
    B.MNG_DEPT_CD /* 관리부서코드 */
FROM TB_BADDED003M A ,TB_BADDED001M B WHERE 1=1 AND B.BZTRP_BGT_SECD = '1' /* 확인출장(실국배정)은 제외 - 2015.04.28 yyh, 실국배정 조건 로직 변경(AUD_KND_CD 에서 BZT_BGT_DVSN_CD 로) - 2016.09.29 yyh */ AND A.CVLCPT_ADT_YR(+) = B.ADT_YR AND A.ADT_NO(+) = B.ADT_NO AND SUBSTRING(B.MNG_DEPT_CD, 1, 1) = '0' AND ((A.ACADT_PRCS_STTS_SECD = '1' AND TO_DATE(NVL(A.DAG_YMD ,'99991231')) - TO_DATE(SYSDATE) <= 0) OR A.ACADT_PRCS_STTS_SECD = '3') ) /*국별 */ SELECT SUBSTRB(MNG_DEPT_CD, 1, 3) || '000' AS SPRVSN_DEPT_CD /* 주관부서코드 */,
    F_DPT_INFO(SUBSTRB(MNG_DEPT_CD, 1, 3) || '000',1) AS F_DPT_INFO,
    COUNT(*) AS TOTAL_CNT,
    sum(case when substr(ADT_KDCD,-1) IN ('0','1','2','3','4','5','6','7','8','9') AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 소계 */,
    sum(case when substr(ADT_KDCD,-1) ='0' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 특정감사(종합분석형) */,
    sum(case when substr(ADT_KDCD,-1) ='1' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 재무감사 */,
    sum(case when substr(ADT_KDCD,-1) ='2' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 특정감사 */,
    sum(case when substr(ADT_KDCD,-1) ='3' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 성과감사 */,
    sum(case when substr(ADT_KDCD,-1) ='4' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 기관운영감사 */,
    sum(case when substr(ADT_KDCD,-1) ='5' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 확인출장 */,
    sum(case when substr(ADT_KDCD,-1) ='6' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 재무감사(결산) */,
    sum(case when substr(ADT_KDCD,-1) ='7' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 민원/손망실등 */,
    sum(case when substr(ADT_KDCD,-1) ='8' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 기타 */,
    sum(case when substr(ADT_KDCD,-1) ='9' AND GRADE ='0' then 1 else 0 end) AS SUBSTR /* 서면/모니터링 */,
    sum(case when GRADE IN ('1','2','3','4','5','6','7','8') THEN 1 else 0 end) AS GRADE /* 소계 */,
    sum(case when GRADE ='1' THEN 1 else 0 end) AS GRADE /* 귀청보고결재건수 */,
    sum(case when GRADE ='2' THEN 1 else 0 end) AS GRADE /* 감사국과결재건수 */,
    sum(case when GRADE ='3' THEN 1 else 0 end) AS GRADE /* 조정담당자결재건수 */,
    sum(case when GRADE ='4' THEN 1 else 0 end) AS GRADE /* 조정담당관결재건수 */,
    sum(case when GRADE ='5' THEN 1 else 0 end) AS GRADE /* 심의실장결재건수 */,
    sum(case when GRADE ='6' THEN 1 else 0 end) AS GRADE /* 총차장결재건수 */,
    sum(case when GRADE ='7' THEN 1 else 0 end) AS GRADE /* 주심위원건수 */,
    sum(case when GRADE ='8' THEN 1 else 0 end) AS GRADE /* 시행결재건수 */,
    sum(CASE WHEN ACADT_PRCS_STTS_SECD = '3' THEN 1 ELSE 0 END) AS ACADT_PRCS_STTS_SECD /* 실지감사처리상태구분코드 */,
    SUM(CASE WHEN TO_DATE(NVL(PRCS_TERM_YMD,'99991231')) - TO_DATE(SYSDATE) < 0 THEN 1 ELSE 0 END) AS TO_DATE,
    (SELECT AS DPT_SNO
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = SUBSTRB(MNG_DEPT_CD, 1, 3) || '000') AS DPT_ORDER FROM BASE GROUP BY SUBSTRB(MNG_DEPT_CD, 1, 3) || '000' ORDER BY DPT_ORDER