WITH DATA AS ( SELECT ROW_NUMBER() OVER(PARTITION BY BB.USE_STR_DT, BB.DMT_DVSN_CD ORDER BY BB.FRST_REG_DT ASC) AS ADT_RPTP_EDT_HSTRY_SQNO /* 감사보고서편집이력순번 */,
    BB.*
FROM TBCSPSAE501D BB ) SELECT A.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    A.APL_DT,
    A.BSC_SRNO,
    SUBSTR(B.USE_STR_DT, 0, 4) || '-' || SUBSTR(B.USE_STR_DT, 5, 2) || '-' || SUBSTR(B.USE_STR_DT, 7, 2) || '(' || SUBSTRING (UPPER(TO_CHAR(TO_DATE(B.USE_STR_DT), 'DAY', 'NLS_DATE_LANGUAGE=KOREAN') ), 0, 1) || ')' AS SUBSTR,
    B.SEAT_NM,
    B.DMT_DVSN_CD,
    B.USE_FEE,
    B.PD_YN,
    B.USE_YN /* 사용여부 */,
    B.COFM_STA_CD,
    A.USE_YN /* 사용여부 */,
    B.BOKG_COFM_DT,
    C.DDL_DT,
    B.RMN_NM,
    B.FRS_MDM_SQNO /* 포렌식매체순번 */,
    GREATEST((B.ADT_RPTP_EDT_HSTRY_SQNO) - (CASE WHEN B.DMT_DVSN_CD = '4' THEN C.F2_WSRM_BOKG_POSS_CNT WHEN B.DMT_DVSN_CD = '5' THEN C.F3_WSRM_BOKG_POSS_CNT WHEN B.DMT_DVSN_CD = '6' THEN C.F3_KSRM_BOKG_POSS_CNT WHEN B.DMT_DVSN_CD = '7' THEN C.F4_WSRM_BOKG_POSS_CNT WHEN B.DMT_DVSN_CD = '8' THEN C.CAMP_BOKG_POSS_CNT ELSE 0 END), 0) AS GREATEST
FROM TBCSPSAE501M A , DATA B , TBCSPSAE134B C WHERE A.TRGT_NOP_ENO = B.TRGT_NOP_ENO AND A.APL_DT = B.APL_DT AND A.BSC_SRNO = B.BSC_SRNO AND B.USE_STR_DT = TO_CHAR(TO_DATE(C.END_DDL_DT)-1,'YYYYMMDD') AND A.TRGT_NOP_ENO = #TRGT_NOP_ENO# AND B.USE_STR_DT BETWEEN #strFromY# || #strFromM# || '01' AND #strToY# || #strToM# || '31' ORDER BY A.APL_DT, B.USE_STR_DT