SELECT /* CSPNBK312PReadPrintOutInvest */ MOUI_NO,
    TO_CHAR(TO_DATE(INV_DEAL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS TO_CHAR,
    INV_DEAL_SLN,
    PET_DT /* 조작일시 */,
    INV_AM,
    DEPTS_PMT_DVSN_CD,
    DEAL_BK_LEDG_BL,
    DEAL_AF_LEDG_BL,
    RMRK_CN /* 비고내용 */,
    BBK_PRT_YN,
    INV_KND_CD,
    #FNL_OTPT_ROW_NO# AS #FNL_OTPT_ROW_NO#
FROM TBCSPNBK102L WHERE MOUI_NO = #MOUI_NO# AND CNL_YN = 'N' AND ( INV_DEAL_DT > ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
FROM TBCSPNBK102L WHERE MOUI_NO = #MOUI_NO# AND CNL_YN = 'N' AND BBK_PRT_YN = 'Y') OR ( INV_DEAL_DT = ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
FROM TBCSPNBK102L WHERE MOUI_NO = #MOUI_NO# AND CNL_YN = 'N' AND BBK_PRT_YN = 'Y') AND INV_DEAL_SLN > ( SELECT NVL(MAX(INV_DEAL_SLN), 0) AS INV_DEAL_SLN
FROM TBCSPNBK102L WHERE INV_DEAL_DT = (SELECT MAX(INV_DEAL_DT)
FROM TBCSPNBK102L WHERE MOUI_NO = #MOUI_NO# AND CNL_YN = 'N' AND BBK_PRT_YN = 'Y') AND MOUI_NO = #MOUI_NO# AND CNL_YN = 'N' AND BBK_PRT_YN = 'Y' ) ) ) ORDER BY INV_DEAL_DT, INV_DEAL_SLN