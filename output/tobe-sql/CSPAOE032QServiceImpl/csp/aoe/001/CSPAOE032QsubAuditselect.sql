SELECT NVL(F_MNG_KND_AUDYRNO(D3.CVLCPT_ADT_YR, D3.TSK_NO, D7.ADT_KDCD, '-'),D3.CVLCPT_ADT_YR || '-' || D3.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    ( SELECT AS ADT_MTTR_NM /* 감사사항명 */
FROM TBCSPAOE021M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO ) AS ADT_MTTR_NM /*감사사항명*/ , F_CODE_NM('1000279', D3.EVL_STEP_CD) AS EVL_STEP_NM /*평가단계*/ , F_CODE_NM('1000280', NVL(D5.EVL_STA_CD, '100')) AS EVL_STA_NM /*평가상태*/ , F_DPT_INFO(D6.HNDL_DIV_DPT_CD, '1') AS HNDL_DIV_DPT_NM /*처리과 - 2015.01.04 최원형감사관 요청*/ FROM ( SELECT D2.EVL_YR,
    D2.HLYR_DVSN_CD,
    D1.TSK_NO,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.CHGR_DVSN_CD,
    '200' AS EVL_STEP_CD,
    D2.PIC_ENO /* 담당자직원전산번호 */
FROM ( SELECT TSK_NO,
    CVLCPT_ADT_YR /* 민원감사년도 */
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) WHERE AUD_STEP_CD_MAX = '10010' ) D1 , TBCSPAOE017D D2 WHERE D2.EVL_YR = #strEvlYr# AND D2.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.CVLCPT_TASK_SECD = '10000' AND D2.CHGR_DVSN_CD = 'CD34' AND D2.CHGR_DVSN_CD = #strEvlDvsnCd# AND D2.PIC_ENO = #PIC_ENO# UNION ALL SELECT D2.EVL_YR,
    D2.HLYR_DVSN_CD,
    D1.TSK_NO,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.CHGR_DVSN_CD,
    '100' AS EVL_STEP_CD,
    D2.PIC_ENO /* 담당자직원전산번호 */
FROM ( SELECT TSK_NO,
    CVLCPT_ADT_YR /* 민원감사년도 */
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M BASE /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# AND 0 = ( SELECT COUNT(*)
FROM TBCSPAOE029M WHERE EVL_YR || HLYR_DVSN_CD != #strEvlYr# || #strHlyrDvsnCd# AND EVL_STEP_CD = '100' AND EVL_CMTR_DVSN_CD = 'CD33' AND CVLCPT_ADT_YR = BASE.CVLCPT_ADT_YR AND TSK_NO = BASE.TSK_NO ) GROUP BY CVLCPT_ADT_YR, TSK_NO ) WHERE ( TO_NUMBER(AUD_STEP_CD_MAX) BETWEEN 10004 AND 10009 AND TO_NUMBER(AUD_STEP_CD_MIN) <= 10004 ) /*귀청보고 ~ ( 귀청보고 - 국장/단장) */ OR AUD_STEP_CD_MAX = '10010' ) D1 , TBCSPAOE017D D2 WHERE D2.EVL_YR = #strEvlYr# AND D2.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.CVLCPT_TASK_SECD = '10000' AND D2.CHGR_DVSN_CD = 'CD33' AND D2.CHGR_DVSN_CD = #strEvlDvsnCd# AND D2.PIC_ENO = #PIC_ENO# ) D3 , TBCSPAOE029M D5 , TBCSPAOE021M D6 , TB_BADDED001M D7 WHERE D3.EVL_YR = D5.EVL_YR (+) AND D3.HLYR_DVSN_CD = D5.HLYR_DVSN_CD (+) AND D5.CVLCPT_TASK_SECD (+) = '10000' /*감사업무*/ AND D3.EVL_STEP_CD = D5.EVL_STEP_CD (+) AND D3.PIC_ENO = D5.EVL_CMTR_CNB (+) AND D3.TSK_NO = D5.TSK_NO (+) AND D3.CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR (+) AND D3.CHGR_DVSN_CD = D5.EVL_CMTR_DVSN_CD (+) AND D3.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR AND D3.TSK_NO = D6.TSK_NO AND D3.TSK_NO = D7.ADT_NO (+) AND D3.CVLCPT_ADT_YR = D7.ADT_YR (+) AND NVL(D5.EVL_STA_CD, '100') in ('100', '200') /*평가상태코드가 100인 미확인인것만 조회한다.*/ ORDER BY D6.HNDL_DIV_DPT_CD, D3.CVLCPT_ADT_YR, D3.TSK_NO