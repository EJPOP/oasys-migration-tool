WITH DATA AS /* CSPSAE504PPermitList */ (SELECT A.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    C.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    B.JBGD_SECD /* 직급구분코드 */,
    B.USER_NM /* 사용자명 */,
    A.BSC_SRNO,
    COUNT(A.DMT_DVSN_CD) AS DMT_DVSN_CD,
    D.UE_PPS_TXT,
    D.APL_DT,
    A.USE_STR_DT,
    A.USE_END_DT,
    D.UE_NOP_CNT,
    SUM(A.USE_FEE) AS USE_FEE,
    B.CNSTN_MBCMT_HOME_TELNO /* 자문위원자택전화번호 */,
    D.USE_YN /* 사용여부 */
FROM TBCSPSAE501D A , TBDCMACM001M B , TBDCMACM002M C , TBCSPSAE501M D WHERE B.TRGT_NOP_ENO = A.TRGT_NOP_ENO AND C.SRECS_DEPT_CD = B.SRECS_DEPT_CD AND D.TRGT_NOP_ENO = A.TRGT_NOP_ENO AND D.APL_DT = A.APL_DT AND D.BSC_SRNO = A.BSC_SRNO AND A.COFM_STA_CD IN ('30', '50', '60') AND A.USE_STR_DT BETWEEN #strFromDt# AND #strToDt# GROUP BY A.TRGT_NOP_ENO , C.CNSTN_MBCMT_DEPT_NM , B.JBGD_SECD , B.USER_NM , A.BSC_SRNO , D.UE_PPS_TXT , D.APL_DT , A.USE_STR_DT , A.USE_END_DT , D.UE_NOP_CNT , B.CNSTN_MBCMT_HOME_TELNO , D.USE_YN ) SELECT TO_CHAR(ROWNUM) AS ADT_RPTP_EDT_HSTRY_SQNO /* 감사보고서편집이력순번 */,
    A.CNSTN_MBCMT_DEPT_NM || CHR(10) || (SELECT AS CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */
FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173' AND CD = A.JBGD_SECD) || ' ' || A.USER_NM AS INFO_RLPR_NM , '생활관 ' || A.DMT_DVSN_CNT || '실' AS DMT , A.UE_PPS_TXT , SUBSTR(A.APL_DT, 5, 2) || '.' || SUBSTR(A.APL_DT, 7, 2) AS APL_DT , SUBSTR(A.USE_STR_DT, 5, 2) || '.' || SUBSTR(A.USE_STR_DT, 7, 2) || ' ~ ' || SUBSTR(A.USE_END_DT, 5, 2) || '.' || SUBSTR(A.USE_END_DT, 7, 2) AS USE_DT , TO_CHAR(A.UE_NOP_CNT) AS UE_NOP_CNT , '가족' AS RELATION_SHIP , DECODE(A.USE_FEE, 0, '면제', A.USE_FEE) AS USE_FEE , A.CNSTN_MBCMT_HOME_TELNO || CHR(10) || DECODE( A.COK_USE_YN, 'Y', '(취사, 바베큐신청)', '') AS CNSTN_MBCMT_HOME_TELNO FROM DATA A , (SELECT D2.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    ROWNUM AS ADT_RPTP_EDT_HSTRY_SQNO
FROM (SELECT DISTINCT D1.TRGT_NOP_ENO AS TRGT_NOP_ENO /* 대상인원직원전산번호 */
FROM DATA D1 ORDER BY D1.TRGT_NOP_ENO ) D2 ) B WHERE B.TRGT_NOP_ENO = A.TRGT_NOP_ENO UNION ALL SELECT '' AS ADT_RPTP_EDT_HSTRY_SQNO /* 감사보고서편집이력순번 */,
    '계' AS INFO_RLPR_NM /* 정보관계자명 */,
    '총 ' || SUM(B.DMT_DVSN_CNT) || '실' AS DMT_DVSN_CNT,
    '' AS UE_PPS_TXT,
    '' AS APL_DT,
    '' AS USE_DT,
    SUM(B.UE_NOP_CNT) || '명' AS UE_NOP_CNT,
    '' AS RELATION_SHIP,
    TO_CHAR(SUM(B.USE_FEE)) AS TO_CHAR,
    '' AS CNSTN_MBCMT_HOME_TELNO /* 자문위원자택전화번호 */
FROM DATA B