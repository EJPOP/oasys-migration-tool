WITH USE_INFO AS ( SELECT A.RMN_NM,
    MIN(A.USE_STR_DT) AS USE_STR_DT,
    MAX(A.USE_END_DT) AS USE_END_DT,
    A.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    B.USER_NM /* 사용자명 */
FROM TBCSPSAE501D A , TBDCMACM001M B WHERE A.COFM_STA_CD IN ('30', '50', '60') AND B.TRGT_NOP_ENO = A.TRGT_NOP_ENO AND A.USE_STR_DT BETWEEN #strFromDt# AND #strToDt# GROUP BY A.TRGT_NOP_ENO, A.RMN_NM, B.USER_NM ) SELECT A.FLOOR2,
    DECODE((SELECT AS USE_YN /* 사용여부 */
FROM TBCSPSAE115B WHERE RMN_NM = A.FLOOR2), 'N', '미사용', (SELECT USER_NM /* 사용자명 */
FROM USE_INFO WHERE A.FLOOR2 IN RMN_NM)) AS USE_NAM_2 , (SELECT SUBSTR(USE_STR_DT, 5, 2) || '.' || SUBSTR(USE_STR_DT, 7, 2) || '~' || SUBSTR(USE_END_DT, 5, 2) || '.' || SUBSTR(USE_END_DT, 7, 2)
FROM USE_INFO WHERE A.FLOOR2 IN RMN_NM) AS USE_DT_2 , A.FLOOR3 , DECODE((SELECT USE_YN /* 사용여부 */
FROM TBCSPSAE115B WHERE RMN_NM = A.FLOOR3), 'N', '미사용', (SELECT USER_NM /* 사용자명 */
FROM USE_INFO WHERE A.FLOOR3 IN RMN_NM)) AS USE_NAM_3 , (SELECT SUBSTR(USE_STR_DT, 5, 2) || '.' || SUBSTR(USE_STR_DT, 7, 2) || '~' || SUBSTR(USE_END_DT, 5, 2) || '.' || SUBSTR(USE_END_DT, 7, 2)
FROM USE_INFO WHERE A.FLOOR3 IN RMN_NM) AS USE_DT_3 , A.FLOOR4 , DECODE((SELECT USE_YN /* 사용여부 */
FROM TBCSPSAE115B WHERE RMN_NM = A.FLOOR4), 'N', '미사용', (SELECT USER_NM /* 사용자명 */
FROM USE_INFO WHERE A.FLOOR4 IN RMN_NM)) AS USE_NAM_4 , (SELECT SUBSTR(USE_STR_DT, 5, 2) || '.' || SUBSTR(USE_STR_DT, 7, 2) || '~' || SUBSTR(USE_END_DT, 5, 2) || '.' || SUBSTR(USE_END_DT, 7, 2)
FROM USE_INFO WHERE A.FLOOR4 IN RMN_NM) AS USE_DT_4 FROM ( SELECT ROW_NO,
    MIN(DECODE(SEAT_NM, '2층', RMN_NM)) AS SEAT_NM,
    MIN(DECODE(SEAT_NM, '3층', RMN_NM)) AS SEAT_NM,
    MIN(DECODE(SEAT_NM, '4층', RMN_NM)) AS SEAT_NM
FROM ( SELECT ROW_NUMBER() OVER (PARTITION BY SEAT_NM ORDER BY RMN_NM) AS ROW_NUMBER,
    SEAT_NM,
    RMN_NM
FROM TBCSPSAE115B ORDER BY RMN_NM ) GROUP BY ROW_NO ) A