INSERT INTO /* CSPNBK511QDvdAcmInsert */ TBCSPNBK402M ( DVD_YR , MOUI_NO , OPT_MOUI_NO , PET_DT , WTDW_ACM , NWD_ACM , EX_ACM , FRST_USER_ID , LAST_USER_ID , LAST_PRCS_DEPT_CD , LAST_MENU_ID , FRST_REG_DT , LAST_MDFCN_DT ) SELECT #dvdYr# AS #DVDYR#,
    D7.MOUI_NO,
    #optMouiNo# AS #OPTMOUINO#,
    SYSDATE,
    SUM( CASE WHEN ( SELECT AS EX_DVD_RTS_TG_YN
FROM TBCSPNBK001M WHERE MOUI_NO = D7.MOUI_NO ) != 'Y' AND (TO_NUMBER( (SELECT SET_TXT
FROM TBCSPNBK003M WHERE OP_MTRL_MNG_CD = '1') ) D4.INV_DEAL_DT ), TO_CHAR(TO_DATE(#dvdYr# || '1231', 'YYYYMMDD') + 1, 'YYYYMMDD' )) AS END_YMD FROM ( SELECT D1.MOUI_NO,
    D1.INV_DEAL_DT,
    D1.INV_DEAL_SLN,
    ( CASE WHEN D1.DEAL_AF_LEDG_BL > TO_NUMBER( (SELECT AS DEAL_AF_LEDG_BL
FROM TBCSPNBK003M WHERE OP_MTRL_MNG_CD = '0') ) THEN TO_NUMBER( (SELECT SET_TXT
FROM TBCSPNBK003M WHERE OP_MTRL_MNG_CD = '0') ) ELSE D1.DEAL_AF_LEDG_BL END ) AS DEAL_AF_LEDG_BL FROM TBCSPNBK102L D1 WHERE D1.CNL_YN = 'N' AND D1.INV_DEAL_DT BETWEEN ( SELECT NVL(MAX(D2.INV_DEAL_DT),#dvdYr# || '0101')
FROM TBCSPNBK102L D2 WHERE D2.MOUI_NO = #mouiNo# AND D2.INV_DEAL_DT <= #dvdYr#|| '0101') AND ( SELECT MAX(D3.INV_DEAL_DT)
FROM TBCSPNBK102L D3 WHERE D3.MOUI_NO = #mouiNo# AND D3.INV_DEAL_DT <= #dvdYr# || '1231') AND D1.MOUI_NO = #mouiNo# ) D4 WHERE ( D4.INV_DEAL_DT , D4.INV_DEAL_SLN ) IN ( SELECT D5.INV_DEAL_DT,
    MAX(D5.INV_DEAL_SLN)
FROM ( SELECT D1.MOUI_NO,
    D1.INV_DEAL_DT,
    D1.INV_DEAL_SLN
FROM TBCSPNBK102L D1 WHERE D1.CNL_YN = 'N' AND D1.INV_DEAL_DT BETWEEN ( SELECT NVL(MAX(D2.INV_DEAL_DT),#dvdYr# || '0101')
FROM TBCSPNBK102L D2 WHERE D2.MOUI_NO = #mouiNo# AND D2.INV_DEAL_DT <= #dvdYr# || '0101') AND ( SELECT MAX(D3.INV_DEAL_DT)
FROM TBCSPNBK102L D3 WHERE D3.MOUI_NO = #mouiNo# AND D3.INV_DEAL_DT <= #dvdYr# || '1231') AND D1.MOUI_NO = #mouiNo# ) D5 GROUP BY D5.INV_DEAL_DT ) ) D7 GROUP BY MOUI_NO