INSERT INTO /* CSPNBK511QDvdMsInsert */ TBCSPNBK401M ( DVD_YR , OPT_MOUI_NO , PET_DT , ELT_CRFW_PRF_M , THTM_UN_DSP_PRF_SP , THTM_PIA_DVD_M , THTM_DVD_TG_PRF_M , WTDW_ACM , WTDW_DVD_RTS , NWD_ACM , NWD_DVD_RTS , EX_ACM , EX_DVD_RTS , DVD_HNDL_STA_CD , DVD_RTS_CHG_YN , FRST_USER_ID , LAST_USER_ID , LAST_PRCS_DEPT_CD , LAST_MENU_ID , FRST_REG_DT , LAST_MDFCN_DT ) SELECT D4.DVD_YR,
    #optMouiNo# AS #OPTMOUINO#,
    SYSDATE AS PET_DT,
    D4.ELT_CRFW_PRF_M,
    D4.THTM_UN_DSP_PRF_SP,
    D4.THTM_PIA_DVD_M,
    D4.THTM_DVD_TG_PRF_M,
    D5.WTDW_ACM,
    FLOOR( D4.THTM_DVD_TG_PRF_M * 365 / D5.SUM_ACM * 100 * 10000 ) / 10000 AS FLOOR,
    D5.NWD_ACM,
    FLOOR( D4.THTM_DVD_TG_PRF_M * 365 / D5.SUM_ACM * 100 * 10000 ) / 10000 AS FLOOR,
    D5.EX_ACM,
    FLOOR( D4.THTM_DVD_TG_PRF_M * 365 / D5.SUM_ACM * 100 * 10000 ) / 10000 AS FLOOR,
    '0' AS DVD_HNDL_STA_CD,
    'N' AS DVD_RTS_CHG_YN,
    #usrId# AS FRST_USER_ID /* 최초사용자아이디 */,
    #usrId# AS LAST_USER_ID /* 최종사용자아이디 */,
    #dptCd# AS LAST_PRCS_DEPT_CD /* 최종처리부서코드 */,
    #mnuId# AS LAST_MENU_ID /* 최종메뉴아이디 */,
    SYSDATE AS FRST_REG_DT,
    SYSDATE AS LAST_MDFCN_DT
FROM ( SELECT #dvdYr# AS #DVDYR#,
    D3.ELT_CRFW_PRF_M /* 전기이월이익금 */,
    D3.THTM_UN_DSP_PRF_SP /* 당기미처분이익잉여금 */,
    D3.THTM_PIA_DVD_M /* 당기선급배당금 */,
    D3.THTM_UN_DSP_PRF_SP - D3.THTM_PIA_DVD_M + D3.ELT_CRFW_PRF_M AS THTM_UN_DSP_PRF_SP /* 당기배당대상이익금 = 당기미처분이익잉여금 - 당기선급배당금 + 전기이월이익금 */
FROM ( SELECT NVL(SUM(DECODE( SUBSTR(D1.MNST_CLU_CD,1,1), '4', D1.DSPS_RQT_AMT, 0 )),0) AS SUBSTR,
    NVL(SUM(DECODE( SUBSTR(D1.MNST_CLU_CD,1,1), '5', D1.DSPS_RQT_AMT, 0 )),0) AS SUBSTR,
    NVL(SUM(DECODE( SUBSTR(D1.MNST_CLU_CD,1,1), '4', D1.DSPS_RQT_AMT, 0 )),0) - NVL(SUM(DECODE( SUBSTR(D1.MNST_CLU_CD,1,1), '5', D1.DSPS_RQT_AMT, 0 )),0) AS SUBSTR /* 당기미처분이익잉여금 = 수익 (4XXXXXX) - 비용 ( 5XXXXXX ) */,
    NVL(SUM( ( CASE WHEN D1.MNST_CLU_CD = '351002' AND D1.TAXR_SITM_SECD = '0' THEN D1.DSPS_RQT_AMT ELSE 0 END ) ), 0) AS MNST_CLU_CD /* 전기이월이익금 */,
    NVL(SUM( ( CASE WHEN D1.MNST_CLU_CD = '115002' AND D1.TAXR_SITM_SECD = '0' THEN D1.DSPS_RQT_AMT ELSE 0 END ) ), 0) AS MNST_CLU_CD /* 당기선급배당금 */
FROM TBCSPNBK502M D1 WHERE D1.DEAL_DT = ( SELECT MAX(D2.DEAL_DT)
FROM TBCSPNBK502M D2 WHERE D2.DEAL_DT <= #dvdYr# || '1231' ) ) D3 ) D4 , ( SELECT D1.DVD_YR,
    SUM(D1.WTDW_ACM) AS WTDW_ACM,
    SUM(D1.NWD_ACM) AS NWD_ACM,
    SUM(D1.EX_ACM) AS EX_ACM,
    (SUM(D1.WTDW_ACM) + SUM(D1.NWD_ACM) + SUM(D1.EX_ACM)) AS WTDW_ACM
FROM TBCSPNBK402M D1 WHERE D1.DVD_YR = #dvdYr# GROUP BY DVD_YR ) D5 WHERE D4.DVD_YR = D5.DVD_YR