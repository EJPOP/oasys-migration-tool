UPDATE /*+ bypass_ujvc */ ( SELECT D7.EVL_YR,
    D7.HLYR_DVSN_CD,
    D7.DPT_TYP_DVSN_CD,
    D7.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    D7.DPT_NOP_CNT * ROUND(D7.PSO_PER_AV_ASC, 2) AS DPT_NOP_CNT /* 부서총점 */,
    ROUND(D7.PSO_PER_AV_ASC, 2) AS ROUND /* 인당평균평점 */,
    ROUND(D7.DPT_ASC, 2) AS ROUND /* 평점 */,
    D8.DPT_TSC,
    D8.PSO_PER_AV_ASC,
    D8.DPT_ASC,
    #FRT_USR_ID# AS #FRT_USR_ID#,
    #FNL_DEAL_DPT_CD# AS #FNL_DEAL_DPT_CD#,
    #FNL_MNU_ID# AS #FNL_MNU_ID#,
    SYSDATE,
    D8.LAST_USER_ID /* 최종사용자아이디 */,
    D8.LAST_PRCS_DEPT_CD /* 최종처리부서코드 */,
    D8.LAST_MENU_ID /* 최종메뉴아이디 */,
    D8.LAST_MDFCN_DT /* 최종수정일시 */
FROM ( SELECT D4.EVL_YR,
    D4.HLYR_DVSN_CD,
    D4.DPT_TYP_DVSN_CD,
    D4.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    D4.DPT_NOP_CNT /* 부서인원 */,
    NVL(D5.AVG_TSK_ASC, 0) AS AVG_TSK_ASC /* 평점 */,
    CASE WHEN D5.AVG_TSK_ASC IS NOT NULL THEN #AVG_VAL# + #STD_DEV_VAL# * ( ( D5.AVG_TSK_ASC - #AVG_SUPP#) / #STD_DEV_SUPP# ) ELSE 0 END AS AVG_TSK_ASC /* 인당평균평점 - 감사부서1인당평점평균 + 감사부서 1인당 평점 표준편차 * {(해당부서평점-지원부서평균)/지원부서표준편차} */
FROM TBCSPAOE034M D4 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    CASE WHEN CNT > 2 THEN ROUND((SUM_TSK_ASC - SUM_TSK_ASC_MIN - SUM_TSK_ASC_MAX) / (CNT-2), 2) ELSE NULL END AS CNT /* 평점 - 총점/ (평가인원-2) 두명의 점수를 제외하므로 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    MIN(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(SUM_TSK_ASC) AS SUM_TSK_ASC,
    SUM(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(CNT) AS CNT /* 평균을 구하기 위해서 총 평가자 수 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    EVL_CMTR_CNB /* 평가위원전산번호 */,
    SUM(TSK_ASC) AS TSK_ASC /* 업무평점 합 */,
    COUNT(*) OVER(PARTITION BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD) AS OVER
FROM TBCSPAOE031M D1 WHERE 1 = 1 AND EVL_STEP_CD = '500' /*위원평가*/ AND EVL_DTM_YN = 'Y' /*평가확정*/ AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD, EVL_CMTR_CNB ) D2 GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD ) D3 ) D5 WHERE D4.EVL_YR = D5.EVL_YR (+) AND D4.HLYR_DVSN_CD = D5.HLYR_DVSN_CD (+) AND D4.DPT_TYP_DVSN_CD = '20' AND D4.SRECS_DEPT_CD = D5.SRECS_DEPT_CD (+) ) D7 , TBCSPAOE034M D8 WHERE D7.EVL_YR = D8.EVL_YR AND D7.HLYR_DVSN_CD = D8.HLYR_DVSN_CD AND D7.DPT_TYP_DVSN_CD = D8.DPT_TYP_DVSN_CD AND D7.SRECS_DEPT_CD = D8.SRECS_DEPT_CD ) SET DPT_TSC = DPT_TSC_NEW ,  PSO_PER_AV_ASC = PSO_PER_AV_ASC_NEW ,  DPT_ASC = DPT_ASC_NEW ,  LAST_USER_ID = FNL_USR_ID_NEW /* 최종사용자아이디 */,  LAST_PRCS_DEPT_CD = FNL_DEAL_DPT_CD_NEW /* 최종처리부서코드 */,  LAST_MENU_ID = FNL_MNU_ID_NEW /* 최종메뉴아이디 */,  LAST_MDFCN_DT = FNL_MDF_DH_NEW /* 최종수정일시 */