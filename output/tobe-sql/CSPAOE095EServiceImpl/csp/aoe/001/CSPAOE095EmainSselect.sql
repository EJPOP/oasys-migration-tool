SELECT D4.EVL_YR,
    D4.HLYR_DVSN_CD,
    F_DPT_INFO(D4.SRECS_DEPT_CD, '1') AS CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    D4.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    NVL(D4.DPT_TSC, 0) AS DPT_TSC,
    NVL(D4.PSO_PER_AV_ASC, 0) AS PSO_PER_AV_ASC /* 인당평균평점 */,
    NVL(D4.DPT_NOP_CNT, 0) AS DPT_NOP_CNT /* 부서인원 */,
    NVL(D4.DPT_ASC, 0) AS DPT_ASC /* 평점 */,
    NVL(D5.AVG_TSK_ASC, 0) AS AVG_TSK_ASC /* 신평점 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    DPT_TSC,
    PSO_PER_AV_ASC,
    DPT_NOP_CNT,
    DPT_ASC
FROM TBCSPAOE034M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_TYP_DVSN_CD = '20' ) D4 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    CASE WHEN CNT > 2 THEN ROUND((SUM_TSK_ASC - SUM_TSK_ASC_MIN - SUM_TSK_ASC_MAX) / (CNT-2), 2) ELSE NULL END AS CNT /* 평점 - 총점/ (평가인원-2) 두명의 점수를 제외하므로 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    MIN(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(SUM_TSK_ASC) AS SUM_TSK_ASC,
    SUM(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(CNT) AS CNT /* 평균을 구하기 위해서 총 평가자 수 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    EVL_CMTR_CNB /* 평가위원전산번호 */,
    SUM(TSK_ASC) AS TSK_ASC /* 업무평점 합 */,
    COUNT(*) OVER(PARTITION BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD) AS OVER
FROM TBCSPAOE031M D1 WHERE 1 = 1 AND EVL_STEP_CD = '500' /*위원평가*/ AND EVL_DTM_YN = 'Y' /*평가확정*/ AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD, EVL_CMTR_CNB ) D2 GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD ) D3 ) D5 WHERE 1=1 AND D4.EVL_YR = D5.EVL_YR (+) AND D4.HLYR_DVSN_CD = D5.HLYR_DVSN_CD (+) AND D4.SRECS_DEPT_CD = D5.SRECS_DEPT_CD (+) ORDER BY D4.SRECS_DEPT_CD