SELECT '미납' AS SE_NM /* 구분명 */,
    A.GRNDS_EXMN_AEX_SQNO || ' ' || A.INFO_RLPR_NM AS INFO_RLPR_NM /* 정보관계자명 */,
    NVL( (SELECT (Z.EDU_EXS*F.EDU_DAY) + (Z.DMT_EXS* (DECODE(A.DMT_UE_YN, 'Y', F.EDU_DAY-1, 0) + DECODE(A.SNDY_LODG_YN, 'Y', 1, 0))) + DECODE(A.DMT_UE_YN, 'Y', Z.BRKF_FDEX*(F.EDU_DAY-1) + Z.LUNCH_FDEX*(F.EDU_DAY) +Z.DINR_FDEX*(F.EDU_DAY-1), Z.LUNCH_FDEX*(F.EDU_DAY)) /* 20250312 감사교육 금요일 점심식비 추가에 따른 수정_천은정감사관 */
FROM TBCSPSAE113B Z WHERE Z.CRS_CD = A.CRS_CD AND APC_DT = (SELECT MAX(APC_DT)
FROM TBCSPSAE113B X WHERE X.CRS_CD = Z.CRS_CD AND X.APC_DT < F.EDU_BGNG_YMD) ), (SELECT (Y.EDU_EXS*F.EDU_DAY) + (Y.DMT_EXS* (DECODE(A.DMT_UE_YN, 'Y', F.EDU_DAY-1, 0) + DECODE(A.SNDY_LODG_YN, 'Y', 1, 0))) + DECODE(A.DMT_UE_YN, 'Y', Y.BRKF_FDEX*(F.EDU_DAY-1) + Y.LUNCH_FDEX*(F.EDU_DAY) +Y.DINR_FDEX*(F.EDU_DAY-1), Y.LUNCH_FDEX*(F.EDU_DAY)) /* 20250312 감사교육 금요일 점심식비 추가에 따른 수정_천은정감사관 */
FROM TBCSPSAE113B Y WHERE Y.CRS_CD = '000' AND APC_DT = (SELECT MAX(APC_DT)
FROM TBCSPSAE113B X WHERE X.CRS_CD = '000' AND X.APC_DT < F.EDU_BGNG_YMD) ) ) AS TOT_AMT , NVL(A.PD_AMT, 0) AS PD_AMT , DECODE(NVL(A.UNPAID_AMT, 0), 0, (NVL(A.PD_AMT, 0) - NVL( (SELECT (Z.EDU_EXS*F.EDU_DAY) + (Z.DMT_EXS* (DECODE(A.DMT_UE_YN, 'Y', F.EDU_DAY-1, 0) + DECODE(A.SNDY_LODG_YN, 'Y', 1, 0))) + DECODE(A.DMT_UE_YN, 'Y', Z.BRKF_FDEX*(F.EDU_DAY-1) + Z.LUNCH_FDEX*(F.EDU_DAY) +Z.DINR_FDEX*(F.EDU_DAY-1), Z.LUNCH_FDEX*(F.EDU_DAY)) /* 20250312 감사교육 금요일 점심식비 추가에 따른 수정_천은정감사관 */
FROM TBCSPSAE113B Z WHERE Z.CRS_CD = A.CRS_CD AND APC_DT = (SELECT MAX(APC_DT)
FROM TBCSPSAE113B X WHERE X.CRS_CD = Z.CRS_CD AND X.APC_DT < F.EDU_BGNG_YMD) ), (SELECT (Y.EDU_EXS*F.EDU_DAY) + (Y.DMT_EXS* (DECODE(A.DMT_UE_YN, 'Y', F.EDU_DAY-1, 0) + DECODE(A.SNDY_LODG_YN, 'Y', 1, 0))) + DECODE(A.DMT_UE_YN, 'Y', Y.BRKF_FDEX*(F.EDU_DAY-1) + Y.LUNCH_FDEX*(F.EDU_DAY) +Y.DINR_FDEX*(F.EDU_DAY-1), Y.LUNCH_FDEX*(F.EDU_DAY)) /* 20250312 감사교육 금요일 점심식비 추가에 따른 수정_천은정감사관 */
FROM TBCSPSAE113B Y WHERE Y.CRS_CD = '000' AND APC_DT = (SELECT MAX(APC_DT)
FROM TBCSPSAE113B X WHERE X.CRS_CD = '000' AND X.APC_DT < F.EDU_BGNG_YMD) ) )), A.UNPAID_AMT) AS UNPAID_AMT , '' AS RMRK_CN FROM TBCSPSAE301D A , (SELECT TO_DATE(EDU_END_YMD, 'YYYYMMDD')+1 - TO_DATE(EDU_BGNG_YMD, 'YYYYMMDD') AS TO_DATE,
    CEIL((TO_DATE(EDU_END_YMD, 'YYYYMMDD') - NEXT_DAY(TO_DATE(EDU_BGNG_YMD, 'YYYYMMDD') -1, '6') +1)/7) AS CEIL /* 20240613 교육과정 점심식비에 금요일 미포함 계산식 조정으로 추가 */,
    LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    EDU_BGNG_YMD /* 교육시작일자 */,
    EDU_END_YMD /* 교육종료일자 */
FROM TBCSPSAE201D) F WHERE F.LINK_YR = A.LINK_YR AND F.CRS_CD = A.CRS_CD AND F.CRS_CDN = A.CRS_CDN AND A.LINK_YR = SUBSTR(#strFromYm#, 0, 4) AND A.CRS_CD = #strEDU_CRS_CD# AND A.CRS_CDN = #CRS_CDN# AND (A.PD_YN = 'N' OR A.UNPAID_AMT < 0) AND A.PD_MEAN_CD IS NOT NULL /* 취소자 구분 */ ORDER BY A.GRNDS_EXMN_AEX_SQNO