SELECT EVL_YR,
    EVL_DVSN_CD,
    SC_GRN_TG_CD,
    TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    COUNT(1) AS 1,
    ROUND(SUM(SC)) AS ROUND
FROM ( SELECT EVL_YR,
    EVL_DVSN_CD,
    SC_GRN_TG_CD,
    TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    (CASE WHEN KNB IS NOT NULL THEN MAX(BSC_SC) + AVG(EVL_SC + ADD_SC) ELSE MAX(BSC_SC) + MAX(EVL_SC) + MAX(ADD_SC) END) AS KNB
FROM (SELECT A.EVL_YR,
    A.EVL_DVSN_CD,
    A.SC_GRN_TG_CD,
    A.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    A.KNB,
    A.EVLT_CNB,
    A.BRD_NO,
    A.BRD_BKNO,
    A.CMNT_NO,
    SUM(CASE WHEN A.SC_CAT_CD = 1 THEN SC ELSE 0 END) AS SC_CAT_CD,
    SUM(CASE WHEN A.SC_CAT_CD = 2 THEN SC ELSE 0 END) AS SC_CAT_CD,
    SUM(CASE WHEN A.SC_CAT_CD = 3 THEN SC ELSE 0 END) AS SC_CAT_CD
FROM TBAEPGKM016L AS A, TBAEPGKM012L AS B WHERE 1=1 AND A.EVL_YR = B.EVL_YR AND A.EVL_DVSN_CD = B.EVL_DVSN_CD AND A.SC_GRN_TG_CD = B.SC_GRN_TG_CD AND A.TRGT_NOP_ENO = #TRGT_NOP_ENO# AND A.EVL_YR = #EVL_YR# AND A.EVL_DVSN_CD = #EVL_DVSN_CD# GROUP BY A.EVL_YR ,A.EVL_DVSN_CD ,A.SC_GRN_TG_CD ,A.TRGT_NOP_ENO ,A.KNB ,A.EVLT_CNB ,A.BRD_NO ,A.BRD_BKNO ,A.CMNT_NO ) WHERE 1=1 GROUP BY EVL_YR ,EVL_DVSN_CD ,SC_GRN_TG_CD ,TRGT_NOP_ENO ,KNB ) WHERE 1=1 GROUP BY EVL_YR ,EVL_DVSN_CD ,SC_GRN_TG_CD ,TRGT_NOP_ENO ORDER BY SC_GRN_TG_CD