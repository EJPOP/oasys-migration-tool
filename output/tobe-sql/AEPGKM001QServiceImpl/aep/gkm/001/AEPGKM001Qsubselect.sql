SELECT EVL_YR,
    EVL_DVSN_CD,
    SC_GRN_TG_CD,
    TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    KNB,
    KLD_NM,
    TG_CAT_NM,
    APRV_YN /* 승인여부 */,
    ROUND(CASE WHEN KNB IS NOT NULL THEN MAX(BSC_SC) + AVG(EVL_SC + ADD_SC) ELSE MAX(BSC_SC) + MAX(EVL_SC) + MAX(ADD_SC) END) AS ROUND
FROM (SELECT A.EVL_YR,
    A.EVL_DVSN_CD,
    A.SC_GRN_TG_CD,
    A.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    A.KNB,
    A.EVLT_CNB,
    A.BRD_NO,
    A.BRD_BKNO,
    A.CMNT_NO,
    A.APRV_YN /* 승인여부 */,
    SUM(CASE WHEN A.SC_CAT_CD = 1 THEN SC ELSE 0 END) AS SC_CAT_CD,
    SUM(CASE WHEN A.SC_CAT_CD = 2 THEN SC ELSE 0 END) AS SC_CAT_CD,
    SUM(CASE WHEN A.SC_CAT_CD = 3 THEN SC ELSE 0 END) AS SC_CAT_CD,
    C.KLD_NM,
    D.TG_CAT_NM
FROM TBAEPGKM016L AS A ,TBAEPGKM012L AS B ,TBAEPGKM001M AS C ,TBAEPGKM017M AS D WHERE 1=1 AND A.EVL_YR = B.EVL_YR AND A.EVL_DVSN_CD = B.EVL_DVSN_CD AND A.SC_GRN_TG_CD = B.SC_GRN_TG_CD AND A.KNB = C.KNB AND A.TRGT_NOP_ENO = C.OTSD_EXPRT_RGTR_ENO AND C.KLD_CAT_CD = D.TG_CAT_ID AND A.TRGT_NOP_ENO = #TRGT_NOP_ENO# AND A.EVL_YR = #EVL_YR# AND A.EVL_DVSN_CD = #EVL_DVSN_CD# GROUP BY A.EVL_YR ,A.EVL_DVSN_CD ,A.SC_GRN_TG_CD ,A.TRGT_NOP_ENO ,A.KNB ,A.EVLT_CNB ,A.BRD_NO ,A.BRD_BKNO ,A.CMNT_NO ,A.APRV_YN ,C.KLD_NM ,D.TG_CAT_NM ) WHERE 1=1 GROUP BY EVL_YR ,EVL_DVSN_CD ,SC_GRN_TG_CD ,TRGT_NOP_ENO ,KNB ,KLD_NM ,TG_CAT_NM ,APRV_YN