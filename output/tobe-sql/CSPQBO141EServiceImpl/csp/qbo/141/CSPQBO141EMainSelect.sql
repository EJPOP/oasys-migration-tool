SELECT A.BOO_DVSN,
    A.BOO_KND_CD,
    A.BOO_NO,
    A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NO,
    A.BOO_VLE_NO,
    A.CAT_SYM_NM,
    A.BOO_TIT_NM,
    A.PBC_PLAC_NM,
    A.RSCH_RPTP_AUT_NM /* 연구보고서저자명 */,
    A.BOO_LEND_DT,
    A.COPT_CAT_CD,
    A.BOO_LEND_POSS_YN,
    A.LAG_INV_CNB,
    A.BOO_DVSN_CD,
    A.BOO_BOKG_SLN,
    A.BAR_CD
FROM ( SELECT F_CODE_NM('1000325',B.BOO_REN_YN_CD) AS F_CODE_NM /* 도서종류코드 */,
    A.BOO_KND_CD,
    A.BOO_NO,
    A.BOO_VLE_NO,
    A.CAT_SYM_NM,
    A.BOO_TIT_NM,
    A.PBC_PLAC_NM,
    A.RSCH_RPTP_AUT_NM /* 연구보고서저자명 */,
    B.BOO_LEND_DT,
    A.COPT_CAT_CD,
    '0' AS BOO_LEND_POSS_YN,
    B.LAG_INV_CNB,
    B.BOO_REN_YN_CD,
    '' AS BOO_BOKG_SLN,
    A.BAR_CD
FROM TBCSPQBO001M A, TBCSPQBO002H B WHERE 1=1 AND A.COPT_CAT_CD = B.COPT_CAT_CD AND A.BOO_KND_CD = B.BOO_KND_CD AND A.BOO_NO = B.BOO_NO AND A.CAT_SYM_NM = B.CAT_SYM_NM AND A.BOO_VLE_NO = B.BOO_VLE_NO AND A.COPT_CAT_CD = #strCOPT_CAT_CD# AND B.BOO_REN_YN_CD = '0' AND B.LAG_INV_CNB = #strLAG_INV_CNB# UNION ALL SELECT F_CODE_NM('1000326',B.LEND_BOKG_STA_CD) AS F_CODE_NM /* 도서종류코드 */,
    A.BOO_KND_CD,
    A.BOO_NO,
    A.BOO_VLE_NO,
    A.CAT_SYM_NM,
    A.BOO_TIT_NM,
    A.PBC_PLAC_NM,
    A.RSCH_RPTP_AUT_NM /* 연구보고서저자명 */,
    '' AS BOO_LEND_DT,
    A.COPT_CAT_CD,
    CASE WHEN ( A.BOO_LEND_DVSN_CD = '1' OR A.BOO_LEND_DVSN_CD IS NULL ) AND B.BOO_BOKG_NO = '1' THEN '1' ELSE '0' END AS BOO_LEND_DVSN_CD,
    B.LEND_BOKG_PEN_CNB,
    B.LEND_BOKG_STA_CD,
    B.BOO_BOKG_SLN,
    A.BAR_CD
FROM TBCSPQBO001M A, (SELECT A.COPT_CAT_CD,
    A.BOO_KND_CD,
    A.BOO_NO,
    A.CAT_SYM_NM,
    A.BOO_VLE_NO,
    A.LEND_BOKG_PEN_CNB,
    A.LEND_BOKG_STA_CD,
    A.BOO_BOKG_SLN,
    RANK() OVER (PARTITION BY A.COPT_CAT_CD, A.BOO_KND_CD, A.BOO_NO, A.CAT_SYM_NM, A.BOO_VLE_NO ORDER BY A.BOO_BOKG_SLN ASC) AS RANK
FROM TBCSPQBO003H A WHERE A.LEND_BOKG_STA_CD = 'Y' ) B WHERE 1=1 AND A.COPT_CAT_CD = B.COPT_CAT_CD AND A.BOO_KND_CD = B.BOO_KND_CD AND A.BOO_NO = B.BOO_NO AND A.CAT_SYM_NM = B.CAT_SYM_NM AND A.BOO_VLE_NO = B.BOO_VLE_NO AND A.COPT_CAT_CD = #strCOPT_CAT_CD# AND B.LEND_BOKG_STA_CD = 'Y' AND B.LEND_BOKG_PEN_CNB = #strLAG_INV_CNB# ) A ORDER BY A.BOO_LEND_DT DESC