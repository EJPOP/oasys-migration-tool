SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.EVL_RQS_YN /* 평가요청여부 */,
    CASE WHEN D1.EVL_RQS_YN IS NULL THEN '10' WHEN D1.EVL_RQS_YN = 'N' THEN '10' ELSE '20' END AS EVL_RQS_YN /* 요청상태코드 */,
    NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D5.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR||'-'||D1.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D1.TSK_NO /* 업무번호 */,
    D3.ADT_STP_SECD /* 감사단계구분코드 */,
    CASE WHEN D4.AUD_END_YN IS NULL THEN '' ELSE '종료' END AS AUD_END_YN /* 감사종료여부 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    F_DPT_INFO(D1.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 2014.02.04 최원형 감사관 요청 */
FROM TBCSPAOE021M D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND CMPTN_YMD IS NOT NULL GROUP BY CVLCPT_ADT_YR, TSK_NO ) D3 , TBCSPAOE022M D4 ,TB_BADDED001M D5 WHERE 1=1 AND D1.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND D1.TSK_NO = D3.TSK_NO AND D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO AND D1.CVLCPT_ADT_YR = D5.ADT_YR (+) AND D1.TSK_NO = D5.ADT_NO (+) AND D3.ADT_STP_SECD = D4.ADT_STP_SECD AND D3.ADT_STP_SECD NOT IN ('10000','10001','10002','10003','10010') AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D5.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D1.TSK_NO = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D1.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' SUBSTR(D5.ADT_KDCD,3,1) = #strAudYrNoKndCd# ORDER BY D1.HNDL_DIV_DPT_CD, D1.CVLCPT_ADT_YR, D1.TSK_NO