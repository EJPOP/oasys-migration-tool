SELECT NVL(F_MNG_KND_AUDYRNO(D3.CVLCPT_ADT_YR, D3.TSK_NO, D5.ADT_KDCD, '-'),D3.CVLCPT_ADT_YR || '-' || D3.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D3.MNDY_CNT /* 연인원 */,
    NVL(D4.PTCPT_CNB_CNT, 0) AS PTCPT_CNB_CNT /* 참여인원 */,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과 */,
    F_CODE_NM('1000270', D3.ADT_KDCD) AS ADT_KDCD /* 감사종류코드 */,
    F_CODE_NM('1000273',D3.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    '' AS EVLT_ASG_YN /* 평가자 지정여부 */,
    D3.LUNH_DT /* 착수일 */,
    D3.CMPTN_YMD /* 완료일자 */,
    F_USR_INFO(D3.CTB_RTE_CFM_BRUCHF_CNB, '2') AS F_USR_INFO /* 기여율확인국장전산번호 */,
    D3.CTB_RTE_CFM_YN /* 기여도확인여부 */,
    D3.AUD_END_YN AS AUD_END_YN /* 종료여부 */,
    D3.DLAY_DT_NM /* 지연일 */,
    D3.EXET_DCN /* 면책일 */,
    D3.EXET_RQS_DCN /* 면책요청일 */,
    D3.DLY_RSN_CN /* 지연사유내용 */,
    D3.DLAY_RPT_TXT /* 지연보고 */
FROM ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO /* 감사연번호 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    D1.MNDY_CNT /* 연인원 */,
    D1.HNDL_DIV_DPT_CD /* 처리과 */,
    D1.ADT_KDCD /* 감사종류코드 */,
    D2.ADT_STP_SECD /* 감사단계구분코드 */,
    D2.LUNH_DT /* 착수일 */,
    D2.CMPTN_YMD /* 완료일자 */,
    D2.CTB_RTE_CFM_BRUCHF_CNB /* 기여율확인국장전산번호 */,
    DECODE((SELECT AS CTB_RTE_CFM_BRUCHF_CNB
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND TSK_NO = D1.TSK_NO AND ADT_STP_SECD = D2.AUD_STEP_CD_MAX) , '', '', 'Y') AS CTB_RTE_CFM_YN /*기여도확인여부*/ , (SELECT AUD_END_YN
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND TSK_NO = D1.TSK_NO AND ADT_STP_SECD = D2.AUD_STEP_CD_MAX) AS AUD_END_YN /*종료여부*/ , D2.DLAY_DT_NM /*지연일*/ , D2.EXET_DCN /*면책일*/ , D2.EXET_RQS_DCN /*면책요청일*/ , D2.DLY_RSN_CN /*지연사유*/ , D2.DLAY_RPT_TXT /*지연보고*/ FROM TBCSPAOE021M D1 , ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_STP_SECD /* 감사단계구분코드 */,
    D1.LUNH_DT,
    D1.CMPTN_YMD /* 완료일자 */,
    D1.DLAY_DT_NM,
    D1.EXET_DCN,
    D1.EXET_RQS_DCN,
    D1.DLY_RSN_CN /* 지연사유내용 */,
    D1.DLAY_RPT_TXT,
    D1.CTB_RTE_CFM_BRUCHF_CNB,
    D2.AUD_STEP_CD_MAX
FROM TBCSPAOE022M D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_STP_SECD /* 감사단계구분코드 */,
    ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE 1 = 1 AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# ) D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_CD_MIN AND D2.AUD_STEP_CD_MAX ) D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO ) D3 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_STP_SECD /* 감사단계구분코드 */,
    COUNT(PTCPT_CNB) AS PTCPT_CNB
FROM TBCSPAOE023M WHERE 1=1 AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# GROUP BY CVLCPT_ADT_YR, TSK_NO, ADT_STP_SECD ) D4 ,TB_BADDED001M D5 WHERE D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR (+) AND D3.TSK_NO = D4.TSK_NO (+) AND D3.ADT_STP_SECD = D4.ADT_STP_SECD (+) AND D3.CVLCPT_ADT_YR = D5.ADT_YR (+) AND D3.TSK_NO = D5.ADT_NO (+) CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D5.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D3.tsk_no = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D3.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' D5.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) ORDER BY D3.HNDL_DIV_DPT_CD, D3.TSK_NO, D3.ADT_STP_SECD