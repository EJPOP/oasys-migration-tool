SELECT D5.EVL_YR AS EVL_YR /* 평가년도 */,
    D5.HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분코드 */,
    D5.CVLCPT_TASK_SECD AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D5.TASK_KDCD /* 업무종류코드 */,
    F_CODE_NM ('1000272', D5.TASK_KDCD) AS F_CODE_NM,
    D5.EVL_STEP_CD AS EVL_STEP_CD /* 평가단계코드 */,
    D5.CHGR_DVSN_CD /* 평가위원 구분코드 */,
    D5.PIC_ENO /* 담당자직원전산번호 */,
    D5.TSK_NO AS TSK_NO /* 업무번호 */,
    F_DPT_INFO(D5.CHR_DPT_CD, '1') AS TKCG_DEPT_NM /* 담당부서명 */,
    D5.TSK_NM AS TSK_NM /* 업무명 */,
    D5.TSK_TXT AS TSK_TXT /* 업무내용 */,
    NVL(D6.EVL_STA_CD, '100') AS EVL_STA_CD /* 평가상태 */,
    D6.NAUD_TSK_EVL_SC AS NAUD_TSK_EVL_SC /* 업무평점 */,
    D6.EVL_RK_CD AS EVL_RK_CD /* 평가등급 */,
    D6.EVL_OPIN AS EVL_OPIN /* 평가의견 */,
    D5.CHR_DPT_CD,
    D13.OTPT_SEQ,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_100 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_100 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_100, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_200 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_200 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_200, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_300 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_300 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_300, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_800 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_800 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_800, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_400 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_400 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_400, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_500 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_500 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_500, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_600 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_600 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_600, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    CASE WHEN D5.TASK_KDCD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_700 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_700 END) ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_700, NULL , NULL, NULL, NULL), 2) END AS TASK_KDCD /* 업무종류코드 */,
    D10.EVL_RK_CD_600 AS EVL_RK_CD_600,
    NVL(D10.CONF_YN, 'N') AS CONF_YN /* Y인 것만 확인자가 확정할수 있다. */,
    NVL(D11.NO_CONF_YN, 'N') AS NO_CONF_YN /* N인 것만 확정취소 할 수 있다. */
FROM ( SELECT D4.EVL_YR /* 평가년도 */,
    D4.HLYR_DVSN_CD /* 반기구분코드 */,
    MAN.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D4.TASK_KDCD /* 업무종류코드 */,
    DECODE(MOD(SUBSTR(MAN.CHGR_DVSN_CD, 4), 2), 1, '600', '700') AS MOD /* 단계코트 홀수면 평가자, 짝수면 확인자(구분코드가 하드코딩이므로) */,
    MAN.CHGR_DVSN_CD /* 평가위원 구분코드 */,
    MAN.PIC_ENO /* 담당자직원전산번호 */,
    D4.TSK_NO /* 업무번호 */,
    D4.CHR_DPT_CD /* 담당부서코드 */,
    D4.TSK_NM /* 업무명 */,
    D4.TSK_TXT /* 업무내용 */,
    CASE WHEN D4.TASK_KDCD = '10006' THEN ((NVL(D4.JUD_PNSH_CRCT_NOC, 0) * MAN.STND_ASC_1) + (NVL(D4.IMP_RDA_NTF_NOC, 0) * MAN.STND_ASC_2) + (NVL(D4.SPCN_MNG_NOC, 0) * MAN.STND_ASC_3)) ELSE MAN.STND_ASC END AS TASK_KDCD /* 업무종류코드 */,
    NVL(D4.JUD_PNSH_CRCT_NOC, 0) AS JUD_PNSH_CRCT_NOC /* 판정징계시정건수 */,
    MAN.STND_ASC_1 /* 표준평점1 */,
    NVL(D4.IMP_RDA_NTF_NOC, 0) AS IMP_RDA_NTF_NOC /* 개선권고통보건수 */,
    MAN.STND_ASC_2 /* 표준평점2 */,
    NVL(D4.SPCN_MNG_NOC, 0) AS SPCN_MNG_NOC /* 특수관리건수 */,
    MAN.STND_ASC_3 /* 표준평점3 */
FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D1.AUD_TSK_KND_CD,
    D1.CHGR_DVSN_CD,
    D2.PIC_ENO /* 담당자직원전산번호 */,
    F_USR_INFO(D2.PIC_ENO, '2') AS INFO_RLPR_NM /* 정보관계자명 */,
    D7.STND_ASC,
    D7.STND_ASC_1 /* 표준평점1 */,
    D7.STND_ASC_2 /* 표준평점2 */,
    D7.STND_ASC_3 /* 표준평점3 */
FROM TBCSPAOE016M D1 , TBCSPAOE017D D2 , TBCSPAOE006M D7 /*업무종류별 표준평점을 알기위해*/ WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D2.CVLCPT_TASK_SECD AND D1.AUD_TSK_KND_CD = D2.AUD_TSK_KND_CD AND D1.CHGR_DVSN_CD = D2.CHGR_DVSN_CD AND D1.EVL_YR = D7.EVL_YR AND D1.HLYR_DVSN_CD = D7.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D7.CVLCPT_TASK_SECD AND D1.AUD_TSK_KND_CD = D7.TASK_KDCD AND D1.CVLCPT_TASK_SECD = '10001' /*감사외업무*/ AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.CHGR_DVSN_CD NOT IN ('CD33', 'CD34') /*감사업무쪽 코드임*/ AND D1.AUD_TSK_KND_CD = #strAudTskKndCd# AND D2.PIC_ENO = #PIC_ENO# ) MAN , TBCSPAOE024M D4 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    TASK_KDCD /* 업무종류코드 */,
    TSK_NO
FROM TBCSPAOE025M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY EVL_YR, HLYR_DVSN_CD, TASK_KDCD, TSK_NO ) D5 /*감사외 업무 팜여인원이 등록되지 않음 보여질 필요가 없다.*/ WHERE MAN.EVL_YR = D4.EVL_YR AND MAN.HLYR_DVSN_CD = D4.HLYR_DVSN_CD AND MAN.AUD_TSK_KND_CD = D4.TASK_KDCD AND D4.EVL_YR = D5.EVL_YR AND D4.HLYR_DVSN_CD = D5.HLYR_DVSN_CD AND D4.TASK_KDCD = D5.TASK_KDCD AND D4.TSK_NO = D5.TSK_NO AND D4.TSK_NM LIKE '%' || #strTskNm# || '%' ORDER BY D4.TASK_KDCD, D4.TSK_NO ) D5 /*감사외 업무의 평가자, 확인자 리스트를 뽑아 평가위원에 해당하는 업무를 뽑아냄.*/ , TBCSPAOE029M D6 , ( SELECT SUM(DECODE(RK_CD, '100', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '200', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '300', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '800', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '400', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '500', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '600', IDVT_INDEX_VAL, 0)) AS RK_CD,
    SUM(DECODE(RK_CD, '700', IDVT_INDEX_VAL, 0)) AS RK_CD,
    EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    AUD_TSK_KND_CD
FROM TBCSPAOE010D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10001' /*감사외업무*/ AND IDCT_YN = 'Y' GROUP BY EVL_YR, HLYR_DVSN_CD, CVLCPT_TASK_SECD, AUD_TSK_KND_CD ) D8 /*평가등급별 성과가중치 개별지표값을 알기위해서*/ , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    AUD_TSK_KND_CD,
    EVL_STEP_CD,
    '700' AS STEP_CD,
    EVL_CMTR_DVSN_CD,
    CASE WHEN LENGTH(EVL_CMTR_DVSN_CD) = '4' AND TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) != 99 THEN 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 2, 0) ELSE 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 3) END AS USER_HSTRY_SECD /* 사용자이력구분코드 */,
    EVL_CMTR_CNB,
    TSK_NO,
    NVL(EVL_DTM_YN, 'N') AS EVL_DTM_YN /* 평가확정여부 */,
    EVL_RK_CD /* 평가자가 평가한 평가등급-평가확정된게 아니여도 평가등급이 있으면 세팅해주기로 함. */
FROM TBCSPAOE029M WHERE EVL_STEP_CD = '600' /*평가자*/ AND NAUD_TSK_EVL_SC IS NOT NULL ) D10 /*이 쿼리에 정보가 있다는것은 평가자가 평가확정 했다는 것*/ ,( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    AUD_TSK_KND_CD,
    EVL_STEP_CD,
    '600' AS STEP_CD,
    EVL_CMTR_DVSN_CD,
    CASE WHEN LENGTH(EVL_CMTR_DVSN_CD) = '4' AND TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) != 99 THEN 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 2, 0) ELSE 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 3) END AS USER_HSTRY_SECD /* 사용자이력구분코드 */,
    EVL_CMTR_CNB,
    TSK_NO,
    EVL_DTM_YN /* 평가확정여부 - 확정했으면 확인취소 못한다. */
FROM TBCSPAOE029M WHERE EVL_STEP_CD = '700' /*확인자*/ AND NAUD_TSK_EVL_SC IS NOT NULL AND EVL_DTM_YN = 'Y' ) D11 /*이 쿼리에 정보가 있다는것은 확인자가 평가확정 했다는 것*/ , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    FML_TXT /* 계산식 */
FROM TBCSPAOE013M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10001' ) D12 , ( SELECT CD,
    ROWNUM
FROM ( SELECT CD,
    CD_NM
FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000272' AND NVL(USE_YN, 'N') = 'Y' AND CD != '10000' /*공통업무 제외*/ AND CD != '000000000' ORDER BY SUBSTR(CD_NM, 0, 4), OTPT_SEQ, CD ) ) D13 WHERE D5.EVL_YR = D6.EVL_YR(+) AND D5.HLYR_DVSN_CD = D6.HLYR_DVSN_CD(+) AND D5.CVLCPT_TASK_SECD = D6.CVLCPT_TASK_SECD (+) AND D5.TASK_KDCD = D6.AUD_TSK_KND_CD (+) AND D5.EVL_STEP_CD = D6.EVL_STEP_CD (+) AND D5.CHGR_DVSN_CD = D6.EVL_CMTR_DVSN_CD (+) AND D5.PIC_ENO = D6.EVL_CMTR_CNB (+) AND D5.TSK_NO = D6.TSK_NO (+) AND D5.EVL_YR = D8.EVL_YR /* 개별지표값이 없으면 계산이 안되니깐 아웃터 할 필요 없음. 없음 안되!*/ AND D5.HLYR_DVSN_CD = D8.HLYR_DVSN_CD AND D5.CVLCPT_TASK_SECD = D8.CVLCPT_TASK_SECD AND D5.TASK_KDCD = D8.AUD_TSK_KND_CD AND D5.EVL_YR = D10.EVL_YR(+) AND D5.HLYR_DVSN_CD = D10.HLYR_DVSN_CD(+) AND D5.CVLCPT_TASK_SECD = D10.CVLCPT_TASK_SECD (+) AND D5.TASK_KDCD = D10.AUD_TSK_KND_CD (+) AND D5.EVL_STEP_CD = D10.STEP_CD (+) AND D5.CHGR_DVSN_CD = D10.USER_HSTRY_SECD (+) AND D5.TSK_NO = D10.TSK_NO (+) AND D5.EVL_YR = D11.EVL_YR(+) AND D5.HLYR_DVSN_CD = D11.HLYR_DVSN_CD(+) AND D5.CVLCPT_TASK_SECD = D11.CVLCPT_TASK_SECD (+) AND D5.TASK_KDCD = D11.AUD_TSK_KND_CD (+) AND D5.EVL_STEP_CD = D11.STEP_CD (+) AND D5.CHGR_DVSN_CD = D11.USER_HSTRY_SECD (+) AND D5.TSK_NO = D11.TSK_NO (+) AND D5.EVL_YR = D12.EVL_YR AND D5.HLYR_DVSN_CD = D12.HLYR_DVSN_CD AND D5.TASK_KDCD = D13.CD AND NVL(D6.EVL_STA_CD, '100') = #strEvlStaCd# AND D5.EVL_STEP_CD = #strEvlStepCd#