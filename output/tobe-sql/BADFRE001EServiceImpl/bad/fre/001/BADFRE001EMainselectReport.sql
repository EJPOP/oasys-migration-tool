SELECT TT.*,
    (SELECT AS PROF_RBPRSN_INST_NM /* 증명책임자기관명 */
FROM TBDCMACM015M WHERE INST_CD = TT.CMO_INST_CD AND ROWNUM = 1) AS COPT_OFI_NM, (SELECT ABR_DPT_NM_1
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = TT.IMPL_MNG_JRSD_DEPT_CD AND ROWNUM = 1) AS ENFM_MNG_BRDV_NM, (SELECT ABR_DPT_NM_1
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = TT.BFR_IMPL_MNG_DEPT_CD AND ROWNUM = 1) AS OD_ENFM_MNG_BRDV_NM, /* 구이행관리국과코드 - 2017.02.01 yyh */ (SELECT ABR_DPT_NM_1
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = TT.ENFC_DEPT_CD AND ROWNUM = 1) AS ENF_BRDV_NM, /* 시행국과 - 2017.02.03 yyh */ F_CODE_NM('1000002', TT.DSPS_RQT_KDCD) AS DSPS_RQT_KND_CVN, F_CODE_NM('1000333', TT.DSPS_RQT_ATRZ_STTS_SECD) AS DSP_RQ_APV_STA_NM, ( SELECT ST1.ENFM_WHLS_CHGR_CNB
FROM TBDCMACM002M ST1 WHERE ST1.SRECS_DEPT_CD LIKE '0%' AND ST1.USE_YN = 'Y' AND ST1.ORZT_DVSN_CD = '30' AND ST1.SRECS_DEPT_CD = TT.IMPL_MNG_JRSD_DEPT_CD AND ROWNUM = 1 ) AS ENFM_WHLS_CHGR_CNB, (SELECT MIN(ST2.PROF_RBPRSN_INST_NM) || DECODE((COUNT(DISTINCT ST1.REL_INST_CD) - 1),0,'',' 외 ' || (COUNT(DISTINCT ST1.REL_INST_CD) - 1)) AS PROF_RBPRSN_INST_NM /* 증명책임자기관명 */
FROM TB_BADEAR006M ST1, TBDCMACM015M ST2 WHERE ST1.SRECS_REL_INST_CD = ST2.INST_CD AND ST1.CVLCPT_ADT_YR = TT.CVLCPT_ADT_YR AND ST1.ADT_NO = TT.ADT_NO AND ST1.DSPS_RQT_SQNO = TT.DSPS_RQT_SQNO GROUP BY ST1.CVLCPT_ADT_YR, ST1.ADT_NO, ST1.DSPS_RQT_SQNO ) AS REL_INST_NM FROM (SELECT T.*,
    ROW_NUMBER() OVER( ORDER BY CVLCPT_ADT_YR DESC, ADT_NO DESC, DSPS_RQT_SQNO DESC ) AS ROW_NUMBER
FROM (SELECT DT.*,
    COUNT(1) OVER() AS 1
FROM ( SELECT T1.ADT_YR /* 감사년도 */,
    T1.ADT_NO /* 감사번호 */,
    T2.DSPS_RQT_SQNO /* 처분요구순번 */,
    F_MNG_KND_AUDYRNO(T1.ADT_YR, T1.ADT_NO, T1.ADT_KDCD, '-') ||'-'||T2.DSPS_RQT_SQNO AS F_MNG_KND_AUDYRNO,
    T1.ADT_MTTR_NM /* 감사사항명 */,
    T2.DSPS_RQT_NM /* 처분요구명 */,
    T3.PRCS_TERM_YMD /* 처리기한일자 */,
    T3.CMO_INST_CD /* 소관청기관코드 */,
    T3.IMPL_MNG_JRSD_DEPT_CD /* 집행관리소관부서코드 */,
    T3.DSPS_RQT_ATRZ_STTS_SECD /* 처분요구결재상태구분코드 */,
    T3.CFMTN_YN /* 확정여부 */,
    /* DECODE(T3.DTM_STA_CD, '2', '확정', '1', DECODE(T3.DSP_RQ_APV_STA_CD, '3', '완결', '미결') , '') AS DTM_YN_NM, */ CASE WHEN T3.CFMTN_STTS_SECD = '2' THEN '확정' WHEN T3.CFMTN_STTS_SECD = '1' AND T3.DSPS_RQT_ATRZ_STTS_SECD = '3' THEN '완결' || CASE WHEN T3.CPLT_STTS_SECD IS NOT NULL THEN '(' || DECODE(T3.CPLT_STTS_SECD,'1','완결','종결') || ')' ELSE '' END WHEN T3.CFMTN_STTS_SECD = '1' AND (T3.DSPS_RQT_ATRZ_STTS_SECD IS NULL OR T3.DSPS_RQT_ATRZ_STTS_SECD != '3') THEN '미결' || CASE WHEN T3.PND_CPLT_STTS_SECD IS NOT NULL THEN '(' || DECODE(T3.PND_CPLT_STTS_SECD,'1','정상','집중') || ')' ELSE '' END ELSE '' END AS CFMTN_STTS_SECD /* 확정상태구분코드 */,
    T1.ADT_KDCD /* 감사종류코드 */,
    T3.ENFC_YMD /* 시행일자 */,
    T3.IMPL_WHLS_CFMTN_YMD /* 집행전말확정일자 */,
    T2.DSPS_RQT_KDCD /* 처분요구종류코드 */,
    T3.RVW_RPTP_DSPS_RQT_CN /* 검토보고서처분요구내용 */,
    T3.RVW_RPTP_UNEX_RTWR_CN /* 검토보고서미집행경위내용 */,
    T3.RVW_RPTP_UNEX_RSN_RVW_CN /* 검토보고서미집행사유검토내용 */,
    T3.ATRZ_DOC_NO /* 결재문서번호 */,
    T3.BFR_IMPL_MNG_DEPT_CD /* 이전집행관리부서코드 */,
    T3.ENFC_DEPT_CD /* 시행부서코드 */
FROM TBBADDED001M T1, TBBADEAR001M T2, TBBADEAR002D T3 WHERE 1 = 1 AND T1.CVLCPT_ADT_YR = T2.CVLCPT_ADT_YR AND T1.ADT_NO = T2.ADT_NO AND T2.CVLCPT_ADT_YR = T3.CVLCPT_ADT_YR AND T2.ADT_NO = T3.ADT_NO AND T2.DSPS_RQT_SQNO = T3.DSPS_RQT_SQNO /* % 아래 6개는 감사결과 처분요구 입력시 바로 집행확정 처리함 1000002 390 현지시정 1000002 410 주의 1000002 490 현지주의 1000002 710 직접고발 1000002 720 자체고발 1000002 730 수사요청 % 아래 18개가 집행전말 처리 대상 종류 1000002 110 변상판정 1000002 210 징계문책 1000002 310 시정(금액) 1000002 320 시정(기타) 1000002 391 현지시정회 1000002 510 법령상개선 1000002 520 제도상개선 1000002 530 행정상개선 1000002 610 통보 1000002 611 권고 1000002 620 통보(인사) 1000002 621 통보(징계) 1000002 623 통보(비위) 1000002 630 통보개선 1000002 810 모범(예산절감) 1000002 820 모범(업무개선) 1000002 830 모범(성실근무) 1000002 840 모범(민원해소) 1000002 850 모범(기타) */ AND T2.DSPS_RQT_KDCD IN ('110','210','310','320','391','620','621','623','630','510','520','530','610','611','810','820','830','840','850') /* 집행전말 대상은 처분요구확정 이후 상태 건 들임. */ AND T3.CFMTN_STTS_SECD IN ('1','2') AND T1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND T1.ADT_GRNT_NO = #ADT_GRNT_NO# AND T2.DSPS_RQT_SQNO = #DSPS_RQT_SQNO# AND T2.DSPS_RQT_NM LIKE '%'||#strTitTxt#||'%' AND T3.CMO_INST_CD = #CMO_INST_CD# AND T3.SRECS_REL_INST_CD = #SRECS_REL_INST_CD# AND EXISTS ( SELECT ST1.REL_INST_CD /* 관계기관코드 */
FROM TBBADEAR006M ST1 WHERE 1 = 1 AND ST1.CVLCPT_ADT_YR = T1.CVLCPT_ADT_YR AND ST1.ADT_NO = T1.ADT_NO AND ST1.DSPS_RQT_SQNO = T2.DSPS_RQT_SQNO AND ST1.SRECS_REL_INST_CD = #SRECS_REL_INST_CD# ) /* 권한이 없는 일선 과 */ AND T3.BFR_IMPL_MNG_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strOdUpSpvBrdvCd#))) AND T3.BFR_IMPL_MNG_DEPT_CD = #BFR_IMPL_MNG_DEPT_CD# AND T3.IMPL_MNG_JRSD_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strUpSpvBrdvCd#))) AND T3.IMPL_MNG_JRSD_DEPT_CD = #IMPL_MNG_JRSD_DEPT_CD# /* 이행관리과 등 권한이 있는 과*/ AND T3.BFR_IMPL_MNG_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strOdUpSpvBrdvCd#))) AND T3.BFR_IMPL_MNG_DEPT_CD = #BFR_IMPL_MNG_DEPT_CD# AND T3.IMPL_MNG_JRSD_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strUpSpvBrdvCd#))) AND T3.IMPL_MNG_JRSD_DEPT_CD = #IMPL_MNG_JRSD_DEPT_CD# AND T3.ENFC_YMD >= #strEnfDtFrom# AND #strEnfDtTo# >= T3.ENFC_YMD AND T3.IMPL_WHLS_CFMTN_YMD >= #strDspRqDtmDtFrom# AND #strDspRqDtmDtTo# >= T3.IMPL_WHLS_CFMTN_YMD /* 주석처리 - 2016.05.13 yyh AND T3.HRK_MNG_ASG_YN = 'Y' */ AND T3.CFMTN_STTS_SECD = '1' AND TO_CHAR(SYSDATE, 'YYYYMMDD') AND T3.CFMTN_STTS_SECD = '1' AND TO_CHAR(SYSDATE, 'YYYYMMDD') > T3.PRCS_TERM_YMD AND T2.DSPS_RQT_KDCD = #DSPS_RQT_KDCD# AND T2.DSPS_RQT_KDCD IN ('310','320','391') AND T2.DSPS_RQT_KDCD IN ('510','520','530') AND T2.DSPS_RQT_KDCD IN ('810','820','830','840','850') AND T2.DSPS_RQT_KDCD IN ('110', '210', '310', '320', '391', '810', '820', '830', '840', '850') AND T2.DSPS_RQT_KDCD IN ('510','520','530','610','611', '620', '621', '623', '630') 3(결재완료) --> AND T3.DTM_STA_CD = '1' AND NVL(T3.DSP_RQ_APV_STA_CD,'0') <> '3' AND T3.DTM_STA_CD = '1' AND NVL(T3.DSP_RQ_APV_STA_CD,'0') = '3' AND T3.DTM_STA_CD = '2' AND T3.NOT_CPLT_STA_DVSN_CD = #strNotCpltStaDvsnCd# AND T3.CPLT_STA_DVSN_CD = #strCpltStaDvsnCd# AND T3.CLSG_PRSS_STA_CD = #strClsgPrssStaCd# (상신전) --> AND DECODE(T3.DSP_RQ_APV_STA_CD,'2','2','3','3','4','4','1') = #strDspRqApvStaCd# AND T2.DSP_RQ_KND_CD = ( SELECT ST1.CD FROM TBDCMACM013C ST1 WHERE ST1.CMM_CD_DVSN_CD = '1000002' AND ST1.USE_YN = 'Y' AND ST1.CD = #strDspRqKndCd# AND ROWNUM = 1 ) AND T3.DTM_STA_CD = ( SELECT ST1.CD FROM TBDCMACM013C ST1 WHERE ST1.CMM_CD_DVSN_CD = '1000017' AND ST1.USE_YN = 'Y' AND ST1.CD = #strDtmStaCd# AND ROWNUM = 1 ) AND T3.CLSG_PRSS_STA_CD = ( SELECT ST1.CD FROM TBDCMACM013C ST1 WHERE ST1.CMM_CD_DVSN_CD = '1000336' AND ST1.USE_YN = 'Y' AND ST1.CD = #strClsgPrssStaCd# AND ROWNUM = 1 ) AND T3.DSP_RQ_APV_STA_CD = ( SELECT ST1.CD FROM TBDCMACM013C ST1 WHERE ST1.CMM_CD_DVSN_CD = '1000333' AND ST1.USE_YN = 'Y' AND ST1.CD = #strDspRqApvStaCd# AND ROWNUM = 1 ) AND T3.DTM_YN = #strDtmYn# AND EXISTS ( SELECT AUD_YR FROM TBBADFRE001H ST1 WHERE 1 = 1 AND ST1.AUD_YR = T3.AUD_YR AND ST1.AUD_NO = T3.AUD_NO AND ST1.DSP_RQ_SNO = T3.DSP_RQ_SNO AND ST1.BAI_CHGD_ACP_DT IS NULL ) AND EXISTS ( SELECT AUD_YR FROM TBBADFRE001H ST1 WHERE 1 = 1 AND ST1.AUD_YR = T3.AUD_YR AND ST1.AUD_NO = T3.AUD_NO AND ST1.DSP_RQ_SNO = T3.DSP_RQ_SNO AND ( ST1.ENFM_WHLS_APV_STA_CD IS NULL OR ST1.ENFM_WHLS_APV_STA_CD NOT IN ('3') ) ) AND T3.DTM_STA_CD = '1' AND NVL(T3.DTM_YN,'N') <> 'Y' AND NOT EXISTS ( SELECT AUD_YR FROM TBBADEAR006M ST1 WHERE 1 = 1 AND ST1.AUD_YR = T3.AUD_YR AND ST1.AUD_NO = T3.AUD_NO AND ST1.DSP_RQ_SNO = T3.DSP_RQ_SNO AND ( ST1.CPLT_YN IS NULL OR ST1.CPLT_YN = 'N' ) ) AND NOT EXISTS ( SELECT AUD_YR FROM TBBADEAR007M ST1 WHERE 1 = 1 AND ST1.AUD_YR = T3.AUD_YR AND ST1.AUD_NO = T3.AUD_NO AND ST1.DSP_RQ_SNO = T3.DSP_RQ_SNO AND ( ST1.CPLT_YN IS NULL OR ST1.CPLT_YN = 'N' ) ) AND T3.DTM_STA_CD = '1' AND T3.DTM_YN = 'Y' AND T3.ENFM_WHLS_APV_KND_CD = '1' AND (T3.DSP_RQ_APV_STA_CD IS NULL OR T3.DSP_RQ_APV_STA_CD NOT IN ('3')) AND T3.DTM_STA_CD = '1' AND T3.DTM_YN = 'Y' AND T3.ENFM_WHLS_APV_KND_CD = '2' AND (T3.DSP_RQ_APV_STA_CD IS NULL OR T3.DSP_RQ_APV_STA_CD NOT IN ('3')) AND T3.DTM_STA_CD = '1' AND T3.DTM_YN = 'Y' AND T3.ENFM_WHLS_APV_KND_CD = '3' AND (T3.DSP_RQ_APV_STA_CD IS NULL OR T3.DSP_RQ_APV_STA_CD NOT IN ('3')) AND T3.DTM_STA_CD = '1' AND T3.DTM_YN = 'Y' AND T3.DSP_RQ_APV_STA_CD = '3' AND (T3.DTM_APV_STA_CD IS NULL OR T3.DTM_APV_STA_CD != '2') AND T3.DTM_STA_CD = '1' AND T3.DTM_YN = 'Y' AND T3.DSP_RQ_APV_STA_CD = '3' AND T3.DTM_APV_STA_CD = '2' AND T3.DTM_STA_CD = '2' /* 감사연번종류코드 - 2015.12.22 yyh */ AND SUBSTR(T1.AUD_KND_CD,3,1) = #strAudYrNoKndCd# /* 관련자명, 조치요구 추가 - 2016.05.16 yyh */ AND EXISTS ( SELECT 1 FROM TBBADEAR007M Y WHERE 1=1 AND Y.AUD_YR = T3.AUD_YR AND Y.AUD_NO = T3.AUD_NO AND Y.DSP_RQ_SNO = T3.DSP_RQ_SNO AND Y.DFNT_NAM LIKE '%' || #strDfntNam# || '%' ) AND EXISTS ( SELECT 1 FROM TBBADEAR007M Y WHERE 1=1 AND Y.AUD_YR = T3.AUD_YR AND Y.AUD_NO = T3.AUD_NO AND Y.DSP_RQ_SNO = T3.DSP_RQ_SNO AND Y.HND_RQ_KND_CD = SUBSTR(#strHndRqKndCd#, 4) ) AND NVL(T3.MAIN_ENFM_MNG_TG_YN,'N') = #strMainEnfmMngTgYn# AND (SELECT MAX(ENFM_STEP_CD) FROM TBBADFRE001H Z1 WHERE Z1.AUD_YR = T3.AUD_YR AND Z1.AUD_NO = T3.AUD_NO AND Z1.DSP_RQ_SNO = T3.DSP_RQ_SNO AND Z1.HST_NO = (SELECT MAX(HST_NO) FROM TBBADFRE001H Z2 WHERE Z2.AUD_YR = T3.AUD_YR AND Z2.AUD_NO = T3.AUD_NO AND Z2.DSP_RQ_SNO = T3.DSP_RQ_SNO)) = #strEnfmStepCd# ) DT ORDER BY AUD_YR DESC, AUD_NO DESC, DSP_RQ_SNO DESC ) T ) TT