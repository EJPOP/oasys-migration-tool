SELECT NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D4.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR || '-' || D1.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO /* 업무번호 */,
    D2.ADT_KDCD /* 감사종류코드 */,
    F_CODE_NM('1000270', D2.ADT_KDCD) AS F_CODE_NM /* 감사종류명 */,
    D2.ADT_MTTR_NM /* 감사사항명 */,
    D3.SPE_ADD_SC /* 특별가산점 */,
    D3.MDT_ASC /* 조정평점 */,
    #strEvlYr# AS #STREVLYR# /* 평가년도 */,
    #strHlyrDvsnCd# AS #STRHLYRDVSNCD# /* 반기구분 */
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D1 , TBCSPAOE021M D2 , TBCSPAOE043M D3 , TB_BADDED001M D4 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D2.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR (+) AND D2.TSK_NO = D3.TSK_NO (+) AND D2.CVLCPT_ADT_YR = D4.ADT_YR (+) AND D2.TSK_NO = D4.ADT_NO (+) AND D2.ADT_KDCD = D3.ADT_KDCD (+) AND TO_CHAR(D1.ADT_STP_SECD) != '10010' AND NVL(D2.EVL_RQS_YN, 'N') != 'Y' /*위원평가 대상이 아닌 것*/ AND D2.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D4.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D2.TSK_NO = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D4.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) AND D2.ADT_MTTR_NM LIKE '%' || #strAudSbjNm# || '%' ORDER BY D2.HNDL_DIV_DPT_CD