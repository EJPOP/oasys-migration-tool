SELECT /* CSPNBK221EArrMouiListSelect */ D7.LEND_KND_CD,
    D7.MOUI_NO,
    D7.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    D7.USER_NM /* 사용자명 */,
    D7.LEND_AM,
    D7.LEND_BL,
    D7.DELAY_LEND_BL,
    D7.FNL_RPM_DT,
    D7.EMN_RPM_PRN,
    D7.ARR_RPM_PRN_SUM_AM,
    D7.CH_ARR_RPM_PRN_SUM_AM,
    D7.TOT_RPM_PRN_SUM_AM
FROM ( SELECT D3.LEND_KND_CD,
    D3.MOUI_NO,
    D5.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    D6.USER_NM /* 사용자명 */,
    D3.LEND_AM,
    D3.LEND_BL,
    D3.DELAY_LEND_BL,
    D4.FNL_RPM_DT,
    D3.EMN_RPM_PRN,
    D4.ARR_RPM_PRN_SUM_AM,
    ( CASE WHEN D4.ARR_RPM_PRN_SUM_AM >= D3.DELAY_LEND_BL THEN D3.DELAY_LEND_BL ELSE CASE WHEN D3.DELAY_LEND_BL = 400000 THEN CASE WHEN D4.ARR_RPM_PRN_SUM_AM >= 400000 THEN D4.ARR_RPM_PRN_SUM_AM ELSE 400000 END ELSE D3.DELAY_LEND_BL END ELSE CASE WHEN D3.DELAY_LEND_BL = 500000 THEN D4.ARR_RPM_PRN_SUM_AM ELSE 500000 END ELSE CASE WHEN D4.ARR_RPM_PRN_SUM_AM >= 670000 THEN D4.ARR_RPM_PRN_SUM_AM ELSE 670000 END END END END ) AS ARR_RPM_PRN_SUM_AM,
    ( D3.EMN_RPM_PRN + D4.ARR_RPM_PRN_SUM_AM ) AS EMN_RPM_PRN
FROM ( SELECT D1.LEND_KND_CD,
    D1.MOUI_NO,
    SUM(D1.LEND_AM) AS LEND_AM,
    SUM(D1.LEND_BL) AS LEND_BL,
    SUM( CASE D1.LEND_BL > 0 AND D1.EXPR_DT D1.LEND_BL > 0 AND D1.EXPR_DT BETWEEN TO_CHAR( ADD_MONTHS( TO_DATE(#arrDt#, 'YYYYMMDD'), -1 ), 'YYYYMMDD') AND TO_CHAR( TO_DATE(#arrDt#, 'YYYYMMDD') - 1, 'YYYYMMDD' ) THEN D1.LEND_BL ELSE 0 END ) AS LEND_BL,
    SUM( CASE WHEN D1.LEND_BL > 0 AND D1.LEND_DT > '20080201' THEN D1.EMN_RPM_PRN ELSE 0 END ) AS LEND_BL
FROM TBCSPNBK203D D1 WHERE D1.LEND_KND_CD = '1' AND D1.CNL_YN = 'N' D1.MOUI_NO = #arrMouiNo# GROUP BY D1.LEND_KND_CD, D1.MOUI_NO ) D3 , ( SELECT D2.MOUI_NO,
    D2.FNL_RPM_DT,
    NVL(D2.ARR_RPM_PRN_SUM_AM, 0) AS ARR_RPM_PRN_SUM_AM
FROM TBCSPNBK202M D2 WHERE D2.LEND_KND_CD = 1 ) D4 , TBCSPNBK001M D5 , TBDCMACM001M D6 WHERE D3.MOUI_NO = D4.MOUI_NO AND D3.MOUI_NO = D5.MOUI_NO AND D5.TRGT_NOP_ENO = D6.TRGT_NOP_ENO AND D3.DELAY_LEND_BL > 0 ) D7 D7.ARR_RPM_PRN_SUM_AM D7.ARR_RPM_PRN_SUM_AM != D7.CH_ARR_RPM_PRN_SUM_AM D7.TRGT_NOP_ENO = #TRGT_NOP_ENO# D7.USER_NM LIKE '%' || #arrMouiNm# || '%' ORDER BY MOUI_NO