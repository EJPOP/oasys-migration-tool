SELECT A.CVLCPT_ADT_YR /* 민원감사년도 */,
    A.ADT_NO /* 감사번호 */,
    A.CVLCPT_ADT_YR||'-'||A.ADT_NO AS CVLCPT_ADT_YR /* 민원감사년도 */,
    ADT_MTTR_NM /* 감사사항명 */,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    F_ORG_INFO(B.INST_CD,'1') ||CASE WHEN NVL(B.INST_CONT,0)-1 > 0 then ' 외' || (B.INST_CONT -1) end AS TRGT_INST_NM /* 대상기관명 */,
    CASE WHEN SUBSTR(A.ADT_KDCD,-1) = '1' THEN '10001' WHEN SUBSTR(A.ADT_KDCD,-1) = '6' THEN '10002' WHEN SUBSTR(A.ADT_KDCD,-1) = '4' THEN '10003' WHEN SUBSTR(A.ADT_KDCD,-1) = '0' THEN '10004' WHEN SUBSTR(A.ADT_KDCD,-1) = '2' THEN '10004' WHEN SUBSTR(A.ADT_KDCD,-1) = '3' THEN '10006' ELSE '' END AS ADT_KDCD /* 감사종류코드 */,
    F_CODE_NM('1000007',A.ADT_KDCD) AS ADT_KND_NM /* 감사종류명 */,
    '' AS ADT_STP_SECD /* 감사단계구분코드 */,
    A.WHOL_RBPRSN_DEPT_CD /* 전체책임자부서코드 */,
    A.WHOL_RBPRSN_JBGD_SECD /* 전체책임자직급구분코드 */,
    A.LEADER_POS_CLASS_NM /* 감사반장 직급명 */,
    A.ADT_RBPRSN_ENO /* 감사책임자직원전산번호 */,
    A.LEADER_NM /* 감사반장 이름 */,
    A.SPVR_DEPT_CD /* 감리원부서코드 */,
    A.SPVR_JBGD_SECD /* 감리원직급구분코드 */,
    A.SPVR_CLASS_NM /* 주관자 직급명 */,
    A.SPVR_ENO /* 감리원직원전산번호 */,
    A.SPVR_NM /* 주관자 이름 */,
    A.ASTN_DEPT_CD /* 보조자부서코드 */,
    A.ASTN_JBGD_SECD /* 보조자직급구분코드 */,
    A.AST_CLASS_NM /* 보조자 직급명 */,
    A.ASTN_ENO /* 보조자직원전산번호 */,
    A.AST_NM /* 보조자 이름 */,
    A.ADT_DCN /* 감사일수 */,
    C.IN_PSON_MAN_DAY /* 연인원 */,
    C.IN_PSON_CNT /* 단계별인원 */,
    C.ADT_DCN /* 감사일수 */,
    SUBSTR(D.SUM_ALL,1,LENGTH(D.SUM_ALL)-3) AS SUBSTR /* 출장여비 */,
    '' AS RSRV_EXMN_OTST_YMD /* 예비조사착수일자 */,
    '' AS ENFC_YMD /* 시행일자 */,
    '' AS DLAY_DT_NM,
    '' AS EXET_DCN
FROM ( SELECT A.ADT_YR /* 감사년도 */,
    A.ADT_NO /* 감사번호 */,
    MAX(A.SPRVSN_DEPT_CD) AS SRECS_DEPT_CD /* 심사재심의부서코드 */,
    F_DPT_INFO(MAX(A.SPRVSN_DEPT_CD),'1') AS CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.WHOL_RBPRSN_DEPT_CD /* 전체책임자부서코드 */,
    MAX(WHOL_RBPRSN_JBGD_SECD) AS WHOL_RBPRSN_JBGD_SECD /* 전체책임자직급구분코드 */,
    MAX(A.WHOL_RBPRSN_JBGD_SECD) AS WHOL_RBPRSN_JBGD_SECD /* 전체책임자직급구분코드 */,
    F_CODE_NM('1000173',MAX(A.WHOL_RBPRSN_JBGD_SECD)) AS F_CODE_NM /* 감사반장 직급명 */,
    MAX(A.ADT_WHOL_RBPRSN_ENO) AS ADT_RBPRSN_ENO /* 감사책임자직원전산번호 */,
    F_USR_INFO(MAX(A.ADT_WHOL_RBPRSN_ENO),'2') AS F_USR_INFO /* 감사반장 이름 */,
    A.SPVR_DEPT_CD /* 감리원부서코드 */,
    MAX(A.SPVR_JBGD_SECD) AS SPVR_JBGD_SECD /* 감리원직급구분코드 */,
    F_CODE_NM('1000173',MAX(A.SPVR_JBGD_SECD)) AS F_CODE_NM /* 주관자 직급명 */,
    MAX(A.SPVR_ENO) AS SPVR_ENO /* 감리원직원전산번호 */,
    F_USR_INFO(MAX(A.SPVR_ENO),'2') AS F_USR_INFO /* 주관자 이름 */,
    A.ASTN_DEPT_CD /* 보조자부서코드 */,
    MAX(A.ASTN_JBGD_SECD) AS ASTN_JBGD_SECD /* 보조자직급구분코드 */,
    F_CODE_NM('1000173',MAX(A.ASTN_JBGD_SECD)) AS F_CODE_NM /* 보조자 직급명 */,
    MAX(A.ASTN_ENO) AS ASTN_ENO /* 보조자직원전산번호 */,
    F_USR_INFO(MAX(A.ASTN_ENO),'2') AS F_USR_INFO /* 보조자 이름 */,
    MAX(ADT_BZTRP_KDCD) AS ADT_BZTRP_KDCD /* 감사출장종류코드 */,
    MAX(ADT_KDCD) AS ADT_KDCD /* 감사종류코드 */,
    min(B.ADT_BGNG_YMD) AS ADT_BGNG_YMD /* 감사시작일자 */,
    max(B.ADT_END_YMD) AS ADT_END_YMD /* 감사종료일자 */,
    sum(B.ADT_DCN) AS ADT_DCN /* 감사일수 */,
    MAX(ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */
FROM TBBADDED001M A , TBBADDED002M B WHERE A.CVLCPT_ADT_YR = B.REL_ADT_YR AND A.ADT_NO = B.REL_ADT_NO AND BZTRP_SECD ='1' AND A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# GROUP BY A.CVLCPT_ADT_YR, A.ADT_NO, A.WHOL_RBPRSN_DEPT_CD, A.SPVR_DEPT_CD, A.ASTN_DEPT_CD ) A , ( SELECT B.REL_ADT_YR /* 관계감사년도 */,
    B.REL_ADT_NO /* 관계감사번호 */,
    MIN(INST_CD) AS INST_CD /* 기관코드 */,
    COUNT(DISTINCT INST_CD) AS INST_CONT /* 기관개수 */
FROM TBBADDED008L A , TBBADDED002M B WHERE A.BZTRP_YR = B.BZTRP_YR and A.BZTRP_SQNO = B.BZTRP_SQNO AND B.ADT_BZTRP_KDCD = (SELECT MAX(ADT_BZTRP_KDCD) AS ADT_BZTRP_KDCD /* 감사출장종류코드 */
FROM TBBADDED002M WHERE REL_ADT_YR = #CVLCPT_ADT_YR# AND REL_ADT_NO = #ADT_NO# AND ADT_BZTRP_KDCD IN ('01','02')) AND REL_ADT_YR = #CVLCPT_ADT_YR# AND REL_ADT_NO = #ADT_NO# GROUP BY REL_ADT_YR, REL_ADT_NO ) B , ( SELECT REL_ADT_YR /* 관계감사년도 */,
    REL_ADT_NO /* 관계감사번호 */,
    SUBSTR(EXTRACT(xmlagg(XMLELEMENT(A,' '||AUD_BZT_KND_NM||' '||ACADT_STP_NO||'단계('||ADT_DCN||'일)') ORDER BY A.ACADT_STP_NO),'//text()'),2) AS ADT_DCN /* 감사일수 */,
    max(IN_PSON_MAN_DAY) AS IN_PSON_MAN_DAY,
    SUBSTR(EXTRACT(xmlagg(XMLELEMENT(A,' '||AUD_BZT_KND_NM||' '||ACADT_STP_NO||'단계('||IN_PSON_CNT||'명)') ORDER BY A.ACADT_STP_NO),'//text()'),2) AS SUBSTR
FROM (SELECT ROWNUM,
    A.REL_ADT_YR /* 관계감사년도 */,
    A.REL_ADT_NO /* 관계감사번호 */,
    A.BZTRP_YR /* 출장년도 */,
    A.BZTRP_SQNO /* 출장순번 */,
    A.ADT_DCN /* 감사일수 */,
    B.IN_PSON_CNT,
    SUM(C.IN_PSON_MAN_DAY) OVER (PARTITION BY REL_ADT_YR,REL_ADT_NO) AS IN_PSON_MAN_DAY,
    ACADT_STP_NO /* 실지감사단계번호 */,
    F_CODE_NM('1000030', ADT_BZTRP_KDCD ) AS F_CODE_NM
FROM TBBADDED002M A , ( select /*+ INDEX(A KBBADBADDED005001) */ BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    sum( case when A.EMP_SECD = '0' then 1 else 0 end) AS EMP_SECD /* 직원구분코드 */
from (select distinct AS BZTRP_YR,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */,
    EMP_SECD /* 직원구분코드 */
from TBBADDED005L ) A group by BZTRP_YR, BZTRP_SQNO ) B , ( select /*+INDEX(B, KBBADBADDED006001)*/ PT1.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    PT1.BZTRP_SQNO /* 출장순번 */,
    SUM(case when TMA.EMP_SECD = '0' then PT1.ADT_DCN else 0 end) AS EMP_SECD /* 직원구분코드 */
from TBBADDED005L tma , TBBADDED006L pt1 where PT1.BZTRP_YR = TMA.BZTRP_YR and PT1.BZTRP_SQNO = TMA.BZTRP_SQNO and PT1.FT_SQNO = TMA.FT_SQNO and PT1.BZTRVR_ALTMNT_SQNO = TMA.BZTRVR_ALTMNT_SQNO group by PT1.BZTRP_YR, PT1.BZTRP_SQNO ) C WHERE B.BZTRP_YR(+) = A.BZTRP_YR and B.BZTRP_SQNO(+) = A.BZTRP_SQNO and C.BZTRP_YR(+) = A.BZTRP_YR and C.BZTRP_SQNO(+) = A.BZTRP_SQNO AND ADT_BZTRP_KDCD = (SELECT MAX(ADT_BZTRP_KDCD) AS ADT_BZTRP_KDCD /* 감사출장종류코드 */
FROM TBBADDED002M WHERE REL_ADT_YR = #CVLCPT_ADT_YR# AND REL_ADT_NO = #ADT_NO# AND ADT_BZTRP_KDCD IN ('01','02')) AND A.REL_ADT_YR = #CVLCPT_ADT_YR# AND A.REL_ADT_NO = #ADT_NO# ) A group by REL_ADT_YR, REL_ADT_NO ) C , ( SELECT SITU.REL_ADT_YR /* 관계감사년도 */,
    SITU.REL_ADT_NO /* 관계감사번호 */,
    SUM(TE.BZTRP_TRVEXP_FDEXP + TE.LDG_CST + TE.BTEXP_CRTR_AMT + NVL(TFD.RL_FARE_AMT, 0) + NVL(SPM_CST,0) +NVL(LEAD_CST,0)+NVL(ADT_ACTV_ACTC_AMT,0)) AS BZTRP_TRVEXP_FDEXP /* 출장여비식비 */
FROM TBBADDED002M SITU , TBBADDED011L TE , (SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */,
    BTEXP_SQNO /* 출장비순번 */,
    SUM(RL_FARE_AMT) AS RL_FARE_AMT /* 철도운임금액 */
FROM TBBADDED017L WHERE CAL_YN= 'N' GROUP BY BZTRP_YR, BZTRP_SQNO, BZTRVR_ENO, BTEXP_SQNO ) TFD WHERE SITU.REL_ADT_YR = #CVLCPT_ADT_YR# AND SITU.REL_ADT_NO = #ADT_NO# AND TE.CAL_YN = 'N' AND SITU.BZTRP_YR = TE.BZTRP_YR AND SITU.BZTRP_SQNO =TE.BZTRP_SQNO AND TE.BZTRP_YR = TFD.BZTRP_YR(+) AND TE.BZTRP_SQNO = TFD.BZTRP_SQNO(+) AND TE.BZTRVR_ENO = TFD.BZTRVR_ENO(+) AND TE.BTEXP_SQNO = TFD.BTEXP_SQNO(+) GROUP BY SITU.REL_ADT_YR, SITU.REL_ADT_NO ) D WHERE A.CVLCPT_ADT_YR = B.REL_ADT_YR AND A.ADT_NO = B.REL_ADT_NO AND A.CVLCPT_ADT_YR = C.REL_ADT_YR AND A.ADT_NO = C.REL_ADT_NO AND A.CVLCPT_ADT_YR = D.REL_ADT_YR AND A.ADT_NO = D.REL_ADT_NO AND A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO#