WITH /* 특정일 기준으로 계산에 필요한 날짜 계산 */ BASE_DATE_CTE AS (SELECT CASE WHEN #strStdDt# = '20250814' THEN TO_DATE('20250814' , 'YYYYMMDD') + 1 ELSE TO_DATE(#strStdDt# , 'YYYYMMDD') END AS #STRSTDDT#
FROM DUAL) , BASE AS ( /* 금주 시작일 ~ 차주 종료일 (2주간) */ SELECT MIN(DT) AS BGNG_YMD /* 시작일자 */,
    MAX(DT) AS END_YMD /* 종료일자 */
FROM ( SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE),1) - TO_DATE(BASE_DATE_CTE.BASE_DATE)
FROM DUAL), 'YYYYMMDD') AS DT FROM DUAL , BASE_DATE_CTE CONNECT BY LEVEL <= 28 ) ), BASE2 AS ( /* 기준일자와 시간표 */ SELECT DT,
    B.*
FROM ( SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE),1) - TO_DATE(BASE_DATE_CTE.BASE_DATE)
FROM DUAL), 'YYYYMMDD') AS DT FROM DUAL , BASE_DATE_CTE CONNECT BY LEVEL <= 28 ) A ,TBCSPMWF009M B WHERE B.BOKG_DVSN_CD = '3' AND (SELECT COUNT(1)
FROM TB_BADDED013B WHERE INFO_YR || HLDY_CRTR_MND = DT) = 0 /* 휴일제외 */ AND (SELECT COUNT(1)
FROM TBCSPMWF011M WHERE HLDY = A.DT AND BOKG_DVSN_CD = '3') = 0 /* 임시휴일 적용 - 2019.07.29 yyh */ AND TO_CHAR(TO_DATE(DT), 'DY', 'NLS_DATE_LANGUAGE=korean') IN ('월','화','수','목') ) SELECT TO_CHAR(TO_DATE(A.DT), 'YYYY-MM-DD') || '(' || TO_CHAR(TO_DATE(A.DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')' AS DSPS_YMD /* 처분일자 */,
    SUBSTR(A.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(A.SCO_TM_STR_CD,3) || ' ~ ' || SUBSTR(A.SCO_TM_END_CD,0,2) || ':' || SUBSTR(A.SCO_TM_END_CD,3) AS SUBSTR,
    A.DT,
    A.SCO_HST_SNO,
    A.SCO_SNO,
    A.SCO_TM_STR_CD,
    A.SCO_TM_END_CD,
    B.BOKG_DT,
    B.DSP_BOKG_DT,
    B.SCO_TM_NM,
    B.BOKG_PEN_CNB,
    B.BOKG_PEN_NM,
    B.BOKG_PEN_DPT_CD,
    B.BOKG_PEN_DPT_NM,
    B.BOKG_RANK_NM,
    B.BOKG_TNB,
    B.TRTMT_INFO
FROM BASE2 A ,( SELECT T2.BOKG_DVSN_CD AS BOKG_DVSN_CD,
    T1.BOKG_DT AS BOKG_DT,
    T1.SCO_HST_SNO AS SCO_HST_SNO,
    T1.SCO_SNO AS SCO_SNO,
    TO_CHAR(TO_DATE(T1.BOKG_DT), 'YYYY-MM-DD') || '(' || TO_CHAR(TO_DATE(T1.BOKG_DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')' AS TO_CHAR,
    SUBSTR(T2.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_STR_CD,3) || ' ~ ' || SUBSTR(T2.SCO_TM_END_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_END_CD,3) AS SUBSTR,
    BOKG_PEN_CNB AS BOKG_PEN_CNB,
    T5.USER_NM /* 사용자명 */,
    BOKG_PEN_DPT_CD AS BOKG_PEN_DPT_CD,
    F_DPT_INFO(BOKG_PEN_DPT_CD, '1') AS F_DPT_INFO,
    F_CODE_NM('1000173', T5.JBGD_SECD) AS F_CODE_NM,
    T5.CRU_TELNO /* 부패전화번호 */,
    CASE WHEN T4.TRTMT_NBC_CD = '1' THEN '(초진)' WHEN T4.TRTMT_NBC_CD = '2' THEN '(재진)' END || T4.TRTMT_FNDT_TXT AS TRTMT_NBC_CD
FROM TBCSPMWF013M T1 ,TBCSPMWF009M T2 ,BASE T3 ,TBCSPMWF012M T4 ,TBDCMACM001M T5 WHERE 1=1 AND T1.SCO_HST_SNO = T2.SCO_HST_SNO AND T1.SCO_SNO = T2.SCO_SNO AND T2.BOKG_DVSN_CD = '3' AND T1.BOKG_APL_DH = T4.BOKG_APL_DH(+) AND T1.BOKG_PEN_CNB = T5.TRGT_NOP_ENO AND T1.BOKG_DT BETWEEN T3.BGNG_YMD AND T3.END_YMD ) B WHERE 1=1 AND A.BOKG_DVSN_CD = B.BOKG_DVSN_CD(+) AND A.SCO_HST_SNO = B.SCO_HST_SNO(+) AND A.SCO_SNO = B.SCO_SNO(+) AND A.DT = B.BOKG_DT(+) ORDER BY A.DT ,A.SCO_HST_SNO ,A.SCO_SNO