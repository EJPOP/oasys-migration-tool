SELECT EVL_DPT_UP_NM,
    EVL_DPT_NM /* 평가소속부서명 */,
    JBGD_NM /* 직급명 */,
    INFO_RLPR_NM /* 정보관계자명 */,
    NEVLT_CNB,
    PSN_TSK_ASC_1 AS PSN_TSK_ASC_1 /* 감사활동 */,
    PSN_TSK_ASC_2 AS PSN_TSK_ASC_2 /* 모니터링 */,
    PSN_TSK_ASC_3 AS PSN_TSK_ASC_3 /* 결산업무 */,
    PSN_TSK_ASC_4 AS PSN_TSK_ASC_4 /* 연보업무 */,
    PSN_TSK_ASC_5 AS PSN_TSK_ASC_5 /* 총괄업무 */,
    PSN_TSK_ASC_6 AS PSN_TSK_ASC_6 /* 집행전말 */,
    PSN_TSK_ASC_7 AS PSN_TSK_ASC_7 /* 기타업무 */,
    PSN_TSK_ASC_8 AS PSN_TSK_ASC_8 /* 성과보고서 */,
    PSN_TSK_ASC_9 AS PSN_TSK_ASC_9 /* 법령모니터링 */,
    PSN_TSK_ASC_99 AS PSN_TSK_ASC_99 /* 법령모니터링 */,
    SPRT_CVS_ASC AS SPRT_CVS_ASC /* 지원환상 */,
    PSN_TSK_ASC_ALL AS PSN_TSK_ASC_ALL /* 종합평점 */,
    DECODE(EVL_TG_YN, 'Y', TO_CHAR(RANK_NUM), '평가제외') AS EVL_TG_YN /* 직급별 순위 */,
    EVL_TG_YN /* 평가대상여부 */,
    RMRK_CN /* 비고내용 */,
    BLT_DPT_UP_NM /* 현부서(국/단) */,
    CRU_OGDP_DEPT_NM /* 부패소속부서명 */
FROM ( SELECT F_DPT_INFO(MAIN.HIRK_DPT_CD, '1') AS F_DPT_INFO /* 현부서(국/단) */,
    F_DPT_INFO(BLT_DPT_CD, '1') || CASE WHEN DPT.DEPT_TPCD IS NOT NULL THEN '(' || DECODE(DPT.DEPT_TPCD, 'S', 'Y', 'A', 'A', 'E', 'E', '') || ')' ELSE '' END AS CRU_OGDP_DEPT_NM /* 부패소속부서명 */,
    F_CODE_NM('1000173', JBGD_SECD) AS JBGD_NM /* 직급명 */,
    F_USR_INFO(NEVLT_CNB, '2') AS INFO_RLPR_NM /* 정보관계자명 */,
    NEVLT_CNB,
    PSN_TSK_ASC_1 AS PSN_TSK_ASC_1 /* 감사활동 */,
    PSN_TSK_ASC_2 AS PSN_TSK_ASC_2 /* 모니터링 */,
    PSN_TSK_ASC_3 AS PSN_TSK_ASC_3 /* 결산업무 */,
    PSN_TSK_ASC_4 AS PSN_TSK_ASC_4 /* 연보업무 */,
    PSN_TSK_ASC_5 AS PSN_TSK_ASC_5 /* 총괄업무 */,
    PSN_TSK_ASC_6 AS PSN_TSK_ASC_6 /* 집행전말 */,
    PSN_TSK_ASC_7 AS PSN_TSK_ASC_7 /* 기타업무 */,
    PSN_TSK_ASC_8 AS PSN_TSK_ASC_8 /* 성과보고서 */,
    PSN_TSK_ASC_9 AS PSN_TSK_ASC_9 /* 법령모니터링 */,
    PSN_TSK_ASC_99 AS PSN_TSK_ASC_99 /* 법령모니터링 */,
    SPRT_CVS_ASC AS SPRT_CVS_ASC /* 지원환상 */,
    PSN_TSK_ASC_ALL AS PSN_TSK_ASC_ALL /* 종합평점 */,
    (CASE WHEN EVL_DPT_UP_CD IS NOT NULL THEN F_DPT_INFO(EVL_DPT_UP_CD, '1') ELSE '' END) AS EVL_DPT_UP_CD /* 평가소속부서명 */,
    (CASE WHEN EVL_DPT_CD IS NOT NULL THEN CASE WHEN DPT_DVSN_CD IS NOT NULL THEN DECODE(DPT_DVSN_CD, '20', 'Y', '10', 'A', '') ELSE '' END || '(' || F_DPT_INFO(EVL_DPT_CD, '1') || ')' ELSE '' END ) AS EVL_DPT_CD /* 평가소속부서명 */,
    RANK_NUM /* 직급별 순위 */,
    JBGD_SECD /* 직급구분코드 */,
    NVL(EVL_TG_YN, 'N') AS EVL_TG_YN,
    RMRK_CN /* 비고내용 */,
    EVL_DPT_UP_CD,
    EVL_DPT_CD
FROM ( SELECT HIRK_DPT_CD /* 현부서(국/단) */,
    BLT_DPT_CD /* 현부서(과) */,
    JBGD_SECD /* 직급구분코드 */,
    NEVLT_CNB,
    PSN_TSK_ASC_1 /* 감사활동 */,
    PSN_TSK_ASC_2 /* 모니터링 */,
    PSN_TSK_ASC_3 /* 결산업무 */,
    PSN_TSK_ASC_4 /* 연보업무 */,
    PSN_TSK_ASC_5 /* 총괄업무 */,
    PSN_TSK_ASC_6 /* 집행전말 */,
    PSN_TSK_ASC_7 /* 기타업무 */,
    PSN_TSK_ASC_8 /* 성과보고서 */,
    PSN_TSK_ASC_9 /* 법령모니터링 */,
    PSN_TSK_ASC_99 /* 법령모니터링 */,
    SPRT_CVS_ASC /* 지원환상 - 추후 테이블 바꾸고 나서 값 가져올수 있음 */,
    PSN_TSK_ASC_ALL /* 종합평점 */,
    EVL_DPT_CD /* 평가종료일 소속부서관리에서 관리되는 평가부서코드 */,
    EVL_DPT_UP_CD,
    DPT_DVSN_CD,
    EVL_TG_YN,
    RMRK_CN /* 비고내용 */,
    RANK() OVER(PARTITION BY JBGD_SECD, EVL_TG_YN ORDER BY PSN_TSK_ASC_ALL DESC) AS RANK /* 직급별 순위 */
FROM ( SELECT D21.EVL_YR,
    D21.HLYR_DVSN_CD,
    ( SELECT AS HIRK_DPT_CD
FROM TBDCMACM002M WHERE D20.SRECS_DEPT_CD = SRECS_DEPT_CD ) AS HIRK_DPT_CD , D20.SRECS_DEPT_CD AS BLT_DPT_CD /*현소속부서*/ , D21.JBGD_SECD , D21.TRGT_NOP_ENO AS NEVLT_CNB , NVL(BASE.PSN_TSK_ASC_1, 0) AS PSN_TSK_ASC_1 , NVL(BASE.PSN_TSK_ASC_2, 0) AS PSN_TSK_ASC_2 , NVL(BASE.PSN_TSK_ASC_3, 0) AS PSN_TSK_ASC_3 , NVL(BASE.PSN_TSK_ASC_4, 0) AS PSN_TSK_ASC_4 , NVL(BASE.PSN_TSK_ASC_5, 0) AS PSN_TSK_ASC_5 , NVL(BASE.PSN_TSK_ASC_6, 0) AS PSN_TSK_ASC_6 , NVL(BASE.PSN_TSK_ASC_7, 0) AS PSN_TSK_ASC_7 , NVL(BASE.PSN_TSK_ASC_8, 0) AS PSN_TSK_ASC_8 , NVL(BASE.PSN_TSK_ASC_9, 0) AS PSN_TSK_ASC_9 , NVL(BASE.PSN_TSK_ASC_99, 0) AS PSN_TSK_ASC_99 , NVL(BASE.SPRT_CVS_ASC, 0) AS SPRT_CVS_ASC , NVL(BASE.PSN_TSK_ASC_1 + BASE.PSN_TSK_ASC_2 + BASE.PSN_TSK_ASC_3 + BASE.PSN_TSK_ASC_4 + BASE.PSN_TSK_ASC_5 + BASE.PSN_TSK_ASC_6 + BASE.PSN_TSK_ASC_7 + BASE.PSN_TSK_ASC_8 + BASE.PSN_TSK_ASC_9 + BASE.SPRT_CVS_ASC, 0) AS PSN_TSK_ASC_ALL , D21.EVL_DPT_CD AS EVL_DPT_CD /*평가종료일 소속부서관리에서 관리되는 평가부서코드*/ , D21.DPT_DVSN_CD /*부서구분코드*/ , D21.EVL_DPT_UP_CD /*평가부서 상위코드*/ , D21.EVL_TG_YN , D21.RMRK_CN FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    NEVLT_CNB /* 피평가자 전산번호 */,
    NVL(SUM(PSN_TSK_ASC_1), 0) AS PSN_TSK_ASC_1 /* 감사활동 */,
    NVL(SUM(PSN_TSK_ASC_2), 0) AS PSN_TSK_ASC_2 /* 모니터링 */,
    NVL(SUM(PSN_TSK_ASC_3), 0) AS PSN_TSK_ASC_3 /* 결산업무 */,
    NVL(SUM(PSN_TSK_ASC_4), 0) AS PSN_TSK_ASC_4 /* 연보업무 */,
    NVL(SUM(PSN_TSK_ASC_5), 0) AS PSN_TSK_ASC_5 /* 총괄업무 */,
    NVL(SUM(PSN_TSK_ASC_6), 0) AS PSN_TSK_ASC_6 /* 집행전말 */,
    NVL(SUM(PSN_TSK_ASC_7), 0) AS PSN_TSK_ASC_7 /* 기타업무 */,
    NVL(SUM(PSN_TSK_ASC_8), 0) AS PSN_TSK_ASC_8 /* 성과보고서 */,
    NVL(SUM(PSN_TSK_ASC_9), 0) AS PSN_TSK_ASC_9 /* 법령모니터링 */,
    NVL(SUM(PSN_TSK_ASC_99), 0) AS PSN_TSK_ASC_99 /* 법령모니터링 */,
    NVL(SUM(SPRT_CVS_ASC), 0) AS SPRT_CVS_ASC
FROM ( /*지원환산점수*/ SELECT EVL_YR AS EVL_YR /* 평가년도 */,
    HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분 */,
    PTCPT_CNB /* 전산번호 */,
    CHR_DPT_CD AS SRECS_DEPT_CD /* 평가할때 부서코드 */,
    0 /* 개인평점 */,
    0 /* 모니터링 */,
    0 /* 결산업무 */,
    0 /* 연보업무 */,
    0 /* 총괄업무 */,
    0 /* 집행전말 */,
    0 /* 기타업무 */,
    0 /* 성과보고서 */,
    0 /* 법령모니터링 */,
    0 /* 법령모니터링 */,
    ROUND(F_AOE_DPT_TSC(#strEvlYr#, #strHlyrDvsnCd#, CHR_DPT_CD) * CTB_RT / 100, 2) AS ROUND /* 지원환산 개인평점 */
FROM ( SELECT D1.EVL_YR AS EVL_YR /* 평가년도 */,
    D1.HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분 */,
    D1.PTCPT_CNB,
    NVL(SUM(D2.WGT_RTE * D1.CTB_RT / 100), 0) AS CTB_RT /* 기여비율 */,
    D1.CHR_DPT_CD
FROM TBCSPAOE027M D1 , TBCSPAOE026M D2 WHERE 1=1 AND D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CHR_DPT_CD = D2.CHR_DPT_CD AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CTB_RT != 0 AND D1.PTCPT_CNB IN (SELECT TRGT_NOP_ENO /* 대상인원직원전산번호 */
FROM TBCSPAOE041M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_DVSN_CD ='10' ) /* 2015.03.30 권효정 감사관 요청사항 */ GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.PTCPT_CNB, D1.CHR_DPT_CD ) UNION ALL SELECT EVL_YR,
    HLYR_DVSN_CD,
    NEVLT_CNB /* 피평가자 전산번호 */,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    PSN_TSK_ASC_1,
    PSN_TSK_ASC_2 /* 모니터링 */,
    PSN_TSK_ASC_3 /* 결산업무 */,
    PSN_TSK_ASC_4 /* 연보업무 */,
    PSN_TSK_ASC_5 /* 총괄업무 */,
    PSN_TSK_ASC_6 /* 집행전말 */,
    PSN_TSK_ASC_7 /* 기타업무 */,
    PSN_TSK_ASC_8 /* 성과보고서 */,
    PSN_TSK_ASC_9 /* 법령모니터링 */,
    PSN_TSK_ASC_99 /* 법령모니터링 */,
    SPRT_CVS_ASC
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    NEVLT_CNB /* 피평가자 전산번호 */,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    0,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND (TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 1 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 14 AND 24 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 64 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 74 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 75 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 89 AND 93 ) THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND (TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 2 AND 3 ) THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 4 THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 5 THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 6 THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND (TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 8 AND 12 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 25 AND 63 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 65 AND 73 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 76 AND 88 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 94 AND 96) THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 13 THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 7 THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    (CASE WHEN CVLCPT_TASK_SECD = '10001' AND (TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) = 65 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 9 AND 10 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 69 AND 70 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 76 AND 80 OR TO_NUMBER(SUBSTR(AUD_TSK_KND_CD,4)) BETWEEN 94 AND 96 ) THEN PSN_TSK_ASC END) AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    0
FROM TBCSPAOE035M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10001' AND NEVLT_CNB IN (SELECT TRGT_NOP_ENO /* 대상인원직원전산번호 */
FROM TBCSPAOE041M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_DVSN_CD ='10' ) /* 2015.03.30 권효정 감사관 요청사항 */ ) UNION ALL SELECT #strEvlYr# AS #STREVLYR#,
    #strHlyrDvsnCd# AS #STRHLYRDVSNCD#,
    PTCPT_CNB,
    BLT_DPT_CD AS SRECS_DEPT_CD /* 평가할때 부서코드 */,
    ROUND(STND_ASC * (CTB_RT/100), 2) AS ROUND /* 개인평점 */,
    0 /* 모니터링 */,
    0 /* 결산업무 */,
    0 /* 연보업무 */,
    0 /* 총괄업무 */,
    0 /* 집행전말 */,
    0 /* 기타업무 */,
    0 /* 성과보고서 */,
    0 /* 법령모니터링 */,
    0 /* 법령모니터링 */,
    0
FROM ( SELECT D20.PTCPT_CNB,
    D20.DRIVE_RTE_ASC /* 추진율 조정평점 */,
    D20.CTB_RT /* 기여비율 */,
    D20.BLT_DPT_CD,
    D20.SPE_ADD_SC,
    D20.MDT_ASC,
    F_AOE_ASP_STND_ASC_2(#strEvlYr#, #strHlyrDvsnCd#, D20.ADT_KDCD, D20.AUD_STEP_CD_MAX, D20.DLY_DT_SUM, D20.SYT_EVL_ADVL_VAL, D20.ASP_STND_ASC, D20.CVLCPT_ADT_YR, D20.TSK_NO) AS F_AOE_ASP_STND_ASC_2 /* 가감평점 */,
    D20.STND_ASC
FROM ( SELECT D19.PTCPT_CNB,
    D19.DRIVE_RTE_ASC /* 추진율 조정평점 */,
    DECODE(D19.DLY_DT_SUM, 0, 0, (DECODE(INSTR(D19.DLY_DT_SUM, '-') , 0,'-', '') || CASE WHEN D19.DRIVE_RTE_ASC IS NOT NULL THEN ROUND(D19.DRIVE_RTE_ASC * NVL(D19.ASP_RTE, 0) / 100, 2) ELSE ROUND(D19.STND_ASC * D19.SYT_EVL_ADVL_VAL * ( D19.DRIVE_RTE_SUM / 100) * (NVL(D19.ASP_RTE, 0)/ 100), 2) END)) AS DLY_DT_SUM /* 가감평점 */,
    D19.CTB_RT /* 기여비율 */,
    D19.BLT_DPT_CD,
    D19.ADT_KDCD /* 감사종류코드 */,
    D19.AUD_STEP_CD_MAX,
    D19.DLY_DT_SUM,
    D19.SYT_EVL_ADVL_VAL,
    D19.SPE_ADD_SC,
    D19.MDT_ASC,
    D19.CVLCPT_ADT_YR /* 민원감사년도 */,
    D19.TSK_NO,
    D19.STND_ASC
FROM ( SELECT D11.PTCPT_CNB,
    D10.STND_ASC /* 표준평점 */,
    D10.SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D10.DRIVE_RTE_SUM /* 추진율 */,
    D10.DRIVE_RTE_ASC /* 추진율 조정평점 */,
    D10.DLY_DT_SUM /* 지연일 */,
    NVL(D10.ASP_RTE, 0) AS ASP_RTE /* 가감점율 */,
    D11.CTB_RT /* 기여비율 */,
    D11.BLT_DPT_CD,
    D10.ADT_KDCD /* 감사종류코드 */,
    D10.AUD_STEP_CD_MAX,
    D10.SPE_ADD_SC,
    D10.MDT_ASC,
    D10.CVLCPT_ADT_YR /* 민원감사년도 */,
    D10.TSK_NO
FROM ( SELECT ADT_KDCD /* 감사종류코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    MNDY_CNT,
    NVL(STND_ASC, 0) AS STND_ASC /* 표준평점 */,
    NVL(SYT_EVL_ADVL_VAL, 0) AS SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    (SELECT AS ASP_RTE
FROM TBCSPAOE012M WHERE DLAY_DT_NM = TO_CHAR(D9.DLY_DT_SUM) AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd#) AS ASP_RTE /*가감점율*/ , EVL_YR , HLYR_DVSN_CD , SYT_TRTM_YN , ROWNUM , F_AOE_DRIVE_RTE_ASC(#strEvlYr#, #strHlyrDvsnCd#, ADT_KDCD, AUD_STEP_CD_MIN, AUD_STEP_CD_MAX, MNDY_CNT, SYT_TRTM_YN, NVL(SYT_EVL_ADVL_VAL, 0)) AS DRIVE_RTE_ASC , NVL(SPE_ADD_SC, F_AOE_SPE_ADD_SC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS SPE_ADD_SC , NVL(MDT_ASC, F_AOE_MDT_ASC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS MDT_ASC FROM ( SELECT D5.ADT_KDCD /* 감사종류코드 */,
    D5.CVLCPT_ADT_YR /* 민원감사년도 */,
    D5.TSK_NO,
    D5.AUD_STEP_CD_MIN,
    D5.AUD_STEP_CD_MAX,
    D5.MNDY_CNT,
    F_AOE_STND_ASC(#strEvlYr#, #strHlyrDvsnCd#, D5.ADT_KDCD, D5.AUD_STEP_CD_MIN, D5.AUD_STEP_CD_MAX, D5.MNDY_CNT, NVL(D5.SYT_TRTM_YN,'N')) AS F_AOE_STND_ASC /* 표준평점 */,
    DECODE(NVL(D6.EVL_STEP_CD, 'X') , '100', D7.IDVT_INDEX_VAL, '200', D6.SYT_EVL_ADVL_VAL , 'X', (SELECT AS EVL_STEP_CD
FROM TBCSPAOE010D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND AUD_TSK_KND_CD = D5.ADT_KDCD AND RK_CD = ( SELECT ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX )) , 0) AS SYT_EVL_ADVL_VAL /*종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다.*/ , (SELECT NVL(SUM(DRIVE_RTE), 0)
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX ) AS DRIVE_RTE_SUM /*추진율*/ , (SELECT SUM(TO_NUMBER(DLAY_DT_NM-(NVL(EXET_DCN,0))))
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX ) AS DLY_DT_SUM /*지연일*/ , D6.EVL_YR , D6.HLYR_DVSN_CD , D5.SYT_TRTM_YN , D6.SPE_ADD_SC , D6.MDT_ASC FROM ( SELECT D2.HNDL_DIV_DPT_CD,
    D2.SPVR_ENO /* 감리원직원전산번호 */,
    D2.ADT_KDCD /* 감사종류코드 */,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO,
    D2.ADT_MTTR_NM /* 감사사항명 */,
    D1.AUD_STEP_CD_MIN,
    D1.AUD_STEP_CD_MAX,
    D2.MNDY_CNT,
    ( SELECT NVL(SYT_TRTM_YN, 'N')
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND TSK_NO = D1.TSK_NO AND ADT_STP_SECD = '10004' ) AS SYT_TRTM_YN /*종합처리안 여부*/ FROM ( SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D1 , TBCSPAOE021M D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO ) D5 /*평가대상 감사활동 - 기준*/ , ( SELECT D8.AUD_TSK_KND_CD,
    D8.CVLCPT_ADT_YR /* 민원감사년도 */,
    D8.TSK_NO,
    D8.SYT_EVL_ADVL_VAL,
    D8.EVL_YR,
    D8.HLYR_DVSN_CD,
    D8.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D8.EVL_RK_CD,
    D8.SYT_EVL_RK_CD,
    D8.EVL_STEP_CD,
    D8.SPE_ADD_SC,
    D8.MDT_ASC
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD) AS EVL_STEP_CD,
    AUD_TSK_KND_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM TBCSPAOE029M WHERE 1=1 AND CVLCPT_TASK_SECD = '10000' AND EVL_STA_CD = '300' /*평가완료*/ AND (CVLCPT_ADT_YR, TSK_NO, EVL_STEP_CD) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD)
FROM TBCSPAOE029M WHERE (CVLCPT_ADT_YR,TSK_NO) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY EVL_YR, HLYR_DVSN_CD, CVLCPT_ADT_YR, TSK_NO, AUD_TSK_KND_CD, CVLCPT_TASK_SECD /*한 감사사항이 귀청보고평가, 위원평가를 받을 수 있기때문에 이렇게 한번 걸러내는 작업을 함*/ ) D7 , TBCSPAOE029M D8 WHERE D7.EVL_YR = D8.EVL_YR AND D7.HLYR_DVSN_CD = D8.HLYR_DVSN_CD AND D7.CVLCPT_TASK_SECD = D8.CVLCPT_TASK_SECD AND D7.AUD_TSK_KND_CD = D8.AUD_TSK_KND_CD AND D7.EVL_STEP_CD = D8.EVL_STEP_CD AND D7.CVLCPT_ADT_YR = D8.CVLCPT_ADT_YR AND D7.TSK_NO = D8.TSK_NO ) D6 /*감사사항 평가관리*/ , TBCSPAOE010D D7 WHERE D5.ADT_KDCD = D6.AUD_TSK_KND_CD (+) AND D5.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR (+) AND D5.TSK_NO = D6.TSK_NO (+) AND D6.EVL_YR = D7.EVL_YR (+) AND D6.HLYR_DVSN_CD = D7.HLYR_DVSN_CD (+) AND D6.CVLCPT_TASK_SECD = D7.CVLCPT_TASK_SECD (+) AND D6.AUD_TSK_KND_CD = D7.AUD_TSK_KND_CD (+) AND D6.EVL_RK_CD = D7.RK_CD (+) ) D9 ) D10 , (SELECT /*+ USE_NL(A02) INDEX(A02 IDX_TBCSPAOE023M_01) */ A02.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    A02.TSK_NO,
    A02.ADT_STP_SECD /* 감사단계구분코드 */,
    A02.PTCPT_CNB,
    A02.CTB_RT /* 기여비율 */,
    A02.BLT_DPT_CD,
    rownum
FROM (SELECT MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO) A01 , TBCSPAOE023M A02 WHERE A02.CVLCPT_ADT_YR = A01.CVLCPT_ADT_YR AND A02.TSK_NO = A01.TSK_NO AND A02.ADT_STP_SECD = A01.AUD_STEP_CD_MAX AND A02.CTB_RT != 0 AND EXISTS (SELECT /*+ NO_UNNEST */ 'Y'
FROM TBCSPAOE041M Z WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_DVSN_CD ='10' AND A02.PTCPT_CNB = Z.TRGT_NOP_ENO) ) D11 WHERE D10.CVLCPT_ADT_YR = D11.CVLCPT_ADT_YR AND D10.TSK_NO = D11.TSK_NO AND D10.AUD_STEP_CD_MAX = D11.ADT_STP_SECD ) D19 ) D20 ) ) GROUP BY EVL_YR, HLYR_DVSN_CD, NEVLT_CNB ) BASE , ( SELECT EVL_DPT_CD,
    TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    EVL_TG_YN /* 평가대상여부 */,
    RMRK_CN /* 비고내용 */,
    DPT_DVSN_CD /* 부서구분코드 */,
    HIRK_DPT_CD,
    JBGD_SECD /* 직급구분코드 */,
    EVL_YR,
    HLYR_DVSN_CD
FROM TBCSPAOE041M D18 , TBDCMACM002M D19 WHERE D18.EVL_DPT_CD = D19.SRECS_DEPT_CD AND D18.EVL_YR = #strEvlYr# AND D18.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D18.DPT_DVSN_CD = '10' ) D21 , TBDCMACM001M D20 WHERE BASE.NEVLT_CNB (+) = D21.TRGT_NOP_ENO AND D21.TRGT_NOP_ENO = D20.TRGT_NOP_ENO ) ) MAIN , TBDCMACM002M DPT WHERE MAIN.BLT_DPT_CD = DPT.SRECS_DEPT_CD (+) ORDER BY DECODE(EVL_TG_YN, 'Y', 1, 2), JBGD_SECD, RANK_NUM ) WHERE 1 = 1 AND JBGD_SECD = #JBGD_SECD# AND EVL_DPT_UP_CD = #strDeptUpCd# AND EVL_DPT_CD = #strDeptCd#