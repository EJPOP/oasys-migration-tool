DECLARE BEGIN UPDATE TB_BADDED145M MT1 SET MT1.CMPTN_YN = 'Y' /* 완료여부 */,  MT1.LAST_USER_ID = #LAST_USER_ID# /* 최종사용자아이디 */,  MT1.LAST_PRCS_DEPT_CD = #LAST_PRCS_DEPT_CD# /* 최종처리부서코드 */,  MT1.LAST_MENU_ID = #LAST_MENU_ID# /* 최종메뉴아이디 */,  MT1.LAST_MDFCN_DT = SYSDATE /* 최종수정일시 */WHERE MT1.ADT_YR = #CVLCPT_ADT_YR# AND MT1.ADT_NO = #ADT_NO# AND MT1.APRVR_JBPS_SECD = 'A1070' AND EXISTS (SELECT 1
FROM TB_BADDED113M T1 INNER JOIN TB_BADDED145M T2 ON (T1.ADT_YR = T2.CVLCPT_ADT_YR AND T1.ADT_NO = T2.ADT_NO AND T1.APRVR_JBPS_SECD = T2.APRVR_JBPS_SECD AND T1.DOC_ID = T2.CVLCPT_DOC_ID AND T1.INCDNT_SQNO = T2.INCDNT_SQNO AND T2.CMPTN_YN = 'Y' AND T2.APRVR_JBPS_SECD = '0010600') INNER JOIN TB_BADDED146M T3 ON (T1.ADT_YR = T3.CVLCPT_ADT_YR AND T1.ADT_NO = T3.ADT_NO AND T2.ADT_STP_SECD = T3.ADT_STP_SECD AND T1.APRVR_JBPS_SECD = T3.APRVR_JBPS_SECD AND T1.DOC_ID = T3.CVLCPT_DOC_ID AND T1.INCDNT_SQNO = T3.INCDNT_SQNO AND T1.DSPS_RQT_SQNO = T3.DSPS_RQT_SQNO AND T2.CMPTN_YN = 'Y' AND T2.APRVR_JBPS_SECD = '0010600') INNER JOIN TB_BADDED147M T4 ON (T4.CVLCPT_ADT_YR = T1.ADT_YR AND T4.ADT_NO = T1.ADT_NO AND T4.APRVR_JBPS_SECD = 'A1070' AND T4.BFR_INCDNT_NO = F_MNG_KND_AUDYRNO(T1.ADT_YR, T1.ADT_NO, T1.ADT_KDCD, '-') || '-' || T2.INCDNT_KDCD || '-' || T3.INCDNT_DSPS_TPCD) WHERE T1.ADT_YR = MT1.ADT_YR AND T1.ADT_NO = MT1.ADT_NO AND T1.DOC_ID = MT1.DOC_ID AND T4.INCDNT_SQNO = MT1.INCDNT_SQNO AND T1.SBCN_DCS_SECD IS NOT NULL) ; INSERT INTO TB_BADDED145H (HSTRY_SECD, FNNC_INFO_SBMSN_RQT_HSTRY_SQNO, CVLCPT_HSTRY_DT, HSTRY_USER_ID, CVLCPT_ADT_YR, ADT_NO, ADT_STP_SECD, CVLCPT_DOC_ID, APRVR_JBPS_SECD, INCDNT_SQNO, ADT_KDCD, ADT_GRNT_NO, RPTP_FLD_ID, INCDNT_KDCD, LIST_SQNO, SBCN_SECD, INCDNT_FLD_CN, SBCM_AGND_NM, INDCT_TTL, QPB_YN, QPB_YMD, ADTR_NM, DTL_DOC_NO, DATA_INPT_SECD, SNTHS_DPP_SE_YN, SCRT_YN /* 증권여부 */, SRECS_SORT_SQNO, DPP_RVWR_ENO, CMPTN_YN, FRST_USER_ID, LAST_USER_ID, LAST_PRCS_DEPT_CD, LAST_MENU_ID, FRST_REG_DT, LAST_MDFCN_DT, RFRNC_DOC_ID) SELECT 'U',
    TBBADDED145H_SEQ.NEXTVAL,
    SYSDATE,
    #LAST_USER_ID# AS LAST_USER_ID /* 최종사용자아이디 */,
    MT1.ADT_YR /* 감사년도 */,
    MT1.ADT_NO /* 감사번호 */,
    MT1.ADT_STP_SECD /* 감사단계구분코드 */,
    MT1.DOC_ID /* 문서아이디 */,
    MT1.APRVR_JBPS_SECD /* 결재자직위구분코드 */,
    MT1.INCDNT_SQNO /* 사건순번 */,
    MT1.ADT_KDCD /* 감사종류코드 */,
    MT1.ADT_GRNT_NO /* 감사부여번호 */,
    MT1.RPTP_FLD_ID /* 보고서분야아이디 */,
    MT1.INCDNT_KDCD /* 사건종류코드 */,
    MT1.LIST_SQNO /* 목록순번 */,
    MT1.SBCN_SECD /* 부의구분코드 */,
    MT1.INCDNT_FLD_CN /* 사건분야내용 */,
    MT1.INCDNT_NM /* 사건명 */,
    MT1.INDCT_TTL /* 표시제목 */,
    MT1.QPB_YN /* 질문서발부여부 */,
    MT1.QPB_YMD /* 질문서발부일자 */,
    MT1.ADTR_NM /* 감사인명 */,
    MT1.DTL_DOC_NO /* 상세문서번호 */,
    MT1.DATA_INPT_SECD /* 자료입력구분코드 */,
    MT1.SNTHS_DPP_SE_YN /* 종합처리안구분여부 */,
    MT1.SCRT_YN /* 증권여부 */,
    MT1.SORT_SQNO /* 정렬순번 */,
    MT1.DPP_RVWR_ENO /* 처리안검토자직원전산번호 */,
    MT1.CMPTN_YN /* 완료여부 */,
    MT1.FRST_USER_ID /* 최초사용자아이디 */,
    MT1.LAST_USER_ID /* 최종사용자아이디 */,
    MT1.LAST_PRCS_DEPT_CD /* 최종처리부서코드 */,
    MT1.LAST_MENU_ID /* 최종메뉴아이디 */,
    MT1.FRST_REG_DT /* 최초등록일시 */,
    MT1.LAST_MDFCN_DT /* 최종수정일시 */,
    MT1.LAST_ADT_RPTP_RFRNC_DOC_ID /* 최종감사보고서참조문서아이디 */
FROM TB_BADDED145M MT1 WHERE MT1.ADT_YR = #CVLCPT_ADT_YR# AND MT1.ADT_NO = #ADT_NO# AND MT1.APRVR_JBPS_SECD = 'A1070' AND EXISTS (SELECT 1
FROM TB_BADDED113M T1 INNER JOIN TB_BADDED145M T2 ON (T1.ADT_YR = T2.CVLCPT_ADT_YR AND T1.ADT_NO = T2.ADT_NO AND T1.APRVR_JBPS_SECD = T2.APRVR_JBPS_SECD AND T1.DOC_ID = T2.CVLCPT_DOC_ID AND T1.INCDNT_SQNO = T2.INCDNT_SQNO AND T2.CMPTN_YN = 'Y' AND T2.APRVR_JBPS_SECD = '0010600') INNER JOIN TB_BADDED146M T3 ON (T1.ADT_YR = T3.CVLCPT_ADT_YR AND T1.ADT_NO = T3.ADT_NO AND T2.ADT_STP_SECD = T3.ADT_STP_SECD AND T1.APRVR_JBPS_SECD = T3.APRVR_JBPS_SECD AND T1.DOC_ID = T3.CVLCPT_DOC_ID AND T1.INCDNT_SQNO = T3.INCDNT_SQNO AND T1.DSPS_RQT_SQNO = T3.DSPS_RQT_SQNO AND T2.CMPTN_YN = 'Y' AND T2.APRVR_JBPS_SECD = '0010600') INNER JOIN TB_BADDED147M T4 ON (T4.CVLCPT_ADT_YR = T1.ADT_YR AND T4.ADT_NO = T1.ADT_NO AND T4.APRVR_JBPS_SECD = 'A1070' AND T4.BFR_INCDNT_NO = F_MNG_KND_AUDYRNO(T1.ADT_YR, T1.ADT_NO, T1.ADT_KDCD, '-') || '-' || T2.INCDNT_KDCD || '-' || T3.INCDNT_DSPS_TPCD) WHERE T1.ADT_YR = MT1.ADT_YR AND T1.ADT_NO = MT1.ADT_NO AND T1.DOC_ID = MT1.DOC_ID AND T4.INCDNT_SQNO = MT1.INCDNT_SQNO AND T1.SBCN_DCS_SECD IS NOT NULL) ; END;