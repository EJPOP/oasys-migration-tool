WITH BASE AS ( SELECT '1' AS USER_HSTRY_SECD /* 사용자이력구분코드 */,
    '신청액' AS SE_NM /* 구분명 */,
    (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP IN ('2','3','6','7') AND SPH IN ('01','08')) AS COL1, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP IN ('2','3','6','7') AND SPH IN ('02','06','07')) AS COL2, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP IN ('2','3','6','7') AND SPH = '03') AS COL3, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP IN ('2','3','6','7') AND SPH = '04') AS COL4, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP IN ('2','3','6','7')) AS TOTAL FROM DUAL UNION ALL SELECT '2' AS USER_HSTRY_SECD /* 사용자이력구분코드 */,
    '확정액' AS SE_NM /* 구분명 */,
    (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP = '7' AND SPH IN ('01','08')) AS COL1, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP = '7' AND SPH IN ('02','06','07')) AS COL2, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP = '7' AND SPH = '03') AS COL3, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP = '7' AND SPH = '04') AS COL4, (SELECT NVL(SUM(PMT_AM),0)
FROM TBDCMACM065M WHERE LINK_YR = #LINK_YR# AND HNDL_STEP = '7') AS TOTAL FROM DUAL ) SELECT SE_NM /* 구분명 */,
    COL1,
    COL2,
    COL3,
    COL4
FROM BASE UNION ALL SELECT '집행률(각 항목 확정액/전체 확정액)' AS SE_NM /* 구분명 */,
    ROUND((SELECT DECODE(NVL(TOTAL,0),0,0, NVL(COL1,0) / TOTAL)
FROM BASE WHERE USER_HSTRY_SECD = '2'),2) * 100 AS COL1, ROUND((SELECT DECODE(NVL(TOTAL,0),0,0, NVL(COL2,0) / TOTAL)
FROM BASE WHERE USER_HSTRY_SECD = '2'),2) * 100 AS COL2, ROUND((SELECT DECODE(NVL(TOTAL,0),0,0, NVL(COL3,0) / TOTAL)
FROM BASE WHERE USER_HSTRY_SECD = '2'),2) * 100 AS COL3, ROUND((SELECT DECODE(NVL(TOTAL,0),0,0, NVL(COL4,0) / TOTAL)
FROM BASE WHERE USER_HSTRY_SECD = '2'),2) * 100 AS COL4 FROM DUAL