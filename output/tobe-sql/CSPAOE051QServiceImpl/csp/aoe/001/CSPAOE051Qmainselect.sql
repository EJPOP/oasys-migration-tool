SELECT NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D2.ADT_KDCD, '-'),D1.EVL_YR_TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연변호 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    D1.HIRK_DPT_NM /* 국 */,
    D1.HNDL_DIV_DPT_NM /* 과 */,
    D1.AUD_KND_NM /* 감사종류 */,
    D1.MNDY_CNT /* 연인원 */,
    D1.PTCPT_CNT /* 단계기말 참여인원수 */,
    D1.DPT_DIV /* 구분 */,
    D1.CRU_OGDP_DEPT_NM /* 부패소속부서명 */,
    D1.JBGD_SECD /* 직급구분코드 */,
    D1.JBGD_NM /* 직급명 */,
    D1.PTCPT_NM /* 성명 */,
    D1.PTCPT_CNB,
    D1.JON_DVSN_CD,
    D1.JON_DVSN_NM /* 참여구분 */,
    D1.CTB_RT /* 기여비율 */,
    D1.EVL_RFR_SBJ_TXT /* 평가참고사항내용 */,
    DECODE(CTB_RTE_A, 0, 0||'(' || 0 || '/' || 0 || ')', ROUND(CTB_RTE_A/PTCPT_CNT_A, 2) || '(' || CTB_RTE_A || '/' || PTCPT_CNT_A || ')' ) AS CTB_RTE_A /* 주관부서 기여율 합계 */,
    DECODE(CTB_RTE_B, 0, 0||'(' || 0 || '/' || 0 || ')', ROUND(CTB_RTE_B/PTCPT_CNT_B, 2) || '(' || CTB_RTE_B || '/' || PTCPT_CNT_B || ')' ) AS CTB_RTE_B /* 지원부서 기여율 합계 */,
    DENSE_RANK() OVER(ORDER BY EVL_YR_TSK_NO) AS DENSE_RANK,
    D1.HNDL_DIV_DPT_CD,
    (SELECT A.DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = HNDL_DIV_DPT_CD) AS DPT_SNO , (SELECT (CASE WHEN A.DPT_SNO != '32' THEN '0' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '150' THEN '1' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '141' THEN '2' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '100' THEN '3' END) AS DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = HNDL_DIV_DPT_CD) AS DPT_SNO2 , BLT_DPT_CD , (SELECT A.DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = BLT_DPT_CD) AS DPT_SNO3 , (SELECT (CASE WHEN A.DPT_SNO != '32' THEN '0' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '150' THEN '1' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '141' THEN '2' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '100' THEN '3' END) AS DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = BLT_DPT_CD) AS DPT_SNO4 FROM ( SELECT D3.CVLCPT_ADT_YR || '-' || D3.TSK_NO AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D3.HIRK_DPT_NM /* 국 */,
    D3.HNDL_DIV_DPT_CD,
    D3.HNDL_DIV_DPT_NM /* 과 */,
    F_CODE_NM('1000270', D3.ADT_KDCD) AS F_CODE_NM /* 감사종류 */,
    D3.MNDY_CNT /* 연인원 */,
    ( SELECT COUNT(PTCPT_CNB) AS PTCPT_CNB
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO AND ADT_STP_SECD = D3.AUD_STEP_CD_MAX ) AS PTCPT_CNT /*단계기말 참여인원수*/ , ( SELECT COUNT(PTCPT_CNB) AS PTCPT_CNB
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO AND ADT_STP_SECD = D3.AUD_STEP_CD_MAX AND BLT_DPT_CD = D3.HNDL_DIV_DPT_CD ) AS PTCPT_CNT_A /*주관부서 단계기말 참여인원수*/ , ( SELECT COUNT(PTCPT_CNB) AS PTCPT_CNB
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO AND ADT_STP_SECD = D3.AUD_STEP_CD_MAX AND BLT_DPT_CD != D3.HNDL_DIV_DPT_CD ) AS PTCPT_CNT_B /*지원부서 단계기말 참여인원수*/ , D3.DPT_DIV /*구분*/ , D3.BLT_DPT_CD , F_DPT_INFO(D3.BLT_DPT_CD, '1') AS CRU_OGDP_DEPT_NM /*소속부서*/ , D3.JBGD_SECD , F_CODE_NM('1000173', D3.JBGD_SECD) AS JBGD_NM /*직급명*/ , F_USR_INFO(D3.PTCPT_CNB, '2') AS PTCPT_NM /*성명*/ , D3.PTCPT_CNB , D3.JON_DVSN_CD , F_CODE_NM('1000278', D3.JON_DVSN_CD) AS JON_DVSN_NM /*참여구분*/ , D3.CTB_RT /*기여율*/ , D3.EVL_RFR_SBJ_TXT /*평가참고사항내용*/ , (SELECT NVL(SUM(CTB_RT), 0) AS CTB_RT /* 기여비율 */
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO AND ADT_STP_SECD = D3.AUD_STEP_CD_MAX AND BLT_DPT_CD = D3.HNDL_DIV_DPT_CD ) AS CTB_RTE_A /*주관부서 기여율 합계*/ , (SELECT NVL(SUM(CTB_RT), 0) AS CTB_RT /* 기여비율 */
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO AND ADT_STP_SECD = D3.AUD_STEP_CD_MAX AND BLT_DPT_CD != D3.HNDL_DIV_DPT_CD ) AS CTB_RTE_B /*지원부서 기여율 합계*/ , D3.TSK_NO FROM ( /*주관부서 평균*/ SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO /* 업무번호 */,
    D1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    D1.HNDL_DIV_DPT_CD,
    F_DPT_INFO(DECODE(D3.HIRK_DPT_CD, NULL, D1.HNDL_DIV_DPT_CD, D3.HIRK_DPT_CD), '1') AS F_DPT_INFO /* 국 */,
    F_DPT_INFO(D1.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 과 */,
    D1.ADT_KDCD /* 감사종류코드 */,
    D1.MNDY_CNT AS MNDY_CNT /* 연인원 */,
    '주관부서' AS DPT_DIV,
    D2.BLT_DPT_CD /* 소속부서 */,
    D2.JBGD_SECD /* 직급구분코드 */,
    D2.PTCPT_CNB /* 성명 */,
    D2.JON_DVSN_CD /* 참여구분 */,
    D2.CTB_RT /* 기여비율 */,
    D2.EVL_RFR_SBJ_TXT /* 평가참고사항내용 */,
    D2.ADT_STP_SECD /* 감사단계구분코드 */,
    1
FROM TBCSPAOE021M D1 , ( SELECT D6.CVLCPT_ADT_YR /* 민원감사년도 */,
    D6.TSK_NO,
    D6.BLT_DPT_CD /* 소속부서 */,
    D6.JBGD_SECD /* 직급구분코드 */,
    D6.PTCPT_CNB /* 성명 */,
    D6.JON_DVSN_CD /* 참여구분 */,
    D6.CTB_RT /* 기여비율 */,
    D6.EVL_RFR_SBJ_TXT /* 평가참고사항내용 */,
    D6.ADT_STP_SECD /* 감사단계구분코드 */
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D5 , TBCSPAOE023M D6 WHERE D5.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR AND D5.TSK_NO = D6.TSK_NO AND D5.AUD_STEP_CD_MAX = D6.ADT_STP_SECD ) D2 , TBDCMACM002M D3 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD = D2.BLT_DPT_CD AND D1.HNDL_DIV_DPT_CD = D3.SRECS_DEPT_CD UNION ALL /*지원부서 평균*/ SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO /* 업무번호 */,
    D1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    D1.HNDL_DIV_DPT_CD,
    F_DPT_INFO(DECODE(D3.HIRK_DPT_CD, NULL, D1.HNDL_DIV_DPT_CD, D3.HIRK_DPT_CD), '1') AS F_DPT_INFO /* 국 */,
    F_DPT_INFO(D1.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 과 */,
    D1.ADT_KDCD /* 감사종류코드 */,
    D1.MNDY_CNT AS MNDY_CNT /* 연인원 */,
    '지원부서' AS DPT_DIV,
    D2.BLT_DPT_CD /* 소속부서 */,
    D2.JBGD_SECD /* 직급구분코드 */,
    D2.PTCPT_CNB /* 성명 */,
    D2.JON_DVSN_CD /* 참여구분 */,
    D2.CTB_RT /* 기여비율 */,
    D2.EVL_RFR_SBJ_TXT /* 평가참고사항내용 */,
    D2.ADT_STP_SECD /* 감사단계구분코드 */,
    2
FROM TBCSPAOE021M D1 , ( SELECT D6.CVLCPT_ADT_YR /* 민원감사년도 */,
    D6.TSK_NO,
    D6.BLT_DPT_CD /* 소속부서 */,
    D6.JBGD_SECD /* 직급구분코드 */,
    D6.PTCPT_CNB /* 성명 */,
    D6.JON_DVSN_CD /* 참여구분 */,
    D6.CTB_RT /* 기여비율 */,
    D6.EVL_RFR_SBJ_TXT /* 평가참고사항내용 */,
    D6.ADT_STP_SECD /* 감사단계구분코드 */
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D5 , TBCSPAOE023M D6 WHERE D5.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR AND D5.TSK_NO = D6.TSK_NO AND D5.AUD_STEP_CD_MAX = D6.ADT_STP_SECD ) D2 , TBDCMACM002M D3 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD != D2.BLT_DPT_CD AND D1.HNDL_DIV_DPT_CD = D3.SRECS_DEPT_CD ORDER BY HNDL_DIV_DPT_CD, ORD, JON_DVSN_CD ) D3 WHERE 1 = 1 AND D3.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D3.ADT_MTTR_NM LIKE '%' || #strAudSbjNm# || '%' ) D1 ,TB_BADDED001M D2 WHERE 1 = 1 AND D1.CVLCPT_ADT_YR = D2.ADT_YR(+) AND D1.TSK_NO = D2.ADT_NO(+) AND CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D2.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D1.tsk_no = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D2.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) ORDER BY DPT_SNO, DPT_SNO2, HNDL_DIV_DPT_CD, EVL_YR_TSK_NO, JON_DVSN_CD DESC, DPT_SNO3, DPT_SNO4, BLT_DPT_CD, JBGD_SECD