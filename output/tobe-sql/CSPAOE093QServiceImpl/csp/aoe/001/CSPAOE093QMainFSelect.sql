SELECT F_DPT_INFO(DEPT.HIRK_DPT_CD, '1') AS F_DPT_INFO /* 부서명(국) */,
    F_DPT_INFO(BASE.SRECS_DEPT_CD, '1') AS CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    F_CODE_NM('1000274', '600') AS F_CODE_NM /* 상급자 평가등급 - 보통 */,
    BASE.SUM_TSK_ASC_1 /* 평가위원 평점 1 ~ 25명 */,
    BASE.SUM_TSK_ASC_2,
    BASE.SUM_TSK_ASC_3,
    BASE.SUM_TSK_ASC_4,
    BASE.SUM_TSK_ASC_5,
    BASE.SUM_TSK_ASC_6,
    BASE.SUM_TSK_ASC_7,
    BASE.SUM_TSK_ASC_8,
    BASE.SUM_TSK_ASC_9,
    BASE.SUM_TSK_ASC_10,
    BASE.SUM_TSK_ASC_11,
    BASE.SUM_TSK_ASC_12,
    BASE.SUM_TSK_ASC_13,
    BASE.SUM_TSK_ASC_14,
    BASE.SUM_TSK_ASC_15,
    BASE.SUM_TSK_ASC_16,
    BASE.SUM_TSK_ASC_17,
    BASE.SUM_TSK_ASC_18,
    BASE.SUM_TSK_ASC_19,
    BASE.SUM_TSK_ASC_20,
    BASE.SUM_TSK_ASC_21,
    BASE.SUM_TSK_ASC_22,
    BASE.SUM_TSK_ASC_23,
    BASE.SUM_TSK_ASC_24,
    BASE.SUM_TSK_ASC_25,
    CASE WHEN CNT > 2 THEN ROUND(SUM_TSK_ASC - SUM_TSK_ASC_MIN - SUM_TSK_ASC_MAX, 2) ELSE NULL END AS CNT /* 총점 - 3명 이상이 평가 했어야지 최고점과 최저점을 뺄수 있으니깐. */,
    CASE WHEN CNT > 2 THEN ROUND((SUM_TSK_ASC - SUM_TSK_ASC_MIN - SUM_TSK_ASC_MAX) / (CNT-2), 2) ELSE NULL END AS CNT /* 평균 - 총점/ (평가인원-2) 두명의 점수를 제외하므로 */
FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    SUM(DECODE(D2.EVL_CMTR_NO, 1, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 2, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 3, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 4, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 5, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 6, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 7, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 8, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 9, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 10, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 11, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 12, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 13, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 14, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 15, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 16, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 17, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 18, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 19, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 20, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 21, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 22, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 23, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 24, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO,
    SUM(DECODE(D2.EVL_CMTR_NO, 25, D1.SUM_TSK_ASC, NULL)) AS EVL_CMTR_NO
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    EVL_CMTR_CNB /* 평가위원전산번호 */,
    SUM(TSK_ASC) AS TSK_ASC /* 업무평점 합 */
FROM TBCSPAOE031M D1 WHERE 1 = 1 AND EVL_STEP_CD = '500' /*위원평가*/ AND EVL_DTM_YN = 'Y' /*평가확정*/ AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND SRECS_DEPT_CD = #SRECS_DEPT_CD# GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD, EVL_CMTR_CNB ) D1 , ( /*평가자 리스트*/ SELECT EVL_YR,
    HLYR_DVSN_CD,
    PIC_ENO /* 담당자직원전산번호 */,
    ROW_NUMBER() OVER (ORDER BY EVL_CMTR_NO) AS ROW_NUMBER
FROM TBCSPAOE017D WHERE 1 = 1 AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10002' AND AUD_TSK_KND_CD = '10000' AND CHGR_DVSN_CD = 'CD03' ) D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.EVL_CMTR_CNB = D2.PIC_ENO GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.SRECS_DEPT_CD ) BASE , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    MIN(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(SUM_TSK_ASC) AS SUM_TSK_ASC,
    SUM(SUM_TSK_ASC) AS SUM_TSK_ASC,
    MAX(CNT) AS CNT /* 평균을 구하기 위해서 총 평가자 수 */
FROM ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    EVL_CMTR_CNB /* 평가위원전산번호 */,
    SUM(TSK_ASC) AS TSK_ASC /* 업무평점 합 */,
    COUNT(*) OVER(PARTITION BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD) AS OVER
FROM TBCSPAOE031M D1 WHERE 1 = 1 AND EVL_STEP_CD = '500' /*위원평가*/ AND EVL_DTM_YN = 'Y' /*평가확정*/ AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND SRECS_DEPT_CD = #SRECS_DEPT_CD# GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD, EVL_CMTR_CNB ) GROUP BY EVL_YR, HLYR_DVSN_CD, SRECS_DEPT_CD ) JUMSU /*총점과 최고점과 최저점*/ , TBDCMACM002M DEPT WHERE BASE.EVL_YR = JUMSU.EVL_YR AND BASE.HLYR_DVSN_CD = JUMSU.HLYR_DVSN_CD AND BASE.SRECS_DEPT_CD = JUMSU.SRECS_DEPT_CD AND BASE.SRECS_DEPT_CD = DEPT.SRECS_DEPT_CD ORDER BY BASE.SRECS_DEPT_CD