SELECT *
FROM ( SELECT D1.REL_ADT_YR||'-'||D1.REL_ADT_NO||'-'||D1.CVLCPT_ADT_STP_SQNO AS REL_ADT_YR /* 관계감사년도 */,
    F_MNG_KND_AUDYRNO(D5.CVLCPT_ADT_YR, D5.ADT_NO, D5.ADT_KDCD, '-') AS F_MNG_KND_AUDYRNO /* 실지감사 연번호 */,
    CASE WHEN D5.ADT_BGNG_YMD IS NOT NULL THEN TO_CHAR(TO_DATE(D5.ADT_BGNG_YMD), 'YYYY-MM-DD')||'~' || TO_CHAR(TO_DATE(D5.ADT_END_YMD), 'YYYY-MM-DD') ELSE '' END AS ADT_BGNG_YMD /* 감사시작일자 */,
    F_MNG_KND_AUDYRNO(D1.REL_ADT_YR, D1.REL_ADT_NO, D2.ADT_KDCD, '-') ||'(' ||D1.CVLCPT_ADT_STP_SQNO || ')' AS ADT_CLSF_NO /* 감사분류번호 */,
    D1.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO AS BZTRP_SQNO /* 출장순번 */,
    F_CODE_NM('1000007',D2.ADT_KDCD) AS F_CODE_NM /* 감사종류명 */,
    D1.BZTRP_SECD AS BZTRP_SECD /* 출장구분코드 */,
    D1.ADT_BZTRP_KDCD AS ADT_BZTRP_KDCD /* 감사출장종류코드 */,
    F_CODE_NM('1000030',D1.ADT_BZTRP_KDCD) AS F_CODE_NM /* 감사출장종류명 */,
    D1.DSPS_RQT_NM AS DSPS_RQT_NM /* 처분요구명 */,
    D1.BZTRP_DEPT_CD AS BZTRP_DEPT_CD /* 출장부서코드 */,
    F_DPT_INFO(D1.BZTRP_DEPT_CD,'1') AS F_DPT_INFO /* 출장국과명 */,
    F_DPT_INFO(D2.MNG_DEPT_CD,'1') AS F_DPT_INFO /* 관리국과명 - 2016.05.27 yyh */,
    D2.SPRVSN_DEPT_CD /* 주관부서코드 */,
    TO_CHAR(TO_DATE(D1.ADT_BGNG_YMD),'YYYY-MM-DD')||'~' || TO_CHAR(TO_DATE(D1.ADT_END_YMD),'YYYY-MM-DD') AS TO_CHAR /* 실시기간 */,
    D3.PCT_CNB_CNT AS PCT_CNB_CNT /* 인원 */,
    D3.EXP_CNT AS EXP_CNT /* 전문가 인원 */,
    D4.CNT /* 수령자 */,
    CASE WHEN D1.CAL_CFMTN_YN = 'Y' THEN '확정' ELSE CASE WHEN D4.CALC_CNT>0 THEN 'Y' ELSE 'N' END END AS CAL_CFMTN_YN /* 계산확정여부 */,
    CASE WHEN D1.CLCLN_CFMTN_YN = 'Y' THEN '확정' ELSE CASE WHEN D4.ADJ_CNT>0 THEN 'Y' ELSE 'N' END END AS CLCLN_CFMTN_YN /* 정산확정여부 */,
    D1.CAW_GIVE_YN AS CAW_GIVE_YN /* 지휘비지급여부 */,
    D1.REL_ADT_YR /* 관계감사년도 */,
    D1.REL_ADT_NO /* 관계감사번호 */,
    D1.CVLCPT_ADT_STP_SQNO /* 민원감사단계순번 */,
    D1.ADT_BGNG_YMD /* 감사시작일자 */,
    D1.ADT_END_YMD /* 감사종료일자 */,
    D1.HLDY_ACTV_SECD /* 휴일활동구분코드 */,
    NVL(D1.CNTRL_YN,'N') AS CNTRL_YN /* 통제여부 */,
    NVL(D1.TRSM_YN,'N') AS TRSM_YN /* 전송여부 */,
    D1.CAL_CFMTN_YN AS CAL_CFMTN_YN /* 계산확정여부 */,
    D1.CLCLN_CFMTN_YN AS CLCLN_CFMTN_YN /* 정산확정여부 */,
    D1.CMUS_VHCL_USE_YN AS CMUS_VHCL_USE_YN /* 공용차량사용여부 */,
    F_CODE_NM('1000751',D2.BZTRP_BGT_SECD) AS F_CODE_NM /* 예산구분 - 2021.02.05 yyh */,
    NVL( ( SELECT SUM( NVL(BTEXP_CRTR_AMT,0) + NVL(LDG_CST,0) + NVL(BZTRP_TRVEXP_FDEXP,0) + NVL(LDG_GPCD_PRCHS_CARD_EXCL_AMT,0) + NVL(CPRG_FARE_CST,0) ) AS BTEXP_CRTR_AMT /* 출장비기준금액 */
FROM TBBADDED011L WHERE 1=1 AND BZTRP_YR = D1.BZTRP_YR AND BZTRP_SQNO = D1.BZTRP_SQNO AND CAL_YN = #CAL_YN# ), 0) + NVL( ( SELECT SUM( NVL(RL_FARE_AMT,0) + NVL(TF_AMT,0) + NVL(PRK_CST,0) + NVL(RL_GPCD_PRCHS_CARD_EXCL_AMT,0) ) AS RL_FARE_AMT /* 철도운임금액 */
FROM TBBADDED017L WHERE 1=1 AND BZTRP_YR = D1.BZTRP_YR AND BZTRP_SQNO = D1.BZTRP_SQNO AND CAL_YN = #CAL_YN# ), 0) AS SUM_COST /* 여비소계(국내여비+철도임) - 2021.03.03 */ FROM TBBADDED002M D1 , TBBADDED001M D2 ,( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    COUNT(DISTINCT BZTRVR_ENO) AS BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM( DECODE(EMP_SECD,'3',1,0)) AS EMP_SECD /* 직원구분코드 */
FROM TBBADDED005L WHERE 1=1 AND BZTRP_YR = #REL_ADT_YR# GROUP BY BZTRP_YR, BZTRP_SQNO ) D3 , ( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    COUNT(DISTINCT BZTRVR_ENO) AS BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM(DECODE(CAL_YN,'N',1,0)) AS CAL_YN /* 계산여부 */,
    SUM(DECODE(CAL_YN,'Y',1,0)) AS CAL_YN /* 계산여부 */
FROM TBBADDED011L WHERE 1=1 AND BZTRP_YR = #REL_ADT_YR# GROUP BY BZTRP_YR, BZTRP_SQNO ) D4 /* 코로나로 인해 실지감사를 확인출장 원배정으로 만들어가는 형식으로 처리되면서 임시적 운영을 위해 추가 START */ , (SELECT T2.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    T2.ADT_NO AS ADT_NO /* 감사번호 */,
    T2.ADT_KDCD AS ADT_KDCD /* 감사종류코드 */,
    T2.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    T2.BZTRP_SQNO AS BZTRP_SQNO /* 출장순번 */,
    ADT_BGNG_YMD /* 감사시작일자 */,
    ADT_END_YMD /* 감사종료일자 */,
    ADT_DCN /* 감사일수 */,
    ADT_BZTRP_KDCD /* 감사출장종류코드 */
FROM TBBADDED002M T1, (SELECT A.ADT_YR AS ADT_YR /* 감사년도 */,
    A.ADT_NO AS ADT_NO /* 감사번호 */,
    A.ADT_KDCD AS ADT_KDCD /* 감사종류코드 */,
    B.REL_ADT_YR AS REL_ADT_YR /* 관계감사년도 */,
    B.REL_ADT_NO AS REL_ADT_NO /* 관계감사번호 */,
    C.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    C.BZTRP_SQNO AS BZTRP_SQNO /* 출장순번 */
FROM TBBADDED001M A INNER JOIN TBBADDED101L B ON A.CVLCPT_ADT_YR = B.CVLCPT_ADT_YR AND A.ADT_NO = B.ADT_NO AND B.ADT_STP_SECD = 'A1030' /*실지감사 의 경우 해당 A1030 조건을 필수*/ INNER JOIN TBBADDED002M C ON B.REL_ADT_YR = C.REL_ADT_YR AND B.REL_ADT_NO = C.REL_ADT_NO WHERE C.BZTRP_YR = #REL_ADT_YR# AND C.BZTRP_SQNO = BZTRP_SQNO) T2 WHERE T1.BZTRP_YR = #REL_ADT_YR# AND T1.BZTRP_SQNO = T2.BZTRP_SQNO ) D5 /* 코로나로 인해 실지감사를 확인출장 원배정으로 만들어가는 형식으로 처리되면서 임시적 운영을 위해 추가 END */ WHERE 1=1 AND D1.BZTRP_SECD = '1' /*감사출장*/ AND D1.REL_ADT_YR = D2.CVLCPT_ADT_YR AND D1.REL_ADT_NO = D2.ADT_NO AND D1.BZTRP_YR = D3.BZTRP_YR(+) AND D1.BZTRP_SQNO = D3.BZTRP_SQNO(+) AND D1.BZTRP_YR = D4.BZTRP_YR(+) AND D1.BZTRP_SQNO = D4.BZTRP_SQNO(+) AND D1.BZTRP_YR = D5.BZTRP_YR(+) AND D1.BZTRP_SQNO = D5.BZTRP_SQNO(+) AND D2.MNG_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#))) /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/ AND D1.REL_ADT_YR = #REL_ADT_YR# AND D1.REL_ADT_NO = #REL_ADT_NO# /* 감사연번종류코드 - 2015.12.18 yyh */ AND SUBSTR(D2.ADT_KDCD,3,1) = SUBSTR(#strAudYrNoKndCd#,3,1) /* 감사부여번호 조건 추가 - 2016.05.27 yyh*/ AND D2.ADT_GRNT_NO = #ADT_GRNT_NO# AND D2.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' AND D2.ADT_KDCD = #ADT_KDCD# /*감사종류코드*/ AND D1.ADT_BZTRP_KDCD = #ADT_BZTRP_KDCD# /*출장종류코드*/ AND D2.MNG_DEPT_CD = #MNG_DEPT_CD# /*주관국과*/ AND D1.CNTRL_YN = 'Y' AND D1.CNTRL_YN = 'N' AND D1.TRSM_YN = 'Y' AND D1.TRSM_YN = 'N' AND D1.BZTRP_SQNO = #BZTRP_SQNO# AND D1.BZTRP_YR = #BZTRP_YR# ) WHERE 1=1 AND (AJT_YN_N != 'N' AND CAL_CFMTN_YN = 'N') AND AJT_YN_N = 'N' AND CAL_CFMTN_YN = 'Y' AND (AJT_YN_Y != 'N' AND CLCLN_CFMTN_YN = 'N') AND AJT_YN_Y = 'N' AND CLCLN_CFMTN_YN = 'Y' ORDER BY 1 DESC