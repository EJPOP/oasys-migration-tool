SELECT D1.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO AS BZTRP_SQNO /* 출장순번 */,
    D1.BZTRVR_ENO AS BZTRVR_ENO /* 출장자직원전산번호 */,
    D1.BZTRVR_NM AS BZTRVR_NM /* 출장자명 */,
    D1.BZTRVR_NM||'('||D1.BZTRVR_ENO||')' AS BZTRVR_NM /* 출장자명 */,
    D1.BZTRVR_JBGD_SECD AS BZTRVR_JBGD_SECD /* 출장자직급구분코드 */,
    NVL(D1.LDG_CST_LIM_RMV_YN, 'N') AS LDG_CST_LIM_RMV_YN /* 숙박비용한도해제여부 */,
    F_CODE_NM('1000173', D1.BZTRVR_JBGD_SECD) AS JBGD_NM /* 직급명 */,
    D1.EMP_SECD AS EMP_SECD /* 직원구분코드 */,
    D1.DPTRE_RGN_SECD AS DPTRE_RGN_SECD /* 출발지역구분코드 */,
    D1.OGDP_DEPT_CD AS OGDP_DEPT_CD /* 소속부서코드 */,
    F_DPT_INFO(D1.OGDP_DEPT_CD,'1') AS F_DPT_INFO /* 소속국과명 */,
    D1.BANK_SECD AS BANK_SECD /* 은행구분코드 */,
    D1.ACTNO_SCRTY AS ACTNO_SCRTY /* 계좌번호보안 */,
    D1.LEAD_AEX_RCPN_YN AS LEAD_AEX_RCPN_YN /* 지휘수용비수령인여부 */,
    D3.BTEXP_CRTR_AMT AS BTEXP_CRTR_AMT /* 출장비기준금액 */,
    D3.LDG_CST AS LDG_CST /* 숙박비용 */,
    D3.BZTRP_TRVEXP_FDEXP AS BZTRP_TRVEXP_FDEXP /* 출장여비식비 */,
    D3.SPM_CST AS SPM_CST /* 보충비용 */,
    D3.BZTRP_DCN AS BZTRP_DCN /* 출장일수 */,
    NVL(D5.RL_FARE_AMT,0) + NVL(D3.CPRG_FARE_CST,0) AS RL_FARE_AMT /* 철도운임금액 */,
    CASE WHEN D2.BZTRP_TL_ENO = D1.BZTRVR_ENO THEN D4.LEAD_CST ELSE 0 END AS LEAD_CST /* 지휘비용 */,
    CASE WHEN D2.BZTRP_TL_ENO = D1.BZTRVR_ENO THEN D4.ADT_ACTV_ACTC_AMT ELSE 0 END AS ADT_ACTV_ACTC_AMT /* 감사활동수용금액 */,
    D3.SUM_COST AS SUM_COST /* 국내여비 */,
    NVL(D3.SUM_COST,0) + NVL(D5.RL_FARE_AMT,0) + NVL(D3.SPM_CST,0) + NVL(D3.CPRG_FARE_CST,0) /* 수도권운임비 추가 */ + CASE WHEN D2.BZTRP_TL_ENO = D1.BZTRVR_ENO THEN NVL(D4.ADT_ACTV_ACTC_AMT,0) + NVL(D4.LEAD_CST,0) ELSE 0 END AS SUM_COST /* 합계 */,
    D1.BZTRVR_OCPT_SECD /* 출장자직종구분코드 */,
    D1.OTSD_INST_CD /* 외부기관코드 */,
    D1.OTSD_INST_NM /* 외부기관명 */,
    CASE WHEN D6.CLCLN_CYCL IS NOT NULL THEN D6.CLCLN_CYCL||'차' ELSE '' END AS CLCLN_CYCL /* 정산차수 */,
    CASE WHEN D7.BZTRVR_ENO IS NULL THEN 'Y' ELSE 'N' END AS DEL_YN /* 삭제여부 */
FROM TB_BADDED010L D1 /*출장수령자내역*/ , ( SELECT #BZTRP_YR# AS BZTRP_YR /* 출장년도 */,
    #BZTRP_SQNO# AS BZTRP_SQNO /* 출장순번 */,
    F_LEAD_EXS_RCV_EXS_RCIT_CNB(#BZTRP_YR#,#BZTRP_SQNO#) AS BZTRP_TL_ENO /* 출장반장직원전산번호 */
FROM DUAL ) D2 /*지휘비수령자를 확인하기 위함.*/ , ( SELECT D1.BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO /* 출장순번 */,
    D1.BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM(NVL(D1.BTEXP_CRTR_AMT,0)) AS BTEXP_CRTR_AMT /* 출장비기준금액 */,
    SUM(NVL(D1.LDG_CST,0)) + SUM(NVL(D1.LDG_GPCD_PRCHS_CARD_EXCL_AMT,0)) AS LDG_CST /* 숙박비용 */,
    SUM(NVL(D1.BZTRP_TRVEXP_FDEXP,0)) AS BZTRP_TRVEXP_FDEXP /* 출장여비식비 */,
    SUM(NVL(D1.BTEXP_CRTR_AMT,0)) + SUM(NVL(D1.LDG_CST,0)) + SUM(NVL(D1.BZTRP_TRVEXP_FDEXP,0)) + SUM(NVL(D1.LDG_GPCD_PRCHS_CARD_EXCL_AMT,0)) AS BTEXP_CRTR_AMT /* 출장비기준금액 */,
    SUM(NVL(D1.SPM_CST,0)) AS SPM_CST /* 보충비용 */,
    SUM(NVL(D1.BZTRP_DCN,0)) AS BZTRP_DCN /* 출장일수 */,
    SUM(NVL(D1.CPRG_FARE_CST,0)) AS CPRG_FARE_CST /* 수도권운임비용 */
FROM TBBADDED011L D1 WHERE 1=1 AND BZTRP_YR = #BZTRP_YR# AND BZTRP_SQNO = #BZTRP_SQNO# AND CAL_YN = #CAL_YN# GROUP BY BZTRP_YR , BZTRP_SQNO , BZTRVR_ENO ) D3 /*일반경비*/ , ( SELECT D1.BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO /* 출장순번 */,
    SUM(NVL(D1.LEAD_CST,0)) AS LEAD_CST /* 지휘비용 */,
    SUM(NVL(D1.ADT_ACTV_ACTC_AMT,0)) AS ADT_ACTV_ACTC_AMT /* 감사활동수용금액 */
FROM TBBADDED011L D1 WHERE 1=1 AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# AND D1.CAL_YN = #CAL_YN# GROUP BY D1.BZTRP_YR , D1.BZTRP_SQNO ) D4 /*지휘비, 감사활동비*/ , ( SELECT D1.BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO /* 출장순번 */,
    D1.BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM( NVL(D1.RL_FARE_AMT,0) + NVL(D1.TF_AMT,0) + NVL(D1.PRK_CST,0) + NVL(D1.RL_GPCD_PRCHS_CARD_EXCL_AMT,0) ) AS RL_FARE_AMT /* 철도운임금액 */
FROM TBBADDED017L D1 WHERE 1=1 AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# AND D1.CAL_YN = #CAL_YN# GROUP BY D1.BZTRP_YR , D1.BZTRP_SQNO , D1.BZTRVR_ENO ) D5 /*철도운임비*/ , ( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */,
    MAX(CLCLN_CYCL) AS CLCLN_CYCL /* 정산차수 */
FROM TBBADDED019H GROUP BY BZTRP_YR , BZTRP_SQNO , BZTRVR_ENO ) D6 , ( SELECT DISTINCT AS BZTRP_YR,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */
FROM ( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    BZTRP_TL_ENO AS BZTRP_TL_ENO /* 출장반장직원전산번호 */
FROM TBBADDED002M WHERE 1=1 AND BZTRP_YR = #BZTRP_YR# AND BZTRP_SQNO = #BZTRP_SQNO# UNION ALL SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */
FROM TBBADDED005L WHERE 1=1 AND BZTRP_YR = #BZTRP_YR# AND BZTRP_SQNO = #BZTRP_SQNO# ) ) D7 WHERE 1=1 AND D1.BZTRP_YR = D2.BZTRP_YR AND D1.BZTRP_SQNO = D2.BZTRP_SQNO AND D1.BZTRP_YR = D3.BZTRP_YR(+) AND D1.BZTRP_SQNO = D3.BZTRP_SQNO(+) AND D1.BZTRVR_ENO = D3.BZTRVR_ENO(+) AND D1.BZTRP_YR = D4.BZTRP_YR(+) AND D1.BZTRP_SQNO = D4.BZTRP_SQNO(+) AND D1.BZTRP_YR = D5.BZTRP_YR(+) AND D1.BZTRP_SQNO = D5.BZTRP_SQNO(+) AND D1.BZTRVR_ENO = D5.BZTRVR_ENO(+) AND D1.BZTRP_YR = D6.BZTRP_YR(+) AND D1.BZTRP_SQNO = D6.BZTRP_SQNO(+) AND D1.BZTRVR_ENO = D6.BZTRVR_ENO(+) AND D1.BZTRP_YR = D7.BZTRP_YR(+) AND D1.BZTRP_SQNO = D7.BZTRP_SQNO(+) AND D1.BZTRVR_ENO = D7.BZTRVR_ENO(+) AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# ORDER BY D1.BZTRVR_ENO