SELECT EVL_YR || '-' || TSK_NO AS EVL_YR /* 감사연번호 */,
    ADT_MTTR_NM /* 감사사항명 */,
    F_DPT_INFO(BLT_DPT_CD, '1') AS CRU_OGDP_DEPT_NM /* 부패소속부서명 */,
    PTCPT_CNT /* 참여인원 */,
    DPT_DIV /* 구분 */,
    BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    BLT_DPT_PTCPT_CNT * 100 / PTCPT_ALL_CNT AS BLT_DPT_PTCPT_CNT /* 과별 참여율 */,
    CTB_RTE_SUM /* 과별 기여율 */,
    CTB_RTE_SUM / (BLT_DPT_PTCPT_CNT * 100 / PTCPT_ALL_CNT) AS CTB_RTE_SUM /* 기여율 배분수치 */
FROM ( SELECT D3.EVL_YR,
    D3.HLYR_DVSN_CD,
    D3.TSK_NO,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D3.DPT_DIV,
    D3.BLT_DPT_CD,
    D3.BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    D3.CTB_RTE_SUM /* 과별 기여율 */,
    ( SELECT COUNT(PTCPT_CNB) AS PTCPT_CNB
FROM TBCSPAOE023M WHERE EVL_YR = D4.EVL_YR AND HLYR_DVSN_CD = D4.HLYR_DVSN_CD AND TSK_NO = D4.TSK_NO AND ADT_STP_SECD = D4.AUD_STEP_CD_MAX ) AS PTCPT_CNT /*단계기말 참여인원수*/ , D4.PTCPT_ALL_CNT /*전체 참여 인원수*/ , D3.ORD FROM ( /*주관부서*/ SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.TSK_NO,
    MAX(D1.ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */,
    '주관부서' AS DPT_DIV,
    D2.BLT_DPT_CD,
    COUNT(*) OVER(PARTITION BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO, D2.BLT_DPT_CD) AS OVER /* 과별 참여인원 */,
    SUM(CTB_RT) AS CTB_RT /* 기여비율 */,
    1
FROM TBCSPAOE021M D1 , TBCSPAOE023M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD = D2.BLT_DPT_CD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO, D2.BLT_DPT_CD UNION ALL /*지원부서*/ SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.TSK_NO,
    MAX(D1.ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */,
    '지원부서' AS DPT_DIV,
    D2.BLT_DPT_CD,
    COUNT(*) OVER(PARTITION BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO, D2.BLT_DPT_CD) AS OVER /* 과별 참여인원 */,
    SUM(CTB_RT) AS CTB_RT /* 기여비율 */,
    2
FROM TBCSPAOE021M D1 , TBCSPAOE023M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD != D2.BLT_DPT_CD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO, D2.BLT_DPT_CD ) D3 , ( SELECT MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    EVL_YR,
    HLYR_DVSN_CD,
    TSK_NO,
    COUNT(*) AS PTCPT_ALL_CNT
FROM TBCSPAOE023M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY EVL_YR, HLYR_DVSN_CD, TSK_NO ) D4 /*단계기말 참여인원수*/ WHERE D3.EVL_YR = D4.EVL_YR AND D3.HLYR_DVSN_CD = D4.HLYR_DVSN_CD AND D3.TSK_NO = D4.TSK_NO ) WHERE 1 = 1 ORDER BY EVL_YR || TSK_NO, ORD