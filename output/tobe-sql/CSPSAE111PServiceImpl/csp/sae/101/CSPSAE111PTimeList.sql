SELECT D4.CRU_SORT_SQNO /* 부패정렬순번 */,
    MAX(D4.TT) AS TT,
    REPLACE(AGGR_CONCAT( NVL(D5.BLL_SBJCT_NM || DECODE(D5.BLL_SBJCT_NM, NULL, '', '(') || D5.INFO_RLPR_NM || DECODE(D5.BLL_SBJCT_NM, NULL, '', ')'), '%%'), '@' ORDER BY D4.LCT_DT ), '%%', '') AS BLL_SBJCT_NM /* 계산서과목명 */
FROM ( SELECT D6.CRU_SORT_SQNO /* 부패정렬순번 */,
    D6.TT,
    D7.LCT_DT
FROM ( SELECT D1.CRU_SORT_SQNO /* 부패정렬순번 */,
    SUBSTRING(D1.HUC_STR_HM, 0, 2) || ':' || SUBSTRING(D1.HUC_STR_HM, 3, 4) || ' ~ ' || SUBSTRING(D1.HUC_END_HM, 0, 2) || ':' || SUBSTRING(D1.HUC_END_HM, 3, 4) || DECODE(D1.HUC_TXT, '중식', ' (중식)', NULL) AS SUBSTRING
FROM TBCSPSAE111B D1 ) D6 , ( SELECT TO_CHAR(TO_DATE(A.EDU_BGNG_YMD, 'YYYYMMDD') + LEVEL-1, 'YYYYMMDD') AS TO_CHAR
FROM ( SELECT EDU_BGNG_YMD /* 교육시작일자 */,
    EDU_END_YMD /* 교육종료일자 */
FROM TBCSPSAE201D WHERE LINK_YR = #LINK_YR# AND CRS_CD = #strEDU_CRS_CD# AND CRS_CDN = #CRS_CDN#) A CONNECT BY LEVEL <= TO_DATE(A.EDU_END_YMD, 'YYYYMMDD') - TO_DATE(A.EDU_BGNG_YMD, 'YYYYMMDD') +1 AND ROWNUM <= 7 ) D7 WHERE SUBSTRING(UPPER(TO_CHAR(TO_DATE(D7.LCT_DT), 'DAY', 'NLS_DATE_LANGUAGE=KOREAN')), 0, 1) NOT IN ('토', '일') ) D4 , ( SELECT D2.HUC_TXT,
    D2.LCT_DT,
    D3.BLL_SBJCT_NM /* 계산서과목명 */,
    NVL(D5.INFO_RLPR_NM, D6.CRS_CHIF_NM) AS INFO_RLPR_NM /* 정보관계자명 */
FROM TBCSPSAE202D D2 , TBCSPSAE101M D3 , TBCSPSAE101L D4 , TBCSPSAE109M D5 , TBCSPSAE201D D6 WHERE D2.SUBJ_CD = D3.SUBJ_CD AND D4.SUBJ_CD(+) = D2.SUBJ_CD AND D5.PFSR_ID(+) = D4.PFSR_ID AND D6.LINK_YR = D2.LINK_YR AND D6.CRS_CD = D2.CRS_CD AND D6.CRS_CDN = D2.CRS_CDN AND D2.LINK_YR = #LINK_YR# AND D2.CRS_CD = #strEDU_CRS_CD# AND D2.CRS_CDN = #CRS_CDN# ) D5 WHERE D4.CRU_SORT_SQNO = D5.HUC_TXT(+) AND D4.LCT_DT = D5.LCT_DT(+) GROUP BY CRU_SORT_SQNO