SELECT D3.EVL_YR AS EVL_YR /* 평가년도 */,
    D3.HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분코드 */,
    D3.CHR_DPT_CD AS SRECS_DEPT_CD /* 부서코드 */,
    D3.TSK_NO AS TSK_NO /* 업무번호 */,
    DECODE(ROW_N , 1, D3.TSK_NM , '') AS ROW_N /* 업무명 */,
    DECODE(ROW_N , 1, D3.WGT_RTE , '') AS ROW_N /* 비중 */,
    F_USR_INFO(D3.PTCPT_CNB, '2') AS INFO_RLPR_NM /* 정보관계자명 */,
    D3.CTB_RT AS CTB_RT /* 기여비율 */,
    D3.TSK_TXT AS TSK_TXT /* 업무내용상세 */,
    D6.EVL_OPIN /* 자체평가의견 */,
    NVL(D5.EVL_STA_CD, '100') AS EVL_STA_CD /* 널이면 평가상태코드가 미평가다. */,
    NVL(D5.EVL_RK_CD, '600') AS EVL_RK_CD /* 지원업무는 평가등급이 보통이다. */,
    D3.PTCPT_CNB /* 참여자 전산번호 */,
    ROW_N AS ROW_N /* 이게 1인것만 비중컬럼 활성화 */,
    #strEvlCmtrCnb# AS #STREVLCMTRCNB# /* 평가위원 전산번호(로그인한사람) */,
    D5.EVL_OPIN AS EVL_OPIN /* 자체평가의견 */,
    F_CODE_NM('1000280', NVL(D5.EVL_STA_CD, '100')) AS F_CODE_NM /* 평가상태 */,
    MOD(DENSE_RANK() OVER(PARTITION BY D3.EVL_YR ORDER BY D3.TSK_NO) , 2) AS MOD /* 백그라운드 색깔 주기 위해서 */,
    DENSE_RANK() OVER(PARTITION BY D3.EVL_YR ORDER BY D3.TSK_NO) AS DENSE_RANK
FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CHR_DPT_CD,
    D1.TSK_NO,
    D1.TSK_TXT,
    D2.PTCPT_CNB /* 참여자 전산번호 */,
    D2.CTB_RT /* 기여비율 */,
    D1.TSK_NM,
    D1.WGT_RTE,
    ROW_NUMBER() OVER(PARTITION BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO ORDER BY D2.PTCPT_CNB) AS ROW_NUMBER /* 로우넘버를 한 이유 : 여러로우가 나와도 중복된 데이터는 맨 윗줄만 나오고 나머진 널로 처리해야해서. */
FROM TBCSPAOE026M D1 , TBCSPAOE027M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND SUBSTR(D1.CHR_DPT_CD, 0, 3) = SUBSTR(D2.CHR_DPT_CD, 0, 3) AND SUBSTR(D1.CHR_DPT_CD, 0, 3) = SUBSTR(D2.CHR_DPT_CD, 0, 3) AND D2.CHR_DPT_CD IN ('122100','122200','122300','122400','122000') AND D1.CHR_DPT_CD = D2.CHR_DPT_CD AND SUBSTR(D1.CHR_DPT_CD, 0, 3) = SUBSTR(D2.CHR_DPT_CD, 0, 3) AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CHR_DPT_CD = #SRECS_DEPT_CD# ) D3 /*지원업무 참여인원및 기여율*/ , TBCSPAOE031M D5 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    EVL_STEP_CD,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    TSK_NO,
    EVL_OPIN
FROM TBCSPAOE031M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND EVL_STEP_CD = '300' /*자체평가*/ AND SRECS_DEPT_CD = #SRECS_DEPT_CD# AND EVL_CMTR_DVSN_CD = 'CD01' /*어짜피 자체평가자는 한명뿐이다.*/ ) D6 WHERE D3.EVL_YR = D5.EVL_YR (+) AND D3.HLYR_DVSN_CD = D5.HLYR_DVSN_CD (+) AND D5.EVL_STEP_CD (+) = '400' /*상급자평가 코드*/ AND D3.CHR_DPT_CD = D5.SRECS_DEPT_CD (+) AND D3.TSK_NO = D5.TSK_NO (+) AND D5.EVL_CMTR_DVSN_CD (+) = 'CD02' /*상급자평가자 코드*/ /* AND D5.EVL_CMTR_CNB 로그인한 평가자의 전산번호 각 부서에 상급자 평가자는 한명이므로 조회조건에 필요없다.*/ AND D3.EVL_YR = D6.EVL_YR (+) AND D3.HLYR_DVSN_CD = D6.HLYR_DVSN_CD (+) AND D3.CHR_DPT_CD = D6.SRECS_DEPT_CD (+) AND D3.TSK_NO = D6.TSK_NO (+) /*자체평가자가 아직 평가 전에 상급자혹은 위원평가자가 로그인 할수 있으므로*/ ORDER BY TSK_NO, ROW_N