WITH DATA AS ( SELECT D1.TPOF_KDCD /* 제보종류코드 */,
    D2.TPOF_KND_SECD /* 제보종류구분코드 */,
    D3.SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    D1.TPOF_STTS_SECD /* 제보상태구분코드 */
FROM TB_CSPDCP101M D1 , TB_CSPDCP201M D2 , (SELECT S1.CVLCPT_CLM_SECD /* 민원청구구분코드 */,
    S1.TPOF_RCPT_YR /* 제보접수년도 */,
    S1.TPOF_RCPT_NO /* 제보접수번호 */,
    S1.TPOF_PBNST_SECD /* 제보공공기관구분코드 */
FROM TBCSPDCP206L S1 WHERE S1.CVLCPT_INST_DSCTN_SECD = 1 AND ( S1.CLM_SECD, S1.CVLCPT_RCPT_YR, S1.CVLCPT_RCPT_RCPT, S1.TPOF_PRCS_INST_SQNO ) IN ( SELECT CLM_SECD /* 청구구분코드 */,
    CVLCPT_RCPT_YR /* 민원접수년도 */,
    CVLCPT_RCPT_RCPT /* 민원접수번호 */,
    MIN(TPOF_PRCS_INST_SQNO) AS TPOF_PRCS_INST_SQNO /* 제보처리기관순번 */
FROM TBCSPDCP206L WHERE CVLCPT_INST_DSCTN_SECD = 1 GROUP BY CLM_SECD, CVLCPT_RCPT_YR, CVLCPT_RCPT_RCPT ) ) D3 WHERE 1=1 AND D1.CVLCPT_CLM_SECD = D2.CVLCPT_CLM_SECD(+) AND D1.TPOF_RCPT_YR = D2.TPOF_RCPT_YR(+) AND D1.TPOF_RCPT_NO = D2.TPOF_RCPT_NO(+) AND D1.CVLCPT_CLM_SECD = D3.CLM_SECD(+) AND D1.TPOF_RCPT_YR = D3.CVLCPT_RCPT_YR(+) AND D1.TPOF_RCPT_NO = D3.CVLCPT_RCPT_RCPT(+) AND D1.CVLCPT_CLM_SECD = 1 AND TO_CHAR(D1.TPOF_RCPT_DT, 'YYYYMMDD') BETWEEN TO_CHAR(TO_DATE(#STARTDT#, 'YYYYMMDD'), 'YYYYMMDD') AND TO_CHAR(TO_DATE(#ENDDT#, 'YYYYMMDD'), 'YYYYMMDD') AND TO_CHAR(D2.TPOF_LAST_PRCS_DT, 'YYYYMMDD') BETWEEN TO_CHAR(TO_DATE(#STARTDT#, 'YYYYMMDD'), 'YYYYMMDD') AND TO_CHAR(TO_DATE(#ENDDT#, 'YYYYMMDD'), 'YYYYMMDD') ), PRE_DATA AS ( SELECT D1.TPOF_KDCD /* 제보종류코드 */,
    D2.TPOF_KND_SECD /* 제보종류구분코드 */,
    D3.SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    D1.TPOF_STTS_SECD /* 제보상태구분코드 */
FROM TB_CSPDCP101M D1 , TB_CSPDCP201M D2 , (SELECT S1.CVLCPT_CLM_SECD /* 민원청구구분코드 */,
    S1.TPOF_RCPT_YR /* 제보접수년도 */,
    S1.TPOF_RCPT_NO /* 제보접수번호 */,
    S1.TPOF_PBNST_SECD /* 제보공공기관구분코드 */
FROM TBCSPDCP206L S1 WHERE S1.CVLCPT_INST_DSCTN_SECD = 1 AND ( S1.CLM_SECD, S1.CVLCPT_RCPT_YR, S1.CVLCPT_RCPT_RCPT, S1.TPOF_PRCS_INST_SQNO ) IN ( SELECT CLM_SECD /* 청구구분코드 */,
    CVLCPT_RCPT_YR /* 민원접수년도 */,
    CVLCPT_RCPT_RCPT /* 민원접수번호 */,
    MIN(TPOF_PRCS_INST_SQNO) AS TPOF_PRCS_INST_SQNO /* 제보처리기관순번 */
FROM TBCSPDCP206L WHERE CVLCPT_INST_DSCTN_SECD = 1 GROUP BY CLM_SECD, CVLCPT_RCPT_YR, CVLCPT_RCPT_RCPT ) ) D3 WHERE 1=1 AND D1.CVLCPT_CLM_SECD = D2.CVLCPT_CLM_SECD(+) AND D1.TPOF_RCPT_YR = D2.TPOF_RCPT_YR(+) AND D1.TPOF_RCPT_NO = D2.TPOF_RCPT_NO(+) AND D1.CVLCPT_CLM_SECD = D3.CLM_SECD(+) AND D1.TPOF_RCPT_YR = D3.CVLCPT_RCPT_YR(+) AND D1.TPOF_RCPT_NO = D3.CVLCPT_RCPT_RCPT(+) AND D1.CVLCPT_CLM_SECD = 1 AND TO_CHAR(D1.TPOF_RCPT_DT, 'YYYYMMDD') BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(TO_DATE(#STARTDT#, 'YYYYMMDD'), -12),'dd'), 'YYYYMMDD') AND TO_CHAR(TRUNC(ADD_MONTHS(TO_DATE(#ENDDT#, 'YYYYMMDD'), -12),'dd'), 'YYYYMMDD') AND TO_CHAR(D2.TPOF_LAST_PRCS_DT, 'YYYYMMDD') BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(TO_DATE(#STARTDT#, 'YYYYMMDD'), -12),'dd'), 'YYYYMMDD') AND TO_CHAR(TRUNC(ADD_MONTHS(TO_DATE(#ENDDT#, 'YYYYMMDD'), -12),'dd'), 'YYYYMMDD') ) SELECT NULL,
    '합계' AS CD_NM,
    COUNT(1) AS 1,
    CASE WHEN COUNT(1) = 0 THEN 0 ELSE (COUNT(1) / COUNT(1)) * 100 END AS 1,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '10' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('20', '21','22', '23') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('30', '31', '32', '33') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '40' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */
FROM DATA UNION ALL SELECT NULL,
    '감사민원' AS CD_NM,
    NVL(SUM( CASE WHEN CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS CRU_KDCD /* 부패종류코드 */,
    CASE WHEN COUNT(1) = 0 THEN 0 ELSE (NVL(SUM( CASE WHEN CRU_KDCD != '카' THEN 1 ELSE 0 END),0) / COUNT(1)) * 100 END AS 1,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD = '10' AND CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD IN ('20','21','22','23') AND CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD IN ('30','31','32','33') AND CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD = '40' AND CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL AND CRU_KDCD != '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */
FROM DATA UNION ALL SELECT D3.CD,
    D3.CD_NM,
    NVL(D4.CNT, 0) AS CNT,
    CASE WHEN NVL(D4.CNTALL, 0) = 0 THEN 0 ELSE NVL(ROUND((D4.CNT/D4.CNTALL)*100, 2),0) END AS CNTALL,
    NVL(D4.CNT_GUK , 0) AS CNT_GUK,
    NVL(D4.CNT_JIBANG, 0) AS CNT_JIBANG,
    NVL(D4.CNT_GONG , 0) AS CNT_GONG,
    NVL(D4.CNT_ETC , 0) AS CNT_ETC,
    NVL(D4.CNT_ING , 0) AS CNT_ING
FROM ( SELECT CD,
    CD_NM
FROM TBDCMACM013C D2 WHERE D2.CMM_CD_DVSN_CD = '1000047' AND D2.CD != '000000000' AND D2.CD != '카' ORDER BY OTPT_SEQ ) D3, ( SELECT D1.CRU_KDCD /* 부패종류코드 */,
    COUNT(1) AS 1,
    (SELECT COUNT(1)
FROM DATA S1 WHERE 1=1) AS CNTALL , NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '10' THEN 1 ELSE 0 END),0) AS CNT_GUK , NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('20', '21','22', '23') THEN 1 ELSE 0 END),0) AS CNT_JIBANG , NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('30', '31', '32', '33') THEN 1 ELSE 0 END),0) AS CNT_GONG , NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '40' THEN 1 ELSE 0 END),0) AS CNT_ETC , NVL(SUM(CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL THEN 1 ELSE 0 END),0) AS CNT_ING FROM DATA D1 GROUP BY ROLLUP(D1.TPOF_KDCD) ) D4 WHERE D3.CD = D4.CRU_KDCD(+) UNION ALL SELECT NULL,
    '일반민원' AS CD_NM,
    NVL(SUM( CASE WHEN CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS CRU_KDCD /* 부패종류코드 */,
    CASE WHEN COUNT(1) = 0 THEN 0 ELSE (NVL(SUM( CASE WHEN CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) / COUNT(1)) * 100 END AS 1,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD = '10' AND CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD IN ('20','21','22','23') AND CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD IN ('30','31','32','33') AND CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD = '40' AND CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM( CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL AND CRU_KDCD = '카' THEN 1 ELSE 0 END), 0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */
FROM DATA UNION ALL SELECT NULL,
    '전년 동기간 증감' AS CD_NM,
    NVL(D5.CNT-D6.CNT, 0) AS CNT,
    NVL(D5.PER-D6.PER, 0) AS PER,
    NVL(D5.CNT_GUK - D6.CNT_GUK , 0) AS CNT_GUK,
    NVL(D5.CNT_JIBANG - D6.CNT_JIBANG, 0) AS CNT_JIBANG,
    NVL(D5.CNT_GONG - D6.CNT_GONG , 0) AS CNT_GONG,
    NVL(D5.CNT_ETC - D6.CNT_ETC , 0) AS CNT_ETC,
    NVL(D5.CNT_ING - D6.CNT_ING , 0) AS CNT_ING
FROM ( SELECT 'A' AS PK,
    COUNT(1) AS 1,
    CASE WHEN COUNT(1) = 0 THEN 0 ELSE (COUNT(1) / COUNT(1)) * 100 END AS 1,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '10' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('20', '21','22', '23') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('30', '31', '32', '33') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '40' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */
FROM DATA ) D5 , ( SELECT 'A' AS PK,
    COUNT(1) AS 1,
    CASE WHEN COUNT(1) = 0 THEN 0 ELSE (COUNT(1) / COUNT(1)) * 100 END AS 1,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '10' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('20', '21','22', '23') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD IN ('30', '31', '32', '33') THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD = '40' THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */,
    NVL(SUM(CASE WHEN SLCT_PBNST_SECD NOT IN ('10', '20', '21','22', '23','30', '31', '32', '33', '40') OR SLCT_PBNST_SECD IS NULL THEN 1 ELSE 0 END),0) AS SLCT_PBNST_SECD /* 청탁공공기관구분코드 */
FROM PRE_DATA ) D6 WHERE D5.PK = D6.PK(+)