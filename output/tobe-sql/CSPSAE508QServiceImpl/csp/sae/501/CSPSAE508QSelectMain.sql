WITH DATA AS /* CSPSAE508QSelectMain */ ( SELECT TO_CHAR(TO_DATE(A.END_DDL_DT)-1, 'YYYY') AS LINK_YR /* 연계년도 */,
    TO_CHAR(TO_DATE(A.END_DDL_DT)-1, 'MM') AS TO_CHAR,
    A.WEK,
    B.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    B.UE_NOP_CNT,
    B.USE_YN /* 사용여부 */,
    C.DMT_DVSN_CD,
    C.RMN_NM,
    B.APL_DT,
    C.USE_STR_DT,
    C.USE_END_DT,
    C.USE_YN /* 사용여부 */,
    C.USE_FEE,
    C.FRS_MDM_SQNO /* 포렌식매체순번 */,
    B.BSC_SRNO
FROM TBCSPSAE134B A , TBCSPSAE501M B , TBCSPSAE501D C , TBDCMACM001M D , TBDCMACM002M E WHERE C.TRGT_NOP_ENO = B.TRGT_NOP_ENO AND C.APL_DT = B.APL_DT AND C.BSC_SRNO = B.BSC_SRNO AND C.USE_STR_DT = TO_CHAR(TO_DATE(A.END_DDL_DT)-1,'YYYYMMDD') AND D.TRGT_NOP_ENO = B.TRGT_NOP_ENO AND E.SRECS_DEPT_CD = D.SRECS_DEPT_CD AND C.USE_STR_DT BETWEEN #strFromDt# AND #strToDt# AND E.SRECS_DEPT_CD = #SRECS_DEPT_CD# AND D.USER_NM LIKE '%' || #strUSR_NAM# || '%' AND C.DMT_DVSN_CD = #strDMT_DVSN_CD# AND C.COFM_STA_CD = #strCOFM_STA_CD# AND C.USE_YN = #USE_YN# ) SELECT NVL2(D1.LINK_YR, D1.LINK_YR, '합계') AS LINK_YR /* 연계년도 */,
    DECODE(NVL2(D1.LINK_YR, D1.LINK_YR, '합계'), '합계', '', NVL2(D1.M, D1.M, '소계')) AS NVL2,
    DECODE(NVL2(D1.M, D1.M, '소계'), '소계', '', NVL2(TO_CHAR(D1.WEK), TO_CHAR(D1.WEK), '소계')) AS NVL2,
    DECODE(NVL2(TO_CHAR(D1.WEK), TO_CHAR(D1.WEK), '소계'), '소계', '', NVL2(B.CNSTN_MBCMT_DEPT_NM, B.CNSTN_MBCMT_DEPT_NM, '소계')) AS CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.USER_NM /* 사용자명 */,
    (SELECT AS CD_NM
FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173' AND CD = A.JBGD_SECD) AS JBGD_SECD , (SELECT CD_NM
FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000140' AND CD = D1.DMT_DVSN_CD) AS DMT_DVSN_CD , D1.RMN_NM , DECODE(D1.COK_USE_YN, 'Y', '사용', DECODE(D1.COK_USE_YN, 'N', '미사용', '') ) AS COK_USE_YN , D1.APL_DT , DECODE(D1.USE_STR_DT, NULL, '', SUBSTR(D1.USE_STR_DT, 0, 4) || '-' || SUBSTR(D1.USE_STR_DT, 5, 2) || '-' || SUBSTR(D1.USE_STR_DT, 7, 2) || ' ~ ' || SUBSTR(D1.USE_END_DT, 0, 4) || '-' || SUBSTR(D1.USE_END_DT, 5, 2) || '-' || SUBSTR(D1.USE_END_DT, 7, 2)) AS USE_DT , D1.USE_FEE , NVL(D1.UE_NOP_CNT, D1.UE_NOP_CNT_TOT) AS UE_NOP_CNT , DECODE(D1.USE_YN, 'Y', '사용', DECODE(D1.USE_YN, 'N', '미사용', '')) AS USE_YN , A.CNSTN_MBCMT_HOME_TELNO , C.IO_CAR_TXT FROM ( SELECT X.LINK_YR /* 연계년도 */,
    X.M,
    X.WEK,
    X.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    X.UE_NOP_CNT_TOT,
    Y.UE_NOP_CNT,
    Y.USE_FEE,
    Y.DMT_DVSN_CD,
    Y.RMN_NM,
    Y.COK_USE_YN,
    Y.APL_DT,
    Y.USE_STR_DT,
    Y.USE_END_DT,
    Y.USE_YN /* 사용여부 */,
    Y.BSC_SRNO
FROM ( SELECT D1.LINK_YR /* 연계년도 */,
    D1.M,
    D1.WEK,
    D1.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    GROUPING(D1.LINK_YR) || GROUPING(D1.M)|| GROUPING(D1.WEK) || GROUPING(D1.TRGT_NOP_ENO) AS GROUPING,
    SUM(D1.UE_NOP_CNT) AS UE_NOP_CNT
FROM ( SELECT DISTINCT D1.LINK_YR AS LINK_YR /* 연계년도 */,
    D1.M,
    D1.WEK,
    D1.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    D1.UE_NOP_CNT
FROM DATA D1 ) D1 GROUP BY ROLLUP ( D1.LINK_YR , D1.M , D1.WEK , D1.TRGT_NOP_ENO ) ) X , ( SELECT D2.LINK_YR /* 연계년도 */,
    D2.M,
    D2.WEK,
    D2.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    GROUPING(D2.LINK_YR) || GROUPING(D2.M)|| GROUPING(D2.WEK) || GROUPING(D2.TRGT_NOP_ENO) AS GROUPING,
    D2.DMT_DVSN_CD,
    D2.RMN_NM,
    D2.COK_USE_YN,
    D2.APL_DT,
    D2.USE_STR_DT,
    D2.USE_END_DT,
    D2.USE_YN /* 사용여부 */,
    SUM(D2.USE_FEE) AS USE_FEE,
    D2.UE_NOP_CNT,
    D2.BSC_SRNO
FROM DATA D2 GROUP BY ROLLUP ( D2.LINK_YR , D2.M , D2.WEK , (D2.TRGT_NOP_ENO , D2.DMT_DVSN_CD , D2.RMN_NM , D2.COK_USE_YN , D2.APL_DT , D2.USE_STR_DT , D2.USE_END_DT , D2.USE_YN , D2.FRS_MDM_SQNO , D2.UE_NOP_CNT , D2.BSC_SRNO) ) )Y WHERE X.GRP = Y.GRP AND NVL(X.LINK_YR, '999') = NVL(Y.LINK_YR, '999') AND NVL(X.M, '999') = NVL(Y.M, '999') AND NVL(X.WEK, '999') = NVL(Y.WEK, '999') AND NVL(X.TRGT_NOP_ENO, '999') = NVL(Y.TRGT_NOP_ENO, '999') ) D1 , TBDCMACM001M A , TBDCMACM002M B , TBCSPSAE501M C WHERE A.TRGT_NOP_ENO(+) = D1.TRGT_NOP_ENO AND B.SRECS_DEPT_CD(+) = A.SRECS_DEPT_CD AND C.TRGT_NOP_ENO(+) = D1.TRGT_NOP_ENO AND C.BSC_SRNO(+) = D1.BSC_SRNO AND C.APL_DT(+) = D1.APL_DT ORDER BY D1.LINK_YR, D1.M, D1.WEK, B.SRECS_DEPT_CD, A.USER_NM, JBGD_SECD, DMT_DVSN_CD, D1.BSC_SRNO, D1.RMN_NM, D1.APL_DT, USE_DT