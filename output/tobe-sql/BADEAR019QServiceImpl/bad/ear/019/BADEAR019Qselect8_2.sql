WITH BASE AS ( select MAIN.INST_SECD ,DE04.CFMTN_STTS_SECD ,DE04.IMPL_WHLS_CFMTN_YMD ,MAIN.DSPS_RQT_KDCD ,DE04.PNRT_PRSRV_AMT ,DE04.RMBR_AMT ,DE04.SPLP_AMT ,DE04.NOP_CONT ,SUBSTR(DE04.ENFC_YMD ,1,4) as YYYY_KBN ,CASE WHEN NVL(DE04.CFMTN_STTS_SECD, '0') = '2' AND DE04.IMPL_WHLS_CFMTN_YMD #strStdDt#/*화면기준일자*/) THEN '2' /*집행중*/ END JIBHANG_KBN from TB_BADEAR001M MAIN ,TB_BADEAR002D DE04 where 1=1 and MAIN.ADT_YR = DE04.ADT_YR and MAIN.ADT_NO = DE04.ADT_NO and MAIN.DSPS_RQT_SQNO = DE04.DSPS_RQT_SQNO and NVL(DE04.CFMTN_STTS_SECD, '0') != '0' and DE04.ENFC_YMD BETWEEN #strFromDt#/*화면 FROM일자*/ and #strToDt# /*화면 TO일자*/ and ((NVL(DE04.CFMTN_STTS_SECD, '0') = '2' AND DE04.IMPL_WHLS_CFMTN_YMD #strStdDt#/*화면기준일자*/))) ) ,GROUP_BASE AS ( select CASE WHEN GROUPING(YYYY_KBN) = '1' THEN '0' ELSE YYYY_KBN END AS GROUPING,
    CASE WHEN GROUPING(CASE WHEN JIBHANG_KBN ='1' THEN '집행완료' WHEN JIBHANG_KBN ='2' THEN '집행중' END) = '1' THEN '계' ELSE (CASE WHEN JIBHANG_KBN ='1' THEN '집행완료' WHEN JIBHANG_KBN ='2' THEN '집행중' END) END AS GROUPING,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) IN ('1','2','3','4','5','6','8') then 1 else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) IN ('1','2','3','4','5','6','8') then NVL(PNRT_PRSRV_AMT,0) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) IN ('1','2','3','4','5','6','8') then (NVL(RMBR_AMT,0)+NVL(SPLP_AMT,0)) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) IN ('1','2','3','4','5','6','8') then NVL(TPOF_NOPE,0) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '1' then 1 else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '1' then NVL(PNRT_PRSRV_AMT,0) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '2' then 1 else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '2' then NVL(TPOF_NOPE,0) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '3' then 1 else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '3' then NVL(PNRT_PRSRV_AMT,0) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '3' then (NVL(RMBR_AMT,0)+NVL(SPLP_AMT,0)) else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '4' then 1 else 0 end) AS SUBSTR,
    sum(case when SUBSTR(DSPS_RQT_KDCD,1,1) = '5' then 1 else 0 end) AS SUBSTR,
    sum(case when DSPS_RQT_KDCD = '611' then 1 else 0 end) AS DSPS_RQT_KDCD /* 처분요구종류코드 */,
    sum(case when DSPS_RQT_KDCD IN ('610','620','621','630','623','625') then 1 else 0 end) AS DSPS_RQT_KDCD /* 처분요구종류코드 */,
    sum(case when DSPS_RQT_KDCD IN ('610','620','621','630','623','625') then NVL(TPOF_NOPE,0) else 0 end) AS DSPS_RQT_KDCD /* 처분요구종류코드 */,
    sum(case when DSPS_RQT_KDCD IN ('810','820','830','840','850') then 1 else 0 end) AS DSPS_RQT_KDCD /* 처분요구종류코드 */,
    sum(case when DSPS_RQT_KDCD IN ('810','820','830','840','850') then NVL(TPOF_NOPE,0) else 0 end) AS DSPS_RQT_KDCD /* 처분요구종류코드 */
from BASE group by rollup(YYYY_KBN) ,rollup(CASE WHEN JIBHANG_KBN ='1' THEN '집행완료' WHEN JIBHANG_KBN ='2' THEN '집행중' END) UNION ALL SELECT to_char(decode(LEVEL-1,0,0,substr(#strFromDt#,1,4)/*화면FROM일자*/ + LEVEL-2))CODE1,
    '집행률(%)' AS CODE2,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0
FROM DUAL CONNECT BY LEVEL <= substr(#strToDt#,1,4) - substr(#strFromDt#,1,4) + 2 /*화면from~to일자 TO~FROM 으로 바인딩 */ ) SELECT DECODE(NVL(CODE1,'0'),'0', '전체합계',CODE1 ) AS CODE1,
    CODE1,
    CODE2,
    SUM_CNT,
    SUM_PNL_DRIN_PSVT_AM,
    SUM_RSTORTN_SPLP_AM,
    SUM_NOP_CNT,
    CASE WHEN CODE2 = '집행률(%)' then /*집행완료 CNT1*100/계 CNT1*/ CASE WHEN lag(CNT1,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) = 0 THEN 0 ELSE ROUND((lag(CNT1,2) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) *100) / lag(CNT1,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)),2) END ELSE CNT1 END AS CODE2,
    PNL_DRIN_PSVT_AM1,
    CASE WHEN CODE2 = '집행률(%)' then /*집행완료 CNT2*100/계 CNT2*/ CASE WHEN lag(CNT2,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) = 0 THEN 0 ELSE ROUND((lag(CNT2,2) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) *100) / lag(CNT2,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)),2) END ELSE CNT2 END AS CODE2,
    NOP_CNT1,
    CASE WHEN CODE2 = '집행률(%)' then /*집행완료 CNT3*100/계 CNT3*/ CASE WHEN lag(CNT3,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) = 0 THEN 0 ELSE ROUND((lag(CNT3,2) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)) *100) / lag(CNT3,3) OVER(partition by code1 ORDER BY code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)),2) END ELSE CNT3 END AS CODE2,
    PNL_DRIN_PSVT_AM2,
    RSTORTN_SPLP_AM1,
    CNT4,
    CNT5,
    CNT6,
    CNT7,
    NOP_CNT2,
    CNT8,
    NOP_CNT3
FROM GROUP_BASE A order by code1, decode(CODE2,'계',1,'집행완료',2, '집행중',3,'집행률(%)',4)