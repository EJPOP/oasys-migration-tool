SELECT INST_CD /* 기관코드 */,
    PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    ADT_BGNG_YMD /* 감사시작일자 */,
    ADT_END_YMD /* 감사종료일자 */,
    AUD_ST_END_DT,
    AUD_ITEM_CNT,
    SUM_AUD_DCN,
    MAX_AUD_DCN,
    AUD_ITEM_CNT||'회 '||MAX_AUD_DCN||'일 '||SUM_AUD_DCN|| '인' AS CPADT_DCN /* 위탁대행감사일수 */,
    ORD
FROM ( SELECT D3.INST_CD AS INST_CD /* 기관코드 */,
    F_ORG_INFO(D3.INST_CD , '1')||'('||D3.INST_CD||')' AS PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    MAX(D3.ADT_BGNG_YMD) AS ADT_BGNG_YMD /* 감사시작일자 */,
    MAX(D3.ADT_END_YMD) AS ADT_END_YMD /* 감사종료일자 */,
    TO_CHAR(TO_DATE(MAX(D3.ADT_BGNG_YMD)),'YYYY-MM-DD') ||'~'|| TO_CHAR(TO_DATE(MAX(D3.ADT_END_YMD)),'YYYY-MM-DD') AS TO_CHAR /* 최종 감사일 */,
    SUM(CASE WHEN D1.ADT_BZTRP_KDCD IN('02') THEN 1 ELSE 0 END) AS ADT_BZTRP_KDCD /* 감사출장종류코드 */,
    SUM(D3.SUM_AUD_DCN) AS SUM_AUD_DCN /*연인원*/ /* 일수 2015.11.24 주석처리 yyh */,
    SUM(D3.MAX_AUD_DCN) AS MAX_AUD_DCN /* 일수 */,
    DECODE(D3.INST_CD,#INST_CD#,1,2) AS INST_CD /* 기관코드 */
FROM TBBADDED002M D1 , TBBADDED001M D2 , ( SELECT D2.BZTRP_YR /* 출장년도 */,
    D2.BZTRP_SQNO /* 출장순번 */,
    D2.INST_CD /* 기관코드 */,
    MIN(D2.ADT_BGNG_YMD) AS ADT_BGNG_YMD /* 감사시작일자 */,
    MAX(D2.ADT_END_YMD) AS ADT_END_YMD /* 감사종료일자 */,
    SUM(D1.ADT_DCN) AS ADT_DCN /* 감사일수 */,
    MAX(D1.ADT_DCN) AS ADT_DCN /* 감사일수 */
FROM TBBADDED006L D1 , TBBADDED008L D2 WHERE 1=1 AND D2.ADT_BGNG_YMD >= #strAudStDt# AND D2.ADT_BGNG_YMD <= #strAudEndDt# /* 감사기관을 하나 선택 후 조회시 조회기관과 동일한 기관구분,기관차수에 해당하는 기관이 조회되어지던 쿼리를 조회기관만 보이게 수정 - 2016.03.04 yyh */ AND D2.INST_CD = #INST_CD# /*검색조건에 기간코드가 1개일때 의 기관코드 */ AND D1.FT_SQNO = D2.FT_SQNO AND D1.FT_TRGT_INST_SQNO = D2.FT_TRGT_INST_SQNO AND D1.BZTRP_SQNO = D2.BZTRP_SQNO AND D1.BZTRP_YR = D2.BZTRP_YR GROUP BY D2.BZTRP_YR , D2.BZTRP_SQNO , D2.INST_CD ) D3 WHERE 1=1 AND D1.REL_ADT_YR = D2.CVLCPT_ADT_YR AND D1.REL_ADT_NO = D2.ADT_NO AND D1.BZTRP_YR = D3.BZTRP_YR AND D1.BZTRP_SQNO = D3.BZTRP_SQNO AND D1.BZTRP_SECD = '1' AND D1.ADT_BZTRP_KDCD IN ('02') GROUP BY D3.INST_CD ) ORDER BY ORD, INST_CD