SELECT NVL2(A.LINK_YR, A.LINK_YR, '합계') AS LINK_YR /* 연계년도 */,
    DECODE(NVL2(A.LINK_YR, A.LINK_YR, '합계'), '합계', '', NVL2(B.EDU_DVSN_NM, B.EDU_DVSN_NM, '소계')) AS NVL2,
    A.CRS_CD,
    DECODE(NVL2(B.EDU_DVSN_NM, B.EDU_DVSN_NM, '소계'), '소계', '', NVL2(A.CRS_NM, A.CRS_NM, '소계')) AS CRS_NM /* 과정명 */,
    DECODE(NVL2(A.CRS_NM, A.CRS_NM, '소계'), '소계', '', NVL2(TO_CHAR(A.CRS_CDN), TO_CHAR(A.CRS_CDN), '소계')) AS CRS_CDN /* 과정기수 */,
    C.EDU_PRD_TXT,
    NVL(D.ORG_DVSN_CD_01, 0) AS ORG_DVSN_CD_01,
    NVL(D.ORG_DVSN_CD_02, 0) AS ORG_DVSN_CD_02,
    NVL(D.ORG_DVSN_CD_03, 0) AS ORG_DVSN_CD_03,
    NVL(D.ORG_DVSN_CD_04, 0) AS ORG_DVSN_CD_04,
    NVL(D.ORG_DVSN_CD_05, 0) AS ORG_DVSN_CD_05,
    #strFromM# AS #STRFROMM#,
    #strToM# AS #STRTOM#
FROM (SELECT A.LINK_YR /* 연계년도 */,
    B.EDU_DVSN_CD,
    B.EDU_CAT_CD,
    A.CRS_CD,
    A.CNT_CRS_CD,
    B.CRS_NM /* 과정명 */,
    A.CRS_CDN /* 과정기수 */,
    SUM(CASE WHEN C.INST_SECD = '10' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN C.INST_SECD = '21' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN C.INST_SECD = '22' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN SUBSTRING(C.INST_SECD,1,1) = '4' THEN 1 ELSE 0 END) AS SUBSTRING,
    SUM(CASE WHEN SUBSTRING(C.INST_SECD,1,1) IN ('5', '6') THEN 1 ELSE 0 END) AS SUBSTRING
FROM (SELECT LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    COUNT(CRS_CD) AS CRS_CD
FROM TBCSPSAE201D WHERE 1=1 AND SUBSTR(EDU_BGNG_YMD, 0, 6) BETWEEN #strFromY# || #strFromM# AND #strToY# || #strToM# GROUP BY LINK_YR, CRS_CD, CRS_CDN) A , TBCSPSAE103C B , TBCSPSAE301D C WHERE 1=1 AND C.LINK_YR(+) = A.LINK_YR AND C.CRS_CD(+) = A.CRS_CD AND C.CRS_CDN(+) = A.CRS_CDN AND A.CRS_CD = B.CRS_CD GROUP BY A.LINK_YR , B.EDU_DVSN_CD , B.EDU_CAT_CD , A.CRS_CD , B.CRS_NM , A.CNT_CRS_CD , A.CRS_CDN ) A , TBCSPSAE101C B , TBCSPSAE201M C , (SELECT A.LINK_YR /* 연계년도 */,
    B.EDU_DVSN_CD,
    B.EDU_CAT_CD,
    A.CRS_CD,
    A.CNT_CRS_CD,
    B.CRS_NM /* 과정명 */,
    A.CRS_CDN /* 과정기수 */,
    SUM(CASE WHEN C.INST_SECD = '10' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN C.INST_SECD = '21' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN C.INST_SECD = '22' THEN 1 ELSE 0 END) AS INST_SECD /* 기관구분코드 */,
    SUM(CASE WHEN SUBSTRING(C.INST_SECD,1,1) = '4' THEN 1 ELSE 0 END) AS SUBSTRING,
    SUM(CASE WHEN SUBSTRING(C.INST_SECD,1,1) IN ('5', '6') THEN 1 ELSE 0 END) AS SUBSTRING
FROM (SELECT LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    COUNT(CRS_CD) AS CRS_CD
FROM TBCSPSAE201D WHERE 1=1 AND SUBSTR(EDU_BGNG_YMD, 0, 6) BETWEEN #strFromY# || #strFromM# AND #strToY# || #strToM# GROUP BY LINK_YR, CRS_CD, CRS_CDN) A , TBCSPSAE103C B , TBCSPSAE301D C WHERE 1=1 AND C.LINK_YR(+) = A.LINK_YR AND C.CRS_CD(+) = A.CRS_CD AND C.CRS_CDN(+) = A.CRS_CDN AND A.CRS_CD = B.CRS_CD AND C.FIN_YN = 'Y' GROUP BY A.LINK_YR , B.EDU_DVSN_CD , B.EDU_CAT_CD , A.CRS_CD , B.CRS_NM , A.CNT_CRS_CD , A.CRS_CDN ) D WHERE A.EDU_DVSN_CD = B.EDU_DVSN_CD AND C.LINK_YR = A.LINK_YR AND C.CRS_CD = A.CRS_CD AND D.LINK_YR(+) = A.LINK_YR AND D.CRS_CD(+) = A.CRS_CD AND D.CRS_CDN(+) = A.CRS_CDN AND A.LINK_YR BETWEEN #strFromY# AND #strToY# AND A.EDU_DVSN_CD = #strEDU_DVSN_CD# AND A.EDU_CAT_CD = #strEDU_CAT_CD# AND A.CRS_CD = #strEDU_CRS_CD# ORDER BY A.LINK_YR, B.EDU_DVSN_NM ASC , A.CRS_CD ASC, A.CRS_CDN