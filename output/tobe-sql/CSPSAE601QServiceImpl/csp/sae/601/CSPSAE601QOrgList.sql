WITH DATA AS ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.CRS_NM /* 과정명 */,
    A.INST_CD /* 기관코드 */,
    B.PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    A.CNT_ORG_CD
FROM ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.CRS_NM /* 과정명 */,
    A.EDU_DVSN_CD,
    A.EDU_CAT_CD,
    A.INST_CD /* 기관코드 */,
    NVL(B.CNT_ORG_CD, 0) AS CNT_ORG_CD
FROM ( SELECT DISTINCT A.LINK_YR AS LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.CRS_NM /* 과정명 */,
    B.INST_CD /* 기관코드 */,
    A.EDU_DVSN_CD,
    A.EDU_CAT_CD
FROM ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    B.CRS_NM /* 과정명 */,
    B.EDU_DVSN_CD,
    B.EDU_CAT_CD
FROM ( SELECT B.LINK_YR /* 연계년도 */,
    B.CRS_CD,
    B.CRS_CDN /* 과정기수 */
FROM ( SELECT DISTINCT AS LINK_YR,
    CRS_CD,
    CRS_CDN /* 과정기수 */
FROM TBCSPSAE301D WHERE LINK_YR = #LINK_YR# ) A, TBCSPSAE201D B WHERE B.LINK_YR = A.LINK_YR(+) AND B.CRS_CD = A.CRS_CD(+) AND B.CRS_CDN = A.CRS_CDN(+) ) A, TBCSPSAE103C B WHERE B.CRS_CD = A.CRS_CD ORDER BY B.EDU_DVSN_CD, B.EDU_CAT_CD, B.CRS_CD ) A , ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.INST_CD /* 기관코드 */
FROM ( SELECT LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    DECODE(INST_CD, NULL, '', (SUBSTR(INST_CD, 1, 3) || '000000000')) AS INST_CD /* 기관코드 */
FROM TBCSPSAE301D WHERE LINK_YR = #LINK_YR# AND INST_CD IS NOT NULL ) A GROUP BY A.LINK_YR, A.CRS_CD, A.CRS_CDN, A.INST_CD ) B WHERE B.LINK_YR(+) = A.LINK_YR AND B.CRS_CD(+) = A.CRS_CD AND B.CRS_CDN(+) = A.CRS_CDN ORDER BY A.EDU_DVSN_CD, A.EDU_CAT_CD ) A, ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.INST_CD /* 기관코드 */,
    NVL(B.CNT_ORG_CD, 0) AS CNT_ORG_CD
FROM ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.INST_CD /* 기관코드 */,
    COUNT(A.INST_CD) AS INST_CD /* 기관코드 */
FROM ( SELECT LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    DECODE(INST_CD, NULL, '', (SUBSTR(INST_CD, 1, 3) || '000000000')) AS INST_CD /* 기관코드 */
FROM TBCSPSAE301D WHERE LINK_YR = #LINK_YR# ) A GROUP BY A.LINK_YR, A.CRS_CD, A.CRS_CDN, A.INST_CD ) A , ( SELECT A.LINK_YR /* 연계년도 */,
    A.CRS_CD,
    A.CRS_CDN /* 과정기수 */,
    A.INST_CD /* 기관코드 */,
    COUNT(A.INST_CD) AS INST_CD /* 기관코드 */
FROM ( SELECT LINK_YR /* 연계년도 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    DECODE(INST_CD, NULL, '', (SUBSTR(INST_CD, 1, 3) || '000000000')) AS INST_CD /* 기관코드 */
FROM TBCSPSAE301D WHERE LINK_YR = #LINK_YR# AND FIN_YN = 'Y' ) A GROUP BY A.LINK_YR, A.CRS_CD, A.CRS_CDN, A.INST_CD ) B WHERE B.LINK_YR(+) = A.LINK_YR AND B.CRS_CD(+) = A.CRS_CD AND B.CRS_CDN(+) = A.CRS_CDN AND B.INST_CD(+) = A.INST_CD ) B WHERE B.LINK_YR(+) = A.LINK_YR AND B.CRS_CD(+) = A.CRS_CD AND B.CRS_CDN(+) = A.CRS_CDN AND B.INST_CD(+) = A.INST_CD ) A , TBDCMACM015M B , TBCSPSAE101C C , TBCSPSAE102C D WHERE B.INST_CD(+) = A.INST_CD AND C.EDU_DVSN_CD = A.EDU_DVSN_CD AND D.EDU_DVSN_CD = A.EDU_DVSN_CD AND D.EDU_CAT_CD = A.EDU_CAT_CD AND A.INST_CD IS NOT NULL AND A.LINK_YR = #LINK_YR# AND A.EDU_DVSN_CD = #strEDU_DVSN_CD# AND A.EDU_CAT_CD = #strEDU_CAT_CD# AND A.CRS_CD = #strEDU_CRS_CD# ORDER BY A.LINK_YR, A.CRS_CD, A.CRS_CDN, A.CRS_NM, A.INST_CD, B.PROF_RBPRSN_INST_NM ) SELECT DISTINCT A.LINK_YR AS LINK_YR /* 연계년도 */,
    A.PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    AGGR_CONCAT(A.CNT_VALUE, '%%' ORDER BY A.CRS_CD, A.CRS_CDN) AS AGGR_CONCAT
FROM ( SELECT LINK_YR /* 연계년도 */,
    INST_CD /* 기관코드 */,
    PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */,
    CRS_CD || '##' || CRS_CDN || '::' ||AGGR_CONCAT( CNT_ORG_CD, '@' ORDER BY CRS_CD, CRS_CDN ) AS CRS_CD
FROM ( SELECT NVL(D5.CNT_ORG_CD, 0) AS CNT_ORG_CD,
    D4.INST_CD /* 기관코드 */,
    D4.CRS_CD,
    D4.CRS_CDN /* 과정기수 */,
    D4.PROF_RBPRSN_INST_NM /* 증명책임자기관명 */,
    D4.LINK_YR /* 연계년도 */
FROM ( SELECT D2.LINK_YR /* 연계년도 */,
    D2.CRS_CD,
    D2.CRS_CDN /* 과정기수 */,
    D3.INST_CD /* 기관코드 */,
    D3.PROF_RBPRSN_INST_NM /* 증명책임자기관명 */
FROM ( SELECT D1.LINK_YR /* 연계년도 */,
    D1.CRS_CD,
    D1.CRS_CDN /* 과정기수 */
FROM TBCSPSAE201D D1 , TBCSPSAE101C D2 , TBCSPSAE102C D3 , TBCSPSAE103C D4 WHERE D2.EDU_DVSN_CD = D3.EDU_DVSN_CD AND D2.EDU_DVSN_CD = D4.EDU_DVSN_CD AND D3.EDU_CAT_CD = D4.EDU_CAT_CD AND D4.CRS_CD = D1.CRS_CD AND D1.LINK_YR = #LINK_YR# AND D2.EDU_DVSN_CD = #strEDU_DVSN_CD# AND D3.EDU_CAT_CD = #strEDU_CAT_CD# AND D4.CRS_CD = #strEDU_CRS_CD# ) D2 , ( SELECT DISTINCT AS INST_CD,
    PROF_RBPRSN_INST_NM /* 증명책임자기관명 */
FROM DATA ) D3 ) D4 , ( SELECT DISTINCT,
    INST_CD /* 기관코드 */,
    CRS_CD,
    CRS_CDN /* 과정기수 */
FROM DATA ORDER BY CRS_CD, CRS_CDN ) D5 WHERE D4.INST_CD = D5.INST_CD(+) AND D4.CRS_CD = D5.CRS_CD(+) AND D4.CRS_CDN = D5.CRS_CDN(+) ) GROUP BY LINK_YR, INST_CD, PROF_RBPRSN_INST_NM, CRS_CD, CRS_CDN ORDER BY CRS_CD, CRS_CDN ) A WHERE PROF_RBPRSN_INST_NM IS NOT NULL GROUP BY A.LINK_YR, A.PROF_RBPRSN_INST_NM