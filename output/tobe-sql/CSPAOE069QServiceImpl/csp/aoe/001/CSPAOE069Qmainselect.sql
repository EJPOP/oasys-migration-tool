WITH DATA AS ( SELECT #strEvlYr# AS #STREVLYR#,
    #strHlyrDvsnCd# AS #STRHLYRDVSNCD#,
    D15.PTCPT_CNB /* 피평가자전산번호 */,
    D15.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D15.PSN_TSK_ASC /* 개인평점 */
FROM (SELECT PTCPT_CNB,
    AUD_KND_NM /* 감사종류코드 */,
    ADT_MTTR_NM /* 감사사항명 */,
    NMPTCPT_CNT /* 참여인원 */,
    STND_ASC /* 표준평점 */,
    SYT_EVL_RK_CD,
    SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    ADVL_ASC /* 가중평점=표준평점*가중치 */,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    DRIVE_RTE_SUM /* 추진율 */,
    DRIVE_RTE_ASC /* 추진율 조정평점 */,
    DLY_DT_SUM /* 지연일 */,
    (CASE WHEN INSTR(DLY_DT_SUM, '-') = 0 AND ASP_RTE = 0 THEN '0.00' WHEN INSTR(DLY_DT_SUM, '-') = 0 THEN TO_CHAR(ASP_RTE,'FM99990.00') ELSE '-' || TO_CHAR(ASP_RTE,'FM99990.00') END) AS INSTR /* 가감점율 */,
    ASP_STND_ASC /* 가감평점 */,
    SPE_ADD_SC /* 특별가산점 */,
    ROUND(STND_ASC, 2) AS ROUND /* 업무평점 = 표준평점 * 평가등급별가중치 * 감사단계별추진율 + (가감평점) + 특별가산점 + 조정평점(조정평점은 사용하지 않는다고 했다. 하지만 혹시 모르니 일단 더하는 방식으로 간다.) */,
    CTB_RT /* 기여비율 */,
    ROUND((STND_ASC) * (CTB_RT/100), 2) AS ROUND /* 개인평점 */,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM (SELECT D20.PTCPT_CNB,
    F_CODE_NM('1000270', D20.ADT_KDCD) AS F_CODE_NM,
    D20.ADT_MTTR_NM /* 감사사항명 */,
    D20.NMPTCPT_CNT /* 참여인원 */,
    D20.STND_ASC /* 표준평점 */,
    D20.SYT_EVL_RK_CD,
    D20.SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D20.ADVL_ASC /* 가중평점=표준평점*가중치 */,
    D20.AUD_STEP_CD_MIN,
    D20.AUD_STEP_CD_MAX,
    D20.DRIVE_RTE_SUM /* 추진율 */,
    D20.DRIVE_RTE_ASC /* 추진율 조정평점 */,
    D20.DLY_DT_SUM /* 지연일 */,
    D20.ASP_RTE /* 가감점율 */,
    F_AOE_ASP_STND_ASC_2(#strEvlYr#, #strHlyrDvsnCd#, D20.ADT_KDCD, D20.AUD_STEP_CD_MAX, D20.DLY_DT_SUM, D20.SYT_EVL_ADVL_VAL, D20.ASP_STND_ASC, D20.CVLCPT_ADT_YR, D20.TSK_NO) AS F_AOE_ASP_STND_ASC_2 /* 가감평점 */,
    D20.SPE_ADD_SC /* 특별가산점 */,
    D20.MDT_ASC /* 조정평점 */,
    D20.CTB_RT /* 기여비율 */,
    D20.MNDY_CNT,
    '10000' AS CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM (SELECT D19.PTCPT_CNB,
    D19.ADT_KDCD /* 감사종류코드 */,
    D19.ADT_MTTR_NM /* 감사사항명 */,
    D19.NMPTCPT_CNT /* 참여인원 */,
    D19.STND_ASC /* 표준평점 */,
    D19.SYT_EVL_RK_CD,
    D19.SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D19.ADVL_ASC /* 가중평점=표준평점*가중치 */,
    D19.AUD_STEP_CD_MIN,
    D19.AUD_STEP_CD_MAX,
    D19.DRIVE_RTE_SUM /* 추진율 */,
    D19.DRIVE_RTE_ASC /* 추진율 조정평점 */,
    D19.DLY_DT_SUM /* 지연일 */,
    D19.ASP_RTE /* 가감점율 */,
    DECODE(D19.DLY_DT_SUM, 0, 0, (DECODE(INSTR(D19.DLY_DT_SUM, '-') , 0, '-', '') || CASE WHEN D19.DRIVE_RTE_ASC IS NOT NULL THEN ROUND(D19.DRIVE_RTE_ASC * NVL(D19.ASP_RTE, 0) / 100, 2) ELSE ROUND(D19.STND_ASC * D19.SYT_EVL_ADVL_VAL * ( D19.DRIVE_RTE_SUM / 100) * (NVL(D19.ASP_RTE, 0) / 100), 2) END) ) AS DLY_DT_SUM /* 가감평점 */,
    D19.SPE_ADD_SC /* 특별가산점 */,
    D19.MDT_ASC /* 조정평점 */,
    D19.CTB_RT /* 기여비율 */,
    D19.MNDY_CNT,
    D19.CVLCPT_ADT_YR /* 민원감사년도 */,
    D19.TSK_NO
FROM (SELECT D10.PTCPT_CNB,
    D10.ADT_KDCD /* 감사종류코드 */,
    D10.ADT_MTTR_NM /* 감사사항명 */,
    D10.NMPTCPT_CNT /* 참여인원 */,
    D10.STND_ASC /* 표준평점 */,
    D10.SYT_EVL_RK_CD,
    D10.SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D10.STND_ASC * D10.SYT_EVL_ADVL_VAL AS STND_ASC /* 가중평점=표준평점*가중치 */,
    D10.AUD_STEP_CD_MIN,
    D10.AUD_STEP_CD_MAX,
    D10.DRIVE_RTE_SUM /* 추진율 */,
    F_AOE_DRIVE_RTE_ASC_2(#strEvlYr#, #strHlyrDvsnCd#, D10.ADT_KDCD, D10.AUD_STEP_CD_MIN, D10.AUD_STEP_CD_MAX, D10.MNDY_CNT, D10.SYT_TRTM_YN, D10.SYT_EVL_ADVL_VAL, F_AOE_STND_ASC) AS F_AOE_DRIVE_RTE_ASC_2 /* 추진율 조정평점 */,
    D10.DLY_DT_SUM /* 지연일 */,
    NVL(D10.ASP_RTE, 0) AS ASP_RTE /* 가감점율 */,
    D10.SPE_ADD_SC /* 특별가산점 */,
    D10.MDT_ASC /* 조정평점 */,
    D10.CTB_RT /* 기여비율 */,
    D10.MNDY_CNT,
    D10.CVLCPT_ADT_YR /* 민원감사년도 */,
    D10.TSK_NO
FROM (SELECT HNDL_DIV_DPT_CD,
    SPVR_ENO /* 감리원직원전산번호 */,
    ADT_KDCD /* 감사종류코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_MTTR_NM /* 감사사항명 */,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    MNDY_CNT,
    NMPTCPT_CNT /* 참여인원 */,
    NVL(STND_ASC, 0) AS STND_ASC /* 표준평점 */,
    SYT_EVL_RK_CD,
    NVL(SYT_EVL_ADVL_VAL, 0) AS SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    (SELECT AS ASP_RTE
FROM TBCSPAOE012M WHERE DLAY_DT_NM = TO_CHAR(D9.DLY_DT_SUM) AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd#) AS ASP_RTE /*가감점율*/ , NVL(SPE_ADD_SC, F_AOE_SPE_ADD_SC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS SPE_ADD_SC , NVL(MDT_ASC, F_AOE_MDT_ASC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS MDT_ASC , EVL_YR , HLYR_DVSN_CD , SYT_TRTM_YN , PTCPT_CNB , CTB_RT , F_AOE_STND_ASC FROM (SELECT D5.HNDL_DIV_DPT_CD,
    D5.SPVR_ENO /* 감리원직원전산번호 */,
    D5.ADT_KDCD /* 감사종류코드 */,
    D5.CVLCPT_ADT_YR /* 민원감사년도 */,
    D5.TSK_NO,
    D5.ADT_MTTR_NM /* 감사사항명 */,
    D5.AUD_STEP_CD_MIN,
    D5.AUD_STEP_CD_MAX,
    D5.MNDY_CNT,
    (SELECT COUNT(*)
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX ) AS NMPTCPT_CNT /*참여인원*/ , F_AOE_STND_ASC(#strEvlYr#, #strHlyrDvsnCd#, D5.ADT_KDCD, D5.AUD_STEP_CD_MIN, D5.AUD_STEP_CD_MAX, D5.MNDY_CNT, NVL(D5.SYT_TRTM_YN,'N')) AS STND_ASC /*표준평점*/ , DECODE(NVL(D6.EVL_STEP_CD, 'X'), '100', D7.IDVT_INDEX_VAL, '200', D6.SYT_EVL_ADVL_VAL, 'X', (SELECT IDVT_INDEX_VAL
FROM TBCSPAOE010D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND AUD_TSK_KND_CD = D5.ADT_KDCD AND RK_CD = (SELECT ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX) ), 0 ) AS SYT_EVL_ADVL_VAL /*종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다.*/ , DECODE(NVL(D6.EVL_STEP_CD, 'X'), '100', D6.EVL_RK_CD, '200', D6.SYT_EVL_RK_CD, 'X', (SELECT ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX ), 0) AS SYT_EVL_RK_CD , (SELECT NVL(SUM(DRIVE_RTE), 0)
FROM TBCSPAOE008D WHERE 1 = 1 AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' ) AS DRIVE_RTE_SUM /*추진율*/ , (SELECT SUM(TO_NUMBER(DLAY_DT_NM-(NVL(EXET_DCN,0))))
FROM TBCSPAOE022M Z WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX ) AS DLY_DT_SUM /*지연일*/ , D6.SPE_ADD_SC , D6.MDT_ASC , D6.EVL_YR , D6.HLYR_DVSN_CD , D5.SYT_TRTM_YN , D8.PTCPT_CNB , D8.CTB_RT , D5.F_AOE_STND_ASC FROM (SELECT D2.HNDL_DIV_DPT_CD,
    D2.SPVR_ENO /* 감리원직원전산번호 */,
    D2.ADT_KDCD /* 감사종류코드 */,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO,
    D2.ADT_MTTR_NM /* 감사사항명 */,
    D1.AUD_STEP_CD_MIN,
    D1.AUD_STEP_CD_MAX,
    D2.MNDY_CNT,
    NVL(D3.SYT_TRTM_YN, 'N') AS SYT_TRTM_YN /* 종합처리안 여부 */,
    F_AOE_STND_ASC(#strEvlYr#, #strHlyrDvsnCd#, D2.ADT_KDCD, D1.AUD_STEP_CD_MIN, D1.AUD_STEP_CD_MAX, D2.MNDY_CNT,NVL(D3.SYT_TRTM_YN, 'N')) AS F_AOE_STND_ASC,
    ROWNUM
FROM (SELECT MIN(A.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(A.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    A.CVLCPT_ADT_YR /* 민원감사년도 */,
    A.TSK_NO
FROM TBCSPAOE022M A, TBCSPAOE001M B WHERE 1 = 1 AND A.CMPTN_YMD IS NOT NULL AND A.CMPTN_YMD BETWEEN B.EVL_STR_DT AND B.EVL_END_DT AND B.EVL_YR = #strEvlYr# AND B.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY CVLCPT_ADT_YR, TSK_NO) D1 , TBCSPAOE021M D2 , TBCSPAOE022M D3 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D3.CVLCPT_ADT_YR(+) = D1.CVLCPT_ADT_YR AND D3.TSK_NO(+) = D1.TSK_NO AND D3.ADT_STP_SECD(+) = '10004' ) D5 /*평가대상 감사활동 - 기준*/ , (SELECT D8.AUD_TSK_KND_CD,
    D8.CVLCPT_ADT_YR /* 민원감사년도 */,
    D8.TSK_NO,
    D8.SYT_EVL_ADVL_VAL,
    D8.EVL_YR,
    D8.HLYR_DVSN_CD,
    D8.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D8.EVL_RK_CD,
    D8.SYT_EVL_RK_CD,
    D8.EVL_STEP_CD,
    D8.SPE_ADD_SC,
    D8.MDT_ASC
FROM (SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD) AS EVL_STEP_CD,
    AUD_TSK_KND_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM TBCSPAOE029M WHERE 1 = 1 AND (CVLCPT_ADT_YR, TSK_NO, EVL_STEP_CD) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD)
FROM TBCSPAOE029M WHERE (CVLCPT_ADT_YR, TSK_NO) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M , ( SELECT EVL_STR_DT,
    EVL_END_DT
FROM TBCSPAOE001M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# ) SS WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN SS.EVL_STR_DT AND SS.EVL_END_DT GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY CVLCPT_ADT_YR, TSK_NO ) AND CVLCPT_TASK_SECD = '10000' AND EVL_STA_CD = '300' /*평가완료*/ GROUP BY EVL_YR, HLYR_DVSN_CD, CVLCPT_ADT_YR, TSK_NO, AUD_TSK_KND_CD, CVLCPT_TASK_SECD /*한 감사사항이 귀청보고평가, 위원평가를 받을 수 있기때문에 이렇게 한번 걸러내는 작업을 함*/ ) D7 , TBCSPAOE029M D8 WHERE D7.EVL_YR = D8.EVL_YR AND D7.HLYR_DVSN_CD = D8.HLYR_DVSN_CD AND D7.CVLCPT_TASK_SECD = D8.CVLCPT_TASK_SECD AND D7.AUD_TSK_KND_CD = D8.AUD_TSK_KND_CD AND D7.EVL_STEP_CD = D8.EVL_STEP_CD AND D7.CVLCPT_ADT_YR = D8.CVLCPT_ADT_YR AND D7.TSK_NO = D8.TSK_NO ) D6 /*감사사항 평가관리*/ , TBCSPAOE010D D7 , TBCSPAOE023M D8 WHERE D5.ADT_KDCD = D6.AUD_TSK_KND_CD (+) AND D5.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR (+) AND D5.TSK_NO = D6.TSK_NO (+) AND D6.EVL_YR = D7.EVL_YR (+) AND D6.HLYR_DVSN_CD = D7.HLYR_DVSN_CD (+) AND D6.CVLCPT_TASK_SECD = D7.CVLCPT_TASK_SECD (+) AND D6.AUD_TSK_KND_CD = D7.AUD_TSK_KND_CD (+) AND D6.EVL_RK_CD = D7.RK_CD (+) AND D8.CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND D8.TSK_NO = D5.TSK_NO AND D8.ADT_STP_SECD = D5.AUD_STEP_CD_MAX AND D8.CTB_RT != 0 ) D9 ) D10 ) D19 ) D20 ) UNION ALL SELECT MAN.NEVLT_CNB /* 피평가자전산번호 */,
    MAN.AUD_KND_NM /* 종류 */,
    JUMSU.TSK_NM /* 업무명 */,
    JUMSU.PTCPT_CNB_CNT /* 참여인원 */,
    JUMSU.STND_ASC /* 표준평점 */,
    JUMSU.EVL_RK_CD /* 평가등급 */,
    JUMSU.IDVT_INDEX_VAL /* 가중치 */,
    JUMSU.ADVL_ASC /* 가중평점=표준평점*가중치 */,
    '' AS TSK_ST_STEP_CD /* 단계기초 */,
    '' AS TSK_END_STEP_CD /* 단계기말 */,
    0 /* 추진율 합 */,
    0 /* 추진율 조정평점=가중평점*추진율/100 */,
    0 /* 지연일 */,
    '' AS ASP_RTE /* 가감점율 */,
    0 /* 가감평점=추진율조정평점*가감점율 */,
    0 /* 특별가산점 */,
    JUMSU.NAUD_TSK_EVL_SC /* 업무평점 */,
    RTE.CTB_RT /* 기여비율 */,
    MAN.PSN_TSK_ASC /* 개인평점 */,
    MAN.CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM (SELECT EVL_YR,
    HLYR_DVSN_CD,
    TSK_NO,
    NEVLT_CNB /* 피평가자전산번호 */,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    F_CODE_NM('1000272', AUD_TSK_KND_CD) AS F_CODE_NM /* 감사종류코드 */,
    AUD_TSK_KND_CD /* 감사업무종류코드 */,
    PSN_TSK_ASC /* 개인평점 */,
    SRECS_DEPT_CD /* 심사재심의부서코드 */,
    JBGD_SECD /* 직급구분코드 */
FROM TBCSPAOE035M WHERE 1 = 1 AND CVLCPT_TASK_SECD = '10001' AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND NEVLT_CNB = #strEvlCnb# ) MAN , TBCSPAOE025M RTE , (SELECT D3.EVL_YR,
    D3.HLYR_DVSN_CD,
    D3.TASK_KDCD /* 업무종류코드 */,
    D3.TSK_NO,
    D3.TSK_NM /* 업무명 */,
    D3.PTCPT_CNB_CNT /* 참여인원 */,
    D4.STND_ASC /* 표준평점 */,
    D5.EVL_RK_CD /* 평가등급 */,
    D6.IDVT_INDEX_VAL /* 가중치 */,
    ROUND(D4.STND_ASC * D6.IDVT_INDEX_VAL, 2) AS ROUND /* 가중평점=표준평점*가중치 */,
    D5.NAUD_TSK_EVL_SC /* 업무평점 */,
    D5.CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM (SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.TASK_KDCD /* 업무종류코드 */,
    D1.TSK_NO,
    MAX(D1.TSK_NM) AS TSK_NM /* 업무명 */,
    COUNT(PTCPT_CNB) AS PTCPT_CNB /* 참여인원 */,
    max(rownum) AS ROWNUM
FROM TBCSPAOE024M D1 , TBCSPAOE025M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.TASK_KDCD = D2.TASK_KDCD AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TASK_KDCD, D1.TSK_NO) D3 , TBCSPAOE006M D4 , TBCSPAOE029M D5 , TBCSPAOE010D D6 WHERE D3.EVL_YR = D4.EVL_YR AND D3.HLYR_DVSN_CD = D4.HLYR_DVSN_CD AND D4.CVLCPT_TASK_SECD = '10001' AND D3.TASK_KDCD = D4.TASK_KDCD AND D3.EVL_YR = D5.EVL_YR AND D3.HLYR_DVSN_CD = D5.HLYR_DVSN_CD AND D3.TASK_KDCD = D5.AUD_TSK_KND_CD AND D3.TSK_NO = D5.TSK_NO AND D5.CVLCPT_TASK_SECD = '10001' AND D5.EVL_STEP_CD = '700' AND D5.EVL_YR = D6.EVL_YR AND D5.HLYR_DVSN_CD = D6.HLYR_DVSN_CD AND D5.CVLCPT_TASK_SECD = D6.CVLCPT_TASK_SECD AND D5.AUD_TSK_KND_CD = D6.AUD_TSK_KND_CD AND D5.EVL_RK_CD = D6.RK_CD ) JUMSU WHERE MAN.EVL_YR = RTE.EVL_YR AND MAN.HLYR_DVSN_CD = RTE.HLYR_DVSN_CD AND MAN.AUD_TSK_KND_CD = RTE.TASK_KDCD AND MAN.TSK_NO = RTE.TSK_NO AND MAN.NEVLT_CNB = RTE.PTCPT_CNB AND MAN.EVL_YR = JUMSU.EVL_YR||'' AND MAN.HLYR_DVSN_CD = JUMSU.HLYR_DVSN_CD||'' AND MAN.TSK_NO = JUMSU.TSK_NO||'' AND MAN.CVLCPT_TASK_SECD = JUMSU.CVLCPT_TASK_SECD||'' AND RTE.CTB_RT != 0 ) D15 , TBDCMACM001M D16 WHERE 1 = 1 AND D15.PTCPT_CNB = D16.TRGT_NOP_ENO AND D15.PTCPT_CNB = #strEvlCnb# ORDER BY D15.PTCPT_CNB, D15.CVLCPT_TASK_SECD ) SELECT F_DPT_INFO(SRECS_DEPT_CD, '1') || CASE WHEN DEPT_TPCD IS NOT NULL THEN '(' || DECODE(DEPT_TPCD, 'S', 'Y', 'A', 'A', 'E', 'E', '') || ')' ELSE NULL END AS CRU_OGDP_DEPT_NM /* 부패소속부서명 */,
    F_DPT_INFO(UP_DPT_CD, '1') AS F_DPT_INFO,
    F_CODE_NM('1000173', JBGD_SECD) AS JBGD_NM /* 직급명 */,
    USER_NM AS USER_NM /* 사용자명 */,
    PTCPT_CNB,
    PSN_TSK_ASC AS PSN_TSK_ASC /* 개인평점환산 = 부서총점환산 * 기여율 / 100 */,
    AUD_SPRT_ASC /* 감사지원 */,
    PSN_TSK_ASC_OTHER /* 감사외 */,
    PSN_TSK_ASC_ALL AS PSN_TSK_ASC_ALL /* 개인종합평점 */,
    TO_CHAR(ROUND(NVL(CTB_RTE_AVG, 0), 2), 'FM999.00') AS TO_CHAR /* 기여도 합계 */,
    DECODE(DPT_DVSN_CD, '10', 'A', '20', 'S', '') || '(' || F_DPT_INFO(EVL_DPT_CD, '1') || ')' AS DPT_DVSN_CD /* 평가부서명 */,
    F_DPT_INFO(EVL_UP_DPT_CD, '1') AS F_DPT_INFO,
    DECODE(EVL_TG_YN, 'Y', TO_CHAR(RANK_NUM), '평가제외') AS EVL_TG_YN /* 직급별순위 */,
    EVL_TG_YN /* 평가제외여부 */,
    RMRK_CN /* 비고내용 */,
    EVL_YR,
    HLYR_DVSN_CD
FROM (SELECT D14.DPT_DVSN_CD /* 평가종료일 부서구분 */,
    D14.EVL_DPT_CD /* 평가종료일 부서코드 */,
    (SELECT AS HIRK_DPT_CD
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = D14.EVL_DPT_CD) AS EVL_UP_DPT_CD , D14.PTCPT_CNB , D14.JBGD_SECD , D14.USER_NM , D14.PSN_TSK_ASC /*개인평점환산 = 부서총점환산 * 기여율 / 100*/ , D14.AUD_SPRT_ASC /*감사지원*/ , D14.PSN_TSK_ASC_OTHER /*감사외*/ , D14.PSN_TSK_ASC_ALL , D14.CTB_RTE_AVG , D14.DEPT_TPCD /*현 부서구분*/ , D14.UP_DPT_CD /*현 부서 국과*/ , D14.SRECS_DEPT_CD /*현부서 과팀*/ , D14.EVL_YR , D14.HLYR_DVSN_CD , D14.EVL_TG_YN , D14.RMRK_CN , RANK() OVER(PARTITION BY D14.JBGD_SECD, D14.EVL_TG_YN ORDER BY D14.PSN_TSK_ASC_ALL DESC) AS RANK_NUM FROM (SELECT D2.DPT_DVSN_CD,
    D2.EVL_DPT_CD,
    D2.TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    D2.JBGD_SECD /* 직급구분코드 */,
    D3.USER_NM /* 사용자명 */,
    D4.HIRK_DPT_CD,
    D3.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    D4.DEPT_TPCD AS DEPT_TPCD /* 부서유형코드 */,
    D2.EVL_YR,
    D2.HLYR_DVSN_CD,
    D2.EVL_TG_YN,
    D2.RMRK_CN /* 비고내용 */,
    DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.PSN_TSK_ASC, 0)) AS EVL_TG_YN /* 개인평점환산 = 부서총점환산 * 기여율 / 100 */,
    DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.AUD_SPRT_ASC, 0)) AS EVL_TG_YN /* 감사지원 */,
    DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.PSN_TSK_ASC_OTHER, 0)) AS EVL_TG_YN /* 감사외 */,
    DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.PSN_TSK_ASC, 0)) + DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.AUD_SPRT_ASC, 0)) + DECODE(D2.EVL_TG_YN, 'N', 0, NVL(D1.PSN_TSK_ASC_OTHER, 0)) AS EVL_TG_YN /* 개인종합평점 */,
    D1.CTB_RTE_AVG
FROM (SELECT A.EVL_YR,
    A.HLYR_DVSN_CD,
    A.PTCPT_CNB,
    SUM(A.AUD_SPRT_ASC) AS AUD_SPRT_ASC,
    SUM(A.PSN_TSK_ASC_OTHER) AS PSN_TSK_ASC_OTHER,
    SUM(A.PSN_TSK_ASC) AS PSN_TSK_ASC,
    SUM(A.CTB_RTE_AVG) AS CTB_RTE_AVG
FROM (SELECT A.EVL_YR AS EVL_YR,
    A.HLYR_DVSN_CD AS HLYR_DVSN_CD,
    A.PTCPT_CNB AS PTCPT_CNB,
    NVL(SUM(ROUND(A.PSN_TSK_ASC_DEPT * A.CTB_RTE_AVG / 100, 2)), 0) AS ROUND,
    0,
    0,
    A.CTB_RTE_AVG
FROM (SELECT A.EVL_YR,
    A.HLYR_DVSN_CD,
    A.CHR_DPT_CD,
    A.PTCPT_CNB,
    A.CTB_RTE_AVG,
    F_AOE_DPT_TSC(A.EVL_YR, A.HLYR_DVSN_CD, A.CHR_DPT_CD) AS F_AOE_DPT_TSC
FROM (SELECT SUM(D1.WGT_RTE * D2.CTB_RT / 100) AS WGT_RTE /* 기여율 = 비중 * 기여율 / 100 */,
    D2.PTCPT_CNB,
    D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CHR_DPT_CD
FROM TBCSPAOE026M D1 , TBCSPAOE027M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CHR_DPT_CD = CASE WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '141' THEN '141000' WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '121' THEN '121000' WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '122' AND D2.CHR_DPT_CD = '122500' THEN D2.CHR_DPT_CD WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '122' AND D2.CHR_DPT_CD <> '122500' THEN '122000' ELSE D2.CHR_DPT_CD END AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.PTCPT_CNB IN (SELECT TRGT_NOP_ENO /* 대상인원직원전산번호 */
FROM TBCSPAOE041M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_DVSN_CD = '20') /*2015.03.30 권효정 감사관 요청사항*/ GROUP BY D2.PTCPT_CNB, D1.EVL_YR, D1.HLYR_DVSN_CD, D1.CHR_DPT_CD, D2.CTB_RT ) A ) A GROUP BY A.EVL_YR, A.HLYR_DVSN_CD, A.PTCPT_CNB, A.CTB_RTE_AVG UNION ALL SELECT D10.EVL_YR AS EVL_YR,
    D10.HLYR_DVSN_CD AS HLYR_DVSN_CD,
    D10.PTCPT_CNB AS PTCPT_CNB,
    0,
    SUM(D10.AUD_SPRT_ASC) AS AUD_SPRT_ASC /* 감사지원 */,
    SUM(D10.PSN_TSK_ASC_OTHER) AS PSN_TSK_ASC_OTHER /* 감사외 */,
    0
FROM (SELECT D6.NEVLT_CNB,
    D6.AUD_SPRT_ASC /* 감사지원 */,
    D6.PSN_TSK_ASC_OTHER /* 감사외 */,
    D6.EVL_YR,
    D6.HLYR_DVSN_CD
FROM ( SELECT A.EVL_YR,
    A.HLYR_DVSN_CD,
    A.NEVLT_CNB /* 피평가자전산번호 */,
    ROUND(NVL(SUM(DECODE(A.CVLCPT_TASK_SECD, '10000', A.PSN_TSK_ASC, 0)), 0), 2) AS ROUND,
    ROUND(NVL(SUM(DECODE(A.CVLCPT_TASK_SECD, '10001', A.PSN_TSK_ASC, 0)), 0), 2) AS ROUND
FROM DATA A WHERE 1 = 1 AND A.NEVLT_CNB = #strEvlCnb# GROUP BY A.EVL_YR, A.HLYR_DVSN_CD, A.NEVLT_CNB ) D6 ) D10 GROUP BY D10.PTCPT_CNB, D10.EVL_YR, D10.HLYR_DVSN_CD ) A GROUP BY A.EVL_YR , A.HLYR_DVSN_CD, A.PTCPT_CNB) D1 , (SELECT EVL_YR,
    HLYR_DVSN_CD,
    DPT_DVSN_CD,
    EVL_DPT_CD,
    EVL_TG_YN,
    TRGT_NOP_ENO /* 대상인원직원전산번호 */,
    RMRK_CN /* 비고내용 */,
    JBGD_SECD /* 직급구분코드 */
FROM TBCSPAOE041M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DPT_DVSN_CD = '20' ) D2 , TBDCMACM001M D3 , TBDCMACM002M D4 WHERE D1.PTCPT_CNB (+) = D2.TRGT_NOP_ENO AND D2.TRGT_NOP_ENO = D3.TRGT_NOP_ENO AND D3.SRECS_DEPT_CD = D4.SRECS_DEPT_CD ) D14 ORDER BY DECODE(D14.EVL_TG_YN, 'Y', 0, 1), D14.JBGD_SECD, RANK_NUM ) D15 WHERE 1 = 1 AND PTCPT_CNB = #strEvlCnb# AND EVL_UP_DPT_CD = #strDeptUpCd# AND EVL_DPT_CD = #strDeptCd# AND JBGD_SECD = #JBGD_SECD#