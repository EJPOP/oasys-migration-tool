WITH BOKG_INFO AS ( SELECT MIN(DECODE(A.USE_STR_DT, B.USE_STR_DT, DECODE(A.DMT_DVSN_CD, B.DMT_DVSN_CD, A.BOKG_CNT, ''), '')) AS USE_STR_DT,
    MIN(DECODE(A.USE_STR_DT, B.USE_STR_DT, DECODE(A.DMT_DVSN_CD, B.DMT_DVSN_CD, A.CNB_CNT, ''), '')) AS USE_STR_DT,
    MIN(DECODE(A.USE_STR_DT, B.USE_STR_DT, DECODE(A.DMT_DVSN_CD, B.DMT_DVSN_CD, A.USE_CNT, ''), '')) AS USE_STR_DT,
    MIN(DECODE(A.USE_STR_DT, B.USE_STR_DT, DECODE(A.DMT_DVSN_CD, B.DMT_DVSN_CD, A.TOT_USE_FEE, ''), '')) AS USE_STR_DT,
    A.USE_STR_DT,
    A.DMT_DVSN_CD
FROM ( SELECT TO_CHAR(COUNT(DMT_DVSN_CD)) AS TO_CHAR,
    '' AS CNB_CNT,
    '' AS USE_CNT,
    '' AS TOT_USE_FEE,
    USE_STR_DT,
    DMT_DVSN_CD
FROM TBCSPSAE501D WHERE COFM_STA_CD IN ('30', '50', '60') GROUP BY USE_STR_DT, DMT_DVSN_CD UNION SELECT '' AS BOKG_CNT,
    '' AS CNB_CNT,
    '' AS USE_CNT,
    TO_CHAR(SUM(USE_FEE)) AS TO_CHAR,
    USE_STR_DT,
    DMT_DVSN_CD
FROM TBCSPSAE501D WHERE COFM_STA_CD IN ('30', '50', '60') GROUP BY USE_STR_DT, DMT_DVSN_CD ) A , (SELECT USE_STR_DT,
    DMT_DVSN_CD
FROM TBCSPSAE501D GROUP BY USE_STR_DT, DMT_DVSN_CD) B WHERE A.USE_STR_DT = B.USE_STR_DT AND A.DMT_DVSN_CD = B.DMT_DVSN_CD GROUP BY A.USE_STR_DT, A.DMT_DVSN_CD ) SELECT NVL2(A.LINK_YR, A.LINK_YR, '총계') AS LINK_YR /* 연계년도 */,
    DECODE(NVL2(A.LINK_YR, A.LINK_YR, '총계'), '총계', '', NVL2(A.M, A.M, '합계')) AS NVL2,
    DECODE(NVL2(A.M, A.M, '합계'), '합계', '', NVL2(TO_CHAR(A.WEK), TO_CHAR(A.WEK), '소계')) AS NVL2,
    DECODE(NVL2(TO_CHAR(A.WEK), TO_CHAR(A.WEK), '소계'), '소계', '', NVL2(A.USE_STR_DT, SUBSTR(A.USE_STR_DT, 0, 4) || '-' || SUBSTR(A.USE_STR_DT, 5, 2) || '-' || SUBSTR(A.USE_STR_DT, 7, 2) || '(' || SUBSTRING(UPPER(TO_CHAR(TO_DATE(A.USE_STR_DT), 'DAY', 'NLS_DATE_LANGUAGE=KOREAN')), 0, 1) || ')' , '소계')) AS NVL2,
    DECODE(NVL2(A.USE_STR_DT, A.USE_STR_DT, '소계'), '소계', '', NVL2(TO_CHAR(A.FLOOR), TO_CHAR(A.FLOOR), '소계')) AS NVL2,
    DECODE(NVL2(TO_CHAR(A.FLOOR), TO_CHAR(A.FLOOR), '소계'), '소계', '', NVL2(A.ROOM_TYPE, A.ROOM_TYPE, '소계')) AS NVL2,
    NVL(SUM(A.BOKG_CNT), 0) AS BOKG_CNT,
    NVL(SUM(TOT_USE_FEE), 0) AS TOT_USE_FEE
FROM ( SELECT DISTINCT TO_CHAR(TO_DATE(A.END_DDL_DT)-1, 'YYYY') AS LINK_YR /* 연계년도 */,
    TO_CHAR(TO_DATE(A.END_DDL_DT)-1, 'MM') AS TO_CHAR,
    A.WEK,
    C.USE_STR_DT,
    D.USR_DFN_TXT_1,
    D.USR_DFN_TXT_2,
    (SELECT AS BOKG_CNT
FROM BOKG_INFO WHERE USE_STR_DT = C.USE_STR_DT AND DMT_DVSN_CD = D.CD) AS BOKG_CNT , (SELECT TOT_USE_FEE
FROM BOKG_INFO WHERE USE_STR_DT = C.USE_STR_DT AND DMT_DVSN_CD = D.CD) AS TOT_USE_FEE FROM TBCSPSAE134B A , TBCSPSAE501M B , TBCSPSAE501D C , TBDCMACM013C D WHERE C.TRGT_NOP_ENO = B.TRGT_NOP_ENO AND C.APL_DT = B.APL_DT AND C.BSC_SRNO = B.BSC_SRNO AND C.COFM_STA_CD IN ('30', '50', '60') AND C.USE_STR_DT = TO_CHAR(TO_DATE(A.END_DDL_DT)-1,'YYYYMMDD') AND D.CMM_CD_DVSN_CD = '1000140' AND D.USE_YN = 'Y' AND C.USE_STR_DT BETWEEN #strFromDt# AND #strToDt# ) A GROUP BY ROLLUP(A.LINK_YR , A.M , A.WEK , A.USE_STR_DT , ( A.FLOOR , A.ROOM_TYPE ) )