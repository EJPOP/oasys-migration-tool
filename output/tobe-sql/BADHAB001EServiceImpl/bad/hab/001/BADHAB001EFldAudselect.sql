SELECT DISTINCT T1.ADT_NO AS ADT_NO /* 감사번호 */,
    T1.CVLCPT_ADT_YR /* 민원감사년도 */,
    ' ' || CHR(10) || T1.ADT_MTTR_NM || CHR(10) || '(' || F_MNG_KND_AUDYRNO(T1.CVLCPT_ADT_YR, T1.ADT_NO, T1.ADT_KDCD, '-') || ') ' || F_USR_INFO(T1.ADT_RBPRSN_ENO, '2') AS CHR /* 감사종류및연번호(AA07) */,
    F_ORG_INFO(T1.ADT_RPRS_INST_CD, '1') || CHR(10) || ' 외 ' || T4.INST_CONT || '개 기관' AS F_ORG_INFO /* 대상기관 */,
    REPLACE(T5.BZT_DT,'@',CHR(10)) AS REPLACE,
    REPLACE(T5.BZT_TL_NM,'@',CHR(10)) AS REPLACE,
    T2.DAG_RPT_YMD /* 귀청보고일자 */,
    '귀청보고' AS RPT_KND /* 보고서종류 */,
    T2.DAG_RPT_NOCS /* 귀청보고건수 */,
    (CASE WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NOT NULL THEN T2.OW_PSD_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NOT NULL THEN T2.OW_PSD_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_DHD_ATRZ_YMD) IS NOT NULL THEN T2.OW_DHD_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_DHD_ATRZ_YMD) IS NULL AND RTRIM(T2.JDAF_SRNG_OFER_ATRZ_YMD) IS NOT NULL THEN T2.JDAF_SRNG_OFER_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_DHD_ATRZ_YMD) IS NULL AND RTRIM(T2.JDAF_SRNG_OFER_ATRZ_YMD) IS NULL AND RTRIM(T2.AJMT_DDG_ATRZ_YMD) IS NOT NULL THEN T2.AJMT_DDG_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_DHD_ATRZ_YMD) IS NULL AND RTRIM(T2.JDAF_SRNG_OFER_ATRZ_YMD) IS NULL AND RTRIM(T2.AJMT_DDG_ATRZ_YMD) IS NULL AND RTRIM(T2.AJMT_OFER_ATRZ_YMD) IS NOT NULL THEN T2.AJMT_OFER_ATRZ_YMD WHEN RTRIM(T2.LDRV_MBCMT_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_PSD_ATRZ_YMD) IS NULL AND RTRIM(T2.OW_DHD_ATRZ_YMD) IS NULL AND RTRIM(T2.JDAF_SRNG_OFER_ATRZ_YMD) IS NULL AND RTRIM(T2.AJMT_DDG_ATRZ_YMD) IS NULL AND RTRIM(T2.AJMT_OFER_ATRZ_YMD) IS NULL AND RTRIM(T2.AB_ATRZ_YMD) IS NOT NULL THEN T2.AB_ATRZ_YMD ELSE '' END) AS RTRIM /* 처리안일자 */,
    '부의위임' AS HNDL_APV_DVSN,
    T2.DPP_SBCN_NOCS /* 처리안부의건수 */,
    T2.DPP_DLGT_NOCS /* 처리안위임건수 */,
    F_USR_INFO(T2.LDRV_ENO, '2') AS LDRV_NM /* 주심위원명 */,
    T2.LDRV_ENO /* 주심위원직원전산번호 */,
    T2.SBCN_YMD /* 부의일자 */,
    '부의' AS SBCN_KND,
    T2.CMT_SBCN_NOCS /* 위원회부의건수 */,
    T2.STUT_RMRK_CN /* 상황비고내용 */,
    T1.SPRVSN_DEPT_CD /* 주관부서코드 */,
    T1.MNG_DEPT_CD /* 관리부서코드 */,
    F_DPT_INFO(T1.MNG_DEPT_CD, '1') AS F_DPT_INFO,
    Z1.ADT_OW_PRCS_DEPT_SQNO /* 감사사무처리부서순번 */,
    (SELECT TO_CHAR(TO_DATE(X1.TRF_DT),'YYYY-MM-DD') || '(' || F_DPT_INFO(X1.TRF_BEF_CHR_DPT_CD, '1') || '->' || F_DPT_INFO(T1.MNG_DEPT_CD, '1') || ')' AS MNG_DEPT_CD /* 관리부서코드 */
FROM TBBADHAB002H X1 WHERE X1.CVLCPT_TASK_SECD = '01' AND X1.REF_YR = T1.CVLCPT_ADT_YR AND TO_CHAR(X1.REF_SRNO) = T1.ADT_NO AND X1.TRF_AF_CHR_DPT_CD = T1.MNG_DEPT_CD AND X1.CMPTN_YN = 'Y' ) AS TRF_BEF_AF_DPT /* 이관처리 전 후 부서 */ , NVL(T2.ADT_YR,'N') AS EXIST_YN FROM TB_BADDED001M T1 /*감사사항기본*/ , TBBADHAB008M Z1 /*감사사무처리부 실지감사사항기본 추가 - 2015.07.27 yyh*/ , TB_BADDED003M T2 /*국과별감사처리상황기본*/ , (SELECT S5.REL_ADT_YR /* 관계감사년도 */,
    S5.REL_ADT_NO /* 관계감사번호 */,
    S5.ADT_BGNG_YMD /* 감사시작일자 */,
    S5.ADT_END_YMD /* 감사종료일자 */
FROM TBBADDED002M S5 /*출장상황기본*/ WHERE S5.ADT_BZTRP_KDCD >= '01' /*감사출장종류코드*/ AND (substring(S5.ADT_BGNG_YMD,1,4) = #strYr# or substring(S5.ADT_END_YMD,1,4) = #strYr#) ) T3 , (SELECT S3.REL_ADT_YR /* 관계감사년도 */,
    S3.REL_ADT_NO /* 관계감사번호 */,
    COUNT(*) AS INST_CONT /* 기관개수 */
FROM (SELECT S2.REL_ADT_YR /* 관계감사년도 */,
    S2.REL_ADT_NO /* 관계감사번호 */,
    S1.INST_CD /* 기관코드 */
FROM TBBADDED008L S1 /*조별출장대상기관내역*/ , TBBADDED002M S2 /*출장상황기본*/ WHERE S1.BZTRP_YR(+) = S2.BZTRP_YR AND S1.BZTRP_SQNO(+) = S2.BZTRP_SQNO AND (substring(S2.ADT_BGNG_YMD,1,4) = #strYr# AND substring(S2.ADT_END_YMD,1,4) = #strYr#) GROUP BY S2.REL_ADT_YR, S2.REL_ADT_NO, S1.INST_CD ) S3 GROUP BY S3.REL_ADT_YR, S3.REL_ADT_NO ) T4, ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    ADT_NO /* 감사번호 */,
    MAX(BZT_DT) AS BZT_DT,
    MAX(BZT_TL_NM) AS BZT_TL_NM
FROM ( SELECT T3.REL_ADT_YR AS REL_ADT_YR /* 관계감사년도 */,
    T3.REL_ADT_NO AS REL_ADT_NO /* 관계감사번호 */,
    SUBSTR(SYS_CONNECT_BY_PATH (T3.BZT_DT, '@'),2) AS SUBSTR,
    SUBSTR(SYS_CONNECT_BY_PATH (T3.BZT_TL_NM, '@'),2) AS SUBSTR
FROM ( SELECT T1.REL_ADT_YR /* 관계감사년도 */,
    T1.REL_ADT_NO /* 관계감사번호 */,
    '(' || SUBSTR(F_CODE_NM('1000030',T1.ADT_BZTRP_KDCD),0,2) || ')' || TO_CHAR(TO_DATE(T1.ADT_BGNG_YMD),'YYYY-MM-DD') || '~' || TO_CHAR(TO_DATE(T1.ADT_END_YMD),'YYYY-MM-DD') AS SUBSTR,
    T1.BZTRP_YR /* 출장년도 */,
    T1.BZTRP_SQNO /* 출장순번 */,
    (SELECT F_USR_INFO(T1.BZTRP_TL_ENO, '2') AS BZTRP_TL_ENO /* 출장반장직원전산번호 */
FROM DUAL) || ' 외 ' || T2.PSON_CNT AS BZT_TL_NM /*출장반장(책임자및출장인원)*/ , ROW_NUMBER() OVER (PARTITION BY T1.REL_ADT_YR, T1.REL_ADT_NO ORDER BY T1.BZTRP_SQNO) RN1 , ROW_NUMBER() OVER (PARTITION BY T1.REL_ADT_YR, T1.REL_ADT_NO ORDER BY T1.BZTRP_SQNO) + 1 RN2 FROM TBBADDED002M T1 /*출장상황기본*/ , (SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    COUNT(*) AS PSON_CNT
FROM (SELECT S2.BZTRP_YR /* 출장년도 */,
    S2.BZTRP_SQNO /* 출장순번 */,
    S1.BZTRVR_ENO /* 출장자직원전산번호 */
FROM TBBADDED005L S1 /*조별출장자배정내역*/ , TBBADDED002M S2 /*출장상황기본*/ WHERE S1.BZTRP_YR(+) = S2.BZTRP_YR AND S1.BZTRP_SQNO(+) = S2.BZTRP_SQNO AND S2.REL_ADT_YR >= #strBztYr# GROUP BY S2.BZTRP_YR, S2.BZTRP_SQNO, S1.BZTRVR_ENO ) S3 GROUP BY S3.BZTRP_YR, S3.BZTRP_SQNO ) T2 WHERE T1.BZTRP_YR = T2.BZTRP_YR AND T1.BZTRP_SQNO = T2.BZTRP_SQNO AND T1.REL_ADT_YR >= #strBztYr# AND T1.ADT_BZTRP_KDCD IN ( '01', '02') /*감사출장종류코드*/ ) T3 START WITH RN1 = 1 CONNECT BY PRIOR RN2 = RN1 AND PRIOR T3.REL_ADT_NO = T3.REL_ADT_NO AND PRIOR T3.REL_ADT_YR = T3.REL_ADT_YR ) T4 GROUP BY CVLCPT_ADT_YR, ADT_NO ) T5 WHERE 1=1 AND Z1.CVLCPT_ADT_YR = T1.CVLCPT_ADT_YR AND Z1.ADT_NO = T1.ADT_NO AND T2.ADT_YR(+) = Z1.CVLCPT_ADT_YR AND T2.ADT_NO(+) = Z1.ADT_NO AND T3.REL_ADT_YR(+) = Z1.CVLCPT_ADT_YR AND T3.REL_ADT_NO(+) = Z1.ADT_NO AND T4.REL_ADT_YR = Z1.CVLCPT_ADT_YR AND T4.REL_ADT_NO = Z1.ADT_NO AND T5.CVLCPT_ADT_YR(+) = Z1.CVLCPT_ADT_YR AND T5.ADT_NO(+) = Z1.ADT_NO AND T1.MNG_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, '', #strDptCd#))) AND T1.MNG_DEPT_CD = #MNG_DEPT_CD# AND T1.ADT_NO = #ADT_NO# ORDER BY Z1.ADT_OW_PRCS_DEPT_SQNO DESC ,T1.SPRVSN_DEPT_CD /* ORDER BY T1.AUD_NO DESC , T1.SPV_BRDV_CD */