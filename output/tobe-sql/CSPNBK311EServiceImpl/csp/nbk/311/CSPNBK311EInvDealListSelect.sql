WITH MAX_INV_IJ AS ( SELECT MAX(D2.INV_DEAL_SLN) AS INV_DEAL_SLN
FROM TBCSPNBK102L D2 WHERE D2.MOUI_NO = #mouiNo# AND D2.INV_KND_CD = '0' AND D2.INV_DEAL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD') D2.CNL_YN = #cnlYn# ), CLSNG_YN_DATA AS ( SELECT /* CSPNBK311ESystemClsngYnSelect */ DISTINCT D4.DDLN_YN AS DDLN_YN /* 마감여부 */
FROM TBCSPNBK502M D4 WHERE D4.DEAL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD') ) SELECT /* CSPNBK311EInvDealListSelect */ D1.MOUI_NO,
    D1.INV_DEAL_DT,
    D1.INV_DEAL_SLN,
    D1.PET_DT /* 조작일시 */,
    TO_CHAR( D1.PET_DT, 'HH24MI') AS TO_CHAR,
    DECODE( D1.DEPTS_PMT_DVSN_CD, 'C', D1.INV_AM, 0 ) AS DEPTS_PMT_DVSN_CD,
    DECODE( D1.DEPTS_PMT_DVSN_CD, 'D', D1.INV_AM, 0 ) AS DEPTS_PMT_DVSN_CD,
    NVL(D1.DEAL_AF_LEDG_BL, 0) AS DEAL_AF_LEDG_BL,
    D1.BBK_PRT_YN,
    '출력' AS BBK_PRT_BTN_NM,
    D1.RMRK_CN /* 비고내용 */,
    NVL(D1.CNL_YN, 'N') AS CNL_YN,
    ( CASE WHEN ( SELECT D5.DDLN_YN AS DDLN_YN /* 마감여부 */
FROM CLSNG_YN_DATA D5 ) = 'N' THEN CASE WHEN D1.INV_DEAL_SLN = ( SELECT D3.MAX_INV_DEAL_SLN
FROM MAX_INV_IJ D3 ) THEN '취소' ELSE NULL END ELSE NULL END ) AS CNL_YN_BTN_NM , D1.CNL_RMK , D1.INV_KND_CD , D1.SMB_DEAL_DT , D1.SMB_SLN , D1.DEPTS_PMT_DVSN_CD FROM TBCSPNBK102L D1 WHERE D1.MOUI_NO = #mouiNo# D1.INV_DEAL_DT BETWEEN #beginInvDealDt# AND #endInvDealDt# D1.INV_KND_CD = #invKndCd# D1.INV_DEAL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD') D1.BBK_PRT_YN = #bbkRptYn# D1.CNL_YN = #cnlYn# ORDER BY INV_DEAL_DT DESC , INV_DEAL_SLN DESC ORDER BY INV_DEAL_DT, INV_DEAL_SLN