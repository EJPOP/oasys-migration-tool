SELECT D1.BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO /* 출장순번 */,
    D1.BZTRVR_ENO /* 출장자직원전산번호 */,
    D1.BZTRVR_NM||'('||D1.BZTRVR_ENO||')' AS BZTRVR_NM /* 출장자명 */,
    D1.BZTRVR_JBGD_SECD /* 출장자직급구분코드 */,
    F_CODE_NM('1000173', D1.BZTRVR_JBGD_SECD) AS F_CODE_NM /* 직급명 */,
    CASE WHEN D3.CNT<=0 AND D2.BZTRVR_ENO IS NOT NULL THEN 'Y' ELSE D1.LEAD_AEX_RCPN_YN END AS LEAD_AEX_RCPN_YN /* 지휘수용비수령인여부 */
FROM TB_BADDED010L D1 , (SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    BZTRP_TL_ENO /* 출장반장직원전산번호 */,
    BZTRVR_ENO /* 출장자직원전산번호 */
FROM (SELECT D1.BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO /* 출장순번 */,
    CASE WHEN D2.LEAD_AEX_RCPN_YN = 'Y' THEN D2.BZTRVR_ENO WHEN D2.LEAD_AEX_RCPN_YN IS NULL THEN D1.BZTRP_TL_ENO END AS BZTRP_TL_ENO /* 출장반장직원전산번호 */,
    D2.BZTRVR_ENO /* 출장자직원전산번호 */
FROM TBBADDED002M D1 /*출장상황기본*/, TBBADDED010L D2 /*출장비수령자내역*/ WHERE 1=1 AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# AND D1.BZTRP_YR = D2.BZTRP_YR(+) AND D1.BZTRP_SQNO = D2.BZTRP_SQNO(+) ) WHERE 1=1 AND BZTRP_TL_ENO = BZTRVR_ENO ) D2 , ( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    SUM(CASE WHEN NVL(D1.LEAD_AEX_RCPN_YN,'N') = 'Y' THEN 1 ELSE 0 END) AS LEAD_AEX_RCPN_YN /* 지휘수용비수령인여부 */
FROM TBBADDED010L D1 WHERE 1=1 AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# GROUP BY BZTRP_YR, BZTRP_SQNO ) D3 WHERE 1=1 AND D1.BZTRP_YR = D2.BZTRP_YR(+) AND D1.BZTRP_SQNO = D2.BZTRP_SQNO(+) AND D1.BZTRVR_ENO = D2.BZTRVR_ENO(+) AND D1.BZTRP_YR = D3.BZTRP_YR(+) AND D1.BZTRP_SQNO = D3.BZTRP_SQNO(+) AND D1.BZTRP_YR = #BZTRP_YR# AND D1.BZTRP_SQNO = #BZTRP_SQNO# ORDER BY TO_NUMBER(D1.BZTRVR_ENO)