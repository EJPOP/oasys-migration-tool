SELECT DECODE(DT.SLCT_RPTP_KDCD, 'A10700500', '부의안/부의안요약문', F_CODE_NM('1000786',DT.SLCT_RPTP_KDCD)) AS SLCT_RPTP_KDCD /* 청탁보고서종류코드 */,
    DT.SLCT_RPTP_NM /* 청탁보고서명 */,
    DT.DISP_APV_STA_NM,
    DT.SLCT_RPTP_KDCD /* 청탁보고서종류코드 */,
    DT.ATRZ_DMND_ID /* 결재요청아이디 */,
    DT.ATRZ_STTS_SECD /* 결재상태구분코드 */,
    DT.TPOF_ATRZ_SECD /* 제보결재구분코드 */,
    DT.CVLCPT_DOC_ID /* 민원문서아이디 */,
    DT.TPOF_RFRNC_ID /* 제보참조아이디 */
FROM ( SELECT T1.SLCT_RPTP_NM /* 청탁보고서명 */,
    F_CODE_NM('1000773',T1.ATRZ_STTS_SECD) || '(' || TO_CHAR(APV.CRU_LAST_ATRZ_DT,'YYYY-MM-DD') || ')' AS F_CODE_NM,
    T1.SLCT_RPTP_KDCD /* 청탁보고서종류코드 */,
    T1.ATRZ_DMND_ID /* 결재요청아이디 */,
    T1.ATRZ_STTS_SECD /* 결재상태구분코드 */,
    T1.CVLCPT_DOC_ID /* 민원문서아이디 */,
    T1.TPOF_RFRNC_ID /* 제보참조아이디 */,
    APV.TPOF_ATRZ_SECD /* 제보결재구분코드 */
FROM ( /*예비조사계획서, 감사실시계획서, 감사종료보고서, 부의안/부의안요약문, 공개문전문*/ SELECT A.RPTP_KDCD /* 보고서종류코드 */,
    CASE WHEN A.RPTP_KDCD = 'A10700500' /*부의안 요약 + 부의안 한줄로 처리 */ THEN A.RPTP_NM ||'/'|| (SELECT ST1.SLCT_RPTP_NM AS RPTP_KDCD /* 보고서종류코드 */
FROM TBBADDED103M ST1 WHERE ST1.CVLCPT_ADT_YR = A.CVLCPT_ADT_YR AND ST1.ADT_NO = A.ADT_NO AND ST1.ADT_STP_SECD = A.ADT_STP_SECD AND ST1.ADT_KDCD = A.ADT_KDCD AND ST1.TPOF_RFRNC_YMD = A.TPOF_RFRNC_YMD AND ST1.RFRNC_DOC_ID = A.RFRNC_DOC_ID AND ST1.TPOF_RFRNC_ID = A.CVLCPT_DOC_ID AND ST1.SLCT_RPTP_KDCD = 'A10700800') ELSE A.SLCT_RPTP_NM END AS SLCT_RPTP_NM ,A.ATRZ_STTS_SECD ,A.ATRZ_DMND_ID ,A.CVLCPT_DOC_ID ,CASE WHEN A.SLCT_RPTP_KDCD = 'A10700500' /*부의안 인 경우 부의안요약문(원장용) DOC_ID를 조회*/ THEN (SELECT ST1.CVLCPT_DOC_ID /* 문서아이디 */
FROM TBBADDED103M ST1 WHERE ST1.CVLCPT_ADT_YR = A.CVLCPT_ADT_YR AND ST1.ADT_NO = A.ADT_NO AND ST1.ADT_STP_SECD = A.ADT_STP_SECD AND ST1.ADT_KDCD = A.ADT_KDCD AND ST1.TPOF_RFRNC_YMD = A.TPOF_RFRNC_YMD AND ST1.RFRNC_DOC_ID = A.RFRNC_DOC_ID AND ST1.TPOF_RFRNC_ID = A.CVLCPT_DOC_ID AND ST1.SLCT_RPTP_KDCD = 'A10700800') ELSE TPOF_RFRNC_ID END AS TPOF_RFRNC_ID FROM TBBADDED103M A WHERE A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# AND A.SLCT_RPTP_KDCD IN ('A10200100','A10300100','A10500200','A10700500') AND A.ATRZ_STTS_SECD = '30' UNION /*감사보고서 : 결재완료된 최종보고서가 있으면 기존의 결재완료된 보고서(감사결과 처리단계의 보고서)가 아니라 최종보고서만 조회 */ SELECT A.RPTP_KDCD /* 보고서종류코드 */,
    A.RPTP_NM /* 보고서명 */,
    A.ATRZ_STTS_SECD /* 결재상태구분코드 */,
    A.ATRZ_DMND_ID /* 결재요청아이디 */,
    A.CVLCPT_DOC_ID /* 문서아이디 */,
    A.RFRNC_ID /* 참조아이디 */
FROM TBBADDED103M A WHERE A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# AND A.SLCT_RPTP_KDCD = 'A10600200' AND A.ATRZ_STTS_SECD = '30' /*최종보고서가 결재 완료면 최종보고서만 조회*/ AND ADT_STP_SECD = 'A1070' AND LAST_ADT_RPTP_YN = 'Y' ) T1 , TBDCMACM022L APV WHERE T1.ATRZ_DMND_ID = APV.ATRZ_DOC_NO AND APV.ATRZ_STTS_SECD = '3' UNION /*공개문전문 : 공개문 전문은 REF_ID, 감사보고서의 DOC_ID 가 있음*/ SELECT A.RPTP_NM /* 보고서명 */,
    '제출일자('|| TO_CHAR(TO_DATE(MAX(B.PBRL_SBMSN_YMD)),'YYYY-MM-DD') || ')' AS TO_CHAR,
    A.RPTP_KDCD /* 보고서종류코드 */,
    A.ATRZ_DMND_ID /* 결재요청아이디 */,
    A.ATRZ_STTS_SECD /* 결재상태구분코드 */,
    A.CVLCPT_DOC_ID /* 문서아이디 */,
    A.RFRNC_ID /* 참조아이디 */,
    '' AS TPOF_ATRZ_SECD /* 제보결재구분코드 */
FROM TBBADDED103M A ,TBBADEAR028M B WHERE A.CVLCPT_ADT_YR = SUBSTR(B.ADT_SQNO, 0, 4) AND A.ADT_NO = SUBSTR(B.ADT_SQNO, 5, 3) AND A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# AND A.SLCT_RPTP_KDCD = 'A10800500' AND B.TASK_SECD = 'KP1' AND B.PRGRS_STTS_SECD IN ('50','30') AND A.TPOF_RFRNC_ID IN (SELECT AA.CVLCPT_DOC_ID /* 문서아이디 */
FROM TBBADDED103M AA WHERE AA.CVLCPT_ADT_YR = A.CVLCPT_ADT_YR AND AA.ADT_NO = A.ADT_NO AND AA.SLCT_RPTP_KDCD = 'A10600200' AND AA.ADT_STP_SECD = 'A1070' AND AA.LAST_ADT_RPTP_YN = 'Y') GROUP BY A.SLCT_RPTP_NM ,A.SLCT_RPTP_KDCD ,A.ATRZ_DMND_ID ,A.ATRZ_STTS_SECD ,A.CVLCPT_DOC_ID,A.TPOF_RFRNC_ID ) DT ORDER BY DT.SLCT_RPTP_KDCD