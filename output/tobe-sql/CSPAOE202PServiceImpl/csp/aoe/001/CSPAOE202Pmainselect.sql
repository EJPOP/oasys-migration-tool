SELECT D10.PTCPT_CNB,
    F_DPT_INFO(D10.CHR_DPT_CD, '1') AS TKCG_DEPT_NM /* 담당부서명 */,
    D10.CTB_RTE_AVG /* 기여율 */,
    NVL(ROUND(D10.PSN_TSK_ASC_DEPT * D10.CTB_RTE_AVG / 100, 2), 0) AS ROUND /* 개인평점환산 = 부서총점환산 * 기여율 / 100 */,
    NVL(D10.AUD_SPRT_ASC, 0) AS AUD_SPRT_ASC /* 감사지원 */,
    NVL(D10.PSN_TSK_ASC_OTHER, 0) AS PSN_TSK_ASC_OTHER /* 감사외 */,
    NVL(D10.PSN_TSK_ASC_DEPT, 0) AS PSN_TSK_ASC_DEPT /* 부서총점환산 */
FROM ( SELECT D3.PTCPT_CNB,
    D3.CTB_RTE_AVG /* 기여율 */,
    D6.AUD_SPRT_ASC /* 감사지원 */,
    D6.PSN_TSK_ASC_OTHER /* 감사외 */,
    (SELECT F_AOE_DPT_TSC(D3.EVL_YR, D3.HLYR_DVSN_CD, D3.CHR_DPT_CD)
FROM DUAL) AS PSN_TSK_ASC_DEPT /*부서총점환산*/ , D3.CHR_DPT_CD AS CHR_DPT_CD /*평가부서*/ , D3.EVL_YR , D3.HLYR_DVSN_CD FROM ( SELECT SUM(D1.WGT_RTE * D2.CTB_RT / 100) AS WGT_RTE /* 기여율=비중*기여율/100 */,
    D2.PTCPT_CNB,
    D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CHR_DPT_CD
FROM TBCSPAOE026M D1 , TBCSPAOE027M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CHR_DPT_CD = CASE WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '141' THEN '141000' WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '121' THEN '121000' WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '122' AND D2.CHR_DPT_CD = '122500' THEN D2.CHR_DPT_CD WHEN SUBSTR(D2.CHR_DPT_CD,1,3) = '122' AND D2.CHR_DPT_CD <> '122500' THEN '122000' ELSE D2.CHR_DPT_CD END AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.PTCPT_CNB = #strEvltCnb# GROUP BY D2.PTCPT_CNB, D1.EVL_YR, D1.HLYR_DVSN_CD, D1.CHR_DPT_CD ) D3 /*지원부서*/ , ( SELECT D4.EVL_YR,
    D4.HLYR_DVSN_CD,
    D4.NEVLT_CNB /* 피평가자전산번호 */,
    ROUND(NVL(SUM(DECODE( D4.CVLCPT_TASK_SECD, '10000', D4.AUD_SPRT_ASC, '') + DECODE( D4.CVLCPT_TASK_SECD, '10000', D4.PSN_TSK_ASC, '')) , 0), 2) AS ROUND,
    ROUND(NVL(SUM(DECODE( D4.CVLCPT_TASK_SECD, '10001', D4.PSN_TSK_ASC, '')), 0), 2) AS ROUND
FROM TBCSPAOE035M D4 WHERE D4.EVL_YR = #strEvlYr# AND D4.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D4.CVLCPT_TASK_SECD IN ('10001', '10000') AND D4.NEVLT_CNB = #strEvltCnb# GROUP BY D4.EVL_YR, D4.HLYR_DVSN_CD, D4.NEVLT_CNB ) D6 WHERE D3.EVL_YR = D6.EVL_YR(+) AND D3.HLYR_DVSN_CD = D6.HLYR_DVSN_CD(+) AND D3.PTCPT_CNB = D6.NEVLT_CNB(+) ) D10 ORDER BY TKCG_DEPT_NM