SELECT NVL(F_MNG_KND_AUDYRNO(D3.CVLCPT_ADT_YR, D3.TSK_NO, D4.ADT_KDCD, '-'),D3.CVLCPT_ADT_YR || '-' || D3.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    MAX(D3.ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과 */,
    F_CODE_NM('1000273', D3.AUD_STEP_CD_MIN) AS F_CODE_NM /* 단계기초 */,
    F_CODE_NM('1000273', D3.AUD_STEP_CD_MAX) AS F_CODE_NM /* 단계기말 */,
    (SELECT TO_CHAR(NVL(SUM(DRIVE_RTE), 0), 'FM99999.00')
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D3.ADT_KDCD AND ADT_STP_SECD BETWEEN D3.AUD_STEP_CD_MIN AND D3.AUD_STEP_CD_MAX ) AS DRIVE_RTE_SUM /*추진율*/ , D3.PTCPT_CNT_MAIN + D3.PTCPT_CNT_OTHER AS PTCPT_CNT_ALL /*전체참여인원*/ , D3.PTCPT_CNT_MAIN AS PTCPT_CNT_MAIN /*주관부서 인원*/ , TO_CHAR(D3.CTB_RTE_MAIN, 'FM99999.00') AS CTB_RTE_MAIN /*주관부서 기여율*/ , TO_CHAR(CASE WHEN D3.CTB_RTE_MAIN != 0 AND D3.PTCPT_CNT_MAIN != 0 THEN ROUND(D3.CTB_RTE_MAIN / D3.PTCPT_CNT_MAIN, 2) ELSE 0 END, 'FM99999.00') AS AVG_CTB_RTE_MAIN /*주관부서_인당 평균기여율*/ , D3.PTCPT_CNT_OTHER AS PTCPT_CNT_OTHER /*지원부서 인원*/ , TO_CHAR(D3.CTB_RTE_OTHER, 'FM99999.00') AS CTB_RTE_OTHER /*지원부서 기여율*/ , TO_CHAR(CASE WHEN D3.CTB_RTE_OTHER != 0 AND D3.PTCPT_CNT_OTHER != 0 THEN ROUND(D3.CTB_RTE_OTHER /D3.PTCPT_CNT_OTHER, 2) ELSE 0 END, 'FM99999.00') AS AVG_CTB_RTE_OTHER /*지원부서_인당 평균기여율*/ , TO_CHAR(CASE WHEN D3.CTB_RTE_MAIN != 0 AND D3.PTCPT_CNT_MAIN != 0 AND D3.CTB_RTE_OTHER != 0 AND D3.PTCPT_CNT_OTHER != 0 THEN ROUND( D3.CTB_RTE_MAIN / D3.PTCPT_CNT_MAIN / (D3.CTB_RTE_OTHER / D3.PTCPT_CNT_OTHER) , 2) ELSE 0 END, 'FM99999.00') AS AVG_CTB_RTE /*기여율배분율(1인당 평균기여율 기준)*/ , (SELECT A.DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = D3.HNDL_DIV_DPT_CD) AS DPT_SNO , (SELECT (CASE WHEN A.DPT_SNO != '32' THEN '0' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '150' THEN '1' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '141' THEN '2' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '100' THEN '3' END) AS DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = D3.HNDL_DIV_DPT_CD) AS DPT_SNO2 FROM ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_KDCD /* 감사종류코드 */,
    MAX(D1.ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */,
    MAX(D1.HNDL_DIV_DPT_CD) AS HNDL_DIV_DPT_CD /* 처리과 */,
    MAX(D2.AUD_STEP_CD_MIN) AS AUD_STEP_CD_MIN /* 단계기초 */,
    MAX(D2.AUD_STEP_CD_MAX) AS AUD_STEP_CD_MAX /* 단계기말 */,
    NVL(SUM(CASE WHEN D2.BLT_DPT_CD = D1.HNDL_DIV_DPT_CD THEN 1 END), 0) AS BLT_DPT_CD /* 주관부서 인원 */,
    NVL(SUM(CASE WHEN D2.BLT_DPT_CD = D1.HNDL_DIV_DPT_CD THEN D2.CTB_RT END), 0) AS BLT_DPT_CD /* 주관부서 기여율 */,
    NVL(SUM(CASE WHEN D2.BLT_DPT_CD != D1.HNDL_DIV_DPT_CD THEN 1 END), 0) AS BLT_DPT_CD /* 지원부서 인원 */,
    NVL(SUM(CASE WHEN D2.BLT_DPT_CD != D1.HNDL_DIV_DPT_CD THEN D2.CTB_RT END), 0) AS BLT_DPT_CD /* 지원부서 기여율 */
FROM TBCSPAOE021M D1 , ( SELECT D3.CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.TSK_NO,
    D3.BLT_DPT_CD,
    D3.CTB_RT /* 기여비율 */,
    D4.AUD_STEP_CD_MAX,
    D4.AUD_STEP_CD_MIN
FROM TBCSPAOE023M D3 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D4 WHERE D3.CVLCPT_ADT_YR = D4.ADT_YR AND D3.TSK_NO = D4.TSK_NO AND D3.ADT_STP_SECD = D4.AUD_STEP_CD_MAX ) D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO, D1.ADT_KDCD ) D3,TB_BADDED001M D4 WHERE 1 = 1 AND D3.CVLCPT_ADT_YR = D4.ADT_YR(+) AND D3.TSK_NO = D4.ADT_NO(+) GROUP BY D3.CVLCPT_ADT_YR, D3.TSK_NO, D3.ADT_KDCD, D3.HNDL_DIV_DPT_CD, D3.AUD_STEP_CD_MIN, D3.AUD_STEP_CD_MAX, D3.PTCPT_CNT_MAIN, D3.PTCPT_CNT_OTHER, D3.PTCPT_CNT_MAIN, D3.CTB_RTE_MAIN, D3.CTB_RTE_OTHER , D4.ADT_KDCD ORDER BY DPT_SNO, DPT_SNO2, D3.HNDL_DIV_DPT_CD, D3.HNDL_DIV_DPT_CD, D3.CVLCPT_ADT_YR, D3.TSK_NO