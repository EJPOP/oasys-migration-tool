SELECT NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D2.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR || '-' || D1.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    F_DPT_INFO(BLT_DPT_CD, '1') AS CRU_OGDP_DEPT_NM /* 부패소속부서명 */,
    PTCPT_CNT_MAX /* 참여인원 */,
    DPT_DIV /* 구분 */,
    BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    TO_CHAR(ROUND(BLT_DPT_PTCPT_CNT * 100 / PTCPT_CNT_MAX, 2), 'FM99999.00') AS TO_CHAR /* 과별 참여율 */,
    TO_CHAR(CTB_RTE_SUM, 'FM99999.00') AS TO_CHAR /* 과별 기여율 */,
    TO_CHAR(ROUND(CTB_RTE_SUM / (BLT_DPT_PTCPT_CNT * 100 / PTCPT_CNT_MAX), 2), 'FM99999.00') AS TO_CHAR /* 기여율 배분수치 */,
    BLT_DPT_CD,
    (SELECT A.DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = BLT_DPT_CD) AS DPT_SNO , (SELECT (CASE WHEN A.DPT_SNO != '32' THEN '0' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '150' THEN '1' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '141' THEN '2' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '100' THEN '3' END) AS DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = BLT_DPT_CD) AS DPT_SNO2 FROM ( SELECT D3.CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.TSK_NO,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D3.DPT_DIV,
    D3.BLT_DPT_CD,
    D3.BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    D3.CTB_RTE_SUM /* 과별 기여율 */,
    D4.PTCPT_CNT_MAX /* 마지막단계 참여 인원수 */,
    D3.ORD,
    D3.HNDL_DIV_DPT_CD
FROM ( /*주관부서*/ SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    '주관부서' AS DPT_DIV,
    D2.BLT_DPT_CD,
    D2.BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    D2.CTB_RTE_SUM /* 과별 기여율 */,
    D1.HNDL_DIV_DPT_CD,
    1
FROM TBCSPAOE021M D1 , ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.BLT_DPT_CD,
    SUM(D1.CTB_RT) AS CTB_RT /* 기여비율 */,
    COUNT(D1.PTCPT_CNB) AS PTCPT_CNB /* 과별 참여인원 */
FROM TBCSPAOE023M D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO )D2 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.ADT_STP_SECD = D2.AUD_STEP_CD_MAX GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO , D1.BLT_DPT_CD )D2 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD = D2.BLT_DPT_CD UNION ALL /*지원부서*/ SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    '지원부서' AS DPT_DIV,
    D2.BLT_DPT_CD,
    D2.BLT_DPT_PTCPT_CNT /* 과별 참여인원 */,
    D2.CTB_RTE_SUM /* 과별 기여율 */,
    D1.HNDL_DIV_DPT_CD,
    2
FROM TBCSPAOE021M D1 , ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.BLT_DPT_CD,
    SUM(D1.CTB_RT) AS CTB_RT /* 기여비율 */,
    COUNT(D1.PTCPT_CNB) AS PTCPT_CNB /* 과별 참여인원 */
FROM TBCSPAOE023M D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO )D2 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.ADT_STP_SECD = D2.AUD_STEP_CD_MAX GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO , D1.BLT_DPT_CD )D2 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.HNDL_DIV_DPT_CD != D2.BLT_DPT_CD ) D3 , ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    COUNT(D1.PTCPT_CNB) AS PTCPT_CNB /* 마지막단계 */
FROM TBCSPAOE023M D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO )D2 WHERE D1.CVLCPT_ADT_YR = D2.ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.ADT_STP_SECD = D2.AUD_STEP_CD_MAX GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO, D2.AUD_STEP_CD_MAX ) D4 WHERE D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO )D1 , TB_BADDED001M D2 WHERE 1 = 1 AND D1.CVLCPT_ADT_YR = D2.ADT_YR(+) AND D1.TSK_NO = D2.ADT_NO(+) ORDER BY DPT_SNO, DPT_SNO2, BLT_DPT_CD, HNDL_DIV_DPT_CD, D1.CVLCPT_ADT_YR, D1.TSK_NO, ORD