SELECT F_CODE_NM('1000270', D1.AUD_TSK_KND_CD) AS F_CODE_NM /* 감사종류 */,
    NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D2.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR || '-' || D1.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    F_CODE_NM('1000274', D1.EVL_RK_CD) AS F_CODE_NM /* 귀청보고 평가등급 */,
    EVL_INDEX_NM_PJCD01,
    EVL_INDEX_NM_PJCD02,
    EVL_INDEX_NM_PJCD03,
    EVL_INDEX_NM_PJCD04,
    EVL_INDEX_NM_PJCD05,
    EVL_INDEX_NM_PJCD06,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD01) AS F_CODE_NM,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD02) AS F_CODE_NM,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD03) AS F_CODE_NM,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD04) AS F_CODE_NM,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD05) AS F_CODE_NM,
    F_CODE_NM('1000274', EVL_RK_CD_PJCD06) AS F_CODE_NM,
    F_CODE_NM('1000274', SYT_EVL_RK_CD) AS F_CODE_NM /* 종합평가등급코드 */,
    TO_CHAR(SYT_EVL_ADVL_VAL,'FM99999.00') AS TO_CHAR /* 종합평가가중치값 */,
    F_DPT_INFO(HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 2014.02.04 최원형 감사관 요청 */
FROM ( SELECT D3.AUD_TSK_KND_CD /* 감사종류 */,
    D3.CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.TSK_NO,
    (SELECT AS ADT_MTTR_NM /* 감사사항명 */
FROM TBCSPAOE021M WHERE CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND TSK_NO = D3.TSK_NO) AS ADT_MTTR_NM /*감사사항명*/ , D3.EVL_RK_CD /*귀청보고 평가등급*/ , D6.EVL_INDEX_NM_PJCD01 , D6.EVL_INDEX_NM_PJCD02 , D6.EVL_INDEX_NM_PJCD03 , D6.EVL_INDEX_NM_PJCD04 , D6.EVL_INDEX_NM_PJCD05 , D6.EVL_INDEX_NM_PJCD06 , D6.EVL_RK_CD_PJCD01 , D6.EVL_RK_CD_PJCD02 , D6.EVL_RK_CD_PJCD03 , D6.EVL_RK_CD_PJCD04 , D6.EVL_RK_CD_PJCD05 , D6.EVL_RK_CD_PJCD06 , D3.SYT_EVL_RK_CD , D3.SYT_EVL_ADVL_VAL , D7.HNDL_DIV_DPT_CD FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D1.AUD_TSK_KND_CD,
    D1.EVL_STEP_CD,
    D1.EVL_CMTR_CNB,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.SYT_EVL_RK_CD,
    D1.SYT_EVL_ADVL_VAL,
    CASE WHEN EVL_STEP_CD = '100' THEN D1.EVL_RK_CD ELSE (SELECT S1.EVL_RK_CD
FROM TBCSPAOE029M S1 WHERE S1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND S1.TSK_NO = D1.TSK_NO AND S1.EVL_STEP_CD = '100') END EVL_RK_CD FROM TBCSPAOE029M D1 WHERE 1 = 1 AND D1.CVLCPT_TASK_SECD = '10000' /*감사업무*/ AND D1.EVL_DTM_YN = 'Y' AND (CVLCPT_ADT_YR, TSK_NO, EVL_STEP_CD) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD)
FROM TBCSPAOE029M WHERE (CVLCPT_ADT_YR,TSK_NO) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M, (SELECT EVL_STR_DT,
    EVL_END_DT
FROM TBCSPAOE001M WHERE EVL_YR = '2018' AND HLYR_DVSN_CD = '10') SS WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN SS.EVL_STR_DT AND SS.EVL_END_DT GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY CVLCPT_ADT_YR, TSK_NO ) AND D1.AUD_TSK_KND_CD = #strAudTskKndCd# AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# ) D3 /*평가완료한 것만 보여준다*/ ,( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    AUD_TSK_KND_CD,
    EVL_STEP_CD,
    EVL_CMTR_CNB,
    TSK_NO,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD01) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD01, 1, INSTR(EVL_INDEX_NM_PJCD01, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD01, (INSTR(EVL_INDEX_NM_PJCD01, ' ')+1)) ELSE EVL_INDEX_NM_PJCD01 END AS LENGTH,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD02) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD02, 1, INSTR(EVL_INDEX_NM_PJCD02, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD02, (INSTR(EVL_INDEX_NM_PJCD02, ' ')+1)) ELSE EVL_INDEX_NM_PJCD02 END AS LENGTH,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD03) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD03, 1, INSTR(EVL_INDEX_NM_PJCD03, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD03, (INSTR(EVL_INDEX_NM_PJCD03, ' ')+1)) ELSE EVL_INDEX_NM_PJCD03 END AS LENGTH,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD04) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD04, 1, INSTR(EVL_INDEX_NM_PJCD04, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD04, (INSTR(EVL_INDEX_NM_PJCD04, ' ')+1)) ELSE EVL_INDEX_NM_PJCD04 END AS LENGTH,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD05) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD05, 1, INSTR(EVL_INDEX_NM_PJCD05, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD05, (INSTR(EVL_INDEX_NM_PJCD05, ' ')+1)) ELSE EVL_INDEX_NM_PJCD05 END AS LENGTH,
    CASE WHEN LENGTH(EVL_INDEX_NM_PJCD06) > 5 THEN SUBSTR(EVL_INDEX_NM_PJCD06, 1, INSTR(EVL_INDEX_NM_PJCD06, ' ')) || CHR(10) || SUBSTR(EVL_INDEX_NM_PJCD06, (INSTR(EVL_INDEX_NM_PJCD06, ' ')+1)) ELSE EVL_INDEX_NM_PJCD06 END AS LENGTH,
    EVL_RK_CD_PJCD01,
    EVL_RK_CD_PJCD02,
    EVL_RK_CD_PJCD03,
    EVL_RK_CD_PJCD04,
    EVL_RK_CD_PJCD05,
    EVL_RK_CD_PJCD06
FROM ( SELECT D5.EVL_YR,
    D5.HLYR_DVSN_CD,
    D5.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D5.AUD_TSK_KND_CD,
    D5.EVL_STEP_CD,
    D5.EVL_CMTR_CNB,
    D5.TSK_NO,
    D5.CVLCPT_ADT_YR /* 민원감사년도 */,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD01', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD02', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD03', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD04', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD05', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD06', D6.EVL_INDEX_NM, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD01', EVL_RK_CD, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD02', EVL_RK_CD, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD03', EVL_RK_CD, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD04', EVL_RK_CD, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD05', EVL_RK_CD, '' )) AS EVL_INDEX_CD,
    MAX(DECODE(D5.EVL_INDEX_CD, 'PJCD06', EVL_RK_CD, '' )) AS EVL_INDEX_CD
FROM TBCSPAOE030M D5 , TBCSPAOE002M D6 WHERE D5.EVL_YR = D6.EVL_YR AND D5.HLYR_DVSN_CD = D6.HLYR_DVSN_CD AND D5.EVL_INDEX_CD = D6.EVL_INDEX_CD AND D5.EVL_YR = #strEvlYr# AND D5.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY D5.EVL_YR, D5.HLYR_DVSN_CD, D5.CVLCPT_TASK_SECD, D5.AUD_TSK_KND_CD, D5.EVL_STEP_CD, D5.EVL_CMTR_CNB, D5.TSK_NO, D5.CVLCPT_ADT_YR ) ) D6 , TBCSPAOE021M D7 WHERE 1 = 1 AND D3.EVL_YR = D6.EVL_YR (+) AND D3.HLYR_DVSN_CD = D6.HLYR_DVSN_CD (+) AND D3.CVLCPT_TASK_SECD = D6.CVLCPT_TASK_SECD (+) AND D3.AUD_TSK_KND_CD = D6.AUD_TSK_KND_CD (+) AND D3.EVL_STEP_CD = D6.EVL_STEP_CD (+) AND D3.EVL_CMTR_CNB = D6.EVL_CMTR_CNB (+) AND D3.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR (+) AND D3.TSK_NO = D6.TSK_NO (+) AND D3.CVLCPT_ADT_YR = D7.CVLCPT_ADT_YR AND D3.TSK_NO = D7.TSK_NO ) D1, TB_BADDED001M D2 WHERE 1 = 1 AND D1.CVLCPT_ADT_YR = D2.ADT_YR(+) AND D1.TSK_NO = D2.ADT_NO(+) AND D1.ADT_MTTR_NM LIKE '%' || #strAudSbjNm# || '%' AND CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D2.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D1.tsk_no = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D2.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) ORDER BY D1.HNDL_DIV_DPT_CD, D1.CVLCPT_ADT_YR, D1.TSK_NO