SELECT NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D3.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR || '-' || D1.TSK_NO) AS ADT_CLSF_NO /* 감사분류번호 */,
    F_CODE_NM('1000270', D1.ADT_KDCD) AS F_CODE_NM /* 감사종류 */,
    D1.MNDY_CNT AS MNDY_CNT /* 연인원수 */,
    F_DPT_INFO(D1.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과부서 */,
    F_CODE_NM('1000273', D2.ADT_STP_SECD) AS ADT_STP_NM /* 감사단계명 */,
    D1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    NVL(D2.CTB_RTE_CFM_YN, 'N') AS CTB_RTE_CFM_YN /* 국장확인 */,
    F_USR_INFO(D2.CTB_RTE_CFM_BRUCHF_CNB, '2') AS F_USR_INFO /* 지정 결재자명 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_KDCD /* 감사종류코드 */,
    D2.ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE021M D1 , ( SELECT DISTINCT D3.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D3.TSK_NO,
    D3.ADT_STP_SECD /* 감사단계구분코드 */,
    D3.CTB_RTE_CFM_BRUCHF_CNB /* 기여율확인 지정 결재자 전산번호 */,
    D3.CTB_RTE_CFM_YN /* 기여율확인여부 */
FROM TBCSPAOE022M D3 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL GROUP BY CVLCPT_ADT_YR, TSK_NO ) D4 , (SELECT MAX(EVL_STR_DT) AS EVL_STR_DT,
    MAX(EVL_END_DT) AS EVL_END_DT
FROM TBCSPAOE001M) D5 WHERE D3.ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO AND D3.ADT_STP_SECD = D4.AUD_STEP_CD_MAX AND NVL(D3.CTB_RTE_CFM_RQS_YN, 'N') = 'Y' /* 기여율확인요청여부가 Y 인건만*/ AND D3.CMPTN_YMD BETWEEN D5.EVL_STR_DT AND D5.EVL_END_DT ) D2, TB_BADDED001M D3 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D1.CVLCPT_ADT_YR = D3.ADT_YR(+) AND D1.TSK_NO = D3.ADT_NO(+) AND D2.CTB_RTE_CFM_BRUCHF_CNB = #strCtbRteCnb# AND D1.HNDL_DIV_DPT_CD IN ( SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TBDCMACM002M WHERE USE_YN = 'Y' AND ( HIRK_DPT_CD = #SRECS_DEPT_CD# OR SRECS_DEPT_CD = #SRECS_DEPT_CD# )) ORDER BY D1.CVLCPT_ADT_YR, D1.TSK_NO