SELECT D3.EVL_YR || '-' || D3.TSK_NO AS EVL_YR /* 감사연번호 */,
    D3.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과 */,
    F_CODE_NM('1000273', D3.AUD_STEP_CD_MIN) AS F_CODE_NM /* 단계기초 */,
    F_CODE_NM('1000273', D3.AUD_STEP_CD_MAX) AS F_CODE_NM /* 단계기말 */,
    D4.DRIVE_RTE_SUM AS DRIVE_RTE_SUM /* 추진율 */,
    D3.PTCPT_CNT_MAIN + D3.PTCPT_CNT_OTHER AS PTCPT_CNT_MAIN /* 전체참여인원 */,
    D3.PTCPT_CNT_MAIN AS PTCPT_CNT_MAIN /* 주관부서 인원 */,
    D3.CTB_RTE_MAIN AS CTB_RTE_MAIN /* 주관부서 기여율 */,
    CASE WHEN D3.CTB_RTE_MAIN != 0 AND D3.PTCPT_CNT_MAIN != 0 THEN ROUND(D3.CTB_RTE_MAIN / D3.PTCPT_CNT_MAIN, 2) ELSE 0 END AS CTB_RTE_MAIN /* 주관부서_인당 평균기여율 */,
    D3.PTCPT_CNT_OTHER AS PTCPT_CNT_OTHER /* 지원부서 인원 */,
    D3.CTB_RTE_OTHER AS CTB_RTE_OTHER /* 지원부서 기여율 */,
    CASE WHEN D3.CTB_RTE_OTHER != 0 AND D3.PTCPT_CNT_OTHER != 0 THEN ROUND(D3.CTB_RTE_OTHER / D3.PTCPT_CNT_OTHER, 2) ELSE 0 END AS CTB_RTE_OTHER /* 지원부서_인당 평균기여율 */,
    CASE WHEN D3.CTB_RTE_MAIN != 0 AND D3.PTCPT_CNT_MAIN != 0 AND D3.CTB_RTE_OTHER != 0 AND D3.PTCPT_CNT_OTHER != 0 THEN ROUND( (D3.CTB_RTE_MAIN / D3.PTCPT_CNT_MAIN) / (D3.CTB_RTE_OTHER / D3.PTCPT_CNT_OTHER) , 2) ELSE 0 END AS CTB_RTE_MAIN /* 기여율배분율(1인당 평균기여율 기준) */
FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.TSK_NO,
    MAX(D1.ADT_KDCD) AS ADT_KDCD /* 감사종류코드 */,
    MAX(D1.ADT_MTTR_NM) AS ADT_MTTR_NM /* 감사사항명 */,
    MAX(D1.HNDL_DIV_DPT_CD) AS HNDL_DIV_DPT_CD /* 처리과 */,
    MIN(D2.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D2.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    SUM(CASE WHEN D2.BLT_DPT_CD = D1.HNDL_DIV_DPT_CD THEN 1 ELSE 0 END) AS BLT_DPT_CD /* 주관부서 인원 */,
    SUM(CASE WHEN D2.BLT_DPT_CD = D1.HNDL_DIV_DPT_CD THEN D2.CTB_RT ELSE 0 END) AS BLT_DPT_CD /* 주관부서 기여율 */,
    SUM(CASE WHEN D2.BLT_DPT_CD != D1.HNDL_DIV_DPT_CD THEN 1 ELSE 0 END) AS BLT_DPT_CD /* 지원부서 인원 */,
    SUM(CASE WHEN D2.BLT_DPT_CD != D1.HNDL_DIV_DPT_CD THEN D2.CTB_RT ELSE 0 END) AS BLT_DPT_CD /* 지원부서 기여율 */
FROM TBCSPAOE021M D1 , TBCSPAOE023M D2 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.TSK_NO ) D3 ,( SELECT EVL_YR,
    HLYR_DVSN_CD,
    ADT_KDCD /* 감사종류코드 */,
    SUM(DRIVE_RTE) AS DRIVE_RTE /* 추진율 합 */
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' /*감사업무*/ GROUP BY EVL_YR, HLYR_DVSN_CD, ADT_KDCD )D4 WHERE D3.EVL_YR = D4.EVL_YR (+) AND D3.HLYR_DVSN_CD = D4.HLYR_DVSN_CD (+) AND D3.ADT_KDCD = D4.ADT_KDCD (+) ORDER BY D3.TSK_NO