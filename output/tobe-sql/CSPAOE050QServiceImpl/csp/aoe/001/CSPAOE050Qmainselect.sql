SELECT F_DPT_INFO(D11.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과부서코드 */,
    F_USR_INFO(D11.SPVR_ENO, '2') AS F_USR_INFO /* 주관자명 */,
    F_CODE_NM('1000270', D11.ADT_KDCD) AS F_CODE_NM /* 감사종류 */,
    D11.SYT_TRTM_YN /* 종합처리안 여부 */,
    NVL(F_MNG_KND_AUDYRNO(D11.CVLCPT_ADT_YR, D11.TSK_NO, D2.ADT_KDCD, '-'),D11.CVLCPT_ADT_YR || '-' || TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D11.ADT_MTTR_NM /* 감사사항명 */,
    F_CODE_NM('1000273', D11.AUD_STEP_CD_MIN) AS F_CODE_NM /* 감사단계 - 단계기초 */,
    F_CODE_NM('1000273', D11.AUD_STEP_CD_MAX) AS F_CODE_NM /* 감사단계 - 단계기말 */,
    D11.MNDY_CNT /* 연인원 */,
    D11.NMPTCPT_CNT /* 참여인원 */,
    D11.RSRV_EXMN_OTST_YMD /* 예비조사착수일자 */,
    D11.STND_ASC AS STND_ASC /* 표준평점 */,
    F_CODE_NM('1000274',D11.SYT_EVL_RK_CD) AS F_CODE_NM /* 종합평가 등급코드. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D11.SYT_EVL_ADVL_VAL AS SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    D11.DRIVE_RTE_SUM AS DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    ( CASE WHEN INSTR(DLY_DT_SUM, '-') = 0 AND ASP_RTE = 0 THEN '0.00' WHEN INSTR(DLY_DT_SUM, '-') = 0 THEN TO_CHAR(ASP_RTE,'FM99990.00') ELSE '-' || TO_CHAR(ASP_RTE,'FM99990.00') END) AS INSTR /* 가감점율 */,
    ASP_STND_ASC AS ASP_STND_ASC /* 가감평점 */,
    SPE_ADD_SC AS SPE_ADD_SC /* 특별가산점 */,
    MDT_ASC AS MDT_ASC /* , DRIVE_RTE_ASC + ASP_STND_ASC + SPE_ADD_SC + MDT_ASC AS TSK_ASC_SUM 최종평점(표준평점*성과가중치*추진율+가감평점+특별가산점+조정평점) - 가점일 경우엔 기준등급의 가중치에 따라 가점의 유무가 달라진다. */,
    CASE WHEN #strEvlYr# != '2019' THEN DRIVE_RTE_ASC + ASP_STND_ASC + SPE_ADD_SC + MDT_ASC ELSE D11.STND_ASC END AS #STREVLYR# /* 최종평점 */,
    HNDL_DIV_DPT_CD,
    (SELECT A.DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = HNDL_DIV_DPT_CD) AS DPT_SNO , (SELECT (CASE WHEN A.DPT_SNO != '32' THEN '0' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '150' THEN '1' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '141' THEN '2' WHEN A.DPT_SNO = '32' AND SUBSTR(A.SRECS_DEPT_CD, 1, 3) = '100' THEN '3' END) AS DPT_SNO
FROM (SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    NVL((SELECT B.DPT_SNO
FROM TBDCMACM002M B WHERE B.SRECS_DEPT_CD = A.HIRK_DPT_CD), '36') AS DPT_SNO FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) <> '000' AND A.SRECS_DEPT_CD NOT IN ('150150', '150160', '150170', '150180') UNION SELECT A.SRECS_DEPT_CD /* 심사재심의부서코드 */,
    A.CNSTN_MBCMT_DEPT_NM /* 자문위원부서명 */,
    A.DPT_SNO
FROM TBDCMACM002M A WHERE A.USE_YN = 'Y' AND SUBSTR(A.SRECS_DEPT_CD, 4) = '000') A WHERE SRECS_DEPT_CD = HNDL_DIV_DPT_CD) AS DPT_SNO2 , TO_CHAR(ROUND(ADVL_ASC, 2), 'FM99990.00') AS ADVL_ASC /* 가중평점 */ , TO_CHAR(DRIVE_RTE_ASC, 'FM99990.00') AS DRIVE_RTE_ASC /* (추진율 조정평점(추진평점) */ FROM ( SELECT HNDL_DIV_DPT_CD,
    SPVR_ENO /* 감리원직원전산번호 */,
    ADT_KDCD /* 감사종류코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_MTTR_NM /* 감사사항명 */,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    MNDY_CNT,
    NMPTCPT_CNT /* 참여인원 */,
    RSRV_EXMN_OTST_YMD /* 예비조사착수일자 */,
    STND_ASC /* 표준평점 */,
    SYT_EVL_RK_CD,
    SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    NVL(ASP_RTE, 0) AS ASP_RTE /* 가감점율 */,
    SYT_TRTM_YN /* 종합처리안 여부 */,
    F_AOE_ASP_STND_ASC_2(#strEvlYr#, #strHlyrDvsnCd#, ADT_KDCD, AUD_STEP_CD_MAX, DLY_DT_SUM, SYT_EVL_ADVL_VAL, TO_NUMBER(ASP_STND_ASC), CVLCPT_ADT_YR, TSK_NO) AS F_AOE_ASP_STND_ASC_2 /* 가감평점 */,
    SPE_ADD_SC /* 특별가산점 */,
    MDT_ASC /* 조정평점 */,
    STND_ASC * SYT_EVL_ADVL_VAL AS STND_ASC /* 가중평점 */,
    DRIVE_RTE_ASC
FROM ( SELECT HNDL_DIV_DPT_CD,
    SPVR_ENO /* 감리원직원전산번호 */,
    ADT_KDCD /* 감사종류코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_MTTR_NM /* 감사사항명 */,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    MNDY_CNT,
    NMPTCPT_CNT /* 참여인원 */,
    RSRV_EXMN_OTST_YMD /* 예비조사착수일자 */,
    STND_ASC /* 표준평점 */,
    SYT_EVL_RK_CD,
    SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    NVL(ASP_RTE, 0) AS ASP_RTE /* 가감점율 */,
    SYT_TRTM_YN /* 종합처리안 여부 */,
    DECODE(INSTR(DLY_DT_SUM, '-') , 0,'-', '') || CASE WHEN DRIVE_RTE_ASC IS NOT NULL THEN TO_CHAR(ROUND(DRIVE_RTE_ASC * NVL(ASP_RTE, 0) / 100, 2),'FM99990.00') ELSE TO_CHAR(ROUND(STND_ASC * SYT_EVL_ADVL_VAL * ( DRIVE_RTE_SUM / 100) * (NVL(ASP_RTE, 0)/ 100) , 2),'FM99990.00') END AS INSTR /* 가감평점 */,
    SPE_ADD_SC /* 특별가산점 */,
    MDT_ASC /* 조정평점 */,
    DRIVE_RTE_ASC
FROM ( SELECT HNDL_DIV_DPT_CD,
    SPVR_ENO /* 감리원직원전산번호 */,
    ADT_KDCD /* 감사종류코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    ADT_MTTR_NM /* 감사사항명 */,
    AUD_STEP_CD_MIN,
    AUD_STEP_CD_MAX,
    MNDY_CNT,
    NMPTCPT_CNT /* 참여인원 */,
    RSRV_EXMN_OTST_YMD /* 예비조사착수일자 */,
    NVL(STND_ASC, 0) AS STND_ASC /* 표준평점 */,
    SYT_EVL_RK_CD,
    NVL(SYT_EVL_ADVL_VAL, 0) AS SYT_EVL_ADVL_VAL /* 종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다. */,
    DRIVE_RTE_SUM /* 추진율 */,
    DLY_DT_SUM /* 지연일 */,
    (SELECT AS ASP_RTE
FROM TBCSPAOE012M WHERE DLAY_DT_NM = TO_CHAR(D9.DLY_DT_SUM) AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd#) AS ASP_RTE /*가감점율*/ , SYT_TRTM_YN /*종합처리안 여부*/ , NVL(SPE_ADD_SC, F_AOE_SPE_ADD_SC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS SPE_ADD_SC , NVL(MDT_ASC, F_AOE_MDT_ASC(#strEvlYr#, #strHlyrDvsnCd#, CVLCPT_ADT_YR, TSK_NO, ADT_KDCD)) AS MDT_ASC , F_AOE_DRIVE_RTE_ASC(#strEvlYr#, #strHlyrDvsnCd#, ADT_KDCD, AUD_STEP_CD_MIN, AUD_STEP_CD_MAX, MNDY_CNT, SYT_TRTM_YN, NVL(SYT_EVL_ADVL_VAL, 0)) AS DRIVE_RTE_ASC /*추진율 조정평점*/ FROM ( SELECT D5.HNDL_DIV_DPT_CD,
    D5.SPVR_ENO /* 감리원직원전산번호 */,
    D5.ADT_KDCD /* 감사종류코드 */,
    D5.CVLCPT_ADT_YR /* 민원감사년도 */,
    D5.TSK_NO,
    D5.ADT_MTTR_NM /* 감사사항명 */,
    D5.AUD_STEP_CD_MIN,
    D5.AUD_STEP_CD_MAX,
    D5.MNDY_CNT,
    ( SELECT COUNT(*)
FROM TBCSPAOE023M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX ) AS NMPTCPT_CNT /*참여인원*/ , ( SELECT LUNH_DT
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD = (SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND LUNH_DT IS NOT NULL)) AS RSRV_EXMN_OTST_YMD /*예비조사단계 착수일 - 예비조사 제외 감사종류때문에 이렇게 쿼리가 지저분하지만 22TL에서 가장 감사단계 코드가 MIN인 것으로.. */ , F_AOE_STND_ASC(#strEvlYr#, #strHlyrDvsnCd#, D5.ADT_KDCD, D5.AUD_STEP_CD_MIN, D5.AUD_STEP_CD_MAX, D5.MNDY_CNT, NVL(D5.SYT_TRTM_YN,'N')) AS STND_ASC /*표준평점*/ , DECODE(NVL(D6.EVL_STEP_CD, 'X') , '100', D7.IDVT_INDEX_VAL, '200', D6.SYT_EVL_ADVL_VAL , 'X', (SELECT IDVT_INDEX_VAL
FROM TBCSPAOE010D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND AUD_TSK_KND_CD = D5.ADT_KDCD AND RK_CD = ( SELECT ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX )) , 0) AS SYT_EVL_ADVL_VAL /*종합평가 가중치-평가자 스텝별로 가중치 가져오는 방법 다르다. 평가대상이 아닌 업무는 조기가점기준등급 코드의 가중치를 가져온다.*/ , DECODE(NVL(D6.EVL_STEP_CD, 'X') , '100', D6.EVL_RK_CD, '200', D6.SYT_EVL_RK_CD, 'X', (SELECT ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD = D5.AUD_STEP_CD_MAX ), 0) AS SYT_EVL_RK_CD , (SELECT NVL(SUM(DRIVE_RTE), 0)
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX ) AS DRIVE_RTE_SUM /*추진율*/ , (SELECT SUM(TO_NUMBER(DLAY_DT_NM-(NVL(EXET_DCN,0))))
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND TSK_NO = D5.TSK_NO AND ADT_STP_SECD BETWEEN D5.AUD_STEP_CD_MIN AND D5.AUD_STEP_CD_MAX ) AS DLY_DT_SUM /*지연일*/ , D5.SYT_TRTM_YN /*종합처리안 여부*/ , D6.SPE_ADD_SC , D6.MDT_ASC FROM ( SELECT D2.HNDL_DIV_DPT_CD,
    D2.SPVR_ENO /* 감리원직원전산번호 */,
    D2.ADT_KDCD /* 감사종류코드 */,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO,
    D2.ADT_MTTR_NM /* 감사사항명 */,
    D1.AUD_STEP_CD_MIN,
    D1.AUD_STEP_CD_MAX,
    D2.MNDY_CNT,
    ( SELECT NVL(SYT_TRTM_YN, 'N')
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND TSK_NO = D1.TSK_NO AND ADT_STP_SECD = '10004' ) AS SYT_TRTM_YN /*종합처리안 여부*/ FROM ( SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D1 , TBCSPAOE021M D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D2.ADT_MTTR_NM LIKE '%' || #strAudSbjNm# || '%' ) D5 , ( SELECT D8.AUD_TSK_KND_CD,
    D8.CVLCPT_ADT_YR /* 민원감사년도 */,
    D8.TSK_NO,
    D8.SYT_EVL_ADVL_VAL,
    D8.EVL_YR,
    D8.HLYR_DVSN_CD,
    D8.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D8.EVL_RK_CD,
    D8.SYT_EVL_RK_CD,
    D8.EVL_STEP_CD,
    D8.DRIVE_RTE_ASC /* 추진율평점 - 표준평점*종합평점가중치*추진율 */,
    D8.SPE_ADD_SC,
    D8.MDT_ASC
FROM ( SELECT AUD_TSK_KND_CD,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD) AS EVL_STEP_CD,
    EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */
FROM TBCSPAOE029M WHERE CVLCPT_TASK_SECD = '10000' /*감사업무*/ AND EVL_STA_CD = '300' /*평가완료*/ AND (CVLCPT_ADT_YR, TSK_NO, EVL_STEP_CD) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(EVL_STEP_CD)
FROM TBCSPAOE029M WHERE (CVLCPT_ADT_YR,TSK_NO) IN (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY CVLCPT_ADT_YR, TSK_NO ) GROUP BY EVL_YR, HLYR_DVSN_CD, CVLCPT_TASK_SECD, AUD_TSK_KND_CD, CVLCPT_ADT_YR, TSK_NO /*한 감사사항이 귀청보고평가, 위원평가를 받을 수 있기때문에 이렇게 한번 걸러내는 작업을 함*/ ) D7 , TBCSPAOE029M D8 WHERE D7.EVL_YR = D8.EVL_YR AND D7.HLYR_DVSN_CD = D8.HLYR_DVSN_CD AND D7.CVLCPT_TASK_SECD = D8.CVLCPT_TASK_SECD AND D7.AUD_TSK_KND_CD = D8.AUD_TSK_KND_CD AND D7.EVL_STEP_CD = D8.EVL_STEP_CD AND D7.CVLCPT_ADT_YR = D8.CVLCPT_ADT_YR AND D7.TSK_NO = D8.TSK_NO ) D6 /*감사사항 평가관리*/ , TBCSPAOE010D D7 WHERE D5.ADT_KDCD = D6.AUD_TSK_KND_CD (+) AND D5.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR (+) AND D5.TSK_NO = D6.TSK_NO (+) AND D6.EVL_YR = D7.EVL_YR (+) AND D6.HLYR_DVSN_CD = D7.HLYR_DVSN_CD (+) AND D6.CVLCPT_TASK_SECD = D7.CVLCPT_TASK_SECD (+) AND D6.AUD_TSK_KND_CD = D7.AUD_TSK_KND_CD (+) AND D6.EVL_RK_CD = D7.RK_CD (+) AND NVL(D5.SYT_TRTM_YN, 'N') = #strSytTrtmYn# ) D9 ) D10 ) D12 ) D11 , TB_BADDED001M D2 WHERE 1 = 1 AND D11.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR(+) AND D11.TSK_NO = D2.ADT_NO(+) AND D11.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D2.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D11.tsk_no = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D2.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) ORDER BY DPT_SNO, DPT_SNO2, HNDL_DIV_DPT_CD, EVL_YR_TSK