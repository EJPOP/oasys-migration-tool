SELECT *
FROM ( SELECT D1.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SQNO AS BZTRP_SQNO /* 출장순번 */,
    D1.SPRT_NO AS SPRT_NO /* 지원번호 */,
    D1.BZTRP_YR||'-'||D1.SPRT_NO AS BZTRP_YR /* 출장년도 */,
    D1.BZTRP_SECD AS BZTRP_SECD /* 출장구분코드 */,
    D1.GNRL_BZTRP_KDCD AS GNRL_BZTRP_KDCD /* 일반출장종류코드 */,
    F_CODE_NM('1000021',D1.GNRL_BZTRP_KDCD) AS F_CODE_NM /* 감사출장종류명 */,
    D1.DSPS_RQT_NM AS DSPS_RQT_NM /* 처분요구명 */,
    D1.BZTRP_DEPT_CD AS BZTRP_DEPT_CD /* 출장부서코드 */,
    F_DPT_INFO(D1.BZTRP_DEPT_CD,'1') AS F_DPT_INFO /* 출장국과명 */,
    TO_CHAR(TO_DATE(D1.ADT_BGNG_YMD),'YYYY-MM-DD')||'~' || TO_CHAR(TO_DATE(D1.ADT_END_YMD),'YYYY-MM-DD') AS TO_CHAR /* 실시기간 */,
    D1.ADT_BGNG_YMD /* 감사시작일자 */,
    D1.ADT_END_YMD /* 감사종료일자 */,
    D3.PCT_CNB_CNT AS PCT_CNB_CNT /* 인원 */,
    D3.EXP_CNT AS EXP_CNT /* 전문가 인원 */,
    D4.CNT /* 수령자 */,
    CASE WHEN D1.CAL_CFMTN_YN = 'Y' THEN '확정' ELSE CASE WHEN D4.CALC_CNT>0 THEN 'Y' ELSE 'N' END END AS CAL_CFMTN_YN /* 계산확정여부 */,
    CASE WHEN D1.CLCLN_CFMTN_YN = 'Y' THEN '확정' ELSE CASE WHEN D4.ADJ_CNT>0 THEN 'Y' ELSE 'N' END END AS CLCLN_CFMTN_YN /* 정산확정여부 */,
    D1.CAW_GIVE_YN AS CAW_GIVE_YN /* 지휘비지급여부 */,
    D1.CAL_CFMTN_YN AS CAL_CFMTN_YN /* 계산확정여부 */,
    D1.CLCLN_CFMTN_YN AS CLCLN_CFMTN_YN /* 정산확정여부 */
FROM TBBADDED002M D1 ,( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    COUNT(DISTINCT BZTRVR_ENO) AS BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM( DECODE(EMP_SECD,'3',1,0)) AS EMP_SECD /* 직원구분코드 */
FROM TBBADDED005L WHERE 1=1 AND BZTRP_YR = #BZTRP_YR# GROUP BY BZTRP_YR, BZTRP_SQNO ) D3 , ( SELECT BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    COUNT(DISTINCT BZTRVR_ENO) AS BZTRVR_ENO /* 출장자직원전산번호 */,
    SUM(DECODE(CAL_YN,'N',1,0)) AS CAL_YN /* 계산여부 */,
    SUM(DECODE(CAL_YN,'Y',1,0)) AS CAL_YN /* 계산여부 */
FROM TBBADDED011L WHERE 1=1 AND BZTRP_YR = #BZTRP_YR# GROUP BY BZTRP_YR, BZTRP_SQNO ) D4 WHERE 1=1 AND D1.BZTRP_SECD = '2' /*일반출장*/ AND D1.BZTRP_YR = D3.BZTRP_YR(+) AND D1.BZTRP_SQNO = D3.BZTRP_SQNO(+) AND D1.BZTRP_YR = D4.BZTRP_YR(+) AND D1.BZTRP_SQNO = D4.BZTRP_SQNO(+) AND D1.BZTRP_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#))) /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/ AND D1.BZTRP_DEPT_CD = #BZTRP_DEPT_CD# /*출장국과코드*/ AND D1.BZTRP_DEPT_CD = #BZTRP_DEPT_CD# /*출장국과코드*/ AND D1.SPRT_NO = #SPRT_NO# /*지원번호*/ AND D1.BZTRP_YR = #BZTRP_YR# /*출장년도*/ AND D1.DSPS_RQT_NM LIKE #TIT_TXT#||'%' /*출장상황명*/ ) WHERE 1=1 AND (AJT_YN_N != 'N' AND CAL_CFMTN_YN = 'N') AND AJT_YN_N = 'N' AND CAL_CFMTN_YN = 'Y' AND (AJT_YN_Y != 'N' AND CLCLN_CFMTN_YN = 'N') AND AJT_YN_Y = 'N' AND CLCLN_CFMTN_YN = 'Y' ORDER BY TO_NUMBER(SPRT_NO) DESC