SELECT T.T6AUD_KEY,
    T.T6DTM_STA_NM,
    T.T6ITEM1_CNT+T6ITEM2_CNT+T6ITEM3_CNT+T6ITEM4_CNT+T6ITEM5_CNT+T6ITEM6_CNT+T6ITEM7_CNT+T6ITEM8_CNT AS T6ITEM1_CNT,
    TRIM(TO_CHAR(T.T6ITEM1_AMT+T.T6ITEM3_AMT,'9,999,999,999,999,999')) || DECODE(T6ITEM1_AMT2+T6ITEM3_AMT2,0,'','(' || TRIM(TO_CHAR(T6ITEM1_AMT2+T6ITEM3_AMT2,'9,999,999,999,999,999')) || ')') AS TRIM,
    T.T6ITEM2_PERSON+T.T6ITEM7_PERSON+T.T6ITEM8_PERSON AS T6ITEM2_PERSON,
    T.T6ITEM1_CNT,
    TRIM(TO_CHAR(T.T6ITEM1_AMT,'9,999,999,999,999,999')) || DECODE(T6ITEM1_AMT2,0,'','(' || TRIM(TO_CHAR(T6ITEM1_AMT2,'9,999,999,999,999,999')) || ')') AS TRIM,
    T.T6ITEM2_CNT,
    T.T6ITEM2_PERSON,
    T.T6ITEM3_CNT,
    TRIM(TO_CHAR(T.T6ITEM3_AMT,'9,999,999,999,999,999')) || DECODE(T6ITEM3_AMT2,0,'','(' || TRIM(TO_CHAR(T6ITEM3_AMT2,'9,999,999,999,999,999')) || ')') AS TRIM,
    T.T6ITEM4_CNT,
    T.T6ITEM5_CNT,
    T.T6ITEM6_CNT,
    T.T6ITEM7_CNT,
    T.T6ITEM7_PERSON,
    T.T6ITEM8_CNT,
    T.T6ITEM8_PERSON
FROM ( select (SELECT '('|| F_MNG_KND_AUDYRNO(ST1.ADT_YR, ST1.ADT_NO, ST1.ADT_KDCD, '-') ||') '||ADT_MTTR_NM AS ADT_YR /* 감사년도 */
FROM TBBADDED001M ST1 WHERE 1 = 1 AND ST1.CVLCPT_ADT_YR||ST1.ADT_NO = DETAIL.CVLCPT_ADT_YR||DETAIL.ADT_NO ) AS "T6AUD_KEY" ,CASE WHEN DETAIL.CVLCPT_ADT_YR||DETAIL.ADT_NO IS NULL THEN '총계' ELSE NVL(CASE WHEN NVL(DETAIL.PRCS_TERM_YMD, '99991231') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '기한미경과' ELSE '기한경과' END,'소계') END AS "T6DTM_STA_NM" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '1' then 1 else 0 end) as "T6ITEM1_CNT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '1' then NVL(DETAIL.PNRT_PRSRV_AMT,0) else 0 end) as "T6ITEM1_AMT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '1' then NVL(DETAIL.RMBR_AMT,0) + NVL(DETAIL.SPLP_AMT,0) else 0 end) as "T6ITEM1_AMT2" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '2' then 1 else 0 end) as "T6ITEM2_CNT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '2' then NVL(DETAIL.TPOF_NOPE,0) else 0 end) as "T6ITEM2_PERSON" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '3' then 1 else 0 end) as "T6ITEM3_CNT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '3' then NVL(DETAIL.PNRT_PRSRV_AMT,0) else 0 end) as "T6ITEM3_AMT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '3' then NVL(DETAIL.RMBR_AMT,0) + NVL(DETAIL.SPLP_AMT,0) else 0 end) as "T6ITEM3_AMT2" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '4' then 1 else 0 end) as "T6ITEM4_CNT" ,sum(case when SUBSTR(MASTER.DSPS_RQT_KDCD,1,1) = '5' then 1 else 0 end) as "T6ITEM5_CNT" ,sum(case when MASTER.DSPS_RQT_KDCD = '611' then 1 else 0 end) as "T6ITEM6_CNT" ,sum(case when MASTER.DSPS_RQT_KDCD in ('610','620', '621', '630') then 1 else 0 end) as "T6ITEM7_CNT" ,sum(case when MASTER.DSPS_RQT_KDCD in ('610','620', '621', '630') then NVL(DETAIL.TPOF_NOPE,0) else 0 end) as "T6ITEM7_PERSON" ,sum(case when MASTER.DSPS_RQT_KDCD in ('710','720', '730') then 1 else 0 end) as "T6ITEM8_CNT" ,sum(case when MASTER.DSPS_RQT_KDCD in ('710','720', '730') then NVL(DETAIL.TPOF_NOPE,0) else 0 end) as "T6ITEM8_PERSON" FROM TBBADEAR001M master ,TBBADEAR002D detail ,TBDCMACM015M org ,TBBADDED001M J1 where 1=1 /* 속도개선으로 쿼리로 변경 2015.05.13 yyh */ AND 'Y' = (CASE WHEN (#strAudYr# = '' AND #strAudGrnNo# = '' AND #strAudYrTo# = '' AND #strAudGrnNoTo# = '') THEN 'Y' ELSE (CASE WHEN LPAD(MASTER.CVLCPT_ADT_YR, 4, '0') || LPAD(J1.ADT_GRNT_NO, 3, '0') BETWEEN LPAD(NVL(#strAudYr#, '1700'), 4, '0') || LPAD(NVL(#strAudGrnNo#, '000'), 3, '0') AND LPAD(NVL(#strAudYrTo#, '9999'), 4, '0') || LPAD(NVL(#strAudGrnNoTo#, '999'), 3, '0') THEN 'Y' ELSE 'N' END) END) AND NVL(DETAIL.ENFC_YMD, '19000101') BETWEEN NVL(#strEnfDtFrom#, '17000101') AND NVL(#strEnfDtTo#, '99991231') AND NVL(DETAIL.IMPL_WHLS_CFMTN_YMD, '19000101') BETWEEN NVL(#strConfirmDtFrom#, '17000101') AND NVL(#strConfirmDtTo#, '99991231') AND DETAIL.IMPL_MNG_JRSD_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strUpSpvBrdvCd#))) AND DETAIL.CMO_INST_CD = #CMO_INST_CD# AND DETAIL.IMPL_MNG_JRSD_DEPT_CD = #IMPL_MNG_JRSD_DEPT_CD# /* 감사연번종류코드 추가 - 2015.12.24 yyh 감사연번종류코드 from ~ to 에서 한개로 변경 - 2016.06.02 yyh */ AND SUBSTR(J1.ADT_KDCD,3,1) = NVL(#strAudYrNoKndCdSt#,'0') AND MASTER.CVLCPT_ADT_YR = DETAIL.CVLCPT_ADT_YR AND MASTER.ADT_NO = DETAIL.ADT_NO AND MASTER.DSPS_RQT_SQNO = DETAIL.DSPS_RQT_SQNO AND MASTER.CVLCPT_ADT_YR = J1.CVLCPT_ADT_YR AND MASTER.ADT_NO = J1.ADT_NO AND DETAIL.CMO_INST_CD = ORG.INST_CD AND DETAIL.CFMTN_STTS_SECD = 1 AND (DETAIL.CFMTN_YN <> 'Y' OR DETAIL.CFMTN_YN IS NULL) group by rollup(DETAIL.CVLCPT_ADT_YR||DETAIL.ADT_NO ,CASE WHEN NVL(DETAIL.PRCS_TERM_YMD, '99991231') >= TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '기한미경과' ELSE '기한경과' END) ) T