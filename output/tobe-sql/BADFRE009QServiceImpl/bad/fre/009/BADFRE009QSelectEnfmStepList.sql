SELECT AA.HIRK_ENFM_MNG_BRDV_CD,
    CASE WHEN AA.HIRK_ENFM_MNG_BRDV_CD IS NULL THEN ' ' ELSE F_DPT_INFO(AA.HIRK_ENFM_MNG_BRDV_CD,'1') END AS HIRK_ENFM_MNG_BRDV_CD,
    F_DPT_INFO(AA.HIRK_ENFM_MNG_BRDV_CD,'1') AS F_DPT_INFO,
    CASE WHEN AA.HIRK_ENFM_MNG_BRDV_CD IS NULL THEN '총계' WHEN AA.IMPL_MNG_JRSD_DEPT_CD IS NULL THEN '소계' ELSE AA.IMPL_MNG_JRSD_DEPT_CD END AS IMPL_MNG_JRSD_DEPT_CD /* 집행관리소관부서코드 */,
    CASE WHEN AA.HIRK_ENFM_MNG_BRDV_CD IS NULL THEN '총계' WHEN AA.IMPL_MNG_JRSD_DEPT_CD IS NULL THEN '소계' ELSE F_DPT_INFO(AA.IMPL_MNG_JRSD_DEPT_CD,'1') END AS HIRK_ENFM_MNG_BRDV_CD,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='10' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='11' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='20' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='21' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='30' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='31' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='32' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='10' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='11' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='10' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='11' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='20' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='21' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='20' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='21' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='30' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='31' THEN CNT ELSE 0 END +CASE WHEN AA.IMPL_STP_SECD ='32' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='30' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='31' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */,
    SUM(CASE WHEN AA.IMPL_STP_SECD ='32' THEN CNT ELSE 0 END ) AS IMPL_STP_SECD /* 집행단계구분코드 */
FROM ( SELECT (SELECT AS HIRK_DPT_CD
FROM TBDCMACM002M WHERE SRECS_DEPT_CD = T1.IMPL_MNG_JRSD_DEPT_CD AND ROWNUM = 1) AS HIRK_ENFM_MNG_BRDV_CD, T1.IMPL_MNG_JRSD_DEPT_CD, T2.IMPL_STP_SECD, COUNT(1) CNT FROM TBBADEAR002D T1, TBBADFRE001H T2, TBBADDED001M J1, (SELECT ST1.ADT_YR /* 감사년도 */,
    ST1.ADT_NO /* 감사번호 */,
    ST1.DSPS_RQT_SQNO /* 처분요구순번 */,
    ST1.REL_INST_CD /* 관계기관코드 */,
    MAX(ST1.HSTRY_SQNO) AS HSTRY_SQNO /* 이력순번 */
FROM TBBADFRE001H ST1 GROUP BY ST1.CVLCPT_ADT_YR, ST1.ADT_NO, ST1.DSPS_RQT_SQNO, ST1.SRECS_REL_INST_CD) T3 WHERE T1.CVLCPT_ADT_YR = T2.CVLCPT_ADT_YR AND T1.ADT_NO = T2.ADT_NO AND T1.DSPS_RQT_SQNO = T2.DSPS_RQT_SQNO AND T2.CVLCPT_ADT_YR = T3.CVLCPT_ADT_YR AND T2.ADT_NO = T3.ADT_NO AND T2.DSPS_RQT_SQNO = T3.DSPS_RQT_SQNO AND T2.SRECS_REL_INST_CD = T3.SRECS_REL_INST_CD AND T2.HSTRY_SQNO = T3.HSTRY_SQNO AND T1.CVLCPT_ADT_YR = J1.CVLCPT_ADT_YR AND T1.ADT_NO = J1.ADT_NO /* 속도개선으로 쿼리로 변경 2015.05.13 yyh */ AND 'Y' = (CASE WHEN (#strAudYr# = '' AND #strAudGrnNo# = '' AND #strAudYrTo# = '' AND #strAudGrnNoTo# = '') THEN 'Y' ELSE (CASE WHEN LPAD(T1.CVLCPT_ADT_YR, 4, '0') || LPAD(J1.ADT_GRNT_NO, 3, '0') BETWEEN LPAD(NVL(#strAudYr#, '1700'), 4, '0') || LPAD(NVL(#strAudGrnNo#, '000'), 3, '0') AND LPAD(NVL(#strAudYrTo#, '9999'), 4, '0') || LPAD(NVL(#strAudGrnNoTo#, '999'), 3, '0') THEN 'Y' ELSE 'N' END) END) AND NVL(T1.ENFC_YMD, '19000101') BETWEEN NVL(#strEnfDtFrom#, '17000101') AND NVL(#strEnfDtTo#, '99991231') AND NVL(T1.IMPL_WHLS_CFMTN_YMD, '19000101') BETWEEN NVL(#strConfirmDtFrom#, '17000101') AND NVL(#strConfirmDtTo#, '99991231') AND T1.IMPL_MNG_JRSD_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#S_CNB#, #strDptAuth#, '', #strUpSpvBrdvCd#))) /* 감사연번종류코드 추가 - 2015.12.24 yyh 감사연번종류코드 from ~ to 에서 한개로 변경 - 2016.06.02 yyh */ AND SUBSTR(J1.ADT_KDCD,3,1) = NVL(#strAudYrNoKndCdSt#,'0') AND T1.CMO_INST_CD = #CMO_INST_CD# AND T1.IMPL_MNG_JRSD_DEPT_CD = #IMPL_MNG_JRSD_DEPT_CD# GROUP BY T1.IMPL_MNG_JRSD_DEPT_CD, T2.IMPL_STP_SECD ) AA WHERE 1 = 1 GROUP BY ROLLUP(AA.HIRK_ENFM_MNG_BRDV_CD, AA.IMPL_MNG_JRSD_DEPT_CD) ORDER BY HIRK_ENFM_MNG_BRDV_CD, IMPL_MNG_JRSD_DEPT_CD