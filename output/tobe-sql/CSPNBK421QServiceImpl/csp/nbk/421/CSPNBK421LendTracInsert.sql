INSERT INTO /* CSPNBK421LendTracInsert */ TBCSPNBK206L ( LEND_KND_CD , PRCS_YM , MOUI_NO , RPM_PRN , RPM_DT , LAG_WDL_TRAC_HNDL_STA_CD , ARR_RPM_PRN_SUM_AM , BK_RPM_PRN_SUM_AM , EMN_RPM_PRN_SUM_AM , FRST_USER_ID , LAST_USER_ID , LAST_PRCS_DEPT_CD , LAST_MENU_ID , FRST_REG_DT , LAST_MDFCN_DT ) SELECT D3.LEND_KND_CD,
    #hndlYm# AS PRCS_YM /* 처리연월 */,
    D3.MOUI_NO,
    ( ( CASE WHEN D4.PRE_ARR_LEND_SUM_BL >= D3.ARR_RPM_PRN_SUM_AM THEN D3.ARR_RPM_PRN_SUM_AM ELSE D4.PRE_ARR_LEND_SUM_BL END ) + ( CASE WHEN D4.PRE_LEND_SUM_BL >= D3.BK_RPM_PRN_SUM_AM THEN D3.BK_RPM_PRN_SUM_AM ELSE D4.PRE_LEND_SUM_BL END ) + EMN_RPM_PRN_SUM_AM ) AS PRE_ARR_LEND_SUM_BL,
    #tracHndlSchDt# AS #TRACHNDLSCHDT#,
    '0' AS LAG_WDL_TRAC_HNDL_STA_CD,
    ( CASE WHEN D4.PRE_ARR_LEND_SUM_BL >= D3.ARR_RPM_PRN_SUM_AM THEN D3.ARR_RPM_PRN_SUM_AM ELSE D4.PRE_ARR_LEND_SUM_BL END ) AS PRE_ARR_LEND_SUM_BL,
    ( CASE WHEN D4.PRE_LEND_SUM_BL >= D3.BK_RPM_PRN_SUM_AM THEN D3.BK_RPM_PRN_SUM_AM ELSE D4.PRE_LEND_SUM_BL END ) AS PRE_LEND_SUM_BL,
    D4.EMN_RPM_PRN_SUM_AM,
    #usrId# AS FRST_USER_ID /* 최초사용자아이디 */,
    #usrId# AS LAST_USER_ID /* 최종사용자아이디 */,
    #dptCd# AS LAST_PRCS_DEPT_CD /* 최종처리부서코드 */,
    #mnuId# AS LAST_MENU_ID /* 최종메뉴아이디 */,
    SYSDATE AS FRST_REG_DT,
    SYSDATE AS LAST_MDFCN_DT
FROM ( SELECT D1.LEND_KND_CD,
    D1.MOUI_NO,
    D1.FNL_RPM_DT,
    D1.LEND_BL,
    D1.EMN_RPM_WAY_DVSN_CD,
    NVL(D1.ARR_RPM_PRN_SUM_AM, 0) AS ARR_RPM_PRN_SUM_AM,
    NVL(D1.BK_RPM_PRN_SUM_AM, 0 ) AS BK_RPM_PRN_SUM_AM
FROM TBCSPNBK202M D1 WHERE D1.LEND_KND_CD = #lendKndCd# AND D1.LEND_BL > 0 AND ( D1.EMN_RPM_WAY_DVSN_CD != '0' OR ( D1.EMN_RPM_WAY_DVSN_CD = '0' AND D1.FNL_RPM_DT #tracHndlSchDt# THEN D2.LEND_BL ELSE 0 END )), 0) AS PRE_LEND_SUM_BL , NVL(SUM((CASE WHEN D2.LEND_DT >= '20080201' THEN ( CASE WHEN D2.LEND_KND_CD = #lendKndCd# THEN ( CASE WHEN D2.LEND_BL >= D2.EMN_RPM_PRN THEN D2.EMN_RPM_PRN ELSE D2.LEND_BL END ) ELSE 0 END ) ELSE 0 END )), 0) AS EMN_RPM_PRN_SUM_AM FROM TBCSPNBK203D D2 WHERE D2.LEND_KND_CD = #lendKndCd# AND D2.LEND_BL > 0 AND D2.CNL_YN = 'N' GROUP BY D2.LEND_KND_CD, D2.MOUI_NO ) D4 WHERE D3.LEND_KND_CD = D4.LEND_KND_CD(+) AND D3.MOUI_NO = D4.MOUI_NO(+) AND D3.MOUI_NO IN ( SELECT MOUI_NO
FROM TBCSPNBK001M WHERE RGR_YN = #strRGR_YN# ) AND ( D4.PRE_ARR_LEND_SUM_BL > 0 OR D4.PRE_LEND_SUM_BL > 0 OR D4.EMN_RPM_PRN_SUM_AM > 0 )