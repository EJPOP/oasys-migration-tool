SELECT S1.DMT_DVSN_CD,
    DECODE(S1.POSS_CNT - NVL(S2.CNT_DMT_DVSN_CD,0), 0, 'Y', 'N') AS POSS_CNT
FROM (SELECT A.DMT_DVSN_CD,
    A.POSS_CNT,
    A.STR_DDL_DT,
    A.END_DDL_DT
FROM (SELECT F2_WSRM_BOKG_POSS_CNT,
    '4' AS DMT_DVSN_CD,
    STR_DDL_DT,
    END_DDL_DT
FROM TBCSPSAE134B WHERE F2_WSRM_BOKG_POSS_CNT > 0 UNION ALL SELECT F3_WSRM_BOKG_POSS_CNT,
    '5' AS DMT_DVSN_CD,
    STR_DDL_DT,
    END_DDL_DT
FROM TBCSPSAE134B WHERE F3_WSRM_BOKG_POSS_CNT > 0 UNION ALL SELECT F3_KSRM_BOKG_POSS_CNT,
    '6' AS DMT_DVSN_CD,
    STR_DDL_DT,
    END_DDL_DT
FROM TBCSPSAE134B WHERE F3_KSRM_BOKG_POSS_CNT > 0 UNION ALL SELECT F4_WSRM_BOKG_POSS_CNT,
    '7' AS DMT_DVSN_CD,
    STR_DDL_DT,
    END_DDL_DT
FROM TBCSPSAE134B WHERE F4_WSRM_BOKG_POSS_CNT > 0 UNION ALL SELECT CAMP_BOKG_POSS_CNT,
    '8' AS DMT_DVSN_CD,
    STR_DDL_DT,
    END_DDL_DT
FROM TBCSPSAE134B WHERE CAMP_BOKG_POSS_CNT > 0 ) A WHERE SYSDATE BETWEEN A.STR_DDL_DT AND A.END_DDL_DT) S1, (SELECT T2.DMT_DVSN_CD,
    COUNT(T2.DMT_DVSN_CD) AS DMT_DVSN_CD
FROM TBCSPSAE501M T1, TBCSPSAE501D T2 WHERE T1.TRGT_NOP_ENO = T2.TRGT_NOP_ENO AND T1.APL_DT = T2.APL_DT AND T1.BSC_SRNO = T2.BSC_SRNO AND USE_STR_DT BETWEEN TO_CHAR(TRUNC(TO_DATE(#DDT#), 'IW'), 'YYYYMMDD') AND TO_CHAR(TRUNC(TO_DATE(#DDT#), 'IW')+6, 'YYYYMMDD') GROUP BY T2.DMT_DVSN_CD) S2 WHERE S1.DMT_DVSN_CD = S2.DMT_DVSN_CD(+) AND S1.DMT_DVSN_CD = #DMT_DVSN_CD#