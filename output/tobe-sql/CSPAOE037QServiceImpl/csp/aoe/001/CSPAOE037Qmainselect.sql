SELECT NVL(F_MNG_KND_AUDYRNO(D3.CVLCPT_ADT_YR, D3.TSK_NO, D5.ADT_KDCD, '-'),D3.CVLCPT_ADT_YR || '-' || D3.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    F_CODE_NM('1000270', D3.ADT_KDCD) AS F_CODE_NM /* 감사종류 */,
    D3.MNDY_CNT /* 연인원 */,
    F_CODE_NM('1000273', D3.ADT_STP_SECD) AS ADT_STP_NM /* 감사단계명 */,
    D3.RMK_1_YN /* 지적,문제 */,
    D3.RMK_2_YN /* 성과,기대 */,
    D3.RMK_3_YN /* 애로,특기기여도사유 */,
    D4.CVLCPT_DOC_ID /* 민원문서아이디 */,
    D4.ADT_PLAN_DOC_TPCD /* 감사계획문서유형코드 */,
    D4.DOC_NM /* 문서명 */,
    D3.ADT_STP_SECD /* 감사단계구분코드 */,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과부서명 2015.02.04 최원형감사관 요청 */
FROM ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    D1.ADT_KDCD /* 감사종류코드 */,
    D1.MNDY_CNT,
    D2.ADT_STP_SECD AS ADT_STP_SECD /* 감사단계구분코드 */,
    DECODE(LENGTH(TRIM(D1.MAIN_INDC_SBJ_PRB_TXT)), 0, 'N', '', 'N', 'Y') AS LENGTH,
    DECODE(LENGTH(TRIM(D1.MAIN_AUD_RSLT_EPT_EFCT_TXT)), 0, 'N', '', 'N', 'Y') AS LENGTH,
    DECODE(LENGTH(TRIM(D1.SPCT_SBJ_PLN_CTT_CTB_RTE_CHG_RSN_TXT)), 0, 'N', '', 'N', 'Y') AS LENGTH,
    D1.HNDL_DIV_DPT_CD
FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE 1 = 1 AND CMPTN_YMD BETWEEN ( SELECT EVL_STR_DT
FROM TBCSPAOE001M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# ) AND ( SELECT EVL_END_DT
FROM TBCSPAOE001M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# ) AND CMPTN_YMD IS NOT NULL GROUP BY CVLCPT_ADT_YR, TSK_NO ) D2 , TBCSPAOE021M D1 WHERE D2.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND D2.TSK_NO = D1.TSK_NO AND D1.ADT_KDCD = #ADT_KDCD# ) D3 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    CVLCPT_DOC_ID /* 민원문서아이디 */,
    ADT_PLAN_DOC_TPCD /* 감사계획문서유형코드 */,
    '[' || F_CODE_NM('1000273', DECODE( ADT_PLAN_DOC_TPCD, 'SP-OE-001', '10000', 'SP-OE-002', '10001', 'SP-OE-003', '10004', 'SP-OE-004', '10004', 'SP-OE-005', '10010', 'SP-OE-006', '10010', 'SP-OE-007', '10010')) || ']' || DOC_NM AS DOC_NM /* 문서명 */
FROM ( SELECT D6.ENAIS_ATCH_FILE_NM AS ENAIS_ATCH_FILE_NM /* ENAIS첨부파일명 */,
    D5.CVLCPT_ADT_YR /* 민원감사년도 */,
    D5.TSK_NO,
    D5.CVLCPT_DOC_ID /* 민원문서아이디 */,
    D5.ADT_PLAN_DOC_TPCD /* 감사계획문서유형코드 */
FROM TBCSPAOE040M D5 , UBKERAPP.ECM_FILE_LIST_VIEW D6 WHERE D5.CVLCPT_DOC_ID = D6.CVLCPT_DOC_ID ) WHERE DOC_NM IS NOT NULL ) D4 ,TB_BADDED001M D5 WHERE D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR (+) AND D3.TSK_NO = D4.TSK_NO (+) AND D3.CVLCPT_ADT_YR = D5.ADT_YR (+) AND D3.TSK_NO = D5.ADT_NO (+) AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D5.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D3.tsk_no = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D5.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) ORDER BY D3.HNDL_DIV_DPT_CD, D3.CVLCPT_ADT_YR, D3.TSK_NO DESC, D3.ADT_STP_SECD