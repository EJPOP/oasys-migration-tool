SELECT /* csp.bii.service.impl.CSPBII216QServiceImpl.CSPBII216QExcelSelect */ T1.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    T1.ADT_NO AS ADT_NO /* 감사번호 */,
    T1.ADT_CLSF_NO AS ADT_CLSF_NO /* 감사분류번호 */,
    T1.ADT_GRNT_NO AS ADT_GRNT_NO /* 감사부여번호 */,
    T1.AUD_YR_NO_KND_CD AS AUD_YR_NO_KND_CD /* 감사연번호종류코드 */,
    T1.AUD_YR_NO_KND_NM AS AUD_YR_NO_KND_NM /* 감사연번호종류코드명 */,
    T1.AUD_DTL_NO AS AUD_DTL_NO /* 세부연번호 */,
    T1.ADT_ASMT_SECD AS ADT_ASMT_SECD /* 감사과제구분코드 */,
    T1.AUD_TASK_NM AS AUD_TASK_NM,
    T1.INST_SECD AS INST_SECD /* 기관구분코드 */,
    T1.ADT_KDCD AS ADT_KDCD /* 감사종류코드 */,
    T1.AUD_KND_NM AS AUD_KND_NM,
    T1.SPRVSN_DEPT_CD AS SPRVSN_DEPT_CD /* 주관부서코드 */,
    T1.SPV_BRDV_NM AS SPV_BRDV_NM /* 주관국과명 */,
    T1.ADT_MTHD_SECD AS ADT_MTHD_SECD /* 감사방법구분코드 */,
    T1.AUD_WAY_NM AS AUD_WAY_NM,
    T1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    T1.ADT_SCL_SECD AS ADT_SCL_SECD /* 감사규모구분코드 */,
    T1.TASK_SECD AS TASK_SECD /* 업무구분코드 */,
    T1.TSK_CAT_NM AS TSK_CAT_NM,
    T1.ADT_RPRS_INST_CD AS ADT_RPRS_INST_CD /* 감사대표기관코드 */,
    T1.AUD_RPST_ORG_NM AS AUD_RPST_ORG_NM,
    T1.MNG_DEPT_CD AS MNG_DEPT_CD /* 관리부서코드 */,
    T1.MNG_DPT_NM AS MNG_DPT_NM,
    T1.PRGRS_STP_SECD AS PRGRS_STP_SECD /* 진행단계구분코드 */,
    F_CODE_NM('1000785',T1.PRGRS_STP_SECD) || (CASE WHEN T1.BZTRP_BGT_SECD = '1' AND T1.PRGRS_STP_SECD = '02' THEN (SELECT '/'|| F_CODE_NM('1000030',ADT_BZTRP_KDCD) AS PRGRS_STP_SECD /* 진행단계구분코드 */
FROM TB_BADDED002M WHERE BZTRP_YR || BZTRP_SQNO = (SELECT MAX(BZTRP_YR || BZTRP_SQNO) AS BZTRP_YR /* 출장년도 */
FROM TB_BADDED002M WHERE REL_ADT_YR = T1.CVLCPT_ADT_YR AND REL_ADT_NO = T1.ADT_NO ) ) END) AS PRSS_STEP_NM /*진행단계코드명*/ , T1.ADT_BGNG_YMD, T1.ADT_END_YMD , T1.ACADT_END_YMD AS ACADT_END_YMD /* 종료보고일- 2017.10.31 EUNOK */ , T1.CVLCPT_DOC_ID , T1.SLCT_RPTP_NM , TO_CHAR(T1.CRU_LAST_ATRZ_DT,'YYYY-MM-DD') AS CRU_LAST_ATRZ_DT , T1.RMRK_CN /* 담당자비고 - 2018.02.01 EUNOK (담당자비고를 정보수집건수로 변경 20200807 EUNOK) */ , T1.ATRZ_STTS_SECD , T1.DOC_TYPE , T1.DOC_ID2 , T1.RPRT_NM2 , T1.DOC_TYPE2 FROM ( SELECT D1.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_NO AS ADT_NO /* 감사번호 */,
    D1.ADT_GRNT_NO AS ADT_GRNT_NO /* 감사부여번호 */,
    F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.ADT_NO, D1.ADT_KDCD, '-') AS ADT_CLSF_NO /* 감사분류번호 */,
    CASE WHEN D1.CVLCPT_ADT_YR >= '2016' THEN D1.ADT_KDCD ELSE '' END AS CVLCPT_ADT_YR /* 민원감사년도 */,
    CASE WHEN D1.CVLCPT_ADT_YR >= '2016' THEN F_CODE_NM('1000739',D1.ADT_KDCD) ELSE '-' END AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.CVLCPT_ADT_YR||'-'||SUBSTR(D1.ADT_ASMT_SECD,-1)||'-'||D1.INST_SECD||'-'||SUBSTR(D1.ADT_KDCD,-1) ||'-'||SUBSTR(D1.SPRVSN_DEPT_CD,1,2)||SUBSTR(D1.SPRVSN_DEPT_CD,4,2)||'-'||SUBSTR(D1.ADT_MTHD_SECD,-1)||'-'||D1.ADT_NO AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_ASMT_SECD AS ADT_ASMT_SECD /* 감사과제구분코드 */,
    F_CODE_NM_YEAR('1000008', D1.ADT_ASMT_SECD, D1.CVLCPT_ADT_YR) AS F_CODE_NM_YEAR,
    D1.INST_SECD AS INST_SECD /* 기관구분코드 */,
    D1.ADT_KDCD AS ADT_KDCD /* 감사종류코드 */,
    F_CODE_NM_YEAR('1000007', D1.ADT_KDCD, D1.CVLCPT_ADT_YR) AS F_CODE_NM_YEAR,
    D1.SPRVSN_DEPT_CD AS SPRVSN_DEPT_CD /* 주관부서코드 */,
    F_DPT_INFO(D1.SPRVSN_DEPT_CD,'1') AS F_DPT_INFO /* 주관국과명 */,
    D1.ADT_MTHD_SECD AS ADT_MTHD_SECD /* 감사방법구분코드 */,
    F_CODE_NM_YEAR('1000009', D1.ADT_MTHD_SECD, D1.CVLCPT_ADT_YR) AS F_CODE_NM_YEAR,
    D1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    D1.ADT_SCL_SECD AS ADT_SCL_SECD /* 감사규모구분코드 */,
    D1.TASK_SECD AS TASK_SECD /* 업무구분코드 */,
    F_CODE_NM('1000120',D1.TASK_SECD) AS F_CODE_NM,
    D1.ADT_RPRS_INST_CD AS ADT_RPRS_INST_CD /* 감사대표기관코드 */,
    F_ORG_INFO(D1.ADT_RPRS_INST_CD,'1') AS F_ORG_INFO,
    D1.MNG_DEPT_CD AS MNG_DEPT_CD /* 관리부서코드 */,
    F_DPT_INFO(D1.MNG_DEPT_CD,'1') AS F_DPT_INFO,
    D1.PRGRS_STP_SECD AS PRGRS_STP_SECD /* 진행단계구분코드 */,
    D1.RMRK_CN /* 비고내용 */,
    D1.BZTRP_BGT_SECD /* 출장예산구분코드 */,
    (SELECT MIN(ADT_BGNG_YMD) AS ADT_BGNG_YMD /* 감사시작일자 */
FROM TBBADDED002M A WHERE REL_ADT_YR = D1.CVLCPT_ADT_YR AND REL_ADT_NO = D1.ADT_NO AND ADT_BZTRP_KDCD IN ('02','03')) AS ADT_BGNG_YMD /* 실지감사 02:실지감사, 03:실지감사연장- 2017.11.14 EUNOK */ ,(SELECT MAX(ADT_END_YMD) AS ADT_END_YMD /* 감사종료일자 */
FROM TBBADDED002M A WHERE REL_ADT_YR = D1.CVLCPT_ADT_YR AND REL_ADT_NO = D1.ADT_NO AND ADT_BZTRP_KDCD IN ('02','03')) AS ADT_END_YMD /* 감사종료일 02:실지감사, 03:실지감사연장- 2017.11.07 EUNOK */ , D3.ACADT_END_YMD /* 종료보고일 - 2017.10.31 EUNOK */ , D4.CVLCPT_DOC_ID , D4.SLCT_RPTP_NM , D4.ATRZ_STTS_SECD , D4.DOC_TYPE , D5.CRU_LAST_ATRZ_DT , D6.CVLCPT_DOC_ID AS DOC_ID2 , D6.SLCT_RPTP_NM AS RPRT_NM2 , D6.DOC_TYPE AS DOC_TYPE2 FROM TBBADDED001M D1 , TBCSPDCP101M D2 , TBBADDED003M D3 ,(SELECT A1.ADT_YR /* 감사년도 */,
    A1.ADT_NO /* 감사번호 */,
    MAX (A1.ATRZ_STTS_SECD) AS ATRZ_STTS_SECD /* 결재상태구분코드 */,
    SUBSTR(XMLAGG(XMLELEMENT(X,',',CVLCPT_DOC_ID) ORDER BY CVLCPT_ADT_YR,ADT_NO,ADT_STP_SECD,CVLCPT_DOC_ID).EXTRACT('//text()'),2) AS CVLCPT_DOC_ID /* 민원문서아이디 */,
    SUBSTR(XMLAGG(XMLELEMENT(X,',',SLCT_RPTP_NM) ORDER BY CVLCPT_ADT_YR,ADT_NO,ADT_STP_SECD,CVLCPT_DOC_ID).EXTRACT('//text()'),2) AS SLCT_RPTP_NM /* 청탁보고서명 */,
    F_OPEN_EDIT(A1.LNKG_URL_ADDR) AS F_OPEN_EDIT
FROM TBBADDED103M A1 WHERE A1.ADT_STP_SECD = 'A1030' AND A1.SLCT_RPTP_KDCD = 'A10300100' AND A1.ATRZ_STTS_SECD = '30' GROUP BY A1.CVLCPT_ADT_YR ,A1.ADT_NO, F_OPEN_EDIT(A1.SRECS_LNKG_URL_ADDR) ) D4 ,( SELECT MAX(AA.ADT_YR) AS CVLCPT_ADT_YR /* 민원감사년도 */,
    MAX(AA.ADT_NO) AS ADT_NO /* 감사번호 */,
    MAX(BB.APV_DH) AS CRU_LAST_ATRZ_DT /* 부패최종결재일시 */
FROM TBBADDED103M AA,TBDCMACM023L BB WHERE AA.ADT_STP_SECD = 'A1030' AND AA.SLCT_RPTP_KDCD = 'A10300100' AND AA.ATRZ_DMND_ID = BB.ATRZ_DOC_NO AND AA.ATRZ_STTS_SECD = '30' GROUP BY AA.CVLCPT_ADT_YR ,AA.ADT_NO,AA.ATRZ_DMND_ID,AA.SLCT_RPTP_KDCD) D5 ,(SELECT A1.ADT_YR /* 감사년도 */,
    A1.ADT_NO /* 감사번호 */,
    MAX (A1.ATRZ_STTS_SECD) AS ATRZ_STTS_SECD /* 결재상태구분코드 */,
    SUBSTR(XMLAGG(XMLELEMENT(X,',',CVLCPT_DOC_ID) ORDER BY CVLCPT_ADT_YR,ADT_NO,ADT_STP_SECD,CVLCPT_DOC_ID).EXTRACT('//text()'),2) AS CVLCPT_DOC_ID /* 민원문서아이디 */,
    SUBSTR(XMLAGG(XMLELEMENT(X,',',SLCT_RPTP_NM) ORDER BY CVLCPT_ADT_YR,ADT_NO,ADT_STP_SECD,CVLCPT_DOC_ID).EXTRACT('//text()'),2) AS SLCT_RPTP_NM /* 청탁보고서명 */,
    F_OPEN_EDIT(A1.LNKG_URL_ADDR) AS F_OPEN_EDIT
FROM TBBADDED103M A1 WHERE A1.ADT_STP_SECD = 'A1030' AND A1.SLCT_RPTP_KDCD = 'A10300150' AND A1.ATRZ_STTS_SECD = '30' GROUP BY A1.CVLCPT_ADT_YR ,A1.ADT_NO, F_OPEN_EDIT(A1.SRECS_LNKG_URL_ADDR) ) D6 ,( SELECT MAX(AA.ADT_YR) AS CVLCPT_ADT_YR /* 민원감사년도 */,
    MAX(AA.ADT_NO) AS ADT_NO /* 감사번호 */,
    MAX(BB.APV_DH) AS CRU_LAST_ATRZ_DT /* 부패최종결재일시 */
FROM TBBADDED103M AA,TBDCMACM023L BB WHERE AA.ADT_STP_SECD = 'A1030' AND AA.SLCT_RPTP_KDCD = 'A10300150' AND AA.ATRZ_DMND_ID = BB.ATRZ_DOC_NO AND AA.ATRZ_STTS_SECD = '30' GROUP BY AA.CVLCPT_ADT_YR ,AA.ADT_NO,AA.ATRZ_DMND_ID,AA.SLCT_RPTP_KDCD) D7 WHERE 1=1 AND D1.CVLCPT_RCPT_YR = D2.CVLCPT_RCPT_YR(+) AND D1.CVLCPT_RCPT_RCPT = D2.CVLCPT_RCPT_RCPT(+) AND D1.CLM_SECD = D2.CLM_SECD(+) AND D1.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR(+) AND D1.ADT_NO = D3.ADT_NO(+) AND D1.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR(+) AND D1.ADT_NO = D4.ADT_NO(+) AND D1.CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR(+) AND D1.ADT_NO = D5.ADT_NO(+) AND D1.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR(+) AND D1.ADT_NO = D6.ADT_NO(+) AND D1.CVLCPT_ADT_YR = D7.CVLCPT_ADT_YR(+) AND D1.ADT_NO = D7.ADT_NO(+) /*AND D1.AUD_NO NOT LIKE '9%' 서면모니터링을 걸러내야하므로*/ AND D1.ADT_KDCD NOT LIKE '175' /* 확인출장 제외 */ AND D1.SPRVSN_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#))) /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/ AND D1.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' AND D1.PRGRS_STP_SECD = #PRGRS_STP_SECD# AND D1.ADT_KDCD = #ADT_KDCD# AND D1.SPRVSN_DEPT_CD = #SPRVSN_DEPT_CD# AND D1.CLM_SECD = #CLM_SECD# /*감사사항검색팝업의 경우 서면/모니터링 감사의 경우 통제가 해제된 건에 대해서만 조회되어야 한다. */ AND NOT EXISTS ( SELECT 1
FROM TBBADDED001M WHERE 1=1 AND CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND ADT_NO = D1.ADT_NO AND SUBSTR(ADT_KDCD,3,1) = '9' AND NVL(SUBSTR(ADT_MTHD_SECD,3,1),' ') <> '4' ) ) T1 WHERE 1=1 AND T1.ADT_BGNG_YMD >= '20170908' AND T1.ADT_BGNG_YMD AND T1.CVLCPT_ADT_YR||LPAD(T1.ADT_GRNT_NO,4,'0') >= #strAudYrSt#||DECODE(#strAudGrnNoSt#,'','0000', LPAD(#strAudGrnNoSt#,4,'0')) AND T1.CVLCPT_ADT_YR||LPAD(T1.ADT_GRNT_NO,4,'0') AND TO_CHAR(T1.CRU_LAST_ATRZ_DT,'YYYYMMDD') &gt;= #strAudEnd_DTS# AND TO_CHAR(T1.CRU_LAST_ATRZ_DT,'YYYYMMDD') &lt;= #strAudEnd_DTE# /* 감사연번종류코드 추가 - 2015.12.22 yyh */ AND SUBSTR(T1.ADT_KDCD,3,1) = SUBSTR(#strAudYrNoKndCdSt#,3,1) ORDER BY CVLCPT_ADT_YR DESC, ADT_NO DESC