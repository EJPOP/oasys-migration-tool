SELECT D1.CVLCPT_ADT_YR AS CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_NO AS ADT_NO /* 감사번호 */,
    F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.ADT_NO, D1.ADT_KDCD, '-') AS ADT_CLSF_NO /* 감사분류번호 */,
    D1.SPRVSN_DEPT_CD AS SPRVSN_DEPT_CD /* 주관부서코드 */,
    F_DPT_INFO(D1.SPRVSN_DEPT_CD,'1') AS F_DPT_INFO /* 주관국과명 */,
    D1.ADT_MTTR_NM AS ADT_MTTR_NM /* 감사사항명 */,
    (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' AS 0
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO AND T1.LINK_YN = 'Y') AS LINK_YN /*홍보제출여부*/ ,( select TO_CHAR(TO_DATE(MIN(D3.REG_YMD)),'YYYY-MM-DD') AS REG_YMD /* 등록일자 */
FROM TB_BADEAR028M D3 where 1=1 and D3.ADT_SQNO = D1.CVLCPT_ADT_YR||D1.ADT_NO ) as B_REGI_DT ,(SELECT TO_CHAR(TO_DATE(MAX(T1.PBRL_SBMSN_YMD)),'YYYY-MM-DD') AS PBRL_SBMSN_YMD /* 홍보제출일자 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO) AS PBRL_SBMSN_YMD ,(SELECT TO_CHAR(TO_DATE(MAX(T1.REG_YMD)),'YYYY-MM-DD') AS REG_YMD /* 등록일자 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO) AS REG_YMD , CASE WHEN (SELECT MAX(T1.REG_YMD) AS REG_YMD /* 등록일자 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO) IS NOT NULL THEN TO_DATE((SELECT MAX(T1.REG_YMD) AS REG_YMD /* 등록일자 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO)) - ( select TO_DATE(MIN(D3.REG_YMD)) AS REG_YMD /* 등록일자 */
FROM TB_BADEAR028M D3 where 1=1 and D3.ADT_SQNO = D1.CVLCPT_ADT_YR||D1.ADT_NO ) ELSE TO_DATE(SYSDATE) -( select TO_DATE(MIN(D3.REG_YMD)) AS REG_YMD /* 등록일자 */
FROM TB_BADEAR028M D3 where 1=1 and D3.ADT_SQNO = D1.CVLCPT_ADT_YR||D1.ADT_NO ) END DAY_CNT ,( SELECT F_CODE_NM('1000756',NVL(MIN(PRGRS_STTS_SECD),'10')) AS PRGRS_STTS_SECD /* 진행상태구분코드 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO AND T1.HMPG_RLS_YN = 'Y' AND NVL(T1.DSPS_RQT_KDCD, '0') NOT IN ('130') ) AS PRSS_STA_NM FROM TB_BADDED001M D1 WHERE 1=1 AND D1.SPRVSN_DEPT_CD IN (SELECT SRECS_DEPT_CD /* 심사재심의부서코드 */
FROM TABLE(F_AUTH_DEPT('', 'ALL', '', #strDPT_CD#))) AND EXISTS (SELECT 1
FROM TB_BADEAR028M T1 WHERE T1.TASK_SECD = 'KP1' AND T1.ADT_SQNO = D1.CVLCPT_ADT_YR || D1.ADT_NO AND T1.PBRL_SBMSN_YN = 'Y') AND D1.CVLCPT_ADT_YR BETWEEN #strAudYrSt# AND #strAudYrEnd# AND ( SELECT NVL(MIN(PRGRS_STTS_SECD),'10') AS PRGRS_STTS_SECD /* 진행상태구분코드 */
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO AND T1.HMPG_RLS_YN = 'Y' AND NVL(T1.DSPS_RQT_KDCD, '0') NOT IN ('130') ) = #strPrssStaCd# AND EXISTS (SELECT 1
FROM TB_BADEAR006M REL WHERE REL.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND REL.ADT_NO = D1.ADT_NO /*화면의 관계기관 FROM 만 입력 했을때*/ AND REL.SRECS_REL_INST_CD = #SRECS_REL_INST_CD# /*화면의 관계기관 FROM - TO를 다 입력 했을때*/ AND REL.SRECS_REL_INST_CD BETWEEN #SRECS_REL_INST_CD# AND #strRltnOrgCdEnd# GROUP BY REL.CVLCPT_ADT_YR, REL.ADT_NO ) AND EXISTS (SELECT 1
FROM TB_BADEAR006M REL WHERE REL.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND REL.ADT_NO = D1.ADT_NO /*화면의 관계기관 TO만 다 입력 했을때*/ AND REL.SRECS_REL_INST_CD BETWEEN '000000000000' AND #strRltnOrgCdEnd# GROUP BY REL.CVLCPT_ADT_YR, REL.ADT_NO ) AND EXISTS (SELECT 1
FROM TB_BADEAR006M REL WHERE REL.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND REL.ADT_NO = D1.ADT_NO AND REL.SRECS_REL_INST_CD IN #strSelectOrgCds[]# GROUP BY REL.CVLCPT_ADT_YR, REL.ADT_NO ) AND D1.CVLCPT_ADT_YR||LPAD(D1.ADT_GRNT_NO,4,'0') >= #strAudYrSt#||DECODE(#strAudGrnNoSt#,'','0000', LPAD(#strAudGrnNoSt#,4,'0')) AND D1.CVLCPT_ADT_YR||LPAD(D1.ADT_GRNT_NO,4,'0') AND SUBSTR(D1.ADT_KDCD,3,1) = SUBSTR(#strAudYrNoKndCdSt#,3,1) AND D1.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' AND EXISTS ( SELECT 1
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO AND T1.LINK_YN = 'Y') AND EXISTS ( SELECT 1
FROM TB_BADEAR030M T1 WHERE T1.CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND T1.ADT_NO = D1.ADT_NO AND T1.LINK_YN = 'N') ORDER BY D1.CVLCPT_ADT_YR DESC, D1.ADT_NO DESC