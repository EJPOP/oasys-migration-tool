/*지원업무 기여율 - 지원업무는 지원환산으로 해서 기여율= 기여율*비중/100 의 합인 기여율의 합을 보여준다. */ SELECT D1.EVL_YR AS EVL_YR /* 평가년도 */,
    D1.HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분 */,
    '지원환산' AS TASK_KDCD /* 업무종류코드 */,
    '' AS TSK_NO /* 업무번호 */,
    '' AS TSK_NM /* 업무명 */,
    '' AS TSK_ST_STEP_CD /* 단계기초 */,
    '' AS TSK_END_STEP_CD /* 단계기말 */,
    D1.PTCPT_CNB AS TRGT_NOP_ENO /* 전산번호 */,
    TO_CHAR(ROUND(SUM(D2.WGT_RTE * D1.CTB_RT / 100), 2), 'FM99999.00') AS CTB_RT /* 기여비율 */,
    '' AS DRIVE_RTE /* 추진율 */
FROM TBCSPAOE027M D1 , TBCSPAOE026M D2 WHERE 1=1 AND D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D2.CHR_DPT_CD = CASE WHEN SUBSTR(D1.CHR_DPT_CD,1,3) = '141' THEN '141000' WHEN SUBSTR(D1.CHR_DPT_CD,1,3) = '121' THEN '121000' WHEN SUBSTR(D1.CHR_DPT_CD,1,3) = '122' AND D1.CHR_DPT_CD = '122500' THEN D1.CHR_DPT_CD WHEN SUBSTR(D1.CHR_DPT_CD,1,3) = '122' AND D1.CHR_DPT_CD <> '122500' THEN '122000' ELSE D1.CHR_DPT_CD END AND D1.TSK_NO = D2.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.PTCPT_CNB = #strNevltCnb# AND D1.CTB_RT != 0 GROUP BY D1.EVL_YR, D1.HLYR_DVSN_CD, D1.PTCPT_CNB UNION ALL /*감사업무 기여율*/ SELECT #strEvlYr# AS #STREVLYR# /* 평가년도 */,
    #strHlyrDvsnCd# AS #STRHLYRDVSNCD# /* 반기구분 */,
    F_CODE_NM('1000270',D5.ADT_KDCD) AS TASK_KDCD /* 업무종류코드 */,
    D3.TSK_NO AS TSK_NO /* 업무번호 */,
    D5.ADT_MTTR_NM /* 감사사항명 */,
    D3.AUD_STEP_CD_MIN /* 단계기초 */,
    D3.AUD_STEP_CD_MAX /* 딘계기말 */,
    D4.PTCPT_CNB AS TRGT_NOP_ENO /* 전산번호 */,
    TO_CHAR(D4.CTB_RT, 'FM99999.00') AS CTB_RT /* 기여비율 */,
    (SELECT TO_CHAR(NVL(SUM(DRIVE_RTE), 0), 'FM99999.00') AS TO_CHAR
FROM TBCSPAOE008D WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = '10000' AND ADT_KDCD = D5.ADT_KDCD AND ADT_STP_SECD BETWEEN D3.AUD_STEP_CD_MIN AND D3.AUD_STEP_CD_MAX ) AS DRIVE_RTE /*추진율*/ FROM ( SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    CASE WHEN D2.TSK_NO IS NOT NULL THEN ( SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE ADT_STP_SECD BETWEEN D2.ADT_STP_SECD AND D1.AUD_STEP_CD_MAX AND CVLCPT_ADT_YR = D1.CVLCPT_ADT_YR AND TSK_NO = D1.TSK_NO AND CMPTN_YMD IS NOT NULL) ELSE D1.AUD_STEP_CD_MIN END AS AUD_STEP_CD_MIN /*단계기초*/ , D1.AUD_STEP_CD_MAX /*단계기말*/ FROM ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M /* 감사업무처리단계관리기본 */ WHERE 1 = 1 AND CMPTN_YMD IS NOT NULL AND CMPTN_YMD BETWEEN #strEvlStrDt# AND #strEvlEndDt# GROUP BY CVLCPT_ADT_YR, TSK_NO ) D1 , ( SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    MAX(ADT_STP_SECD) + 1 AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE029M WHERE EVL_YR != #strEvlYr# AND HLYR_DVSN_CD != #strHlyrDvsnCd# /*이번에 평가 받은건 빼야하니깐.*/ AND CVLCPT_TASK_SECD = '10000' GROUP BY CVLCPT_ADT_YR, TSK_NO ) D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR (+) AND D1.TSK_NO = D2.TSK_NO (+) ) D3 , TBCSPAOE023M D4 , TBCSPAOE021M D5 WHERE D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO AND D4.ADT_STP_SECD = D3.AUD_STEP_CD_MAX AND D4.PTCPT_CNB = #strNevltCnb# AND D3.CVLCPT_ADT_YR = D5.CVLCPT_ADT_YR AND D3.TSK_NO = D5.TSK_NO AND D4.CTB_RT != 0 UNION ALL /*감사외업무 기여율*/ SELECT D3.EVL_YR AS EVL_YR /* 평가년도 */,
    D3.HLYR_DVSN_CD AS HLYR_DVSN_CD /* 반기구분 */,
    F_CODE_NM('1000272', D3.TASK_KDCD) AS TASK_KDCD /* 업무종류코드 */,
    D3.TSK_NO AS TSK_NO /* 업무번호 */,
    D3.TSK_NM AS TSK_NM /* 업무명 */,
    '' AS TSK_ST_STEP_CD /* 단계기초 */,
    '' AS TSK_END_STEP_CD /* 단계기말 */,
    D1.PTCPT_CNB AS TRGT_NOP_ENO /* 전산번호 */,
    TO_CHAR(D1.CTB_RT, 'FM99999.00') AS CTB_RT /* 기여비율 */,
    '' AS DRIVE_RTE /* 추진율 */
FROM TBCSPAOE025M D1 , TBCSPAOE024M D3 WHERE 1=1 AND D1.EVL_YR = D3.EVL_YR AND D1.HLYR_DVSN_CD = D3.HLYR_DVSN_CD AND D1.TASK_KDCD = D3.TASK_KDCD AND D1.TSK_NO = D3.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.PTCPT_CNB = #strNevltCnb# AND D1.CTB_RT != 0