SELECT EVL_CLU_CD,
    EVL_CLU_NM,
    EVL_TXT,
    EVL_RK_NM,
    KNB,
    AVG_SC,
    MINUS_SC AS MINUS_SC
FROM ( SELECT EVL_CLU_CD,
    EVL_CLU_NM,
    EVL_TXT,
    EVL_RK_CD,
    EVL_RK_NM,
    KNB,
    AVG_SC,
    MINUS_SC,
    ROW_NUMBER() OVER (PARTITION BY EVL_CLU_CD, EVL_CLU_NM, EVL_TXT, KNB, AVG_SC ORDER BY MINUS_SC) AS ADT_RPTP_EDT_HSTRY_SQNO /* 감사보고서편집이력순번 */
FROM ( SELECT A.EVL_CLU_CD,
    A.EVL_CLU_NM,
    A.EVL_TXT,
    B.EVL_RK_CD,
    B.EVL_RK_NM,
    B.EVL_SC,
    C.KNB,
    C.AVG_SC,
    CASE WHEN B.EVL_SC >= TO_NUMBER(NVL(C.AVG_SC, 0)) THEN TO_NUMBER(B.EVL_SC) - TO_NUMBER(NVL(C.AVG_SC, 0)) ELSE TO_NUMBER(NVL(C.AVG_SC, 0)) - TO_NUMBER(B.EVL_SC) END AS EVL_SC
FROM TBAEPGKM008M AS A ,TBAEPGKM009D AS B ,(SELECT EVL_YR,
    EVL_DVSN_CD,
    SC_GRN_TG_CD,
    EVL_CLU_CD,
    KNB,
    SC_CAT_CD,
    AVG(SC) AS AVG
FROM TBAEPGKM016L WHERE SC_CAT_CD = '2' AND KNB = #KNB# GROUP BY EVL_YR ,EVL_DVSN_CD ,SC_GRN_TG_CD ,EVL_CLU_CD ,KNB ,SC_CAT_CD ORDER BY EVL_YR ,EVL_DVSN_CD ,SC_GRN_TG_CD ,EVL_CLU_CD ,KNB) AS C WHERE A.EVL_CLU_CD = B.EVL_CLU_CD AND A.EVL_CLU_CD = C.EVL_CLU_CD ) ) WHERE ADT_RPTP_EDT_HSTRY_SQNO = '1'