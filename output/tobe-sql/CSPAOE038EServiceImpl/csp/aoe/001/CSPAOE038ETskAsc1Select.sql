SELECT CASE WHEN D1.ADT_STP_YN = 'N' AND (D1.CNT_YN = '1' OR D1.CNT_YN = '2') THEN NVL(ROUND(D1.CD01111 * #strIdvtIndexVal# * D9.CD013, 2), 0) ELSE NVL(ROUND(D1.RTE_ASC, 2), 0) END AS ADT_STP_YN /* 감사단계여부 */,
    case when instr(d4.CD014, '-') = 0 then /*조기가점 처리일 경우*/ CASE WHEN D12.AUD_STEP_END_CD = D10.IDVT_INDEX_VAL THEN nvl(round(D1.RTE_ASC1 + (D1.CD0111*ROUND(#strIdvtIndexVal#, 2)*D3.CD013*D4.CD014) + 0 + 0 , 2), 0) else nvl(round(D1.RTE_ASC2 + 0 + 0 + 0 , 2), 0) END WHEN D12.AUD_STEP_END_CD >= '10004' THEN /*단계기말이 귀청보고 이상이면, 기준등급의 가중치 초과일 때 가점처리한다.*/ CASE WHEN ROUND(#strIdvtIndexVal#, 2) = '10006' AND D3.AUD_STEP_END_CD >= '10006') THEN D1.AUD_STEP_END_DRIVE_RTE ELSE D2.AUD_STEP_END_DRIVE_RTE END AS INSTR
FROM ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 심의실 이후에 대한 추진율 구하는 쿼리*/ SELECT 0,
    NVL(SUM(D1.DRIVE_RTE)/100, 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD >= '10006' AND D2.AUD_STEP_END_CD >= '10006') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D1 , ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 감사단장 이전에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE)/100, 0) AS DRIVE_RTE,
    0
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD <= '10005' AND D2.AUD_STEP_END_CD <= '10005') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D2 , ( SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE LUNH_DT IS NOT NULL AND CMPTN_YMD IS NOT NULL AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND (CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY CVLCPT_ADT_YR, TSK_NO ) D3 ) D3 /*심의실 포함 안 한 감사단장 이전 추진율 및 심의실 이후 추진율*/ ) D1 /*감사단장 이전 추진율 및 심의실 이후 추진율*/ , (SELECT DISTINCT NVL(SYT_TRTM_YN, 'N') AS SYT_TRTM_YN
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo#) D3 , (SELECT MNDY_CNT
FROM TBCSPAOE021M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo#) D4 ) D1 /*감사종류별 표준평점*/, (SELECT SUM(D1.DRIVE_RTE)/100 AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND D1.CMPTN_YMD IS NOT NULL AND ( D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D3 /*감사단계별 추진율*/, (SELECT SUM(D1.DRIVE_RTE)/100 AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND D1.CMPTN_YMD IS NOT NULL AND ( D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D9 /*감사단계별 추진율*/, (SELECT CASE WHEN HNDL_PRD_DVSN_CD = '100' THEN NVL(ASP_RTE/100, '0') ELSE -NVL(ASP_RTE/100, '0') END AS HNDL_PRD_DVSN_CD
FROM TBCSPAOE012M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DLAY_DT_NM = ( SELECT SUM(D2.DLAY_DT_NM)
FROM ( SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND D1.CMPTN_YMD IS NOT NULL AND ( D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO ) D1 , TBCSPAOE022M D2 WHERE D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO AND D2.ADT_STP_SECD BETWEEN D1.AUD_STEP_ST_CD AND D1.AUD_STEP_END_CD ) ) D4 /*조기지연처리 가감점율*/, (SELECT FML_TXT
FROM TBCSPAOE013M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# ) D7 /*감사업무 업무평점 수식*/, (SELECT B.IDVT_INDEX_VAL
FROM TBCSPAOE010D B WHERE B.RK_CD = ( SELECT A.ELY_ADPT_STAD_RK_CD
FROM TBCSPAOE008D A WHERE A.EVL_YR = #strEvlYr# AND A.HLYR_DVSN_CD = #strHlyrDvsnCd# AND A.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND A.ADT_KDCD = (SELECT C.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE021M C WHERE C.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND C.TSK_NO = #strTskNo#) AND A.ADT_STP_SECD = (SELECT MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND D1.CMPTN_YMD IS NOT NULL AND ( D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D1.TSK_NO ) ) AND B.EVL_YR = #strEvlYr# AND B.HLYR_DVSN_CD = #strHlyrDvsnCd# AND B.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND B.AUD_TSK_KND_CD = (SELECT ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE021M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo#)) D10 /*조기가점기준등급*/ , (SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO
FROM TBCSPAOE022M WHERE LUNH_DT IS NOT NULL AND CMPTN_YMD IS NOT NULL AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND (CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY CVLCPT_ADT_YR, TSK_NO) D12