SELECT D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO /* 감사번호 */,
    NVL(F_MNG_KND_AUDYRNO(D1.CVLCPT_ADT_YR, D1.TSK_NO, D8.ADT_KDCD, '-'),D1.CVLCPT_ADT_YR||'-'||D1.TSK_NO) AS F_MNG_KND_AUDYRNO /* 감사연번호 */,
    D1.ADT_MTTR_NM /* 감사사항명 */,
    D1.HNDL_DIV_DPT_CD /* 처리과부서코드 */,
    F_DPT_INFO(D1.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO /* 처리과명 */,
    NVL(D1.TRGT_INST_NM, '') AS TRGT_INST_NM /* 대상기관명 */,
    D1.ADT_KDCD /* 감사종류코드 */,
    F_CODE_NM('1000270', D1.ADT_KDCD) AS F_CODE_NM /* 감사종류명 */,
    F_CODE_NM('1000273', D6.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.AUD_LDR_CNB /* 감사단장 전산번호 */,
    D1.AUD_LDR_BLT_DPT_CD /* 감사단장소속부서코드 */,
    F_DPT_INFO(D1.AUD_LDR_BLT_DPT_CD, '1') AS F_DPT_INFO /* 감사단장소속부서명 */,
    D1.AUD_LDR_RANK_CD /* 감사단장직급코드 */,
    F_CODE_NM('1000173', D1.AUD_LDR_RANK_CD) AS JBPS_NM /* 직위명 */,
    D3.USER_NM /* 사용자명 */,
    D1.SPVR_ENO /* 감리원직원전산번호 */,
    D1.SPVR_BLT_DPT_CD /* 주관자소속부서코드 */,
    F_DPT_INFO(D1.SPVR_BLT_DPT_CD, '1') AS F_DPT_INFO /* 주관자소속부서명 */,
    D1.SPVR_JBGD_SECD /* 감리원직급구분코드 */,
    F_CODE_NM('1000173', D1.SPVR_JBGD_SECD) AS F_CODE_NM /* 주관자직급명 */,
    D4.USER_NM /* 사용자명 */,
    D1.ASTN_ENO /* 보조자직원전산번호 */,
    D1.AST_BLT_DPT_CD /* 보조자소속부서코드 */,
    F_DPT_INFO(D1.AST_BLT_DPT_CD, '1') AS F_DPT_INFO /* 보조자소속부서명 */,
    D1.ASTN_JBGD_SECD /* 보조자직급구분코드 */,
    F_CODE_NM('1000173', D1.ASTN_JBGD_SECD) AS F_CODE_NM /* 보조자직급명 */,
    D5.USER_NM /* 사용자명 */,
    NVL(D1.BZT_AM, 0) AS BZT_AM /* 출장금액 */,
    CASE WHEN (SELECT AS LUNH_DT
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10000') IS NULL THEN '' ELSE SUBSTR((SELECT LUNH_DT
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10000'), 1, 4)||'-'||SUBSTR((SELECT LUNH_DT
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10000'), 5, 2)||'-'||SUBSTR((SELECT LUNH_DT
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10000'), 7, 2) END AS RSRV_EXMN_OTST_YMD /*예비조사착수일*/, CASE WHEN (SELECT CMPTN_YMD /* 완료일자 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10010') IS NULL THEN '' ELSE SUBSTR((SELECT CMPTN_YMD /* 완료일자 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10010'), 1, 4)||'-'||SUBSTR((SELECT CMPTN_YMD /* 완료일자 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10010'), 5, 2)||'-'||SUBSTR((SELECT CMPTN_YMD /* 완료일자 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND ADT_STP_SECD = '10010'), 7, 2) END AS ENFC_YMD /*시행일*/, D7.TOT_AUD_OP_PRD_DCN /*총감사운영기간일수*/, NVL(D1.MNDY_CNT, 9) AS MNDY_CNT /*연인원수*/, NVL(D2.DLAY_DT_NM, '0') AS DLAY_DT_NM /*지연일명*/, NVL(D2.EXET_DCN, 0) AS EXET_DCN /*면책일수*/ , D7.STUT_NOP_CNT /*단계별인원수*/, D7.STUT_PRD_DCN /*단계별기간일수*/, D1.MAIN_INDC_SBJ_PRB_TXT /*주요지적사항문제점내용*/ , D1.MAIN_AUD_RSLT_EPT_EFCT_TXT /*주요감사결과기대효과내용*/, D1.SPCT_SBJ_PLN_CTT_CTB_RTE_CHG_RSN_TXT /*특기사항계획대비기여율변경사유내용*/ FROM TBCSPAOE021M D1 , (SELECT CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    SUM(DLAY_DT_NM) AS DLAY_DT_NM,
    SUM(EXET_DCN) AS EXET_DCN
FROM TBCSPAOE022M GROUP BY CVLCPT_ADT_YR, TSK_NO) D2 , TBDCMACM001M D3 , TBDCMACM001M D4 , TBDCMACM001M D5 , (SELECT NVL(MAX(ADT_STP_SECD), '') AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #ADT_NO# AND CMPTN_YMD IS NOT NULL ) D6 , (SELECT A.CVLCPT_ADT_YR /* 민원감사년도 */,
    A.ADT_NO /* 감사번호 */,
    A.ADT_DCN /* 감사일수 */,
    C.IN_PSON_CNT /* 단계별인원 */,
    C.ADT_DCN /* 감사일수 */
FROM (SELECT A.ADT_YR /* 감사년도 */,
    A.ADT_NO /* 감사번호 */,
    MAX(ADT_KDCD) AS ADT_KDCD /* 감사종류코드 */,
    sum(B.ADT_DCN) AS ADT_DCN /* 감사일수 */
FROM TBBADDED001M A , TBBADDED002M B WHERE A.CVLCPT_ADT_YR = B.REL_ADT_YR AND A.ADT_NO = B.REL_ADT_NO AND BZTRP_SECD ='1' AND A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# GROUP BY A.CVLCPT_ADT_YR , A.ADT_NO , A.WHOL_RBPRSN_DEPT_CD , A.SPVR_DEPT_CD , A.ASTN_DEPT_CD ) A, (SELECT REL_ADT_YR /* 관계감사년도 */,
    REL_ADT_NO /* 관계감사번호 */,
    SUBSTRB(max(SYS_CONNECT_BY_PATH(ACADT_STP_NO||'단계('||ADT_DCN||'일)', ' ')), 2) AS ADT_DCN /* 감사일수 */,
    max(IN_PSON_MAN_DAY) AS IN_PSON_MAN_DAY,
    SUBSTRB(max(SYS_CONNECT_BY_PATH(ACADT_STP_NO||'단계('||IN_PSON_CNT||'명)', ' ')), 2) AS SUBSTRB
FROM (SELECT ROWNUM,
    A.REL_ADT_YR /* 관계감사년도 */,
    A.REL_ADT_NO /* 관계감사번호 */,
    A.BZTRP_YR /* 출장년도 */,
    A.BZTRP_SQNO /* 출장순번 */,
    A.ADT_DCN /* 감사일수 */,
    B.IN_PSON_CNT,
    SUM(C.IN_PSON_MAN_DAY) OVER (PARTITION BY REL_ADT_YR, REL_ADT_NO) AS IN_PSON_MAN_DAY,
    ACADT_STP_NO /* 실지감사단계번호 */
FROM TBBADDED002M A , (select /*+ INDEX(A KBBADBADDED005001) */ BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    BZTRP_SQNO /* 출장순번 */,
    sum( case when A.EMP_SECD = '0' then 1 else 0 end) AS EMP_SECD /* 직원구분코드 */
from (SELECT distinct AS BZTRP_YR,
    BZTRP_SQNO /* 출장순번 */,
    BZTRVR_ENO /* 출장자직원전산번호 */,
    EMP_SECD /* 직원구분코드 */
FROM TBBADDED005L ) A group by BZTRP_YR, BZTRP_SQNO ) B, (select /*+INDEX(B, KBBADBADDED006001)*/ PT1.BZTRP_YR AS BZTRP_YR /* 출장년도 */,
    PT1.BZTRP_SQNO /* 출장순번 */,
    SUM( case when TMA.EMP_SECD = '0' then PT1.ADT_DCN else 0 end) AS EMP_SECD /* 직원구분코드 */
from TBBADDED005L tma , TBBADDED006L pt1 where PT1.BZTRP_YR = TMA.BZTRP_YR and PT1.BZTRP_SQNO = TMA.BZTRP_SQNO and PT1.FT_SQNO = TMA.FT_SQNO and PT1.BZTRVR_ALTMNT_SQNO = TMA.BZTRVR_ALTMNT_SQNO group by PT1.BZTRP_YR, PT1.BZTRP_SQNO ) C WHERE B.BZTRP_YR(+) = A.BZTRP_YR AND B.BZTRP_SQNO(+) = A.BZTRP_SQNO AND C.BZTRP_YR(+) = A.BZTRP_YR AND C.BZTRP_SQNO(+) = A.BZTRP_SQNO /*AND AUD_BZT_KND_CD ='02'*/ AND A.REL_ADT_YR = #CVLCPT_ADT_YR# AND A.REL_ADT_NO = #ADT_NO# ) WHERE LEVEL >= 1 START WITH RN = 1 CONNECT BY PRIOR RN = RN-1 group by REL_ADT_YR, REL_ADT_NO ) C WHERE A.CVLCPT_ADT_YR = C.REL_ADT_YR AND A.ADT_NO = C.REL_ADT_NO AND A.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND A.ADT_NO = #ADT_NO# ) D7 ,TB_BADDED001M D8 WHERE 1=1 AND ROWNUM = 1 AND D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR (+) AND D1.TSK_NO = D2.TSK_NO (+) AND D1.AUD_LDR_CNB = D3.TRGT_NOP_ENO (+) AND D1.SPVR_ENO = D4.TRGT_NOP_ENO (+) AND D1.ASTN_ENO = D5.TRGT_NOP_ENO (+) AND D1.CVLCPT_ADT_YR = D7.CVLCPT_ADT_YR (+) AND D1.TSK_NO = D7.TSK_NO (+) AND D1.CVLCPT_ADT_YR = D8.ADT_YR(+) AND D1.TSK_NO = D8.ADT_NO(+) AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #ADT_NO#