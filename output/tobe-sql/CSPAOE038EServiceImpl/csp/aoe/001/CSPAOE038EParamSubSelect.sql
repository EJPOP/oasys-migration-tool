SELECT D2.EVL_YR /* 평가년도 */,
    D2.HLYR_DVSN_CD /* 반기구분 */,
    NVL(D2.CVLCPT_TASK_SECD,'10000') AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D2.AUD_TSK_KND_CD /* 감사업무종류코드 */,
    NVL(D2.EVL_STEP_CD,'200') AS EVL_STEP_CD /* 평가단계코드(위원평가) */,
    NVL(D1.EVL_CMTR_DVSN_CD,'CD34') AS EVL_CMTR_DVSN_CD /* 평가위원구분코드(위원평가) */,
    D1.EVL_CMTR_CNB /* 평가자전산번호 */,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO /* 업무번호 */,
    D2.EVL_INDEX_CD /* 평가지표코드 */,
    D2.EVL_RK_CD /* 평가등급코드 */,
    D3.IDVT_INDEX_VAL /* 개별지표값 */,
    D6.WGT_RTE /* 비중 */,
    (D6.WGT_RTE/100) * D3.IDVT_INDEX_VAL AS WGT_RTE /* 비중*개별지표값 */,
    NVL(D1.SYT_EVL_ADVL_VAL,0) AS SYT_EVL_ADVL_VAL /* 종합평가가중치값 */,
    NVL(( SELECT D1.RK_CD
FROM( SELECT RK_CD,
    RANK() OVER(ORDER BY RK_CD DESC) AS RANK
FROM TBCSPAOE010D WHERE 1=1 AND EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (( SELECT ROUND(AVG(D3.IDVT_INDEX_VAL),1) AS ROUND /* 종합평가가중치값 */
FROM TBCSPAOE030M D2 LEFT JOIN TBCSPAOE010D D3 ON D2.EVL_YR = D3.EVL_YR AND D2.HLYR_DVSN_CD = D3.HLYR_DVSN_CD AND D2.CVLCPT_TASK_SECD = D3.CVLCPT_TASK_SECD AND D2.AUD_TSK_KND_CD = D3.AUD_TSK_KND_CD AND D2.EVL_RK_CD = D3.RK_CD WHERE 1=1 AND D2.EVL_STEP_CD = #strEvlStepCd# AND D2.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND D2.EVL_CMTR_CNB = #strEvlCmtrCnb# AND D2.EVL_YR = #strEvlYr# AND D2.HLYR_DVSN_CD = #strHlyrDvsnCd# )) = '10006' AND D3.AUD_STEP_END_CD >= '10006') THEN D1.AUD_STEP_END_DRIVE_RTE ELSE D2.AUD_STEP_END_DRIVE_RTE END AS AUD_STEP_END_DRIVE_RTE FROM ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 심의실 이후에 대한 추진율 구하는 쿼리*/ SELECT 0,
    NVL(SUM(D1.DRIVE_RTE)/100, 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.LUNH_DT BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) OR D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD >= '10006' AND D2.AUD_STEP_END_CD >= '10006') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D1 , ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 감사단장 이전에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE)/100, 0) AS DRIVE_RTE,
    0
FROM TBCSPAOE008D D1, (SELECT MIN(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    MAX(D1.ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.LUNH_DT BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) OR D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD 0 THEN (SELECT CASE WHEN HNDL_PRD_DVSN_CD = '100' THEN NVL(ASP_RTE/100, '0') ELSE -NVL(ASP_RTE/100, '0') END AS HNDL_PRD_DVSN_CD
FROM TBCSPAOE012M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND DLAY_DT_NM = (SELECT SUM(DLAY_DT_NM)
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND (LUNH_DT BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) OR CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) ) ) ELSE 0 END AS CD014 FROM DUAL ) D4 /*조기지연처리 가감점*/ , ( SELECT NVL(SPE_ADD_SC,0) AS SPE_ADD_SC
FROM TBCSPAOE029M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND AUD_TSK_KND_CD = #strAudKndCd# AND EVL_STEP_CD = #strEvlStepCd# AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# ) D5 /*특별가산점*/ , ( SELECT ROUND(NVL(MDT_ASC,0),2) AS ROUND
FROM TBCSPAOE029M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND AUD_TSK_KND_CD = #strAudKndCd# AND EVL_STEP_CD = #strEvlStepCd# AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# ) D6 /*평점조정*/ , ( SELECT FML_TXT
FROM TBCSPAOE013M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# ) D7 /*감사업무 업무평점 수식*/ ) D5 WHERE 1=1 AND D6.EVL_YR = D2.EVL_YR AND D6.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D6.EVL_INDEX_CD = D2.EVL_INDEX_CD AND D2.EVL_STEP_CD = #strEvlStepCd# AND D2.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND D2.EVL_CMTR_CNB = #strEvlCmtrCnb# AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.AUD_TSK_KND_CD = #strAudKndCd# AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo#