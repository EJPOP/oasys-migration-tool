SELECT D2.EVL_YR,
    D2.HLYR_DVSN_CD,
    D2.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D2.AUD_TSK_KND_CD,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO,
    NVL(F_MNG_KND_AUDYRNO(D2.CVLCPT_ADT_YR, D2.TSK_NO, D6.ADT_KDCD, '-'),D2.CVLCPT_ADT_YR||'-'||D2.TSK_NO) AS F_MNG_KND_AUDYRNO,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D2.TSK_ASC,
    D2.EVL_STEP_CD,
    D2.EVL_CMTR_DVSN_CD,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO,
    D3.HNDL_DIV_DPT_CD
FROM TBCSPAOE029M D2 LEFT JOIN TBCSPAOE033M D1 ON D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D2.CVLCPT_TASK_SECD AND D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO , TBCSPAOE021M D3 LEFT JOIN TBCSPAOE022M D4 ON D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO , TBCSPAOE008D D5,TB_BADDED001M D6 WHERE 1=1 AND D2.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND D2.TSK_NO = D3.TSK_NO AND D2.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR(+) AND D2.TSK_NO = D6.ADT_NO(+) AND D2.EVL_YR =D5.EVL_YR AND D2.HLYR_DVSN_CD = D5.HLYR_DVSN_CD AND D3.ADT_KDCD = D5.ADT_KDCD AND D4.ADT_STP_SECD = D5.ADT_STP_SECD AND D2.EVL_YR = #strEvlYr# AND D2.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.CVLCPT_TASK_SECD = '10000' /*감사업무평점*/ AND D2.ADT_STP_SECD <> '10010' AND D2.EVL_STEP_CD = '100' /*귀청보고단계평가*/ D2.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D6.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D2.TSK_NO = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D6.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) D3.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' GROUP BY D2.EVL_YR, D2.HLYR_DVSN_CD, D2.CVLCPT_TASK_SECD, D2.AUD_TSK_KND_CD, D2.CVLCPT_ADT_YR, D2.TSK_NO, D3.ADT_MTTR_NM, D2.TSK_ASC, D2.EVL_STEP_CD, D2.EVL_CMTR_DVSN_CD, D2.SYT_EVL_RK_CD, D2.SYT_EVL_ADVL_VAL, D3.HNDL_DIV_DPT_CD, D6.ADT_KDCD UNION SELECT D2.EVL_YR,
    D2.HLYR_DVSN_CD,
    D2.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D2.AUD_TSK_KND_CD,
    D2.CVLCPT_ADT_YR /* 민원감사년도 */,
    D2.TSK_NO,
    NVL(F_MNG_KND_AUDYRNO(D2.CVLCPT_ADT_YR, D2.TSK_NO, D6.ADT_KDCD, '-'),D2.CVLCPT_ADT_YR||'-'||D2.TSK_NO) AS F_MNG_KND_AUDYRNO,
    D3.ADT_MTTR_NM /* 감사사항명 */,
    D2.TSK_ASC,
    D2.EVL_STEP_CD,
    D2.EVL_CMTR_DVSN_CD,
    F_DPT_INFO(D3.HNDL_DIV_DPT_CD, '1') AS F_DPT_INFO,
    D3.HNDL_DIV_DPT_CD
FROM TBCSPAOE029M D2 LEFT JOIN TBCSPAOE033M D1 ON D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D2.CVLCPT_TASK_SECD AND D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO , TBCSPAOE021M D3 LEFT JOIN TBCSPAOE022M D4 ON D3.CVLCPT_ADT_YR = D4.CVLCPT_ADT_YR AND D3.TSK_NO = D4.TSK_NO , TBCSPAOE008D D5,TB_BADDED001M D6 WHERE 1=1 AND D2.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND D2.TSK_NO = D3.TSK_NO AND D2.CVLCPT_ADT_YR = D6.CVLCPT_ADT_YR(+) AND D2.TSK_NO = D6.ADT_NO(+) AND D2.EVL_YR =D5.EVL_YR AND D2.HLYR_DVSN_CD = D5.HLYR_DVSN_CD AND D3.ADT_KDCD = D5.ADT_KDCD AND D4.ADT_STP_SECD = D5.ADT_STP_SECD AND D2.EVL_YR = #strEvlYr# AND D2.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D2.CVLCPT_TASK_SECD = '10000' /*감사업무평점*/ AND D2.EVL_STEP_CD = '200' /*위원평가단계*/ D2.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# CASE WHEN LENGTH(#ADT_GRNT_NO#) = 3 AND D6.ADT_GRNT_NO = #ADT_GRNT_NO# THEN '1' WHEN LENGTH(#ADT_GRNT_NO#) <> 3 AND D2.TSK_NO = #ADT_GRNT_NO# THEN '1' ELSE '' END = '1' D6.ADT_KDCD like '%'||SUBSTR(#strAudYrNoKndCd#,3,1) D3.ADT_MTTR_NM LIKE '%'||#strAudSbjNm#||'%' GROUP BY D2.EVL_YR, D2.HLYR_DVSN_CD, D2.CVLCPT_TASK_SECD, D2.AUD_TSK_KND_CD, D2.CVLCPT_ADT_YR, D2.TSK_NO, D3.ADT_MTTR_NM, D2.TSK_ASC, D2.EVL_STEP_CD, D2.EVL_CMTR_DVSN_CD, D2.SYT_EVL_RK_CD, D2.SYT_EVL_ADVL_VAL, D3.HNDL_DIV_DPT_CD, D6.ADT_KDCD ORDER BY D3.HNDL_DIV_DPT_CD