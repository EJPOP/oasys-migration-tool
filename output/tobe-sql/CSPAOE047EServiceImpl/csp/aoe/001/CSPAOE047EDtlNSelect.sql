SELECT #strEvlYr# AS #STREVLYR#,
    #strHlyrDvsnCd# AS #STRHLYRDVSNCD#,
    #CVLCPT_TASK_SECD# AS CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    #CVLCPT_ADT_YR# AS CVLCPT_ADT_YR /* 민원감사년도 */,
    #strTskNo# AS #STRTSKNO#,
    D1.EVL_CLU_CD1,
    D1.MNDY_CNT,
    D1.SYT_TRTM_YN,
    D1.ADT_KDCD /* 감사종류코드 */,
    D1.STND_ASC,
    D2.EVL_CLU_CD2,
    D2.SYT_EVL_RK_CD,
    D2.SYT_EVL_ADVL_VAL,
    D3.EVL_CLU_CD3,
    D3.AUD_ST_STEP_CD,
    D3.AUD_END_STEP_CD,
    D3.DRIVE_RTE,
    D7.ADT_STP_YN /* 감사단계여부 */,
    D7.AUD_STEP_ST_DRIVE_RTE,
    D7.AUD_STEP_END_DRIVE_RTE,
    D4.EVL_CLU_CD4,
    D4.HNDL_PRD_DVSN_CD,
    D4.HNDL_PRD_DCN,
    D4.DLAY_DT_NM,
    D4.ASP_RTE,
    D5.EVL_CLU_CD5,
    D5.SPE_ADP_CLU_CD,
    D5.SPE_ADD_SC,
    D6.EVL_CLU_CD6,
    D6.MDT_ASC
FROM ( SELECT 'CD011' AS EVL_CLU_CD1,
    CASE WHEN D1.SYT_TRTM_YN IS NULL THEN 'N' ELSE D1.SYT_TRTM_YN END AS SYT_TRTM_YN,
    D1.MNDY_CNT,
    D1.ADT_KDCD /* 감사종류코드 */,
    ROUND(F_GET_CAL(CONCAT(CONCAT(SUBSTR(D1.FML_TXT, 1, INSTR(D1.FML_TXT, 'A01')-1), 'A01,'), SUBSTR(D1.FML_TXT, INSTR(D1.FML_TXT, 'A01')+4)), D1.MNDY_CNT), 2) AS ROUND
FROM( SELECT D2.MNDY_CNT , D2.ADT_KDCD , D3.SYT_TRTM_YN , CASE WHEN TO_NUMBER(D3.ADT_STP_SECD) = '10006' AND D3.AUD_STEP_END_CD >= '10006') THEN D1.AUD_STEP_END_DRIVE_RTE ELSE D2.AUD_STEP_END_DRIVE_RTE END AS AUD_STEP_END_DRIVE_RTE FROM ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 심의실 이후에 대한 추진율 구하는 쿼리*/ SELECT 0,
    NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT (SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND LUNH_DT IS NOT NULL) AS AUD_STEP_ST_CD , (SELECT MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND CMPTN_YMD IS NOT NULL) AS AUD_STEP_END_CD , D1.CVLCPT_ADT_YR , D2.ADT_KDCD FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD >= '10006' AND D2.AUD_STEP_END_CD >= '10006') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D1 , ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 감사단장 이전에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE,
    0
FROM TBCSPAOE008D D1, (SELECT (SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND LUNH_DT IS NOT NULL) AS AUD_STEP_ST_CD , (SELECT MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND CMPTN_YMD IS NOT NULL) AS AUD_STEP_END_CD , D1.CVLCPT_ADT_YR , D2.ADT_KDCD FROM TBCSPAOE022M D1 LEFT JOIN TBCSPAOE021M D2 ON D1.CVLCPT_ADT_YR = D2.CVLCPT_ADT_YR AND D1.TSK_NO = D2.TSK_NO WHERE D1.LUNH_DT IS NOT NULL AND D1.CMPTN_YMD IS NOT NULL AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# AND (D1.CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY D1.CVLCPT_ADT_YR, D2.ADT_KDCD ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD <= '10005' AND D2.AUD_STEP_END_CD <= '10005') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D2 , ( SELECT (SELECT MIN(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND LUNH_DT IS NOT NULL) AS AUD_STEP_ST_CD , (SELECT MAX(ADT_STP_SECD) AS ADT_STP_SECD /* 감사단계구분코드 */
FROM TBCSPAOE022M WHERE CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND CMPTN_YMD IS NOT NULL) AS AUD_STEP_END_CD , CVLCPT_ADT_YR , TSK_NO FROM TBCSPAOE022M WHERE LUNH_DT IS NOT NULL AND CMPTN_YMD IS NOT NULL AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND (CMPTN_YMD BETWEEN (select EVL_STR_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#) AND (select EVL_END_DT
from TBCSPAOE001M where EVL_YR = #strEvlYr# and HLYR_DVSN_CD = #strHlyrDvsnCd#)) GROUP BY CVLCPT_ADT_YR, TSK_NO ) D3 ) D3 /*심의실 포함 안 한 감사단장 이전 추진율 및 심의실 이후 추진율*/ ) D7