SELECT A.EVL_YR,
    A.HLYR_DVSN_CD,
    A.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    A.CVLCPT_ADT_YR /* 민원감사년도 */,
    A.TSK_NO,
    A.TPOF_CYCL /* 제보차수 */,
    A.EVL_CLU_CD1,
    A.MNDY_CNT,
    A.SYT_TRTM_YN,
    A.ADT_KDCD /* 감사종류코드 */,
    A.STND_ASC,
    A.EVL_CLU_CD2,
    A.SYT_EVL_RK_CD,
    A.SYT_EVL_ADVL_VAL,
    A.EVL_CLU_CD3,
    A.AUD_ST_STEP_CD,
    A.AUD_END_STEP_CD,
    A.DRIVE_RTE,
    B.ADT_STP_YN /* 감사단계여부 */,
    B.AUD_STEP_ST_DRIVE_RTE,
    B.AUD_STEP_END_DRIVE_RTE,
    A.EVL_CLU_CD4,
    A.HNDL_PRD_DVSN_CD,
    A.HNDL_PRD_DCN,
    A.ASP_RTE,
    A.EVL_CLU_CD5,
    A.SPE_ADP_CLU_CD,
    A.SPE_ADD_SC,
    A.EVL_CLU_CD6,
    A.MDT_ASC,
    A.FML_TXT,
    A.FNL_ASC
FROM ( SELECT D1.EVL_YR,
    D1.HLYR_DVSN_CD,
    D1.CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.TSK_NO,
    D1.TPOF_CYCL /* 제보차수 */,
    D1.EVL_CLU_CD_1,
    D1.MNDY_CNT,
    D1.SYT_TRTM_YN,
    D1.ADT_KDCD /* 감사종류코드 */,
    D1.STND_ASC,
    D1.EVL_CLU_CD_2,
    D1.AUD_TSK_EVL_RK_CD,
    D1.ADVL_VAL,
    D1.EVL_CLU_CD_3,
    D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.DRIVE_RTE,
    D1.EVL_CLU_CD_4,
    D1.HNDL_PRD_DVSN_CD,
    D1.HNDL_PRD_DCN,
    D1.ASP_RTE,
    D1.EVL_CLU_CD_5,
    D1.SPE_ADP_CLU_CD,
    NVL(D1.SPE_ADD_SC, 0) AS SPE_ADD_SC,
    D1.EVL_CLU_CD_6,
    NVL(D1.MDT_ASC, 0) AS MDT_ASC,
    D2.FML_TXT,
    NVL(ROUND(F_TSK_ASC_SUM(D1.CVLCPT_TASK_SECD, D2.FML_TXT, D1.STND_ASC, D1.ADVL_VAL, D1.DRIVE_RTE/100, D1.STND_ASC*D1.ADVL_VAL*(D1.DRIVE_RTE/100)*D3.ASP_RTE, NVL(D1.SPE_ADD_SC,0), NVL(D1.MDT_ASC,0)),2),0) AS ROUND
FROM TBCSPAOE033M D1 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    FML_TXT
FROM TBCSPAOE013M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# ) D2 , ( SELECT EVL_YR,
    HLYR_DVSN_CD,
    CVLCPT_TASK_SECD /* 민원업무구분코드 */,
    CVLCPT_ADT_YR /* 민원감사년도 */,
    TSK_NO,
    HNDL_PRD_DVSN_CD,
    HNDL_PRD_DCN,
    CASE WHEN HNDL_PRD_DVSN_CD = '100' THEN ASP_RTE/100 ELSE -(ASP_RTE/100) END AS HNDL_PRD_DVSN_CD
FROM TBCSPAOE033M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# AND TPOF_CYCL = ( SELECT MAX(TPOF_CYCL) AS TPOF_CYCL /* 제보차수 */
FROM TBCSPAOE033M WHERE EVL_YR = #strEvlYr# AND HLYR_DVSN_CD = #strHlyrDvsnCd# AND CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND TSK_NO = #strTskNo# ) ) D3 WHERE D1.EVL_YR = D2.EVL_YR AND D1.HLYR_DVSN_CD = D2.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D2.CVLCPT_TASK_SECD AND D1.EVL_YR = d3.EVL_YR AND D1.HLYR_DVSN_CD = d3.HLYR_DVSN_CD AND D1.CVLCPT_TASK_SECD = D3.CVLCPT_TASK_SECD AND D1.CVLCPT_ADT_YR = D3.CVLCPT_ADT_YR AND D1.TSK_NO = d3.TSK_NO AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A , ( SELECT D1.ADT_STP_YN /* 감사단계여부 */,
    CASE WHEN D1.ADT_STP_YN = 'Y' THEN D2.AUD_STEP_ST_DRIVE_RTE ELSE D3.AUD_STEP_ST_DRIVE_RTE END AS ADT_STP_YN /* 감사단계여부 */,
    CASE WHEN D1.ADT_STP_YN = 'N' THEN D3.AUD_STEP_END_DRIVE_RTE ELSE D2.AUD_STEP_END_DRIVE_RTE END AS ADT_STP_YN /* 감사단계여부 */
FROM ( SELECT CASE WHEN COUNT(*) = 1 THEN 'Y' ELSE 'N' END AS ADT_STP_YN /* 감사단계여부 */
FROM ( SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D1 WHERE '10006' BETWEEN D1.AUD_STEP_ST_CD AND D1.AUD_STEP_END_CD ) D1 , ( /*심의실 포함한 감사단장 이전 추진율 및 심의실 이후 추진율*/ SELECT D1.AUD_STEP_ST_DRIVE_RTE,
    D2.AUD_STEP_END_DRIVE_RTE
FROM ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함하고 감사단장 이전에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND '10006' BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND '10005' ) D1 , ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함하고 심의실 이후에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND '10006' BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD AND D1.ADT_STP_SECD BETWEEN '10006' AND D2.AUD_STEP_END_CD ) D2 ) D2 /*심의실 포함한 감사단장 이전 추진율 및 심의실 이후 추진율*/ , ( /*심의실 포함 안 한 감사단장 이전 추진율 및 심의실 이후 추진율*/ SELECT CASE WHEN (D3.AUD_STEP_ST_CD = '10006' AND D3.AUD_STEP_END_CD >= '10006') THEN D1.AUD_STEP_END_DRIVE_RTE ELSE D2.AUD_STEP_END_DRIVE_RTE END AS AUD_STEP_ST_CD
FROM ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 심의실 이후에 대한 추진율 구하는 쿼리*/ SELECT 0,
    NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE
FROM TBCSPAOE008D D1, (SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD >= '10006' AND D2.AUD_STEP_END_CD >= '10006') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D1 , ( /*감사기초단계 ~ 감사기말단계에서 심의실 포함 안하고 감사단장 이전에 대한 추진율 구하는 쿼리*/ SELECT NVL(SUM(D1.DRIVE_RTE), 0) AS DRIVE_RTE,
    0
FROM TBCSPAOE008D D1, (SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D2 WHERE D1.ADT_KDCD = D2.ADT_KDCD AND D1.EVL_YR = #strEvlYr# AND D1.HLYR_DVSN_CD = #strHlyrDvsnCd# AND D1.CVLCPT_TASK_SECD = #CVLCPT_TASK_SECD# AND (D2.AUD_STEP_ST_CD <= '10005' AND D2.AUD_STEP_END_CD <= '10005') AND D1.ADT_STP_SECD BETWEEN D2.AUD_STEP_ST_CD AND D2.AUD_STEP_END_CD ) D2 , ( SELECT A.*
FROM (SELECT D1.AUD_STEP_FNDT_CD,
    D1.AUD_STEP_TEND_CD,
    D1.CVLCPT_ADT_YR /* 민원감사년도 */,
    D1.ADT_KDCD /* 감사종류코드 */
FROM TBCSPAOE033M D1 WHERE D1.CVLCPT_ADT_YR = #CVLCPT_ADT_YR# AND D1.TSK_NO = #strTskNo# ORDER BY D1.TPOF_CYCL DESC ) A WHERE ROWNUM =1 ) D3 ) D3 /*심의실 포함 안 한 감사단장 이전 추진율 및 심의실 이후 추진율*/ ) B WHERE ROWNUM = 1